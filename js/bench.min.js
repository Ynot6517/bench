var ROCKIMG="png/asteroid.jpg",DEBRISIMG="png/debris.png",OBSTACLES=[],PX=[300,500,300,500,300,500],PY=[250,250,400,400,550,550],id=0,MAXROCKS=20,ROCKS="m 104,7.69 c 23.68645,6.788715 36.31832,32.149873 60.26972,38.343289 22.5828,-0.437523 44.66378,16.533927 47.0145,39.571574 1.7824,16.350067 17.58775,28.375637 19.42957,45.557037 4.62232,16.14295 -3.063,34.92477 -18.79084,41.60093 -19.22063,12.27219 -23.97348,36.29633 -26.3595,57.32031 -11.7719,24.5963 -39.77913,35.95058 -65.41883,39.06789 -22.440402,-6.18345 -41.283826,10.88352 -61.241176,17.63584 -16.76045,5.45152 -33.113233,-7.47894 -38.530882,-22.80759 C 17.176622,247.87625 8.1464261,234.3236 4.0567839,218.40819 -1.7438181,195.92883 0.63774097,172.45364 4.606828,149.91669 6.1331829,124.03728 -5.926177,97.8685 3.3319943,72.406886 13.558278,40.415571 42.544211,19.463551 70.611984,3.7855478 81.374827,-1.0770344 94.740584,0.18536967 104,7.69 Z;m 74,7.61 c 7.753759,10.858255 23.659647,10.35574 34.20385,4.142701 9.03128,-4.0534436 19.21494,-1.9401962 28.52161,-5.0910648 10.92015,-2.154159 21.76622,-6.83507944 32.99101,-6.11838415 11.23296,2.00017155 13.66436,15.68926995 8.03436,24.21865495 -4.25358,10.809597 -16.56604,13.981888 -22.0997,23.735597 -7.53509,10.764739 -16.34633,24.503225 -31.127,24.468428 C 106.27572,72.548533 92.950913,91.727866 74.194294,88.144844 53.667818,82.293086 47.847944,55.910483 26.797923,50.69776 17.185894,50.719378 7.3060035,46.218346 3.1175923,37.113415 -2.8694247,26.930094 1.5394187,12.37286 13.030969,8.3968377 31.259956,1.4461437 53.349301,-4.6053888 71.463354,5.9051033 L 72.744026,6.7252875 74,7.61 Z;m 138.53,10.01 c 5.40626,19.802152 28.87853,18.911256 43.83272,26.459905 11.82989,11.386765 31.17305,17.630966 36.42803,33.950779 2.76543,19.624152 -17.99639,27.262955 -31.52942,35.447526 -20.56062,12.50938 -15.67798,41.22927 -31.85977,56.80308 -24.38514,18.96463 -57.192913,8.68832 -83.266997,-0.73605 C 52.576398,152.8614 28.041486,160.65945 11.190678,145.71557 -10.095375,129.9042 5.6556381,104.78632 23.486247,94.500663 41.288608,78.919071 45.241114,53.068768 63.439939,37.518779 81.853911,28.422426 88.100324,1.9971094 110.1991,-0.04794856 120.29646,0.14465668 131.88206,1.3566358 138.53,10.01 Z;m 72,0.6 c 14.992071,11.950867 27.356734,30.835777 49.0539,29.052927 22.54799,4.831198 11.23093,26.179505 10.66804,40.712681 1.29041,14.474071 22.7749,29.284722 9.00205,42.809722 -13.17549,7.38011 -25.84477,-13.04589 -39.91957,-2.56419 -15.021143,8.78534 -32.001234,23.92033 -50.515361,15.66927 C 35.997216,113.15938 16.127851,106.79857 2.1855691,94.383884 -1.9388697,76.898501 4.7466217,58.441952 0.18438048,40.73882 5.806309,19.339462 29.633649,12.251672 47.490222,3.9936009 55.293323,1.1777068 63.69706,-0.47426763 72,0.6 Z;m 92,3.55 c 13.35095,8.210786 30.00977,12.329972 45.29538,7.505902 14.45246,-1.6753573 32.50637,7.379137 33.3896,23.277674 -1.16698,9.619667 0.66069,19.077557 3.44222,28.233278 2.93882,9.916384 -2.53869,19.612559 -10.66892,25.090369 -8.67744,6.76962 -19.58996,11.562362 -25.09186,21.625407 C 122.19669,126.15279 96.416289,137.714 73.363004,129.22379 55.525476,120.88068 36.083637,114.55994 21.716964,100.47179 9.4202131,92.882312 -3.2620408,80.742356 -0.20756142,64.830795 2.5853742,21.920143 51.014336,-12.142371 92,3.55 Z;m 88,2.74 c 14.89109,15.864469 2.110781,42.020731 18.2397,57.227029 14.57912,9.438869 32.69928,18.10007 37.81781,36.219188 2.33267,12.551883 -4.98332,24.138463 -6.42804,36.406793 -5.71592,28.56302 -10.66403,58.58523 -28.18426,82.73461 C 98.325691,232.46357 84.01503,250.5467 63.256996,255.54156 49.213713,255.38464 40.958093,241.00245 40.126977,228.3937 37.959362,214.06608 35.463141,199.2234 26.80698,187.16906 15.184733,168.07566 -0.3727357,148.86285 0.4410242,125.2403 -0.82700464,113.95211 0.519549,101.14315 10.224845,93.729596 20.701913,83.99428 34.545443,79.406559 46.583369,72.066911 53.792512,51.74081 50.415478,26.382572 67.670781,10.611651 73.195023,5.947624 80.084933,-1.5559468 88,2.74 Z;m 70,4.85 c 42.89941,11.006942 88.6401,43.28005 90.08216,91.521071 4.22874,32.066519 -25.2289,52.095309 -32.77045,79.371239 3.64366,27.24689 -21.21346,30.54811 -41.778085,30.6541 -21.372431,4.1684 -46.503427,26.35806 -65.567673,4.77976 C 3.3962995,181.86073 43.409531,166.1283 54.968858,144.61803 66.594281,121.17951 24.886107,110.63839 36.541486,85.749591 36.788718,57.106427 1.9022922,43.643872 0.13121547,16.51475 11.628065,-9.165748 48.972608,0.09541228 70,4.85 Z;m 96,7.07 c 22.21936,-1.2748503 43.42137,10.625131 53.9089,30.272432 8.69197,19.332889 29.14037,36.901754 25.83445,59.413289 -7.95029,18.940209 -35.1644,24.545899 -28.70496,50.351999 -1.28406,21.10408 -27.33498,25.04775 -44.12503,26.41517 C 70.449544,167.8654 53.977736,135.08707 36.549008,110.65576 24.184423,92.2867 -4.119229,80.15006 -0.04494536,54.336438 2.2215288,30.459903 28.930966,27.401092 43.204026,13.183848 57.854593,-1.7401486 77.888088,-2.5989637 96,7.07 Z;m 22.83,10.14 c 36.381764,-7.5182231 75.332367,38.705706 106.91598,1.085856 31.19487,-26.154371 64.93771,4.569675 55.83452,40.417752 1.71024,59.468512 22.98507,123.885752 -7.35227,179.631272 -25.41621,20.31663 -58.99436,-0.0606 -86.820718,-3.84368 C 51.742324,218.90308 20.026502,183.63753 28.77643,141.9493 30.362924,107.69434 -3.8628827,84.245955 1.6335787,49.436507 3.2882936,34.68249 8.8431709,17.52641 22.83,10.14 Z;m 73.35,7.1 c 0.742924,12.833017 9.807449,30.172841 25.048008,26.528143 12.599832,-3.585974 26.310422,0.221493 34.295202,10.888176 7.73658,9.139649 12.54536,20.89596 23.4449,27.005137 11.57532,7.821056 24.58954,16.721939 27.19873,31.558114 5.2342,14.71903 7.51038,37.09103 -9.77698,44.67607 -13.80015,7.13307 -29.14257,-1.25293 -43.31614,3.72193 -15.15132,5.75741 -29.03507,-4.44612 -42.634543,-9.54349 -12.876028,-7.03738 -23.708035,3.30735 -33.940389,9.99189 -10.952691,7.628 -28.068654,3.85643 -32.543364,-9.34957 C 17.241811,131.38836 19.162764,117.59989 9.6636371,108.86755 0.15964236,94.112038 1.7097107,75.919244 1.8103437,59.24479 -0.3116275,44.692966 -3.0568617,24.567133 12.428846,16.257076 26.141799,8.6801814 39.824977,-3.1474859 56.644493,-0.08206564 62.578526,1.0293171 69.0122,2.5858262 73.35,7.1 Z;m 102,0.21 c 23.61326,-4.7742217 51.16121,11.73593 53.54307,36.69987 21.13119,18.005513 53.25206,4.662235 74.55944,23.311004 22.65735,16.804037 21.00815,47.485046 21.62736,72.671856 0.43306,30.01726 26.25312,58.22 12.89012,88.29914 -18.75656,25.83353 -53.60122,25.96862 -81.62681,34.04374 C 135.5408,265.27781 81.577228,270.66209 38.232192,244.33067 6.9293937,226.26954 -10.189513,184.12625 6.784637,150.71849 17.122164,118.96541 34.809642,84.588051 21.694586,50.963708 14.927939,28.153412 35.951375,8.3332141 57.118388,5.0589238 71.860142,2.3204637 86.957794,-0.28888751 102,0.21 Z;m 89.32,24.66 c 7.9625,5.588282 18.11069,11.432752 19.47608,22.040464 0.0713,11.380458 -5.26314,22.564982 -12.989602,30.768455 -7.782536,8.131695 -21.20007,14.120957 -31.758821,7.709676 C 57.730916,81.320978 51.834067,76.247376 44.226347,75.243966 32.970122,71.801274 22.789116,63.602609 18.590866,52.405008 13.675682,45.204443 1.8028657,40.50528 4.1280348,30.087205 6.0641439,21.282435 15.670301,17.787489 23.781595,18.047675 32.363214,18.899333 39.762362,14.27495 47.323866,11.057853 54.036138,10.011348 60.080345,6.7869695 66.94239,6.5239514 73.827745,6.2832858 79.992573,10.600531 83.027632,16.625433 84.923397,19.450903 86.872053,22.276379 89.32,24.66 Z".split(";"),
DEBRISCLOUD="M 304.95954,64.376304 C 277.49277,82.276003 241.66827,69.454477 211.41731,79.85341 182.94785,87.482512 151.97474,94.154867 123.11879,83.943747 95.48938,75.99336 66.651738,70.398968 37.484081,73.398842 18.970572,78.061107 -14.137683,61.027612 8.1795392,44.831273 35.781402,29.89724 66.869667,20.316467 97.592631,11.657888 162.57714,-6.6090419 236.65056,-0.9763699 294.31725,32.566319 c 15.15677,5.196271 26.61381,20.160102 10.64229,31.809985 z;m 342.60305,45.386961 c -7.29191,22.348261 -9.66643,46.973239 -30.70022,65.744569 -9.56291,8.46772 -25.11789,12.92218 -40.59786,11.98244 C 220.12739,123.1282 171.21545,103.90824 119.65346,111.45169 79.932518,115.72011 39.481042,104.62899 9.8413502,86.727358 -3.629765,72.850491 5.3001906,54.56609 20.913419,43.453167 39.272225,29.821382 66.622062,19.233063 94.387958,22.827131 144.87655,25.920022 198.72655,22.705697 242.49463,3.6247875 c 38.9784,-6.1384604 84.97751,7.9784805 98.78833,34.5910935 0.92712,2.352947 1.12743,4.748359 1.32009,7.17108 z M 98.348381,22.576575 l 0.55403,-0.173574 -0.55403,0.173574 z m 24.424669,1.147571 0.55403,-0.173574 -0.55403,0.173574 z m 28.00812,0.08717 0.55403,-0.173574 -0.55403,0.173574 z m 22.30992,-1.125739 0.55404,-0.173574 -0.55404,0.173574 z m 2.17138,-0.213036 0.55402,-0.173574 -0.55402,0.173574 z m 0.62445,-0.238469 0.55403,-0.173575 -0.55403,0.173575 z m 1.54695,0.02544 0.55403,-0.173574 -0.55403,0.173574 z m 14.92991,-3.236843 0.55404,-0.173569 -0.55404,0.173569 z m 6.37929,-1.511898 0.55401,-0.173565 -0.55401,0.173565 z M 237.86298,5.344172 238.417,5.1706024 237.86298,5.344172 Z;M 8.6920869,121.16887 C -4.1927589,98.966912 0.90898033,72.55157 8.7041909,49.662049 14.372638,35.476035 16.326584,18.502785 30.338869,8.681508 45.825701,-3.4131758 72.656091,-5.7614358 86.844372,9.2566296 97.590533,22.345836 117.873,25.584085 134.01661,19.956304 c 11.08514,-3.247312 20.45186,-9.79416 30.54262,-14.8525666 14.11297,-5.1505053 26.8782,7.2472106 29.23156,19.2600866 4.21484,11.498886 -1.06379,24.192355 6.41451,34.874819 7.62632,15.290163 20.05159,31.543452 14.34819,49.165577 -3.03505,13.5232 -12.4538,26.30757 -27.13751,30.91577 -13.91592,5.06137 -29.79779,3.4131 -43.10475,-2.40379 -17.36813,-4.34952 -33.14526,6.4165 -46.726747,14.86036 -14.840207,9.32885 -35.077152,16.24822 -52.087702,7.44298 -16.955592,-7.9194 -28.150179,-23.00607 -36.8043201,-38.05067 z;m 91.923226,127.78997 c 5.513731,11.3981 10.972854,25.51358 4.351499,37.62239 -7.54852,11.28418 -25.767729,9.59278 -33.334473,-0.81802 C 55.622193,157.05053 54.513378,146.07813 49.726705,137.18449 41.653771,125.15429 24.823594,120.63855 20.32487,105.94528 19.390228,97.039845 28.352819,92.306256 34.653598,88.093208 45.592211,81.790657 47.006891,67.243399 43.146197,56.335555 40.153404,45.98415 32.61561,38.046886 25.958609,29.920187 21.014609,18.807726 32.47462,6.8789866 43.555566,7.023595 52.328844,7.0126986 62.046398,10.741411 69.897324,4.9841051 78.99616,-0.10794813 86.373887,-10.091033 97.644393,-9.976946 c 13.469977,1.6211714 21.001927,14.9780158 24.779587,26.68591 4.09484,12.671839 4.09866,26.180141 7.02758,39.110388 1.46634,10.045348 -1.9205,22.178303 -12.13367,26.284736 -14.87769,7.426397 -27.334214,22.427262 -27.509921,39.622562 0.182575,2.25508 -0.171998,4.82307 2.115257,6.06332 z m -4.240826,-5.7236 c -2.796123,0.46537 0.642581,1.50828 0.72337,0.29222 l -0.72337,-0.29222 z;m 53.39,17 c 8.857468,18.680274 35.638969,29.655166 53.26768,16.552682 9.4851,-13.02633 29.26144,-21.688691 42.23907,-8.10085 13.3583,12.578881 11.1836,35.187026 -1.51894,47.443912 -9.14919,9.666576 -13.28816,23.915425 -6.58545,36.100486 5.44133,14.24364 14.35173,28.50153 11.97365,44.38173 5.07893,15.66617 -15.68191,32.3177 -29.44475,22.33028 C 110.6022,169.06652 93.829496,166.42587 87.217235,151.92188 78.379044,137.89166 83.963593,119.73027 74.402737,106.12243 65.827752,92.01835 48.203264,82.689295 31.783423,87.523944 18.33036,88.28596 11.389874,73.121866 13.520578,61.502437 15.481591,47.172531 -2.1632982,36.550726 4.0544615,21.982665 9.0812944,2.1611127 40.629477,-6.3421749 51.54838,12.953159 52.291692,14.237963 52.912978,15.594107 53.39,17 Z;m 53,28.01 c 17.264267,-0.215909 32.661816,-13.369626 50.21866,-9.082602 7.22749,2.514502 14.01831,10.390153 22.24021,5.672311 11.30763,-5.596745 17.32705,-20.2041726 30.88327,-21.3792418 11.63112,0.9015139 18.09339,12.3581728 24.16953,20.9111348 8.18578,10.112096 3.95736,25.007478 -5.15698,32.980017 -6.99113,8.003235 -17.51071,9.445625 -26.92735,12.360189 -14.16502,8.412284 -13.3072,30.629892 -29.93155,36.224342 -14.8311,-2.26076 -20.970578,-21.014783 -36.475878,-21.444488 -17.53188,0.713857 -29.193332,17.645528 -32.013793,33.593988 -1.961796,8.81551 0.354193,19.03046 -6.246545,26.36422 -5.430599,7.83687 -17.165422,10.68299 -24.881498,4.42654 C 4.9530851,138.95257 4.5896229,118.11427 12.893511,104.63532 19.137393,89.506979 26.037539,72.290072 19.933499,55.997969 17.518418,48.114476 9.4615578,44.674169 5.3905151,37.988065 -0.63100116,29.32318 -1.2186853,14.692506 9.3842495,9.2505971 18.552531,3.804272 28.646946,10.231493 35.097662,16.846668 40.328121,21.512442 45.748065,26.928689 53,28.01 Z;m 168.96,92 c -18.50703,19.38046 -3.01703,54.1903 23.95617,52.99453 19.19731,4.43402 27.75181,29.62521 13.24594,43.78213 -13.678,13.91986 -28.60684,33.36373 -50.94777,25.56722 C 132.89847,209.53592 117.2191,188.40609 92.738599,190.39623 73.511926,192.25447 46.474831,188.69238 45.221174,164.12611 47.858658,139.29003 19.45257,136.80785 5.4202307,126.69731 -4.7122326,101.49779 26.120786,90.455869 44.41309,85.144865 71.708322,72.249234 58.921776,45.204494 56.456307,23.773578 65.305726,5.2763567 90.435503,10.848472 106.49066,2.9345145 133.66834,-7.4060996 133.72447,31.035544 147.59229,43.624972 161.10873,55.504323 178.34631,72.281842 168.96,92 Z;m 183.99,21 c -5.56101,14.774238 -10.2477,33.563429 0.63641,47.120851 9.17136,8.95922 24.20153,3.674604 33.84782,12.312651 17.7844,11.961888 26.62799,33.887568 27.46098,54.728648 -0.88728,13.54567 -15.82829,20.54396 -28.00934,18.62906 -12.52223,-0.58085 -23.82537,-6.85871 -33.46056,-14.40887 -23.36253,-12.84254 -51.25219,-5.20342 -74.25967,4.51817 -14.904768,6.77899 -30.771017,14.6877 -47.650424,11.46214 C 50.281769,153.28514 41.539746,142.6497 29.150367,140.78095 18.214439,137.6825 4.4568112,135.09631 -0.33046599,123.26948 -2.0525657,107.0685 14.467061,96.197332 28.643924,93.886155 c 19.97782,-4.24195 40.661561,2.422228 60.514619,-2.233597 20.492967,-8.00363 29.015007,-30.475583 35.045477,-49.885401 2.45271,-13.03661 8.61197,-25.547868 19.48849,-33.5363126 9.51432,-8.26542468 25.89966,-12.0039348 35.33904,-1.6198311 C 182.64496,10.400522 184.68305,15.755864 183.99,21 Z;m 167,10.03 c 8.61332,11.733364 24.83887,11.186348 37.52164,7.864768 11.43633,-2.298219 24.04442,-5.736899 35.00002,0.08332 12.67268,14.243207 4.59387,35.94259 -7.70045,47.589028 -7.26252,9.015314 -19.05552,9.440288 -28.61213,14.415579 -15.38504,7.593175 -28.19142,23.270189 -46.67795,22.424269 -12.57735,-0.37299 -21.05597,-12.961046 -33.9889,-11.75122 -19.17926,-0.06631 -35.334555,22.20865 -26.387033,40.00049 4.126283,9.2659 17.003503,15.67229 13.998643,27.27996 -6.45663,11.01615 -21.675732,10.64774 -32.92803,11.22868 -10.935349,-0.9392 -16.018548,16.25838 -29.314738,13.65383 -21.53893,0.66305 -36.824707,-22.96858 -31.944453,-42.86518 2.364129,-13.52708 12.077562,-28.58683 3.573383,-41.761378 C 12.106522,91.199521 3.1288265,85.121422 1.7167286,73.903193 -4.6401612,48.365802 12.28966,16.672837 39.900312,13.991916 49.325716,12.840211 57.436875,19.235805 66.624607,20.478449 87.461898,25.968426 111.74653,22.670227 127.35394,6.7895446 138.74069,-3.5031337 156.70439,-0.14037568 167,10.03 Z".split(";");
function loadrock(b,e){var f,g,h=[],l;id=0;if("undefined"==typeof TEAMS[1].rocks||-1==TEAMS[1].rocks[2])TEAMS[1].rocks=[0,1,2];if("undefined"==typeof TEAMS[2].rocks||-1==TEAMS[2].rocks[2])TEAMS[2].rocks=[3,4,5];if(""!=e)for(g=e.split(";"),f=0;6>f;f++)l=g[f].split(","),h[f]=[parseInt(l[0],10),parseInt(l[1],10),parseInt(l[2],10)],4==l.length&&(3>f?TEAMS[1].rocks[f]=parseInt(l[3],10):TEAMS[2].rocks[f-3]=parseInt(l[3],10));else for(f=0;6>f;f++){do for(l=!0,h[f]=[400*Math.random()+300-PX[f],400*Math.random()+
300-PY[f],45*Math.random()],g=0;g<f;g++){var m=h[f][0]-h[g][0]+PX[f]-PX[g],q=h[f][0]-h[g][0]+PY[f]-PY[g];if(15E3>m*m+q*q){l=!1;break}}while(!l)}for(f=0;3>f;f++)OBSTACLES[f]=new Rock(TEAMS[1].rocks[f],h[f],TEAMS[1].rocks[f]>=MAXROCKS,1,f),OBSTACLES[f+3]=new Rock(TEAMS[2].rocks[f],h[f+3],TEAMS[2].rocks[f]>=MAXROCKS,2,f)}function saverock(){if(0==OBSTACLES.length)return"";for(var b=OBSTACLES[0].toASCII(),e=1;6>e;e++)b+=";"+OBSTACLES[e].toASCII();return b}
function Rock(b,e,f,g){g=f-1+g;this.o=[];this.type=b>=MAXROCKS?DEBRIS:ROCK;this.id=b;this.name=(b>=MAXROCKS?"Debris #":"Asteroid #")+g;this.arraypts=[];this.dragged=!1;this.tx=e[0];this.ty=e[1];this.alpha=e[2];PATTERN=s.image(b>=MAXROCKS?DEBRISIMG:ROCKIMG,0,0,256,256).pattern(0,0,256,256);var h=b>=MAXROCKS?DEBRISCLOUD:ROCKS;this.inside=s.path(h[b%MAXROCKS]).attr({fill:PATTERN,strokeWidth:0,stroke:"#888","class":"ASTEROID"+f});this.outline=s.path(h[b%MAXROCKS]).attr({fill:"rgba(0,0,0,0)",strokeWidth:2,
stroke:"#888"});this.g=s.group(this.outline,this.inside);for(f=0;f<this.outline.getTotalLength();f+=5)this.arraypts.push(this.outline.getPointAtLength(f));0==REPLAY.length&&this.addDrag();this.path="";this.outlinepts=[];this.g.hover(function(){this.outline.attr({strokeWidth:6,stroke:"#F00"})}.bind(this),function(){this.outline.attr({strokeWidth:2,stroke:"#888"})}.bind(this));this.g.addClass("unit");h=this.g.getBBox();this.o=[];var l=.27;b>=MAXROCKS&&(l=.4);b%=MAXROCKS;for(f=1;4>f;f++)this.o[f]=s.ellipse(h.x+
h.width/2,h.y+h.height/2,200/l/2*f+h.width/2,200/l/2*f+h.height/2).attr({pointerEvents:"none",display:"none",fill:WHITE,opacity:.3,strokeWidth:2});this.m=(new Snap.Matrix).translate(e[0]+PX[g],e[1]+PY[g]).rotate(e[2],0,0).scale(l,l);this.getOutlineString();this.show()}
Rock.prototype={addDrag:function(){this.g.drag(this.dragmove.bind(this),this.dragstart.bind(this),this.dragstop.bind(this))},unDrag:function(){this.g.undrag()},getBall:function(){var b=this.g.getBBox();return{x:b.x+b.width/2,y:b.y+b.height/2,diam:Math.max(b.width/2,b.height/2)}},toASCII:function(){return Math.floor(this.tx)+","+Math.floor(this.ty)+","+Math.floor(this.alpha)+","+this.id},getrangeallunits:function(){return Unit.prototype.getrangeallunits.call(this)},getrange:function(b){return Unit.prototype.getrange.call(this,
b)},gethitrangeallunits:function(){return[[],[],[],[]]},togglehitsector:function(){},togglerange:function(){},getOutlinePoints:function(){var b;this.outlinepts=[];for(b=0;b<this.arraypts.length;b+=5)this.outlinepts.push(transformPoint(this.m,this.arraypts[b]));return this.outlinepts},getBox:function(){},getOutline:function(){var b=s.path(this.path);b.appendTo(s);return b},getOutlineString:function(){var b;this.getOutlinePoints();this.path="M ";for(b=0;b<this.outlinepts.length;b++){var e=this.outlinepts[b];
this.path+=e.x+" "+e.y+" ";0==b&&(this.path+="L ")}this.path+="Z";return{s:this.path,p:this.outlinepts}},turn:function(b){this.m.add(MR(b,0,0));this.alpha+=b;this.show()},unselect:function(){},select:function(){if(phase==SETUP_PHASE){var b=activeunit;activeunit=this;b.unselect();this.showpanel()}},showpanel:function(){Unit.prototype.showpanel.call(this)},dragmove:function(b,e,f,g){Unit.prototype.dragmove.call(this,b,e,f,g)},dragstart:function(b,e,f){var g=activeunit;activeunit=this;g.unselect();Unit.prototype.dragstart.call(this,
b,e,f);this.dragshow()},dragshow:function(){for(var b=1;4>b;b++)this.o[b].transform(this.dragMatrix).attr({display:"block"}).appendTo(VIEWPORT);this.g.transform(this.dragMatrix);this.g.appendTo(VIEWPORT)},showhitsector:function(){},dragstop:function(b){for(var e=1;4>e;e++)this.o[e].attr({display:"none"});Unit.prototype.dragstop.call(this,b)},show:function(){this.g.transform(this.m);this.g.appendTo(VIEWPORT)},setclickhandler:function(b){this.g.unmousedown();this.g.mousedown(b)},setdefaultclickhandler:function(){this.g.unmousedown();
this.g.mousedown(function(){this.select()}.bind(this))}};var V1="v1",V2="v2",CURRENT_DECK=V2;function Critical(b,e){this.lethal=!1;$.extend(this,CRITICAL_DECK[e]);this.no=this.name+e;b.criticals.push(this);this.isactive=!1;this.unit=b}
Critical.prototype={toString:function(){var b;if(!this.isactive)return"";var e=this.name;"undefined"!=typeof CRIT_translation[this.name].name&&(e=CRIT_translation[this.name].name);b="<td class='tdstat'>"+e+"</td>";e="";"undefined"!=typeof CRIT_translation[this.name].text&&(e=formatstring(CRIT_translation[this.name].text));d="<td class='tooltip outoverflow'>"+e+"</td>";return 1==this.unit.team?"<tr >"+b+"<td><code class='Criticalupg upgrades'></code></td>"+d+"</tr>":"<tr ><td><code class='Criticalupg upgrades'></code></td>"+
b+d+"</tr>"},log:function(){this.unit.log("Critical: %0",this.name);var b;"undefined"!=typeof CRIT_translation[this.name].text?(b=formatstring(CRIT_translation[this.name].text),log("<ul><li>"+b+"</li></ul>")):log("no translation:"+this.name)}};
var CRITICAL_DECK=[{type:"ship",count:2,name:"Structural Damage",version:[V2],faceup:function(){this.log();this.isactive=!0;this.unit.wrap_after("getagility",this,function(b){return 0<b?b-1:b})},facedown:function(){this.isactive&&(this.unit.getagility.unwrap(this),this.unit.log("%0 repaired",this.name),this.unit.showstats());this.isactive=!1},action:function(b){var e=this.unit.rollattackdie(1,this,"hit")[0];"hit"==e||"critical"==e?this.facedown():this.unit.log("%0 not repaired",this.name);this.unit.endaction(b,
"CRITICAL")}},{type:"ship",count:2,name:"Structural Damage (original)",version:[V1],faceup:function(){this.log();this.isactive=!0;this.unit.wrap_after("getagility",this,function(b){return 0<b?b-1:b})},facedown:function(){this.isactive&&(this.unit.getagility.unwrap(this),this.unit.log("%0 repaired",this.name),this.unit.showstats());this.isactive=!1},action:function(b){"hit"==this.unit.rollattackdie(1,this,"hit")[0]?this.facedown():this.unit.log("%0 not repaired",this.name);this.unit.endaction(b,"CRITICAL")}},
{type:"ship",name:"Damaged Engine",version:[V1,V2],count:2,faceup:function(){this.log();this.isactive=!0;var b=[];this.unit.wrap_after("getdial",this,function(e){if(0==b.length)for(var f=0;f<e.length;f++)b[f]={move:e[f].move,difficulty:e[f].difficulty},e[f].move.match(/TL\d|TR\d/)&&(b[f].difficulty="RED");return b})},facedown:function(){this.isactive&&this.unit.getdial.unwrap(this);this.isactive=!1}},{type:"ship",name:"Console Fire",count:2,version:[V1,V2],lethal:!0,faceup:function(){var b=this;this.log();
this.isactive=!0;this.unit.wrap_before("begincombatphase",this,function(){"hit"==this.rollattackdie(1,b,"blank")[0]&&(this.log("+1 %HIT% [%0]",this.name),this.resolvehit(1),this.checkdead())})},action:function(b){this.facedown();this.unit.endaction(b,"CRITICAL")},facedown:function(){this.isactive&&(this.unit.log("%0 repaired",this.name),this.unit.begincombatphase.unwrap(this));this.isactive=!1}},{type:"ship",count:2,name:"Weapon Malfunction",version:[V1],faceup:function(){this.log();this.isactive=
!0;for(var b=0;b<this.unit.weapons.length&&!this.unit.weapons[b].isprimary;b++);this.w=b;this.unit.weapons[b].wrap_after("getattack",this,function(b){return 0<b?b-1:b})},facedown:function(){this.isactive&&(this.unit.weapons[this.w].getattack.unwrap(this),this.unit.log("%0 repaired",this.unit.weapons[this.w].name),this.isactive=!1)},action:function(b){var e=this.unit.rollattackdie(1,this,"hit")[0];"critical"==e||"hit"==e?this.facedown():this.unit.log("%0 not repaired",this.name);this.unit.endaction(b,
"CRITICAL")}},{type:"ship",count:2,name:"Damaged Sensor Array (original)",version:[V1],faceup:function(){this.log();this.isactive=!0;this.unit.wrap_after("getactionbarlist",this,function(){return[]})},facedown:function(){this.isactive&&(this.unit.getactionbarlist.unwrap(this),this.unit.log("%0 repaired",this.name),this.isactive=!1)},action:function(b){"hit"==this.unit.rollattackdie(1,this,"hit")[0]?this.facedown():this.unit.log("%0 not repaired",this.name);this.unit.endaction(b,"CRITICAL")}},{type:"ship",
count:2,name:"Damaged Sensor Array",version:[V2],faceup:function(){this.log();this.isactive=!0;this.unit.wrap_after("getactionbarlist",this,function(){return[]})},facedown:function(){this.isactive&&(this.unit.getactionbarlist.unwrap(this),this.unit.log("%0 repaired",this.name),this.isactive=!1)},action:function(b){var e=this.unit.rollattackdie(1,this,"hit")[0];"hit"==e||"critical"==e?this.facedown():this.unit.log("%0 not repaired",this.name);this.unit.endaction(b,"CRITICAL")}},{name:"Minor Explosion",
count:2,type:"ship",lethal:!0,version:[V1],faceup:function(){this.log();var b=this.unit.rollattackdie(1,this,"blank")[0];this.isactive=!1;"hit"==b&&this.unit.removehull(1)},facedown:function(){this.isactive=!1}},{name:"Thrust Control Fire",count:2,version:[V1,V2],type:"ship",faceup:function(){this.log();this.unit.addstress();this.isactive=!1},facedown:function(){this.isactive=!1}},{name:"Direct Hit!",count:7,version:[V1,V2],type:"ship",lethal:!0,faceup:function(){this.log();this.unit.removehull(1)},
facedown:function(){this.isactive=!1;this.unit.hull++}},{name:"Munitions Failure",count:2,type:"ship",version:[V1],lethal:!0,faceup:function(){this.log();var b=[];for(i=0;i<this.unit.weapons.length;i++)this.unit.weapons[i].issecondary&&b.push(this.unit.weapons[i]);this.isactive=!1;if(0!=b.length){var e=this.unit.rand(b.length);this.wp=b[e];this.wp.isactive=!1;this.unit.log(this.wp.name+" not functioning anymore");this.unit.show()}},facedown:function(){this.isactive=!1}},{name:"Minor Hull Breach",
count:2,type:"ship",lethal:!0,version:[V1],faceup:function(){var b=this;this.log();this.isactive=!0;this.hd=this.unit.handledifficulty;this.unit.wrap_after("handledifficulty",this,function(e){"hit"==this.rollattackdie(1,b,"blank")[0]&&"RED"==e&&(this.log("+1 %HIT% [%0]",b.name),this.removehull(1))})},facedown:function(){this.isactive&&(this.unit.handledifficulty.unwrap(this),this.isactive=!1,this.unit.log("%0 repaired",this.name))}},{name:"Damaged Cockpit",count:2,type:"pilot",version:[V1,V2],faceup:function(){var b=
this;this.log();this.isactive=!0;this.unit.wrap_before("endround",this,function(){this.wrap_after("getskill",b,function(){return 0});filltabskill();this.showstats()}.bind(this.unit))},facedown:function(){this.isactive&&(this.isactive=!1,this.unit.getskill.unwrap(this),filltabskill(),this.unit.showstats())}},{name:"Blinded Pilot",count:2,version:[V1,V2],type:"pilot",faceup:function(){var b=this;this.log();this.isactive=!0;this.unit.wrap_after("getattackstrength",this,function(e,f,g){this.getattackstrength.unwrap(b);
b.isactive=!1;return 0})},facedown:function(){this.isactive=!1}},{name:"Injured Pilot",count:2,type:"pilot",lethal:!0,version:[V1],faceup:function(){this.log();var b;this.isactive=!0;for(b=0;b<this.unit.upgrades.length;b++){var e=this.unit.upgrades[b];e.type==ELITE&&e.desactivate()}this.unit.desactivate();this.unit.show()},facedown:function(){if(this.isactive){var b;"undefined"!=typeof this.unit.init&&this.unit.init();for(b=0;b<this.unit.upgrades.length;b++){var e=this.unit.upgrades[b];e.type==ELITE&&
(e.isactive=!0,"undefined"!=typeof e.init&&e.init(this.unit))}this.unit.show()}this.isactive=!1}},{name:"Stunned Pilot",count:2,version:[V1,V2],type:"pilot",lethal:!0,faceup:function(){var b=this;this.log();this.isactive=!0;this.unit.wrap_before("resolvecollision",this,function(){this.log("+1 %HIT% [%0]",b.name);this.resolvehit(1)});this.unit.wrap_before("resolveocollision",this,function(){this.log("+1 %HIT% [%0]",b.name);this.resolvehit(1)})},facedown:function(){this.isactive&&(this.unit.unwrap("resolvecollision",
this),this.unit.unwrap("resolveocollision",this),this.unit.log("no longer stunned"));this.isactive=!1}},{name:"Loose Stabilizer",count:2,type:"ship",faceup:function(){this.log();this.isactive=!0;this.unit.wrap_after("handledifficulty",this,function(b){"WHITE"==b&&this.addstress()})},facedown:function(){this.isactive&&(this.unit.handledifficulty.unwrap(this),this.unit.log("%0 repaired",this.name));this.isactive=!1},action:function(b){this.facedown();this.unit.endaction(b,"CRITICAL")},version:[V2]},
{name:"Major Explosion",count:2,type:"ship",lethal:!0,faceup:function(){this.log();"hit"==this.unit.rollattackdie(1,this,"blank")[0]&&(this.unit.log("+1 %CRIT% [%0]",this.name),this.unit.resolvecritical(1));this.isactive=!1},facedown:function(){},version:[V2]},{name:"Major Hull Breach",count:2,type:"ship",lethal:!0,version:[V2],faceup:function(){var b=round;this.log();this.isactive=!0;this.unit.wrap_after("deal",this,function(e,f,g){if(round==b)return g;var h=$.Deferred();g.done(function(b){b.face=
FACEUP;h.resolve(b)});return h.promise()})},facedown:function(){this.isactive&&this.unit.deal.unwrap(this);this.isactive=!1},action:function(b){this.facedown();this.unit.endaction(b,"CRITICAL")}},{name:"Shaken Pilot",count:2,type:"pilot",faceup:function(){this.log();this.isactive=!0;var b=[],e=this;this.unit.wrap_after("getdial",this,function(e){if(0==b.length)for(var f=0;f<e.length;f++)e[f].move.match(/F1|F2|F3|F4|F5/)||b.push({move:e[f].move,difficulty:e[f].difficulty});return b});this.unit.wrap_after("timeformaneuver",
this,function(b){b&&!this.hasionizationeffect()&&e.facedown();return b})},facedown:function(){this.isactive&&(this.isactive=!1,this.unit.getdial.unwrap(this),this.unit.timeformaneuver.unwrap(this))},version:[V2]},{name:"Weapons Failure",count:2,type:"ship",faceup:function(){for(var b in this.weapons)this.weapons[b].wrap_after("getattack",this,function(b){return 0<b?b-1:b})},facedown:function(){for(var b in this.weapons)this.weapons[b].getattack.unwrap(this)},action:function(b){var e=this.unit.rollattackdie(1,
this,"hit")[0];"hit"==e||"critical"==e?this.facedown():this.unit.log("%0 not repaired",this.name);this.unit.endaction(b,"CRITICAL")},version:[V2]}];var FAST=!1,s,BLACK="#111",GREEN="#0F0",RED="#F00",WHITE="#FFF",BLUE="#0AF",YELLOW="#FF0",GREY="#888",HALFBLACK="#222",HALFGREEN="#080",HALFRED="#800",HALFWHITE="#888",HALFBLUE="#058",HALFYELLOW="#880",HALFGREY="#444",TIMEANIM=FAST?0:1E3,FACE=["focus","hit","critical","evade","blank"],ATTACKDICE=[0,0,1,1,1,2,4,4],DEFENSEDICE=[0,0,3,3,3,4,4,4],MPOS={F0:[0,3],F1:[1,3],F2:[2,3],F3:[3,3],F4:[4,3],F5:[5,3],BL1:[1,2],BL2:[2,2],BL3:[3,2],TL1:[1,1],TL2:[2,1],TL3:[3,1],BR1:[1,4],BR2:[2,4],BR3:[3,4],TR1:[1,
5],TR2:[2,5],TR3:[3,5],K1:[1,7],K2:[2,7],K3:[3,7],K4:[4,7],K5:[5,7],SL2:[2,0],SL3:[3,0],SR2:[2,6],SR3:[3,6],TRL3:[3,0],TRR3:[3,6],TRL2:[2,0],TRR2:[2,6]},REBEL="REBEL",EMPIRE="EMPIRE",SCUM="SCUM",ILLICIT="Illicit",ELITE="Elite",TURRET="Turret",MISSILE="Missile",ASTROMECH="Astromech",TORPEDO="Torpedo",CANNON="Cannon",BOMB="Bomb",TECH="Tech",CREW="Crew",SYSTEM="System",SALVAGED="Salvaged",MOD="Mod",TITLE="Title",ROCK="Rock",DEBRIS="Debris",NONE="None",NOLOG=!1,generics=[],gid=0,REROLL_M=0,ADD_M=1,MOD_M=
2,ATTACK_M=0,DEFENSE_M=1,ATTACKCOMPARE_M=2,FACEUP=1,FACEDOWN=2,DISCARD=0,xws_lookup=function(b){for(var e in PILOT_dict)if(PILOT_dict[e]==b)return e;return""},upg_lookup=function(b){for(var e in UPGRADE_dict)if(UPGRADE_dict[e]==b)return e;return""},activeunit,unitlist,pilotlist,squadron=[],active=0,globalid=1,targetunit,PATTERN,SOUND_DIR="ogg/",SOUND_FILES="cloak_romulan decloak_romulan EXPLODE3 KX9_laser_cannon TIE-Fire Slave1-Guns Falcon-Guns XWing-Fly1 TIE-Fly2 Slave1-Fly1 Falcon-Fly1 Falcon-Fly3 YWing-Fly2 ISD-Fly missile XWing-Fly2 DStar-Gun4 TIE-Fly6 Slave1-Fly2 ghost".split(" "),
SOUNDS={},SOUND_NAMES="cloak decloak explode xwing_fire tie_fire slave_fire falcon_fire xwing_fly tie_fly slave_fly falcon_fly yt2400_fly ywing_fly isd_fly missile xwing2_fly dstar_gun tie2_fly slave2_fly ghost".split(" ");
function loadsound(){var b,e,f={explode:2,cloak:0,decloak:1};for(b=0;b<squadron.length;b++)for(f[squadron[b].ship.firesnd]=SOUND_NAMES.indexOf(squadron[b].ship.firesnd),-1==SOUND_NAMES.indexOf(squadron[b].ship.firesnd)&&console.log("cannot find fire sound for "+squadron[b].ship.firesnd+"/"+squadron[b].ship.name),f[squadron[b].ship.flysnd]=SOUND_NAMES.indexOf(squadron[b].ship.flysnd),-1==SOUND_NAMES.indexOf(squadron[b].ship.flysnd)&&console.log("cannot find sound for "+squadron[b].ship.flysnd+"/"+
squadron[b].ship.name),e=1;e<squadron[b].weapons.length;e++)f[squadron[b].weapons[e].firesnd]=SOUND_NAMES.indexOf(squadron[b].weapons[e].firesnd),-1==SOUND_NAMES.indexOf(squadron[b].weapons[e].firesnd)&&console.log("cannot find fire sound for "+squadron[b].weapons[e].firesnd+"/"+squadron[b].weapons[e].name);for(b in f)SOUNDS[b]=new Howl({urls:[SOUND_DIR+SOUND_FILES[f[b]]+".ogg",SOUND_DIR+SOUND_FILES[f[b]]+".m4a",SOUND_DIR+SOUND_FILES[f[b]]+".wav"],autoplay:!1,loop:!1})}
function transformPoint(b,e){return{x:e.x*b.a+e.y*b.c+b.e,y:e.x*b.b+e.y*b.d+b.f}}function halftone(b){return b==GREEN?HALFGREEN:b==RED?HALFRED:b==WHITE?HALFWHITE:b==BLUE?HALFBLUE:b==YELLOW?HALFYELLOW:b==GREY?HALFGREY:b}
var MS=function(b,e){return(new Snap.Matrix).scale(b,e)},MT=function(b,e){return(new Snap.Matrix).translate(b,e)},MR=function(b,e,f){return(new Snap.Matrix).rotate(b,e,f)},C={GREEN:"#0F0",RED:"#F00",WHITE:"#FFF"},P,A={ARCROTATE:{key:"R",color:GREEN},ROLL:{key:"r",color:GREEN},SLAM:{key:"s",color:BLUE},FOCUS:{key:"f",color:GREEN},TARGET:{key:"l",color:BLUE},EVADE:{key:"e",color:GREEN},BOOST:{key:"b",color:GREEN},STRESS:{key:"?",color:RED},CLOAK:{key:"k",color:BLUE},ISTARGETED:{key:"l",color:RED},ASTROMECH:{key:"A",
color:YELLOW},CANNON:{key:"C",color:YELLOW},CREW:{key:"W",color:YELLOW},MISSILE:{key:"M",color:YELLOW},TORPEDO:{key:"P",color:YELLOW},ELITE:{key:"E",color:YELLOW},TURRET:{key:"U",color:YELLOW},UPGRADE:{key:"S",color:YELLOW},CRITICAL:{key:"c",color:RED},SALVAGED:{key:"V",color:YELLOW},BOMB:{key:"B",color:YELLOW},TITLE:{key:"t",color:YELLOW},MOD:{key:"m",color:YELLOW},SYSTEM:{key:"S",color:YELLOW},ILLICIT:{key:"I",color:YELLOW},LASER:{key:"%",color:RED},TURRETLASER:{key:"$",color:RED},BILASER:{key:"<",
color:RED},MOBILELASER:{key:"<",color:RED},LASER180:{key:">",color:RED},NOTHING:{key:"&nbsp;",color:WHITE},HIT:{key:"d",color:WHITE},SHIELD:{key:"v",color:YELLOW},TECH:{key:"X",color:WHITE}},AINDEX="ROLL FOCUS TARGET EVADE BOOST STRESS CLOAK ISTARGETED ASTRO CANNON CREW MISSILE TORPEDO ELITE TURRET UPGRADE CRITICAL NOTHING".split(" ");function repeat(b,e){if(1>e)return"";for(var f="";1<e;)e&1&&(f+=b),e>>=1,b+=b;return f+b}function dist(b,e){return(b.x-e.x)*(b.x-e.x)+(b.y-e.y)*(b.y-e.y)}
function Unit(b,e){var f;this.isdocked=this.dead=!1;this.ship={};this.id=gid;this.life=1;this.arcrotation=180;this.wrapping=[];var g=this.id;generics["u"+gid]=this;gid++;this.maxupg=[];this.exclupg=[];this.team=b;this.faction=TEAMS[b].faction;this.shipactionList=[];this.dial=[];this.ordnance=!1;this.dialselect="<table class='dial' id='dial"+g+"'></table>";this.text="<span id='text"+g+"' class='details'></span>";this.upgradesno=0;this.upgrades=[];this.criticals=[];this.DEFENSEREROLLD=[];this.ATTACKREROLLA=
[];this.ATTACKMODA=[];this.ATTACKADD=[];this.DEFENSEMODD=[];this.DEFENSEADD=[];this.tx=this.ty=this.alpha=0;if("undefined"==typeof PILOTS[e])this.error("pilot does not exists "+e);else{g=unitlist[PILOTS[e].unit];this.ship={shield:g.shield,hull:g.hull,firesnd:g.firesnd,flysnd:g.flysnd,name:PILOTS[e].unit,hastitle:g.hastitle};"undefined"==typeof PILOTS[e].shipimg?(f=g.faction.indexOf(this.faction),-1==f&&(f=0),this.shipimg=g.img[f]):this.shipimg=PILOTS[e].shipimg;this.scale=g.scale;this.islarge=1==
g.islarge?!0:!1;this.hull=g.hull;this.shield=g.shield;this.agility=g.evade;this.hasmobilearc="Mobilelaser"==g.weapon_type;for(f=0;f<g.dial.length;f++)this.dial[f]={move:g.dial[f].move,difficulty:g.dial[f].difficulty};this.shipactionList=g.actionList.slice(0);this.weapons=[];this.upgrades=[];this.criticals=[];this.bombs=[];this.lastdrop=-1;Laser(this,g.weapon_type,g.fire);this.name=PILOTS[e].name;this.pilotid=e;this.unique=1==PILOTS[e].unique?!0:!1;this.skill=PILOTS[e].skill;this.install="undefined"!=
typeof PILOTS[e].install?PILOTS[e].install:function(){};this.uninstall="undefined"!=typeof PILOTS[e].uninstall?PILOTS[e].uninstall:function(){};g=PILOTS[e].upgrades;this.upg=[];this.upgbonus=[];for(j=0;10>j;j++)this.upg[j]=-1;this.upgradetype=[];for(k=0;k<g.length;k++)this.upgradetype[k]=g[k];this.upgradetype[k++]=MOD;unitlist[this.ship.name].hastitle&&(this.upgradetype[k++]=TITLE);this.upgradesno=k;this.points=PILOTS[e].points;this.install(this);TEAMS[this.team].updatepoints()}}
Unit.prototype={tosquadron:function(b){var e,f=this.upg;this.activeweapon=this.usedweapon=this.addedattack2=this.noattack=this.addedattack=-1;this.touching=[];this.action=this.maneuver=-1;this.actionsdone=[];this.hasdecloaked=this.hasmoved=!1;this.tractorbeam=this.focus=this.reroll=0;this.lastmaneuver=-1;this.iscloaked=!1;this.istargeted=[];this.targeting=[];this.hasfired=this.evade=this.ionized=this.stress=0;this.maxfired=1;this.criticalresolved=this.hitresolved=0;this.m=new Snap.Matrix;this.collision=
!1;this.oldoverlap=-1;this.ocollision={overlap:-1,template:[],mine:[]};var g=[];for(e in f)-1<f[e]&&g.push(Upgradefromid(this,f[e]));this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;e=this.shipimg;this.islarge?this.img="undefined"==typeof e?b.text(0,0,this.ship.code).transform("r -90 0 0 "+("EMPIRE"==this.faction||"SCUM"==this.faction?"s 2 -2":"s 2 2")+"t -15 5").attr({"class":"xwingship"}):b.image("png/"+this.shipimg,-50*this.scale,-50*this.scale,100*this.scale,100*this.scale).transform("r 90 0 0"):
("undefined"!=typeof this.shipimg&&(e=this.shipimg),this.img="undefined"==typeof e?b.text(-10,10,this.ship.code).transform("r -90 0 0 "+("EMPIRE"==this.faction||"SCUM"==this.faction?"r -1 1":"")).attr({"class":"xwingship"}):b.image("png/"+e,-20*this.scale,-20*this.scale,40*this.scale,40*this.scale).transform("r 90 0 0").attr({pointerEvents:"none"}));this.imgsmoke=b.image("png/smoke.gif",-20,-60,30,50).transform("r 180 0 0").attr({display:"none"});this.imgflame=b.image("png/out.gif",-15,-40,20,40).transform("r 180 0 0").attr({display:"none"});
f=this.islarge?40:20;this.outline=b.rect(-f,-f,2*f,2*f).attr({fill:"rgba(8,8,8,0.5)",strokeWidth:2});this.border=b.rect(-f,-f,2*f,2*f).attr({fill:"rgba(0,0,0,0)",strokeWidth:2,stroke:halftone(this.color)});this.tohitstats={};this.tohit=b.text(-f,f-30,"0").attr({"class":"tohit",strokeWidth:1});this.meanhit=b.text(-f,f-15,"0").attr({"class":"tohit",strokeWidth:1});this.meanhitsymbol=b.text(-f+40,f-15,"0").attr({"class":"symbols",strokeWidth:0,text:"d"});this.meancrit=b.text(-f,f,"0").attr({"class":"tohit",
strokeWidth:1});this.meancritsymbol=b.text(-f+40,f,"0").attr({"class":"symbols",strokeWidth:0,text:"c"});this.gproba=b.group(this.tohit,this.meanhit,this.meanhitsymbol,this.meancrit,this.meancritsymbol).attr({display:"none",fontSize:"15",stroke:"#fff",fill:"#fff",opacity:1});this.skillbar=b.text(1-f,3-f,repeat("u",this.skill)).transform("r -90 0 0").attr({"class":"xsymbols",fill:"#fa0"});this.firebar=b.text(1-f,5-f,repeat("u",this.weapons[0].attack)).transform("r -90 0 0").attr({"class":"xsymbols",
fill:"#f00"});this.evadebar=b.text(1-f,7-f,repeat("u",this.agility)).transform("r -90 0 0").attr({"class":"xsymbols",fill:"#0f0"});this.hullbar=b.text(1-f,9-f,repeat("u",this.hull)).transform("r -90 0 0").attr({"class":"xsymbols",fill:"#cc0"});this.shieldbar=b.text(1-f,9-f,repeat("u",this.shield+this.hull)).transform("r -90 0 0").attr({"class":"xsymbols",fill:"#0af"});this.gstat=b.group(this.skillbar,this.firebar,this.evadebar,this.shieldbar,this.hullbar,this.gproba).attr({pointerEvents:"none"});
this.dialspeed=b.text(2+f,3-f,"").attr({"class":"dialspeed",pointerEvents:"none"});this.dialdirection=b.text(f+8,3-f,"").attr({"class":"symbols",pointerEvents:"none"});this.actionicon=b.text(f+2,-7,"").attr({pointerEvents:"none","class":"symbols",strokeWidth:0});this.sector=b.polygon(3-f,-f,0,0,f-3,-f).attr({fill:this.color,opacity:.5,strokeWidth:0});this.ranges=[];this.sectors=[];this.infoicon=[];for(e=0;6>e;e++)this.infoicon[e]=b.text(f-7,6-f+7*e,A[AINDEX[e+2]].key).attr({pointerEvents:"none","class":"xsymbols",
fill:A[AINDEX[e+2]].color,strokeWidth:0});this.geffect=b.group(this.imgflame,this.imgsmoke).attr({pointerEvents:"none"});this.g=b.group(this.sector,this.outline,this.img,this.border,this.dialspeed,this.dialdirection,this.actionicon,this.infoicon[0],this.infoicon[1],this.infoicon[2],this.infoicon[3],this.infoicon[4],this.infoicon[5],this.gstat);VIEWPORT.add(this.g);VIEWPORT.add(this.geffect);this.g.addClass("unit");this.g.hover(function(){this.setinfo(translate(this.name))}.bind(this),function(){$(".info").hide()}.bind(this));
this.setdefaultclickhandler();this.upgrades.sort(function(b,e){var f=(b.isWeapon()?4:0)+(b.isBomb()?1:0);return(e.isWeapon()?4:0)+(e.isBomb()?1:0)-f});this.g.drag(this.dragmove.bind(this),this.dragstart.bind(this),this.dragstop.bind(this))},setinfo:function(b){var e=VIEWPORT.m.clone(),f=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>f?l=(g-f)/2:h=(f-g)/2;var m=Math.max(900/f,900/g),q=this.g.getBBox(),f=$("#svgout").offset();$("#playmat").width();$("#playmat").height();g=e.x(q.x,q.y-20)/m;
g+=f.left+h;e=e.y(q.x,q.y-20)/m;e+=f.top+l;return $(".info").css({left:g,top:e}).attr({pointerEvents:"none"}).html(formatstring(b)).appendTo("body").show()},wrap_after:function(b,e,f,g){var h=this,l=h[b];"undefined"==typeof h[b].save&&this!=Bomb.prototype&&this!=Unit.prototype&&this!=Weapon.prototype&&(h[b].save=h.__proto__[b]);"undefined"==typeof l&&console.log("name"+b+" undefined");var m=function(){var b=Array.prototype.slice.call(arguments),e;e=l.apply(this,b);return e=f.apply(this,b.concat([e]))};
m.save=l;m.org=e;"undefined"==typeof e.wrapping&&(e.wrapping=[]);e.wrapping.push({name:b,wrap:this});m.vanilla="undefined"!=typeof l.vanilla?l.vanilla:l;m.unwrapper=function(b){var f=h.wrap_before(b,e,function(b){m.unwrap(e);f.unwrap(e);h.show();return b})};l.next=m;m.unwrap=function(e){if(m.org==e)return m.save.next=m.next,"undefined"==typeof m.next&&(h[b]=m.save),"getskill"==b&&filltabskill(),h.show(),m.save;"function"==typeof m.save.unwrap&&(m.save=m.save.unwrap(e));h.show();return m};this[b]=
m;"getskill"==b&&filltabskill();return m},desactivate:function(){for(var b in this.wrapping){var e=this.wrapping[b];"function"==typeof e.wrap[e.name].unwrap&&e.wrap[e.name].unwrap(this)}this.isactive=!1},wrap_before:function(b,e,f,g){var h=this,l=h[b];"undefined"==typeof h[b].save&&this!=Bomb.prototype&&this!=Unit.prototype&&this!=Weapon.prototype&&(h[b].save=h.__proto__[b]);"undefined"==typeof l&&console.log("name"+b+" undefined");var m=function(){var b=Array.prototype.slice.call(arguments);f.apply(this,
b);return l.apply(this,b)};m.save=l;m.org=e;"undefined"==typeof l&&console.error("org:"+e.name+" "+b);"undefined"==typeof e.wrapping&&(e.wrapping=[]);e.wrapping.push({name:b,wrap:this});m.vanilla="undefined"!=typeof l.vanilla?l.vanilla:l;m.unwrapper=function(b){var f=h.wrap_before(b,e,function(){m.unwrap(e);f.unwrap(e);h.show()})};l.next=m;m.unwrap=function(e){if(m.org==e)return m.save.next=m.next,"undefined"==typeof m.next&&(h[b]=m.save),h.show(),m.save;"function"==typeof m.save.unwrap&&(m.save=
m.save.unwrap(e));return m};return this[b]=m},toJSON:function(){var b={};b.name=xws_lookup(this.name);b.points=PILOTS[this.pilotid].points;b.ship=xws_lookup(this.ship.name);for(var e={},f={},g=0;g<this.upg.length;g++){var h=this.upg[g];if(-1<h&&"undefined"!=typeof h){var l=UPGRADES[h];"undefined"==typeof e[upg_lookup(l.type)]&&(e[upg_lookup(l.type)]=[]);b.points+=l.points;if("undefined"!=typeof UPGRADES[h].pointsupg)for(var m=0;m<UPGRADES[h].upgrades.length;m++)f[UPGRADES[h].upgrades[m]]=UPGRADES[h].pointsupg;
e[upg_lookup(l.type)].push(upg_lookup(l.name))}}for(g=0;g<this.upg.length;g++)h=this.upg[g],-1<h&&"undefined"!=typeof h&&"undefined"!=typeof f[UPGRADES[h].type]&&(l=f[UPGRADES[h].type],b.points=0<UPGRADES[h].points+l?b.points+l:b.points-UPGRADES[h].points);this.points=b.points;b.upgrades=e;return b},toJuggler:function(b){var e=this.name;1==b&&(e=translate(this.name));e=e.replace(/\'/g,"");1==PILOTS[this.pilotid].ambiguous&&"undefined"!=typeof PILOTS[this.pilotid].edition&&(e=e+"("+PILOTS[this.pilotid].edition+
")");for(var f=0;f<this.upg.length;f++){var g=this.upg[f];if(-1<g){var h=UPGRADES[g].name;1==b&&(h=translate(UPGRADES[g].name));e+=" + "+h.replace(/\(Crew\)/g,"").replace(/\'/g,"")}}return e},toASCII:function(){for(var b=this.pilotid,e=0;e<this.upgrades.length;e++){var f=this.upgrades[e].id;-1<f&&(b+=","+f)}return b+=":"+Math.floor(this.tx)+","+Math.floor(this.ty)+","+Math.floor(this.alpha)},toKey:function(){for(var b=("00"+this.pilotid.toString(32)).slice(-2),e=[],f=0;f<this.upg.length;f++)-1<this.upg[f]&&
e.push(this.upg[f]);e.sort();for(f=0;f<e.length;f++)b+=("00"+e[f].toString(32)).slice(-2);return b},toString2:function(){var b=PILOTS[this.pilotid].dict;1==PILOTS[this.pilotid].ambiguous&&"undefined"!=typeof PILOTS[this.pilotid].edition&&(b+="-"+PILOTS[this.pilotid].edition.toLowerCase().replace(" ",""));var e=SHIP_translation[this.ship.name];"undefined"==typeof SHIP_translation[this.ship.name]&&(e=this.ship.name);return Mustache.render(TEMPLATES["unit-creation"],{imgname:b,faction:currentteam.faction,
skill:this.getskill(),name:translate(this.name),points:this.points,unique:1==PILOTS[this.pilotid].unique?!1:!0,id:this.id,evade:this.agility,hull:this.hull,shield:this.shield,fire:this.weapons[0].getattack(),shipimg:this.shipimg,diallist:dial2JSON(this.getdial()),shipname:e,actionstring:this.getactionstring(),upgradeaddstring:this.getupgradeaddstring()})},setpriority:function(b){var e={FOCUS:3,EVADE:1,CLOAK:4,TARGET:2,CRITICAL:100}[b.type];"undefined"==typeof e&&(e=0);b.priority=e;e=[];"BOOST"==b.type&&
(e=this.getboostmatrix(this.m));"ROLL"==b.type&&(e=this.getrollmatrix(this.m));if(0<e.length){var f=this.m,g=this.evaluateposition(),h=g-1;for(i=0;i<e.length;i++)this.m=e[i],h=Math.max(h,this.evaluateposition());this.m=f;h>g&&(b.priority=2*(h-g))}},getstatstring:function(){var b;b=""+("<div class='xsymbols RED'>"+repeat("u",this.weapons[0].getattack())+"</div>");b+="<div class='xsymbols GREEN'>"+repeat("u",this.getagility())+"</div>";b+="<div class='xsymbols YELLOW'>"+repeat("u",this.hull)+"</div>";
return b+="<div class='xsymbols BLUE'>"+repeat("u",this.shield)+"</div>"},getupgradeaddstring:function(){for(var b="",e=0;e<this.upgradetype.length;e++)-1==this.upg[e]&&(b+="<button num="+e+" class='upgrades "+this.upgradetype[e].replace(/\|/g,"")+"'>+</button>");return b},showskill_old:function(){$("#unit"+this.id+" .statskill").html(this.getskill())},showupgradeadd:function(){$("#unit"+this.id+" .upgavail").html(this.getupgradeaddstring());addupgradeaddhandler(this)},getagility:function(){return phase==
COMBAT_PHASE?this.agility-this.tractorbeam:this.agility},getskill:function(){return this.skill},getdial:function(){return this.hasionizationeffect()?[{move:"F1",difficulty:"WHITE"}]:this.dial},doplan:function(){this.showdial();return this.deferred},getdialstring:function(){var b=[],e="";for(j=0;5>=j;j++)for(b[j]=[],k=0;7>=k;k++)b[j][k]="<td></td>";var f=this.getdial();for(j=0;j<f.length;j++)d=f[j],b[MPOS[d.move][0]][MPOS[d.move][1]]="<td class='symbols "+d.difficulty+"' move='"+d.move+"'>"+P[d.move].key+
"</td>";for(j=5;0<=j;j--){e+="<tr>";e=0<j&&5>j?e+("<td>"+j+"</td>"):e+"<td></td>";for(k=0;7>=k;k++)e+=b[j][k];e+="</tr>\n"}return e},canreveal:function(b){return"RED"!=b.difficulty||0==this.stress},showdial:function(){var b=[],e,f,g=this.getdial();if(phase==PLANNING_PHASE||phase==SELECT_PHASE||phase==CREATION_PHASE){for(e=0;5>=e;e++)for(b[e]=[],f=0;7>=f;f++)b[e][f]="<td></td>";$("#select"+this.id).val();for(e=0;e<g.length;e++){f=g[e];var h=MPOS[f.move][0],l=MPOS[f.move][1];this.canreveal(f)?(b[h][l]=
"<td",phase==PLANNING_PHASE&&(b[h][l]+=" onclick='activeunit.setmaneuver("+e+")'"),b[h][l]+=" class='symbols maneuver "+f.difficulty,this.maneuver==e&&(b[h][l]+=" selected"),b[h][l]+="' >"+P[f.move].key+"</td>"):b[h][l]="<td></td>"}g="";for(e=5;0<=e;e--){g+="<tr>";g=0<e&&5>e?g+("<td>"+e+"</td>"):g+"<td></td>";for(f=0;7>=f;f++)g+=b[e][f];g+="</tr>\n"}phase==SELECT_PHASE||phase==CREATION_PHASE?$("#dial"+this.id).html(g):$("#maneuverdial").html(g)}phase>=PLANNING_PHASE&&(-1==this.maneuver||this.hasmoved)&&
this.clearmaneuver()},getupgradelist:function(b){for(var e=[],f=0;f<UPGRADES.length;f++){var g=UPGRADES[f];if(!("undefined"!=typeof g.faction&&g.faction!=this.faction||"undefined"!=typeof g.ship&&-1==this.ship.name.search(g.ship)||"undefined"!=typeof g.ishuge||"undefined"!=typeof g.islarge&&this.islarge!=g.islarge||"undefined"!=typeof g.skillmin&&this.getskill()<g.skillmin||"undefined"!=typeof g.agilitymax&&this.getagility()>=g.agilitymax||"undefined"!=typeof g.noupgrades&&-1<this.upgradetype.indexOf(g.noupgrades)||
"undefined"!=typeof g.actionrequired&&-1==this.shipactionList.indexOf(g.actionrequired.toUpperCase())||"undefined"!=typeof this.maxupg[g.type]&&this.maxupg[g.type]<g.points)){if("undefined"!=typeof g.requiredupg){for(var h=!0,l=0;l<g.requiredupg.length;l++)if(-1==this.upgradetype.indexOf(g.requiredupg[l])){h=!1;break}if(!h)continue}!b.match(g.type)||1==g.takesdouble&&this.upgradetype.indexOf(g.type)==this.upgradetype.lastIndexOf(g.type)||e.push(f)}}e.sort(function(b,e){return translate(UPGRADES[b].name)>
translate(UPGRADES[e].name)});return e},turn:function(b){this.alpha+=b;this.m.rotate(b,0,0);this.show()},getactionstring:function(){for(var b="",e=0;e<this.shipactionList.length;e++)b+="<span class='GREEN symbols'>"+A[this.shipactionList[e]].key+"</span>&nbsp;";return b},showactionlist:function(){var b=this.getactionstring();$("#unit"+this.id+" .actionlist").html(b)},getattacktable:function(b){return ATTACK[b]},attackroll:function(b){var e,f,g,h,l=this.getattacktable(b),m=0,q=Math.random();if(0==
b)return 0;for(f=0;f<=b;f++)for(g=0;g<=b-f;g++)for(h=0;h<=b-f-g;h++)if(e=f*FCH_FOCUS+g+FCH_CRIT*h,m+=l[e],m>q)return FCH_FOCUS*f+h*FCH_CRIT+g;return 0},confirm:function(b){return confirm(b)},rollattackdie:function(b,e,f){e=[];for(f=0;f<b;f++)e.push(FACE[ATTACKDICE[this.rand(8)]]);return e},rolldefensedie:function(b,e,f){e=[];for(f=0;f<b;f++)e.push(FACE[DEFENSEDICE[this.rand(8)]]);return e},rand:function(b){return Math.floor(Math.random()*b)},getdefensetable:function(b){return DEFENSE[b]},defenseroll:function(b){var e,
f,g,h=$.Deferred(),l=this.getdefensetable(b),m=0,q=Math.random();if(0==b)return h.resolve({dice:b,roll:0}).promise();"undefined"==typeof l&&this.error("P undefined for n="+b);for(g=0;g<=b;g++)for(f=0;f<=b-g;f++)if(e=g*FE_FOCUS+f*FE_EVADE,m+=l[e],m>q)return h.resolve({dice:b,roll:FE_FOCUS*g+f*FE_EVADE}).promise();return h.resolve({dice:b,roll:0}).promise()},getdicemodifiers:function(){return[{from:ATTACK_M,type:MOD_M,to:ATTACK_M,org:this,req:function(){return this.canusefocus()}.bind(this),aiactivate:function(b,
e){return 0<FCH_focus(b)},f:function(b,e){this.removefocustoken();var f=FCH_focus(b);0<f&&(b=b-FCH_FOCUS*f+FCH_HIT*f);return b}.bind(this),str:"focus",token:!0,noreroll:"focus"},{from:ATTACK_M,type:REROLL_M,to:ATTACK_M,org:this,req:function(b,e,f){return this.canusetarget(f)}.bind(this),n:function(){return 9},dice:["blank","focus"],f:function(){activeunit.removetarget(targetunit)},str:"target",token:!0},{from:DEFENSE_M,type:MOD_M,to:DEFENSE_M,org:this,req:function(){return this.canusefocus()}.bind(this),
aiactivate:function(b,e){mm=getattackvalue();return 0<FE_focus(b)&&FCH_hit(mm)+FCH_crit(mm)>FE_evade(b)},f:function(b,e){this.removefocustoken();var f=FE_focus(b);0<f&&(b=b-FE_FOCUS*f+FE_EVADE*f);return b}.bind(this),str:"focus",token:!0},{from:DEFENSE_M,type:ADD_M,to:DEFENSE_M,org:this,req:function(){return this.canuseevade()}.bind(this),aiactivate:function(b,e){mm=getattackvalue();return FCH_hit(mm)+FCH_crit(mm)>FE_evade(b)},f:function(b,e){this.removeevadetoken();return{m:b+FE_EVADE,n:e+1}}.bind(this),
str:"evade",token:!0,noreroll:"focus"}]},adddicemodifier:function(b,e,f,g,h){h.org=g;h.type=e;h.from=b;h.to=f;this.wrap_after("getdicemodifiers",g,function(b){return b.concat(h)})},setclickhandler:function(b){this.g.unmousedown();this.g.mousedown(b)},setdefaultclickhandler:function(){this.g.unmousedown();this.g.mousedown(function(){this.select()}.bind(this))},dragshow:function(){this.g.transform(this.dragMatrix);this.geffect.transform(this.dragMatrix)},dragmove:function(b,e,f,g){f=VIEWPORT.m.split();
g=Math.max(900/$("#svgout").width(),900/$("#svgout").height());b=b*g/f.scalex;e=e*g/f.scalex;this.dragMatrix=MT(b,e).add(this.m);this.dx=b;this.dy=e;this.dragged=!0;$(".phasepanel").hide();this.dragshow()},dragstart:function(b,e,f){this.showhitsector(!1);this.dragMatrix=this.m;this.dragged=!1},dragstop:function(b){this.dragged&&(this.m=this.dragMatrix,this.showpanel(),this.tx+=this.dx,this.ty+=this.dy);this.dragged=!1},isinzone:function(b){b=this.getOutlinePoints(b);var e,f;e=SETUPS.playzone;for(f=
0;4>f;f++)if(!Snap.path.isPointInside(e,b[f].x,b[f].y))return!1;return!0},getOutlinePoints:function(b){var e=this.islarge?40:20;"undefined"==typeof b&&(b=this.m);return[{x:b.x(-e,-e),y:b.y(-e,-e)},{x:b.x(e,-e),y:b.y(e,-e)},{x:b.x(e,e),y:b.y(e,e)},{x:b.x(-e,e),y:b.y(-e,e)}]},getOutlineString:function(b){b=this.getOutlinePoints(b);return{s:"M "+b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y+" "+b[2].x+" "+b[2].y+" "+b[3].x+" "+b[3].y+" Z",p:b}},getOutline:function(b){var e=this.islarge?40:20,f=s.rect(-e,
-e,2*e,2*e),e=s.text(e+8,3-e,"8").attr({"class":"symbols",fontSize:"1.3em"});return s.g(e,f).transform(b).attr({fill:this.color,opacity:.3,display:"none"})},getRangePoints:function(b,e){var f=this.islarge?40:20;return $.map([{x:-f,y:-100*b-f},{x:f,y:-100*b-f},{x:100*b+f,y:-f},{x:100*b+f,y:f},{x:f,y:100*b+f},{x:-f,y:100*b+f},{x:-100*b-f,y:f},{x:-100*b-f,y:-f}],function(b,f){return transformPoint(e,b)})},getHalfRangePoints:function(b,e){var f=this.islarge?40:20;return $.map([{x:100*b+f,y:0},{x:100*
b+f,y:-f},{x:f,y:-100*b-f},{x:-f,y:-100*b-f},{x:-100*b-f,y:-f},{x:-100*b-f,y:0}],function(b,f){return transformPoint(e,b)})},getRangeString:function(b,e){var f=" A "+100*b+" "+100*b+" 0 0 1 ",g=this.getRangePoints(b,e);return"M "+g[1].x+" "+g[1].y+f+g[2].x+" "+g[2].y+" L "+g[3].x+" "+g[3].y+f+g[4].x+" "+g[4].y+" L "+g[5].x+" "+g[5].y+f+g[6].x+" "+g[6].y+" L "+g[7].x+" "+g[7].y+f+g[0].x+" "+g[0].y+" Z"},getHalfRangeString:function(b,e){var f=" A "+100*b+" "+100*b+" 0 0 0 ",g=this.getHalfRangePoints(b,
e);return"M "+g[0].x+" "+g[0].y+" L "+g[1].x+" "+g[1].y+f+g[2].x+" "+g[2].y+" L "+g[3].x+" "+g[3].y+f+g[4].x+" "+g[4].y+" L "+g[5].x+" "+g[5].y+" Z"},getSubRangeString:function(b,e,f){var g=" A "+100*b+" "+100*b+" 0 0 1 ";b=this.getRangePoints(b,f);var h="M "+b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y+g+b[2].x+" "+b[2].y+" L "+b[3].x+" "+b[3].y+g+b[4].x+" "+b[4].y+" L "+b[5].x+" "+b[5].y+g+b[6].x+" "+b[6].y+" L "+b[7].x+" "+b[7].y+g+b[0].x+" "+b[0].y,g=" A "+100*e+" "+100*e+" 0 0 0 ";b=this.getRangePoints(e,
f);return h+=" L "+b[0].x+" "+b[0].y+g+b[7].x+" "+b[7].y+" L "+b[6].x+" "+b[6].y+g+b[5].x+" "+b[5].y+" L "+b[4].x+" "+b[4].y+g+b[3].x+" "+b[3].y+" L "+b[2].x+" "+b[2].y+g+b[1].x+" "+b[1].y+" L "+b[0].x+" "+b[0].y},getHalfSubRangeString:function(b,e,f){var g=" A "+100*b+" "+100*b+" 0 0 0 ";b=this.getHalfRangePoints(b,f);var h="M "+b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y+g+b[2].x+" "+b[2].y+" L "+b[3].x+" "+b[3].y+g+b[4].x+" "+b[4].y+" L "+b[5].x+" "+b[5].y,g=" A "+100*e+" "+100*e+" 0 0 1 ";b=this.getHalfRangePoints(e,
f);return h+=" L "+b[5].x+" "+b[5].y+" L "+b[4].x+" "+b[4].y+g+b[3].x+" "+b[3].y+" L "+b[2].x+" "+b[2].y+g+b[1].x+" "+b[1].y+" L "+b[0].x+" "+b[0].y+" Z"},getPrimarySectorString:function(b,e){var f;f=this.getSectorPoints(b,e);var g=" A "+100*b+" "+100*b+" 0 0 1 ",h=transformPoint(e,{x:0,y:0});return"M "+h.x+" "+h.y+" L "+f[0].x+" "+f[0].y+g+f[1].x+" "+f[1].y+" L "+f[2].x+" "+f[2].y+g+f[3].x+" "+f[3].y+" Z"},getPrimarySubSectorString:function(b,e,f){var g=" A "+100*b+" "+100*b+" 0 0 1 ";b=this.getSectorPoints(b,
f);var h="M "+b[0].x+" "+b[0].y+g+b[1].x+" "+b[1].y+" L "+b[2].x+" "+b[2].y+g+b[3].x+" "+b[3].y;b=this.getSectorPoints(e,f);g=" A "+100*e+" "+100*e+" 0 0 0 ";return h+="L "+b[3].x+" "+b[3].y+g+b[2].x+" "+b[2].y+" L "+b[1].x+" "+b[1].y+g+b[0].x+" "+b[0].y+" Z"},getSectorPoints:function(b,e){var f=this.islarge?40:20;if(this.hasmobilearc)return this.getQuarterSectorPoints(b,e);var g=Math.sqrt((f-3)*(f-3)+f*f);return $.map([{x:-(g+100*b)/Math.sqrt(1+f*f/(f-3)/(f-3)),y:-(g+100*b)/Math.sqrt(1+(f-3)*(f-
3)/f/f)},{x:-f+3,y:-f-100*b-1},{x:f-3,y:-f-100*b-1},{x:(g+100*b)/Math.sqrt(1+f*f/(f-3)/(f-3)),y:-(g+2+100*b)/Math.sqrt(1+(f-3)*(f-3)/f/f)}],function(b,f){return transformPoint(e,b)})},getQuarterSectorPoints:function(b,e){var f=this.islarge?40:20,g=Math.sqrt(2),h=g*f;return $.map([{x:-(h+100*b)/g,y:-(h+100*b)/g},{x:-f,y:-f-100*b},{x:f,y:-f-100*b},{x:(h+100*b)/g,y:-(h+100*b)/g}],function(b,f){return transformPoint(e,b)})},setmaneuver:function(b){this.lastmaneuver=this.maneuver;this.maneuver=b;this.showdial();
this.showmaneuver();"undefined"==typeof this.deferred&&this.error("undefined deferred");nextplanning()},select:function(){if(this.dead||this.isdocked)return activeunit;if(phase<ACTIVATION_PHASE||phase==ACTIVATION_PHASE||phase==COMBAT_PHASE){var b=activeunit;activeunit=this;b!=this&&b.unselect();$("#"+this.id).addClass("selected");this.show();center(this)}return activeunit},unselect:function(){this!=activeunit&&($("#"+this.id).removeClass("selected"),this.showoutline(),this.showmaneuver())},getmcollisions:function(b){var e,
f,g=[];e=this.getOutlineString(b);b=e.s;f=e.p;for(e=0;e<OBSTACLES.length;e++)if(OBSTACLES[e].type!=NONE){var h=OBSTACLES[e].getOutlineString();if(OBSTACLES[e].type==BOMB&&(0<Snap.path.intersection(h.s,b).length||this.isPointInside(h.s,f)||this.isPointInside(b,h.p))){g.push(e);break}}return g},getBall:function(b){return{x:b.x(0,0),y:b.y(0,0),diam:this.islarge?56:28}},guessevades:function(b,e){var f=function(f){f==FE_evade(b.roll)&&(this.log("guessed correctly ! +1 %EVADE% [%0]",self.name),b.roll+=
FE_EVADE,b.dice+=1);$("#actiondial").empty();e.resolve(b)}.bind(this);this.log("guess the number of evades out of %0 dice [%1]",b.dice,self.name);$("#actiondial").empty();for(var g=0;g<=b.dice;g++)(function(b){var e=$("<button>").html(b+" <code class='xevadetoken'></code>").on("touch click",function(){f(b)}.bind(this));$("#actiondial").append(e)}).call(this,g)},fastgetocollisions:function(b,e,f,g){var h,l=[],m=this.getBall(e);if("undefined"==typeof f&&(h=b.invert(),f=e.x(0,0),g=e.y(0,0),e=h.x(f,g),
h=h.y(f,g),f=s.path("M 0 0 L "+e+" "+h).appendTo(VIEWPORT).attr({display:"none"}),g=f.getTotalLength(),0==g))return!1;for(e=h=0;h<=g;h+=g/5,e++){var q=f.getPointAtLength(h);l[e]={x:b.x(q.x,q.y),y:b.y(q.x,q.y)}}for(e=0;e<OBSTACLES.length;e++)if(OBSTACLES[e].type!=BOMB&&OBSTACLES[e].type!=NONE){b=OBSTACLES[e].getBall();h=b.diam+m.diam;f=h*h;if((b.x-m.x)*(b.x-m.x)+(b.y-m.y)*(b.y-m.y)<f)return!0;for(h=0;h<l.length;h++)if((b.x-l[h].x)*(b.x-l[h].x)+(b.y-l[h].y)*(b.y-l[h].y)<f)return!0}return!1},getocollisions:function(b,
e,f,g){var h,l=[],m,q={overlap:-1,template:[],mine:[]};e=this.getOutlineString(e);h=e.s;m=e.p;for(e=0;e<OBSTACLES.length;e++){var v=OBSTACLES[e];if(v.type!=NONE){var w=v.getOutlineString();(0<Snap.path.intersection(w.s,h).length||this.isPointInside(w.s,m)||this.isPointInside(h,w.p))&&this.oldoverlap!=e&&(v.type!=BOMB?q.overlap=e:q.mine.push(v))}}if("undefined"!=typeof f){for(e=h=0;h<=g;h+=5,e++)v=f.getPointAtLength(h),l[e]={x:b.x(v.x,v.y),y:b.y(v.x,v.y)};for(b=0;b<l.length;b++)for(e=0;e<OBSTACLES.length;e++)if(v=
OBSTACLES[e],v.type!=NONE&&e!=q.overlap&&e!=this.oldoverlap&&-1==q.template.indexOf(e)&&-1==q.mine.indexOf(v))for(f=v.getOutlineString().p,h=0;h<f.length;h++)if(g=f[h].x-l[b].x,m=f[h].y-l[b].y,100>=g*g+m*m){v.type!=BOMB?q.template.push(e):q.mine.push(OBSTACLES[e]);break}}return q},iscollidingunit:function(b,e){var f=this.getOutlineString(b).s,g=e.getOutlineString(e.m).s,h=0<Snap.path.intersection(f,g).length;this.islarge&&(h=h||this.isinoutline(f,e,e.m));e.islarge&&(h=h||e.isinoutline(g,this,b));
return h},getcollidingunits:function(b){var e,f=[];for(e in squadron){var g=squadron[e];g!=this&&this.iscollidingunit(b,g)&&f.push(g)}return f},getpathmatrix:function(b,e){var f=P[e].path,g=f.getTotalLength();this.islarge&&(g+=40);g=this.getmatrixwithmove(b,f,g);e.match(/K\d|SR\d|SL\d/)&&g.rotate(180,0,0);e.match(/TRL\d/)&&g.rotate(-90,0,0);e.match(/TRR\d/)&&g.rotate(90,0,0);f.remove();return g},getmovecolor:function(b,e,f,g,h,l){var m,q=!1;if(!this.isinzone(b))return RED;f&&(f=this.ocollision,this.ocollision=
this.getocollisions(this.m,b,g,h),this.hascollidedobstacle()&&(q=!0),this.ocollision=f);if(q)return YELLOW;if(e)for(m in e=this.getOutlineString(b),this.getskill(),squadron)if(g=squadron[m],g!=this&&(b=l?g.futurem:g.m,b=g.getOutlineString(b),0<Snap.path.intersection(b.s,e.s).length||this.islarge&&!g.islarge&&this.isPointInside(e.s,b.p)||!this.islarge&&g.islarge&&this.isPointInside(b.s,e.p)))return WHITE;return GREEN},isTurret:function(b){return"Turretlaser"==b.type},candoactivation:function(){return-1!=
this.maneuver},candoroll:function(){for(var b=this.getrollmatrix(this.m),e=!1,f=this.canmoveonobstacles("ROLL"),g=0;g<b.length;g++)var h=this.getmovecolor(b[g],!0,!0),e=e||h==GREEN||h==YELLOW&&f;return e},candoboost:function(){for(var b=this.getboostmatrix(this.m),e=!1,f=this.canmoveonobstacles("BOOST"),g=0;g<b.length;g++)var h=this.getmovecolor(b[g],!0,!0),e=e||h==GREEN||h==YELLOW&&f;return e},newaction:function(b,e){return{action:b,org:this,type:e,name:e}},getactionbarlist:function(b){var e,f=[];
for(e=0;e<this.shipactionList.length;e++){var g=this.shipactionList[e];if(!this.isactiondone(g))switch(g){case "CLOAK":this.candocloak()&&f.push(this.newaction(this.addcloak,"CLOAK"));break;case "FOCUS":this.candofocus()&&f.push(this.newaction(this.addfocus,"FOCUS"));break;case "EVADE":this.candoevade()&&f.push(this.newaction(this.addevade,"EVADE"));break;case "TARGET":this.candotarget()&&f.push(this.newaction(this.resolvetarget,"TARGET"));break;case "ARCROTATE":this.candoarcrotate()&&f.push(this.newaction(this.resolvearcrotate,
"ARCROTATE"));break;case "BOOST":this.candoboost()&&f.push(this.newaction(this.resolveboost,"BOOST"));break;case "ROLL":this.candoroll()&&f.push(this.newaction(this.resolveroll,"ROLL"));break;case "SLAM":b&&f.push(this.newaction(this.resolveslam,"SLAM"))}}return f},getupgactionlist:function(){var b,e=[];for(b=0;b<this.upgrades.length;b++){var f=this.upgrades[b];!this.isactiondone(f.name)&&f.isactive&&"function"==typeof f.action&&f.candoaction()&&e.push({org:f,action:f.action,type:f.type.toUpperCase(),
name:f.name});!this.isactiondone(f.name+"/2")&&f.isactive&&"function"==typeof f.action2&&f.candoaction2()&&e.push({org:f,action:f.action2,type:f.type.toUpperCase(),name:f.name+"/2"})}return e},getcritactionlist:function(){var b,e=[];for(b=0;b<this.criticals.length;b++){var f=this.criticals[b];!this.isactiondone(f.name)&&f.isactive&&"function"==typeof f.action&&(f.type="CRITICAL",f.org=f,e.push(f))}return e},getactionlist:function(b){b=this.getactionbarlist(b);var e=this.getupgactionlist(),f=this.getcritactionlist();
return b.concat(e).concat(f)},addevadetoken:function(){this.evade++;this.animateaddtoken("xevadetoken");this.movelog("E");this.show()},addevade:function(b){this.addevadetoken();this.endaction(b,"EVADE")},addfocustoken:function(){this.focus++;this.animateaddtoken("xfocustoken");this.movelog("FO");this.show()},addtractorbeam:function(b){this.addtractorbeamtoken();if(1==this.tractorbeam&&!this.islarge){var e=this.m;p=Unit.prototype.getrollmatrix.call(this,this.m).concat(this.getpathmatrix(this.m,"F1"));
b.doselection(function(f){b.resolveactionmove.call(this,p,function(b,h){b.ocollision=b.getocollisions(e,p[h]);b.endnoaction(f,"BOOST")},!0,!0)}.bind(this))}},addtractorbeamtoken:function(){this.tractorbeam++;this.animateaddtoken("xtractorbeamtoken");this.movelog("TB");this.show()},removetractorbeamtoken:function(){this.tractorbeam--;this.animateremovetoken("xtractorbeamtoken");this.movelog("tb");this.show()},addfocus:function(b){this.addfocustoken();this.endaction(b,"FOCUS")},addstress:function(){this.stress++;
this.animateaddtoken("xstresstoken");this.movelog("ST");this.show()},addiontoken:function(){this.ionized++;this.animateaddtoken("xionizedtoken");this.movelog("I");this.show()},removeiontoken:function(){this.ionized--;this.animateremovetoken("xionizedtoken");this.movelog("i");this.show()},warndeath:function(b,e,f){},dies:function(){this.movelog("d-0");$("#"+this.id).attr("onclick","");$("#"+this.id).addClass("dead");$("#"+this.id).html(""+this);$("#"+this.id+" .outoverflow").each(function(b){"auto"!=
$(this).css("top")&&$(this).css("top",$(this).parent().offset().top+"px")});i=squadron.indexOf(this);for(i in squadron)squadron[i]==this?delete squadron[i]:squadron[i].team==this.team&&squadron[i].warndeath(this.hull,this.shield,this);filltabskill();for(i=0;i<this.targeting.length;i++){var b=this.targeting[i];n=b.istargeted.indexOf(this);-1<n&&b.istargeted.splice(n,1);b.show()}for(i=0;i<this.istargeted.length;i++)b=this.istargeted[i],n=b.targeting.indexOf(this),-1<n&&b.targeting.splice(n,1),b.show();
this.targeting=[];this.g.attr({display:"none"});this.imgsmoke.attr("display","none");this.imgflame.attr("display","none");this.imgexplosion=this.islarge?s.image("png/explosion3.gif",-80,-80,160,160):s.image("png/explosion3.gif#"+Math.random(),-40,-40,80,80);this.geffect.add(this.imgexplosion);this.show();FAST||SOUNDS.explode.play();this.dead=!0;this.log("has exploded!");setTimeout(function(){this.geffect.attr({display:"none"});this.show();TEAMS[this.team].checkdead()&&win(this.team)}.bind(this),FAST?
0:1E3)},canbedestroyed:function(){return skillturn!=this.getskill()?!0:!1},checkdead:function(){if(!this.dead&&(0>=this.hull||!this.isinzone(this.m))){this.dies();var b=TEAMS[this.team].history.rawdata;"undefined"==typeof b[round]&&(b[round]={hits:0,dead:""});b[round].dead+=this.name+" ";return!0}return!1},cancelhit:function(b,e){var f=FCH_hit(b.ch);return f>=b.e?{ch:b.ch-b.e*FCH_HIT,e:0}:{ch:b.ch-f*FCH_HIT,e:b.e-f}},cancelcritical:function(b,e){var f=FCH_crit(b.ch);return f>=b.e?{ch:b.ch-b.e*FCH_CRIT,
e:0}:{ch:b.ch-f*FCH_CRIT,e:b.e-f}},evadeattack:function(b){var e=getdefenseresult(),f=getattackresult();displayattackroll(getattackdice(),f);e=this.cancelhit({ch:f,e:e},b);e=this.cancelcritical(e,b);"undefined"==typeof e&&this.error("undefined cancel critical");return e.ch},declareattack:function(b,e){targetunit=e;this.activeweapon=b;if(this.weapons[b].declareattack(e))return this.log("attacks %0 with %1",e.name,this.weapons[b].name),e.isattackedby(b,this),!0;this.log("cannot attack %0 [%1]",e.name,
this.weapons[b].name);return!1},isattackedby:function(b,e){},modifydamageassigned:function(b,e){return b},modifydefenseroll:function(b,e,f){return e},modifyattackroll:function(b,e,f){return b},resolveishit:function(){},hashit:function(b){return 0<this.criticalresolved+this.hitresolved},resolvedamage:function(){$(".fireline").remove();FAST||this.playfiresnd();var b=targetunit.evadeattack(this),b=this.weapons[this.activeweapon].modifydamageassigned(b,targetunit),b=targetunit.modifydamageassigned(b,
this);TEAMS[this.team].allred+=getattackdice();TEAMS[targetunit.team].allgreen+=getdefensedice();TEAMS[this.team].allhits+=FCH_hit(b);TEAMS[this.team].allcrits+=FCH_crit(b);TEAMS[targetunit.team].allevade+=FE_evade(getdefenseresult());var e=FCH_crit(b),f=FCH_hit(b);this.hasdamaged=!0;this.hitresolved=f;this.criticalresolved=e;this.hashit(targetunit)&&(targetunit.resolveishit(this),this.weapons[this.activeweapon].prehit(targetunit,e,f),this.hitresolved+this.criticalresolved<targetunit.shield?targetunit.log("-%0 %SHIELD%",
this.criticalresolved+this.hitresolved):0<targetunit.shield&&targetunit.log("-%0 %SHIELD%",targetunit.shield),this.hitresolved=targetunit.resolvehit(this.hitresolved),this.criticalresolved=targetunit.resolvecritical(this.criticalresolved),this.weapons[this.activeweapon].posthit(targetunit,e,f));this.weapons[this.activeweapon].endattack(e,f);this.usedweapon=this.activeweapon;this.weapons[this.activeweapon].hasdoubleattack()?(this.latedeferred=this.deferred,targetunit.canbedestroyed(skillturn)&&targetunit.checkdead(),
targetunit.dead||this.newlock().done(function(){this.deferred=this.latedeferred;this.log("+1 attack with %0",this.weapons[this.activeweapon].name);this.resolveattack(this.activeweapon,targetunit)}.bind(this)),this.cleanupattack()):TEAMS[targetunit.team].initiative?(targetunit.afterdefenseeffect(e,f,this),barrier(function(){this.afterattackeffect(e,f);targetunit.canbedestroyed(skillturn)&&targetunit.checkdead();targetunit.endbeingattacked(e,f,this);this.endattack(e,f,this);this.cleanupattack()}.bind(this))):
(this.afterattackeffect(e,f),barrier(function(){targetunit.afterdefenseeffect(e,f,this);targetunit.canbedestroyed(skillturn)&&targetunit.checkdead();this.endattack(e,f,this);targetunit.endbeingattacked(e,f,this);this.cleanupattack()}.bind(this)))},afterattackeffect:function(b,e){},afterdefenseeffect:function(b,e){},postattack:function(b){},cleanupattack:function(){this.actionbarrier();ENGAGED=!1},resetfocus:function(){return 0},resetevade:function(){return 0},resettractorbeam:function(){return 0},
endround:function(){for(var b=0;b<this.upgrades.length;b++)this.upgrades[b].endround();this.focus=this.resetfocus();this.evade=this.resetevade();this.hasfired=0;this.maxfired=1;this.tractorbeam=this.resettractorbeam();this.oldoverlap=this.ocollision.overlap;this.ocollision.overlap=-1;this.ocollision.template=[];this.ocollision.mine=[];this.collision=!1;this.touching=[];this.showinfo()},playfiresnd:function(){var b=targetunit.g.getBBox(),e=transformPoint(this.m,{x:0,y:-(this.islarge?40:20)}),f=s.path("M "+
e.x+" "+e.y+" L "+(b.x+b.w/2)+" "+(b.y+b.h/2)).appendTo(VIEWPORT).attr({stroke:this.color,strokeWidth:2}),g=setInterval(function(){f.remove();clearInterval(g)},200);this.movelog("f-"+targetunit.id+"-"+this.activeweapon);"undefined"!=typeof this.weapons[this.activeweapon]&&"undefined"!=typeof this.weapons[this.activeweapon].firesnd?SOUNDS[this.weapons[this.activeweapon].firesnd].play():SOUNDS[this.ship.firesnd].play()},endattack:function(b,e,f){for(i=0;i<DICES.length;i++)$("."+DICES[i]+"dice").remove();
this.show()},endbeingattacked:function(b,e,f){},showpositions:function(b){var e,f=[];for(e=0;e<b.length;e++)f[e]=this.getOutline(b[e].m).attr({title:b[e].move,opacity:.4,fill:halftone(b[e].color),display:"block","class":"possible"}).appendTo(VIEWPORT),function(e){f[e].hover(function(){f[e].attr({stroke:b[e].color,strokeWidth:4})}.bind(this),function(){f[e].attr({strokeWidth:0})}.bind(this))}.call(this,e)},showmeanposition:function(){this.getdial();this.evaluatemoves(!0,!0);this.showpositions([{color:GREEN,
move:"mean",m:this.meanm}])},shownextpositions:function(){var b=this.getdial();this.evaluatemoves(!0,!0);var e=[];for(i=0;i<b.length;i++)e[i]=b[i].next;this.showpositions(e)},showpossiblepositions:function(){this.evaluatemoves(!0,!0);var b=this.getdial();this.showpositions(b)},evaluateposition:function(){var b=0,e=0,f=0,g,h,l=0;NOLOG=!0;for(h in squadron){var m=squadron[h];if(this.isenemy(m)){var q=0;for(g=0;g<m.weapons.length;g++){var v=m.weapons[g].getrange(this);0<v&&4>v&&(q=Math.max(q,m.getattackstrength(g,
this)))}b+=q;for(g=0;g<this.weapons.length;g++)q=this.weapons[g].getrange(m),0<q&&4>q&&(e=Math.max(e,this.getattackstrength(g,m)));l+=this.getdist(this.m,m)/9E4;f++}}NOLOG=!1;return e-b-l/f},evaluatemoves:function(b,e){this.meanmround=round;var f=this.getdial(),g=0,h=0,l=0,m=0,q,v=RED,w={"#000":0,"#F00":1,"#FF0":2,"#FFF":3,"#0F0":4};NOLOG=!0;var x=(this.m.split().rotate+360+180)%360-180;for(q=0;q<f.length;q++)f[q].path=P[f[q].move].path,f[q].len=f[q].path.getTotalLength()+(this.islarge?40:0);for(q=
0;q<f.length;q++){var y=this.getpathmatrix(this.m,f[q].move);f[q].m=y;if(this.canreveal(f[q])){var z=this.getmovecolor(y,b,e,f[q].path,f[q].len,!0);f[q].color=z;if(z!=RED&&z!=BLACK&&b&&e){var B=RED,E=this.ocollision;for(j=0;j<f.length;j++){var D;if(!("F0"==f[j].move||"RED"==f[j].difficulty&&(this.hasnostresseffect()&&"GREEN"!=f[q].difficulty||"RED"==f[q].difficulty))){var F=this.getmatrixwithmove(y,f[j].path,f[j].len);D=GREEN;this.isinzone(F)?e&&(this.fastgetocollisions(y,F,f[j].path,f[j].len)?this.ocollision.overlap=
1:this.ocollision.overlap=-1,this.hascollidedobstacle()&&(D=YELLOW)):D=RED;w[D]>w[B]&&(B=D)}}this.ocollision=E;w[B]<w[z]&&(f[q].color=B)}}else f[q].color=BLACK;w[v]>w[f[q].color]&&(v=f[q].color);f[q].color!=GREEN&&f[q].color!=WHITE||f[q].move.match(/K\d|SR\d|SL\d|TRL\d|TRR\d/)||(y=y.split(),m++,y.rotate=(y.rotate-x+180)%360-180,g+=y.dx,h+=y.dy,l+=y.rotate)}for(q=0;q<f.length;q++)"F0"==f[q].move&&(f[q].color=v);0==m&&(m=1);g/=m;h/=m;l/=m;this.meanm=(new Snap.Matrix).translate(g,h).rotate(l+x,0,0);
NOLOG=!1},removetarget:function(b){var e;e=b.istargeted.indexOf(this);-1<e&&b.istargeted.splice(e,1);e=this.targeting.indexOf(b);-1<e&&(this.targeting.splice(e,1),this.movelog("t-"+b.id),b.show(),this.show());0==this.targeting.length&&$("#atokens > .xtargettoken").remove()},removeevadetoken:function(){this.animateremovetoken("xevadetoken");this.evade--;this.movelog("e");this.show()},removefocustoken:function(){this.animateremovetoken("xfocustoken");this.focus--;this.movelog("fo");this.show()},resolveactionmove:function(b,
e,f,g){var h;this.pos=[];var l=function(b,e,l){for(h=0;h<this.pos.length;h++)this.pos[h].ol.remove();if(f){var m=b.split(),q=this.m.split();s.path("M "+q.dx+" "+q.dy+" L "+m.dx+" "+m.dy).attr({stroke:this.color,display:TRACE?"block":"none",strokeWidth:"20px",strokeLinecap:"round",strokeDasharray:"1, 30",opacity:.2,fill:"rgba(0,0,0,0)"}).addClass("trace").appendTo(VIEWPORT);this.m=b}m=this.getmcollisions(this.m);if(0<m.length)for(h=0;h<m.length;h++)q=OBSTACLES[m[h]],q.type==BOMB&&"function"==typeof q.detonate?
q.detonate(this,!1):(this.ocollision.overlap=h,this.log("colliding with obstacle"),g||this.resolveocollision(1,[]));f&&(m=b.split(),this.movelog("am-"+Math.floor(300+m.dx)+"-"+Math.floor(300+m.dy)+"-"+Math.floor((360+Math.floor(m.rotate))%360)));l(this,e);this.show()}.bind(this);for(h=b.length-1;0<=h;h--){var m=this.getmovecolor(b[h],!0,!0);if(g&&(m==YELLOW||m==RED)||m==GREEN||g&&!f)p=this.getOutline(b[h]).attr({display:"block"}).appendTo(VIEWPORT),this.pos.push({ol:p,k:h})}if(0<this.pos.length)if(1==
this.pos.length)l(b[this.pos[0].k],this.pos[0].k,e);else for(h=0;h<this.pos.length;h++)(function(f){var g=this.pos[f];g.ol.hover(function(){this.pos[f].ol.attr({stroke:this.color,strokeWidth:4})}.bind(this),function(){this.pos[f].ol.attr({strokeWidth:0})}.bind(this));g.ol.click(function(){l(b[this.pos[f].k],this.pos[f].k,e)}.bind(this));g.ol.touchend(function(){l(b[this.pos[f].k],this.pos[f].k,e)}.bind(this))}).call(this,h);else l(this.m,-1,e)},resolveactionselection:function(b,e){var f;this.pos=
[];var g=function(g){for(f=0;f<b.length;f++)b[f].outline.removeClass("outline"),b[f].outline.attr({fill:"rgba(8,8,8,0.5)"}),b[f].setdefaultclickhandler();e(g)}.bind(this);if(0==b.length)g(-1);else if(1==b.length)g(0);else for(f=0;f<b.length;f++)b[f].outline.attr({fill:"rgba(100,100,100,0.8)"}),b[f].outline.addClass("outline"),function(e){b[e].setclickhandler(function(){g(e)})}(f)},getboostmatrix:function(b){return[this.getpathmatrix(this.m,"F1"),this.getpathmatrix(this.m,"BL1"),this.getpathmatrix(this.m,
"BR1")]},resolveboost:function(b){this.resolveactionmove(this.getboostmatrix(this.m),function(e,f){e.endaction(b,"BOOST")},!0,this.canmoveonobstacles("BOOST"))},candoarcrotate:function(){return this.hasmobilearc},setarcrotate:function(b){this.arcrotation=90*b},resolvearcrotate:function(b,e){for(var f=this.weapons[0].auxiliary,g=[],h=this,l=0;4>l;l++)g[l]=s.path(f.call(this,1,this.m.clone().rotate(90*l-this.arcrotation,0,0))).attr({fill:this.color,stroke:this.color,opacity:.1}).appendTo(VIEWPORT);
for(l=0;4>l;l++)(function(f){g[f].hover(function(){g[f].attr({opacity:.4})},function(){g[f].attr({opacity:.1})});g[f].click(function(){h.setarcrotate(f);0==f&&h.log("Mobile firing arc rotated to front");1==f&&h.log("Mobile firing arc rotated to right side");2==f&&h.log("Mobile firing arc rotated to back");3==f&&h.log("Mobile firing arc rotated to left side");h.movelog("R-"+f);for(var l=0;4>l;l++)g[l].attr({display:"none"});1==e?h.endnoaction(b,"ARCMOBILE"):h.endaction(b,"ARCMOBILE")})})(l)},canmoveonobstacles:function(b){return!1},
getdecloakmatrix:function(b){var e=this.getpathmatrix(this.m.clone().rotate(90,0,0),"F2").translate(0,this.islarge?20:0).rotate(-90,0,0),f=this.getpathmatrix(this.m.clone().rotate(-90,0,0),"F2").translate(0,this.islarge?20:0).rotate(90,0,0);return[b.clone(),e.clone().translate(0,-20),e,e.clone().translate(0,20),f.clone().translate(0,-20),f,f.clone().translate(0,20),this.getpathmatrix(b.clone(),"F2")]},removecloaktoken:function(){this.agility-=2;this.iscloaked=!1;this.animateremovetoken("xcloaktoken");
this.movelog("ct");FAST||SOUNDS.decloak.play()},resolvedecloak:function(b){var e="(or self to cancel)";1==b&&(e="(or self)");this.log("select position to decloak "+e);this.doselection(function(e){this.resolveactionmove(this.getdecloakmatrix(this.m),function(f,h){(0<h||1==b)&&this.removecloaktoken();this.hasdecloaked=!0;this.endnoaction(e,"DECLOAK")}.bind(this),!0,this.canmoveonobstacles("DECLOAK"))}.bind(this));return!0},gettallonrollmatrix:function(b,e){var f=this.getpathmatrix(b,e);return[f.clone().translate(0,
-20),f,f.clone().translate(0,20)]},getrollmatrix:function(b){b=this.getpathmatrix(this.m.clone().rotate(90,0,0),"F1").translate(0,this.islarge?20:0).rotate(-90,0,0);var e=this.getpathmatrix(this.m.clone().rotate(-90,0,0),"F1").translate(0,this.islarge?20:0).rotate(90,0,0);p=[b.clone().translate(0,-20),b,b.clone().translate(0,20),e.clone().translate(0,-20),e,e.clone().translate(0,20)];this.islarge&&(p=p.concat([b.clone().translate(0,-40),b.clone().translate(0,40),e.clone().translate(0,-40),e.clone().translate(0,
40)]));return p},resolveroll:function(b){this.resolveactionmove(this.getrollmatrix(this.m),function(e,f){e.endaction(b,"ROLL")},!0,this.canmoveonobstacles("ROLL"))},boundtargets:function(b){if(-1<this.targeting.indexOf(b))return!0;for(b=this.targeting.length-1;0<=b;b--)this.removetarget(this.targeting[b]);return!1},addtarget:function(b){this.boundtargets(b)||(this.targeting.push(b),this.animateaddtoken("xtargettoken"),b.istargeted.push(this),b.animateaddtoken("xtargetedtoken"),this.movelog("T-"+b.id),
b.show(),this.show())},gettargetableunits:function(b){var e=[],f;for(f in squadron)this.isenemy(squadron[f])&&this.getrange(squadron[f])<=b&&e.push(squadron[f]);return e},selectnearbyunits:function(b,e){var f=[],g;for(g in squadron)e(this,squadron[g])&&this.getrange(squadron[g])<=b&&f.push(squadron[g]);return f},selectnearbyobstacle:function(b){var e=[],f=9E4;1==b?f=1E4:2==b&&(f=4E4);for(b=0;b<OBSTACLES.length;b++){var g=OBSTACLES[b];(g.type==DEBRIS||g.type==ROCK)&&this.getdist(this.m,g)<=f&&e.push(g)}return e},
selectnearbyally:function(b,e){return this.selectnearbyunits(b,function(b,g){var f=!0;"function"==typeof e&&(f=e(b,g));return b.isally(g)&&b!=g&&f})},selectnearbyallyandself:function(b,e){return this.selectnearbyunits(b,function(b,g){var f=!0;"function"==typeof e&&(f=e(b,g));return b.isally(g)&&f})},selectnearbyenemy:function(b,e){return this.selectnearbyunits(b,function(b,g){var f=!0;"function"==typeof e&&(f=e(b,g));return b.isenemy(g)&&f})},isally:function(b){return b.team==this.team},isenemy:function(b){return b.team!=
this.team},resolvetargetnoaction:function(b,e){var f=this.gettargetableunits(3);this.resolveactionselection(f,function(g){0<=g&&this.addtarget(f[g]);1==e?this.endnoaction(b,"TARGET"):this.endaction(b,"TARGET")}.bind(this))},resolvetarget:function(b){this.resolvetargetnoaction(b,!1)},addcloaktoken:function(){this.iscloaked=!0;this.agility+=2;this.animateaddtoken("xcloaktoken");this.movelog("CT");FAST||SOUNDS.cloak.play()},addcloak:function(b){this.addcloaktoken();this.endaction(b,"CLOAK")},resolveslam:function(b){var e=
this.getdial();e.length<=this.lastmaneuver&&(this.lastmaneuver=0);for(var f=e[this.lastmaneuver].move.substr(-1),g=[],h=[],l=0;l<e.length;l++)e[l].move.substr(-1)==f&&(g.push(this.getpathmatrix(this.m,e[l].move)),h.push(l));this.log("select maneuver for SLAM");this.noattack=round;this.wrap_after("getdial",this,function(b){for(var e=[],f=0;f<b.length;f++)e[f]={move:b[f].move,difficulty:"WHITE"};return e}).unwrapper("endmaneuver");this.wrap_after("endmaneuver",this,function(){this.endaction(b,"SLAM")}).unwrapper("endactivationphase");
this.wrap_after("candoendmaneuveraction",this,function(){return!1}).unwrapper("endphase");this.resolveactionmove(g,function(b,e){this.maneuver=h[e];this.resolvemaneuver()}.bind(this),!1,!0)},enqueueaction:function(b,e){actionr.push($.Deferred());var f=actionr.length-1;"undefined"==typeof e&&(e="undefined");actionr[f].name=e;0==f?b(f):actionr[f-1].done(function(){b(f)}.bind(this));return actionr[f]},endnoaction:function(b,e){actionr[b].resolve(e);b==actionr.length-1&&actionrlock.resolve();this.show()},
endaction:function(b,e){phase==ACTIVATION_PHASE&&$("#activationdial").show();this.clearaction();this.endnoaction(b,e)},resolveaction:function(b,e){$("#actiondial").empty();null==b?this.endaction(e,null):(this.actionsdone.push(b.name),b.action.call(b.org,e))},resolvenoaction:function(b,e){$("#actiondial").empty();null==b?this.endnoaction(e,null):b.action.call(b.org,e)},evaluatetohit:function(b,e){var f=this.gethitrange(b,e);if(e!=this&&3>=f&&0<f){var g=this.getattackstrength(b,e),h=e.getdefensestrength(b,
this),f=this.focus,l=this.reroll,m=this.weapons[b];-1<this.targeting.indexOf(e)&&(this.reroll=10);1==m.consumes&&"Target".match(m.getrequirements())&&this.canusetarget(e)&&(this.reroll=0);1==m.consumes&&"Focus".match(m.getrequirements())&&this.canusefocus(e)&&this.focus--;g=tohitproba(this,this.weapons[b],e,this.getattacktable(g),e.getdefensetable(h),g,h);f&&(this.focus=f);l&&(this.reroll=l);return g}return{proba:[],tohit:0,meanhit:0,meancritical:0,tokill:0}},isfireobstructed:function(){return-1<
this.ocollision.overlap&&OBSTACLES[this.ocollision.overlap].type==ROCK},hascollidedobstacle:function(){return-1<this.ocollision.overlap||0<this.ocollision.template.length},canfire:function(){return this.noattack<round&&this.hasfired<this.maxfired&&!this.iscloaked&&!this.isfireobstructed()},getattackstrength:function(b,e){return this.weapons[b].getattack()+this.weapons[b].getrangeattackbonus(e)},getobstructiondef:function(b){return this.getoutlinerange(this.m,b).o?1:0},getdefensestrength:function(b,
e){var f=this.getagility(),g=e.getobstructiondef(this);0<g&&this.log("+%0 defense for obstacle",g);return f+e.weapons[b].getrangedefensebonus(this)+g},hasnorerollmodifiers:function(b,e,f,g,h){for(var l=this.getdicemodifiers(),m=0;m<l.length;m++){var q=l[m];if(q.from==b&&q.to==e&&q.type==MOD_M&&q.req(f,g)&&q.noreroll==h)return!0}return!1},getresultmodifiers:function(b,e,f,g){var h,l=function(b,e){var h=b.str+(f==DEFENSE_M?"modtokend":"modtokena");"undefined"!=typeof b.token&&(h="x"+b.str+"token");
h=$("<td>").addClass(h).attr({id:"mod"+e,title:"modify roll ["+b.org.name+"]"}).html("");h.click(function(){modroll(this.f,e,g)}.bind(b));return h},m=function(b,e){var h=b.str+(f==DEFENSE_M?"modtokend":"modtokena");"undefined"!=typeof b.token&&(h="x"+b.str+"token");h=$("<td>").addClass(h).attr({id:"mod"+e,title:"add result ["+b.org.name+"]"}).html("");h.click(function(){addroll(this.f,e,g)}.bind(b));return h},q=function(b,e){var h=b.n(),l="R"+h,m="tokens";b.str&&(m="x"+b.str+"token",l="");l=$("<td>").addClass(m).attr({id:"reroll"+
e,title:h+" rerolls["+b.org.name+"]"}).html(l);l.click(function(){reroll(h,f,g,b,e)});return l},v=this.getdicemodifiers(),w=[];for(h=0;h<v.length;h++){var x=v[h];x.from==f&&x.to==g&&(x.type==MOD_M&&x.req.call(this,b,e)&&w.push(l(x,h)),x.type==ADD_M&&x.req.call(this,b,e)&&w.push(m(x,h)),x.type==REROLL_M&&x.req.call(this,activeunit,activeunit.weapons[activeunit.activeweapon],targetunit)&&w.push(q(x,h)))}return w},addhasfired:function(){this.hasfired++},resolveattack:function(b,e){var f;this.gethitrange(b,
e);this.addhasfired();this.hasdamaged=!1;displaycombatdial();var g=e.g.getBBox(),h=transformPoint(this.m,{x:0,y:-(this.islarge?40:20)});s.path("M "+h.x+" "+h.y+" L "+(g.x+g.w/2)+" "+(g.y+g.h/2)).appendTo(VIEWPORT).attr({stroke:this.color,strokeWidth:2,strokeDasharray:100,"class":"animated fireline"});this.select();for(f in squadron)if(squadron[f]==this)break;this.preattackroll(b,e);this.doselection(function(g){var h=this.getattackstrength(b,e),l=e.getdefensestrength(b,this);this.doattackroll(this.attackroll(h),
h,l,f,g)}.bind(this),"in combat")},preattackroll:function(b,e){},doattack:function(b,e){this.activeweapons=b;this.activeenemies=e;this.showattack(b,e)},doattackroll:function(b,e,f,g,h){b=this.weapons[this.activeweapon].modifydamagegiven(b);displayattackroll(b,e);this.ar=b;this.ad=e;displayattacktokens(this,function(){targetunit.defenseroll(f).done(function(b){targetunit.dodefenseroll(b.roll,b.dice,g,h)})})},dodefenseroll:function(b,e,f,g){this.dr=b;this.dd=e;displaydefenseroll(b,e);displaydefensetokens(this,
function(){this.resolvedamage();this.endnoaction(g,"in combat")}.bind(squadron[f]))},drawpathmove:function(b,e,f){if(!FAST){if(this.islarge){var g=b.clone();s.path("M 0 0 l 0 -20").transform(g).appendTo(VIEWPORT).attr({stroke:this.color,display:TRACE?"block":"none",strokeWidth:"20px",opacity:.2,fill:"rgba(0,0,0,0)"}).addClass("trace");e=s.path(e.getSubpath(0,f-40)).attr("display","none");e.clone().transform(g.translate(0,-20)).appendTo(VIEWPORT).attr({stroke:this.color,display:TRACE?"block":"none",
strokeWidth:"20px",opacity:.2,fill:"rgba(0,0,0,0)"}).addClass("trace");s.path("M 0 0 l 0 -20").transform(this.getmatrixwithmove(b,e,f-20)).appendTo(VIEWPORT).attr({stroke:this.color,display:TRACE?"block":"none",strokeWidth:"20px",opacity:.2,fill:"rgba(0,0,0,0)"}).addClass("trace")}else s.path(e.getSubpath(0,f)).transform(b).attr({stroke:this.color,display:TRACE?"block":"none",strokeWidth:"20px",opacity:.2,fill:"rgba(0,0,0,0)"}).addClass("trace").appendTo(VIEWPORT);this.show()}},getmatrixwithmove:function(b,
e,f){var g=e.getTotalLength();b=b.clone();this.islarge?20>=f?b.translate(0,-f):(g=f>g+20?f-g-20:0,e=e.getPointAtLength(f-g-20),b.translate(e.x,-20+e.y).rotate(e.alpha-90,0,0).translate(0,-g)):(e=e.getPointAtLength(f),b.translate(e.x,e.y).rotate(e.alpha-90,0,0));return b},removestresstoken:function(){0<this.stress&&(this.stress--,this.animateremovetoken("xstresstoken"));this.movelog("st");this.show()},handledifficulty:function(b){"RED"==b?this.addstress():"GREEN"==b&&0<this.stress&&this.removestresstoken()},
completemaneuver:function(b,e,f,g){var h=P[b].path,l,m;this.maneuverdifficulty=e;if("F0"==b)this.hasmoved=!0,this.handledifficulty(e),this.lastmaneuver=this.maneuver,this.endmaneuver(),this.touching=[];else{var q=h.getTotalLength();this.collision=!1;this.showhitsector(!1);this.islarge&&(q+=40);m=this.m;l=this.getmatrixwithmove(this.m,h,q);var v=this.getcollidingunits(l),w=[];if(0<v.length)for(this.log("collides with %0: no action",v[0].name),this.collision=!0;0<q&&0<v.length;)w=v,--q,l=this.getmatrixwithmove(this.m,
h,q),v=this.getcollidingunits(l);this.drawpathmove(this.m,h,q);for(i=0;i<this.touching.length;i++)v=this.touching[i],v.touching.splice(v.touching.indexOf(this),1);this.touching=w;this.ocollision=this.getocollisions(m,l,h,q);this.isfireobstructed()&&this.log("overlaps obstacle: cannot attack");this.hascollidedobstacle()&&this.log("unit or template overlaps obstacle: no action");0<q&&(this.m=l);var x=0;0<q?(this.hasmoved=!0,$("#activationdial").empty(),FAST||SOUNDS[this.ship.flysnd].play(),Snap.animate(0,
q,function(b){l=this.getmatrixwithmove(m,h,b);this.g.transform(l);this.geffect.transform(l)}.bind(this),TIMEANIM*q/200,mina.linear,function(){this.collision||(b.match(/K\d|SR\d|SL\d/)||1==f?(this.m.rotate(180,0,0),x=180):b.match(/TRL\d/)?(this.m.rotate(-90,0,0),x=-90):b.match(/TRR\d/)&&("undefined"!=typeof g?this.m=g:this.m.rotate(90,0,0),x=90));this.movelog("m-"+b+"-"+(360+x)%360+"-"+Math.floor(q));this.handledifficulty(e);this.lastmaneuver=this.maneuver;this.hascollidedobstacle()&&this.resolveocollision(this.ocollision.overlap,
this.ocollision.template);if(0<this.ocollision.mine.length)for(i=0;i<this.ocollision.mine.length;i++)this.ocollision.mine[i].detonate(this,!1);this.collision&&this.resolvecollision();this.endmaneuver()}.bind(this))):(this.hasmoved=!0,this.log("cannot move"),this.handledifficulty(e),this.lastmaneuver=this.maneuver,this.collision&&this.resolvecollision(),this.endmaneuver())}},getmaneuverlist:function(){var b=this.getmaneuver(),e={};e[b.move]=b;return"undefined"!=typeof b?e:{}},resolvemaneuver:function(){$("#activationdial").empty();
if(!(0>this.maneuver)){var b=[],e=[],f=this.getmaneuverlist(),g;for(g in f)if(e.push(f[g]),f[g].move.match(/TRR\d|TRL\d/))for(var h=this.gettallonrollmatrix(this.m,f[g].move),l=0;l<h.length;l++)b.push(h[l]),0<l&&e.push(f[g]);else 1!=f[g].halfturn||f[g].move.match(/K\d|SR\d|SL\d/)?b.push(this.getpathmatrix(this.m,f[g].move)):b.push(this.getpathmatrix(this.m,f[g].move).rotate(180,0,0));this.resolveactionmove(b,function(f,g){-1==g&&(g=0);var h=e[g].move,l=e[g].difficulty;1!=e[g].halfturn&&(e[g].halfturn=
!1);this.completemaneuver(h,l,e[g].halfturn,b[g])}.bind(this),!1,!0)}},endmaneuver:function(){var b=this.ionized;if(this.hasionizationeffect())for(var e=0;e<b;e++)this.removeiontoken();this.maneuver=-1;this.hasmoved=!0;this.show();this.checkdead()?this.shield=this.hull=0:this.doendmaneuveraction();this.cleanupmaneuver()},cleanupmaneuver:function(){this.actionbarrier()},unlock:function(b){this.show();return this.deferred.resolve(b)},newlock:function(){this.deferred=$.Deferred();return this.deferred.promise()},
enddecloak:function(){return this.newlock()},candomaneuver:function(){return-1<this.maneuver},addafterattackeffect:function(b,e){this.wrap_after("afterattackeffect",b,e)},addafterdefenseeffect:function(b,e){this.wrap_after("afterdefenseeffect",b,e)},isattacktwice:function(){return!1},addattack:function(b,e,f,g,h,l,m){var q=this;"undefined"==typeof l&&(l="endattack");"undefined"==typeof m&&(m=!1);(m?Unit.prototype:this).wrap_after(l,e,function(m,w,x){var v=!1;"removeshield"==l||"warndeath"==l||"endmaneuver"==
l?x=activeunit:"undefined"==typeof x&&(x=this);for(i in f)if(f[i].isactive){v=!0;break}if(b.call(q,m,w,x)&&q.noattack<round&&v&&!q.iscloaked&&!q.isfireobstructed()){var z=x.deferred,v=function(){var l,q=[];this.deferred=z;l="function"==typeof h?h.call(this):this.selectnearbyenemy(3);for(var v in f)f[v].isactive&&0<f[v].getenemiesinrange(l).length&&q.push(f[v]);0==q.length?(this.log("no available target for %0",e.name),this.cleanupattack()):b.call(this,m,w,x)?(this.log("+1 attack [%0]",e.name),"function"==
typeof g&&this.wrap_before("resolveattack",this,function(){g.call(this)}.bind(this)).unwrapper("cleanupattack"),this.maxfired++,this.doattack(q,l)):this.cleanupattack()}.bind(q);"endcombatphase"!=l&&"warndeath"!=l&&phase==COMBAT_PHASE?x.newlock().done(v):v()}})},candoendmaneuveraction:function(){return this.candoaction()&&!this.collision&&!this.hascollidedobstacle()},doendmaneuveraction:function(){return this.doaction(this.getactionlist(!0),"",this.candoendmaneuveraction)},doselection:function(b,
e){return this.enqueueaction(b,e)},isactiondone:function(b){return-1!=this.actionsdone.indexOf(b)},doaction:function(b,e,f){"undefined"==typeof f&&(f=this.candoaction);return 0==b.length?(this.log("no action available"),this.enqueueaction(function(b){this.endnoaction(b)}.bind(this),this.name)):this.enqueueaction(function(g){var h;$("#actiondial").empty();if(f.call(this)){this.select();"undefined"!=typeof e&&""!=e&&this.log(e);$("#actiondial").html($("<div>"));for(h=0;h<b.length;h++)this.isactiondone(b[h].name)||
function(e,f){var l=$("<div>").addClass("symbols").text(A[e.type].key).click(function(){this.resolveaction(e,g)}.bind(this));"BOMB"==e.type&&l.addClass("bombs");l.attr("title",b[h].name);"/2"==b[h].name.slice(-2)&&l.css("color","yellow");$("#actiondial > div").append(l)}.call(this,b[h],h);var l=$("<button>").addClass("m-skip").addClass("wbutton").click(function(){this.resolveaction(null,g)}.bind(this));$("#actiondial > div").append(l)}else this.endaction(g,null)}.bind(this),b[0].name)},donoaction:function(b,
e,f,g){return 0==b.length?(this.log("no action available"),this.enqueueaction(function(b){this.endnoaction(b)}.bind(this),this.name)):this.enqueueaction(function(h){var l;"undefined"!=typeof e&&""!=e&&this.log(e);this.select();$("#actiondial").html($("<div>"));for(l=0;l<b.length;l++)(function(b,e){var f=$("<div title='"+b.name+"'>").addClass("symbols").text(A[b.type].key).click(function(){this.resolvenoaction(b,h)}.bind(this));$("#actiondial > div").append(f)}).call(this,b[l],l);1==f&&(l=$("<button>").addClass("m-skip").addClass("wbutton").click(function(){"function"==
typeof g&&g();this.resolvenoaction(null,h)}.bind(this)),$("#actiondial > div").append(l))}.bind(this),b[0].name)},hasnostresseffect:function(){return 0==this.stress},candoaction:function(){return this.hasnostresseffect()},candecloak:function(){return this.iscloaked&&phase==ACTIVATION_PHASE&&!this.hasdecloaked},selecttargetforattack:function(b,e){var f;ENGAGED=!0;f=this.weapons[b].getenemiesinrange(e);if(0==f.length)return this.log("no target for %0",this.weapons[b].name),this.cleanupattack(),!1;$("#attackdial").empty();
this.selectunit(f,function(e,f){e[f]!=this&&this.declareattack(b,e[f])?this.resolveattack(b,e[f]):this.cleanupattack()},[""],!1);return!0},showattack:function(b,e){var f=[],g,h;$("#attackdial").show();"undefined"==typeof b&&(b=this.weapons);var l=this.getenemiesinrange(b,e),m=$("<div>");for(g=h=0;h<b.length;h++)0<l[h].length&&(f[g++]=this.weapons.indexOf(b[h]));var q=this;for(g=0;g<f.length;g++)(function(b){var f=A[q.weapons[b].type.toUpperCase()];m.append($("<div>").attr({"class":"symbols "+b.color}).html(f.key).click(function(){q.selecttargetforattack(b,
e)}))})(f[g]);m.append($("<button>").attr({"class":"m-skip wbutton"}).click(function(){this.addhasfired();this.show();this.cleanupattack()}.bind(this)));$("#attackdial").html(m)},candotarget:function(){return 0<this.gettargetableunits(3).length},candofocus:function(){return!0},candoevade:function(){return!0},candropbomb:function(){return this.lastdrop!=round&&this.getskill()==skillturn},addactivationdial:function(b,e,f,g){this.activationdial.push({pred:b,action:e,html:f,elt:g})},actionbarrier:function(){actionrlock=
$.Deferred();this.areactionspending()?actionrlock.done(function(){this.unlock()}.bind(this)):(actionrlock.resolve(),this.unlock())},addafteractions:function(b){actionrlock.done(b)},areactionspending:function(){for(var b=0;b<actionr.length;b++)if("pending"==actionr[b].state())return!0;return!1},dodecloak:function(){this.iscloaked?this.resolvedecloak():this.hasdecloaked=!0;this.actionbarrier()},getbomblocation:function(){return["F1"]},getbombposition:function(b,e){for(var f=[],g=0;g<b.length;g++)f.push(this.getpathmatrix(this.m.clone().rotate(180,
0,0),b[g]).translate(0,(this.islarge?40:20)-e));return f},bombdropped:function(){},updateactivationdial:function(){var b=this;this.activationdial=[];if(!(this.candropbomb()&&this.hasionizationeffect()||b.lastdrop==round))switch(this.bombs.length){case 3:this.bombs[2].canbedropped()&&this.addactivationdial(function(){return b.lastdrop!=round&&b.bombs[2].canbedropped()},function(){b.lastdrop=round;$(".bombs").remove();b.bombs[2].actiondrop()},A.BOMB.key,$("<div>").attr({"class":"symbols bombs",title:b.bombs[2].name}));
case 2:this.bombs[1].canbedropped()&&this.addactivationdial(function(){return b.lastdrop!=round&&b.bombs[1].canbedropped()},function(){b.lastdrop=round;$(".bombs").remove();b.bombs[1].actiondrop()},A.BOMB.key,$("<div>").attr({"class":"symbols bombs",title:b.bombs[1].name}));case 1:this.bombs[0].canbedropped()&&this.addactivationdial(function(){return b.lastdrop!=round&&b.bombs[0].canbedropped()},function(){b.lastdrop=round;$(".bombs").remove();b.bombs[0].actiondrop()},A.BOMB.key,$("<div>").attr({"class":"symbols bombs",
title:b.bombs[0].name}))}return this.activationdial},doactivation:function(){this.showactivation()},showactivation:function(){$("#activationdial").html("<div></div>");if(this.timeformaneuver()&&!this.areactionspending()){for(var b=this.updateactivationdial(),e=0;e<b.length;e++)(function(e){var f=b[e];f.pred()&&f.elt.appendTo("#activationdial > div").click(function(){$("#activationdial").html("<div></div>");f.action()}).html(f.html)})(e);$("<button>").addClass("m-move").addClass("wbutton").click(function(){this.resolvemaneuver()}.bind(this)).appendTo("#activationdial > div")}},
movelog:function(b){b.match(/L-%%.*/)&&this.setinfo(decodeURIComponent(b.substring(4,b.length-2))).delay(1500).fadeOut(400);ANIM+="_"+this.id+"-"+b},computepoints:function(){},error:function(b){b=formatstring(b);log("<div><span style='color:red;font-weight:bold;'>**ERROR** ["+this.name+"]</span> "+b+"</div>")},log:function(b,e,f,g){NOLOG||("undefined"!=typeof UI_translation[b]&&(b=UI_translation[b]),"string"==typeof e&&(e=translate(e)),b=b.replace(/%0/g,e),"string"==typeof f&&(f=translate(f)),b=b.replace(/%1/g,
f),"string"==typeof g&&(g=translate(g)),b=b.replace(/%2/g,g),b=formatstring(b),log("<div><span style='color:"+this.color+"'>["+this.name+"]</span> "+b+"</div>"))},candocloak:function(){return!this.iscloaked},clearaction:function(){this.action=-1},showaction:function(){if(this.action<this.actionList.length&&-1<this.action){var b=A[this.actionList[this.action].type].color;this.actionicon.attr({fill:this==activeunit?b:halftone(b)})}else this.actionicon.attr({text:""})},showinfo:function(){var b=0,e=
$("#"+this.id+" .usabletokens").html(),f=this.getusabletokens();$("#"+this.id+" .usabletokens").html(f);if(e!=f)for(var g in squadron)e=squadron[g],this.isally(e)&&this.getskill()>=e.getskill()&&e.showoverflow();0<this.focus&&this.infoicon[b++].attr({text:A.FOCUS.key,fill:A.FOCUS.color});0<this.evade&&this.infoicon[b++].attr({text:A.EVADE.key,fill:A.EVADE.color});1==this.iscloaked&&this.infoicon[b++].attr({text:A.CLOAK.key,fill:A.CLOAK.color});0<this.targeting.length&&6>b&&this.infoicon[b++].attr({text:A.TARGET.key,
fill:A.TARGET.color});0<this.istargeted.length&&this.infoicon[b++].attr({text:A.ISTARGETED.key,fill:A.ISTARGETED.color});0<this.stress&&6>b&&this.infoicon[b++].attr({text:A.STRESS.key,fill:A.STRESS.color});0<this.ionized&&6>b&&this.infoicon[b++].attr({text:"Z",fill:A.STRESS.color});0<this.tractorbeam&&6>b&&this.infoicon[b++].attr({text:"Y",fill:A.STRESS.color});for(g=b;6>g;g++)this.infoicon[b++].attr({text:""})},showoutline:function(){this.border.attr({stroke:activeunit==this?this.color:halftone(this.color)})},
dock:function(b){this.isdocked=!0;$("#"+this.id).attr("onclick","");$("#"+this.id).addClass("docked");$("#"+this.id).html(""+this);this.g.attr({display:"none"});this.geffect.attr({display:"none"});this.log("docked on %0",b.name);this.show();b.docked=this},deploy:function(b,e){this.movelog("DPY");$("#"+this.id).removeClass("docked");$("#"+this.id).html(""+this);$("#"+this.id+" .outoverflow").each(function(b){"auto"!=$(this).css("top")&&$(this).css("top",$(this).parent().offset().top+"px")});$("#"+
this.id).click(function(){this.select()}.bind(this));this.g.attr({display:"block"});this.geffect.attr({display:"block"});this.m=b.m.clone();this.isdocked=!1;this.log("deploying from %0",b.name);this.show();b.docked=null;this.log("select maneuver for deployment");b.doselection(function(f){this.resolveactionmove(e,function(b,e){var f=this.getdial().length;e>=f?(this.m.translate(0,-20),e-=f):this.m.translate(0,20).rotate(180,0,0);this.maneuver=e;this.resolvemaneuver()}.bind(this),!1,!0);b.endnoaction(f,
"DEPLOY")}.bind(this))},endcombatphase:function(){$(".fireline").remove()},endphase:function(){},beginplanningphase:function(){this.actionsdone=[];return this.newlock()},beginactivationphase:function(){return this.newlock()},timetoshowmaneuver:function(){return-1<this.maneuver&&phase<=ACTIVATION_PHASE},getmaneuver:function(){return this.hasionizationeffect()?{move:"F1",difficulty:"WHITE"}:this.getdial()[this.maneuver]},showmaneuver:function(){if(this.timetoshowmaneuver()){var b=this.getmaneuver(),
e=C["undefined"!=typeof this.forceddifficulty?this.forceddifficulty:b.difficulty];activeunit!=this&&(e=halftone(e));this.dialspeed.attr({text:P[b.move].speed,fill:e});this.dialdirection.attr({text:P[b.move].key,fill:e})}},clearmaneuver:function(){this.dialspeed.attr({text:""});this.dialdirection.attr({text:""})},beginactivation:function(){this.showmaneuver();this.show()},endactivationphase:function(){},hasionizationeffect:function(){return 0<this.ionized&&!this.islarge||1<this.ionized},begincombatphase:function(){return this.newlock()},
beginattack:function(){},toString:function(){if(phase==SELECT_PHASE||phase==CREATION_PHASE)return this.toString2();var b,e=8;b=squadron.indexOf(this);str=-1==b?"<div class='dead '>":this.isdocked?"<div class='docked'>":"<div>";str+="<div><div class='statskill'>"+this.getskill()+"</div>";t=formatstring(getpilottexttranslation(this,this.faction));str+="<div class='name'>";""!=t&&(str+="<div class='tooltip outoverflow'><span>"+t+"</span></div>");str+="<div>"+translate(this.name)+"</div></div>";text=
SHIP_translation[this.ship.name];"undefined"==typeof text&&(text=this.ship.name);str+="<div><div style='font-size:smaller'><code class='"+this.faction+"'></code>&nbsp;"+text+"</div></div>";e+=2*this.upgrades.length;this.hull+this.shield<=e?(str+="<div class='outoverflow stat'>",str+="<div class='hull'>"+repeat("u ",this.hull)+"</div>",str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>"):this.hull>e?(str+="<div class='outoverflow stat'>",str+="<div class='hull'>"+repeat("u ",e)+"</div></div>",
this.hull<=2*e?(str+="<div class='outoverflow stat2'>",str+="<div class='hull'>"+repeat("u ",this.hull-e)+"</div>",this.shield+this.hull<=2*e?str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>":(str+="<div class='shield'>"+repeat("u ",2*e-this.hull)+"</div></div>",str+="<div class='outoverflow stat3'>",str+="<div class='shield'>"+repeat("u ",this.shield-2*e+this.hull)+"</div></div>")):(str+="<div class='outoverflow stat2'><div class='hull'>"+repeat("u ",e)+"</div></div>",str+="<div class='outoverflow stat3'><div class='hull'>"+
repeat("u ",this.hull-2*e)+"</div>",str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>")):(str+="<div class='outoverflow stat'><div class='hull'>"+repeat("u ",this.hull)+"</div>",str+="<div class='shield'>"+repeat("u ",e-this.hull)+"</div></div>",str+="<div class='outoverflow stat2'><div class='shield'>"+repeat("u ",this.shield-e+this.hull)+"</div></div>");str+="<div><div>";-1<b&&(str+="<div class='usabletokens' style='width:100%'>"+this.getusabletokens()+"</div>");str+="</div></div>";
var f=e="",g="";b="<td><button class='statevade' onclick='if (!squadron["+b+"].dead&&!squadron["+b+"].isdocked) squadron["+b+"].togglerange();'><span class='val'>"+this.getagility()+"</span><span class='symbols'>^</span></button></td>";e=1==this.team?e+("<tr><td></td>"+b+"</tr>"):e+("<tr>"+b+"<td></td></tr>");for(b=0;b<this.upgrades.length;b++)f+=this.upgrades[b];for(b=0;b<this.criticals.length;b++)g+=this.criticals[b];return str+="<table class='details' style='width:100%'>"+e+f+g+"</table></div>"},
canusefocus:function(){return 0<this.focus},canuseevade:function(){return 0<this.evade},canusetarget:function(b){return 0<this.targeting.length&&("undefined"==typeof b||-1<this.targeting.indexOf(b))},getusabletokens:function(){this.focuses=1<this.focus?[this.focus]:[];this.evades=1<this.evade?[this.evade]:[];this.stresses=1<this.stress?[this.stress]:[];this.ionizedes=1<this.ionized?[this.ionized]:[];this.tractorbeames=1<this.tractorbeam?[this.tractorbeam]:[];this.targetedname=[];this.targetingname=
[];for(var b=0;b<this.istargeted.length;b++)this.targetedname[b]=this.istargeted[b].name.replace(/\'/g,"&#39;");for(b=0;b<this.targeting.length;b++)this.targetingname[b]=this.targeting[b].name.replace(/\'/g,"&#39;");return Mustache.render(TEMPLATES.usabletokens,this)},showskill:function(){var b=this.getskill();$("#unit"+this.id+" .statskill").html(b);$("#"+this.id+" .statskill").html(b)},showstats:function(){$("#unit"+this.id+" .statevade .val").html(this.getagility());if(phase==SELECT_PHASE||phase==
CREATION_PHASE)$("#unit"+this.id+" .stathull .val").html(this.ship.hull),$("#unit"+this.id+" .statshield .val").html(this.ship.shield);else{this.skillbar.attr({text:repeat("u",this.getskill())});this.firebar.attr({text:repeat("u",this.weapons[0].getattack())});this.evadebar.attr({text:repeat("u",this.getagility())});this.hullbar.attr({text:repeat("u",this.hull)});this.shieldbar.attr({text:repeat("u",this.shield+this.hull)});var b=8+2*this.upgrades.length;this.hull+this.shield<=b?($("#"+this.id+" .stat .hull").html(repeat("u ",
this.hull)),$("#"+this.id+" .stat .shield").html(repeat("u ",this.shield))):this.hull>b?($("#"+this.id+" .stat .hull").html(repeat("u ",b)),this.hull<=2*b?($("#"+this.id+" .stat2 .hull").html(repeat("u ",this.hull-b)),this.shield+this.hull<=2*b?$("#"+this.id+" .stat2 .shield").html(repeat("u ",this.shield)):($("#"+this.id+" .stat2 .shield").html(repeat("u ",2*b-this.hull)),$("#"+this.id+" .stat3 .shield").html(repeat("u ",this.shield-2*b+this.hull)))):($("#"+this.id+" .stat2 .hull").html(repeat("u ",
b)),$("#"+this.id+" .stat3 .hull").html(repeat("u ",this.hull-2*b)),$("#"+this.id+" .stat3 .shield").html(repeat("u ",this.shield)))):($("#"+this.id+" .stat .hull").html(repeat("u ",this.hull)),$("#"+this.id+" .stat .shield").html(repeat("u ",b-this.hull)),$("#"+this.id+" .stat2 .shield").html(repeat("u ",this.shield-b+this.hull)))}},showpanel:function(){var b=VIEWPORT.m.clone(),e=this.g.getBBox(),f=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>f?l=(g-f)/2:h=(f-g)/2;f=Math.min(f/900,g/900);
h+=(b.x(e.x,e.y)+e.width/2)*f;e=l+b.y(e.x,e.y)*f;b=b.split().scalex;$(".phasepanel").css({left:h+b*(this.islarge?40:20),top:e}).show()},timeformaneuver:function(){return this==activeunit&&-1<this.maneuver&&!this.hasmoved&&this.getskill()==skillturn&&phase==ACTIVATION_PHASE&&subphase==ACTIVATION_PHASE},showoverflow:function(){this.dead||($("#"+this.id).html(""+this),$("#"+this.id+" .outoverflow").each(function(b){"auto"!=$(this).css("top")&&$(this).css("top",$(this).parent().offset().top+"px")}))},
show:function(){phase==CREATION_PHASE?$("#unit"+this.id).html(this.toString2()):"undefined"!=typeof this.g&&(this.g.transform(this.m),this.g.appendTo(VIEWPORT),this.geffect.transform(this.m),this.geffect.appendTo(VIEWPORT),this.showoutline(),this.flameno++,this.showstats(),this.showinfo(),activeunit==this&&(this.showpanel(),this.showdial(),this.showmaneuver(),phase==ACTIVATION_PHASE&&this.showactivation(),ENGAGED||phase!=COMBAT_PHASE||(!this.canfire()||this.areactionspending()||INREPLAY?$("#attackdial").empty():
this.showattack(this.activeweapons,this.activeenemies)),this.showoverflow()))},updatetohit:function(b,e){var f=this.weapons[e],g=f.getenemiesinrange();if(b)for(h in g)g[h].tohitstats[this.id]={unit:this,weapon:e};else for(var h in g)delete g[h].tohitstats[this.id];for(h in g){var l=g[h];NOLOG=!0;var m=1,q=0,v=0,w=l.focus,x=l.evade,y,z;for(z in l.tohitstats){var B=l.tohitstats[z],f=B.weapon;if("undefined"!=typeof B.unit){var E=B.unit.evaluatetohit(B.weapon,l),m=m*(1-E.tohit/100),q=q+E.meanhit,v=v+
E.meancritical;0<l.focus&&l.focus--;0<l.evade&&l.evade--;for(y=[];"function"==typeof B.unit.weapons[f].followupattack&&-1==y.indexOf(f);)y.push(f),f=B.unit.weapons[f].followupattack(),E=B.unit.evaluatetohit(f,l),m*=1-E.tohit/100,q+=E.meanhit,v+=E.meancritical,0<l.focus&&l.focus--,0<l.evade&&l.evade--}}l.tohitstats.tohit=m;l.tohitstats.meanhit=q;l.tohitstats.meancrit=v;l.evade=x;l.focus=w;NOLOG=!1}},displaytohit:function(b){b=this.weapons[b].getenemiesinrange();for(var e in b){var f=b[e],g=1-f.tohitstats.tohit,
h=f.tohitstats.meanhit,l=f.tohitstats.meancrit;if(0==h)f.gproba.attr({display:"none"});else{var m=-f.m.split().rotate;f.gproba.transform("r "+m+" 0 0").attr({display:"block"});f.tohit.attr({text:Math.floor(100*g)+"%"});f.meanhit.attr({text:Math.floor(100*h)/100});f.meancrit.attr({text:Math.floor(100*l)/100})}f.show()}},showhitsector:function(b,e){this.select();"undefined"==typeof e&&(e=0);var f=this.weapons[e];if(b){var g=f.getlowrange(),h=f.gethighrange();if(f.isTurret()||this.isTurret(f))this.showrange(b,
g,h);else{var l;if(1==g){for(l=g;l<=h;l++)this.sectors.push(s.path(this.getPrimarySectorString(l,this.m)).attr({fill:this.color,stroke:this.color,opacity:.1,pointerEvents:"none"}).appendTo(VIEWPORT));if("undefined"!=typeof f.auxiliary)for(f=f.auxiliary,l=g;l<=h;l++)this.sectors.push(s.path(f.call(this,l,this.m)).attr({fill:this.color,stroke:this.color,opacity:.1,pointerEvents:"none"}).appendTo(VIEWPORT))}else{for(l=g;l<=h;l++)this.sectors.push(s.path(this.getPrimarySubSectorString(g-1,l,this.m)).attr({fill:this.color,
stroke:this.color,opacity:.1,pointerEvents:"none"}).appendTo(VIEWPORT));if("undefined"!=typeof f.subauxiliary)for(f=f.subauxiliary,l=g;l<=h;l++)this.sectors.push(s.path(f.call(this,g-1,l,this.m.clone())).attr({fill:this.color,stroke:this.color,opacity:.1,pointerEvents:"none"}).appendTo(VIEWPORT))}}}else{for(l=0;l<this.sectors.length;l++)this.sectors[l].remove();for(l=0;l<this.ranges.length;l++)this.ranges[l].remove();this.ranges=[];this.sectors=[]}this.updatetohit(b,e);this.displaytohit(e)},showrange:function(b,
e,f){this.select();if(b)if(1==e)for(b=e;b<=f;b++)this.ranges.push(s.path(this.getRangeString(b,this.m)).attr({fill:this.color,stroke:this.color,opacity:.1,pointerEvents:"none"}).appendTo(VIEWPORT));else for(b=e;b<=f;b++)this.ranges.push(s.path(this.getSubRangeString(e-1,b,this.m)).attr({fill:this.color,stroke:this.color,opacity:.1,pointerEvents:"none"}).appendTo(VIEWPORT));else{for(b=0;b<this.ranges.length;b++)this.ranges[b].remove();this.ranges=[]}},togglehitsector:function(b){this.showhitsector(0<
this.sectors.length+this.ranges.length?!1:!0,b)},togglerange:function(){this.showrange(0<this.ranges.length?!1:!0,1,3)},isPointInside:function(b,e){for(var f=0;f<e.length;f++)if(Snap.path.isPointInside(b,e[f].x,e[f].y))return!0;return!1},isinsector:function(b,e,f,g,h,l){f=f.getOutlineString(f.m);b=1<e?g.call(this,e-1,e,b):h.call(this,e,b);return null!=b&&(0<Snap.path.intersection(f.s,b).length||this.isPointInside(b,f.p))},isinfiringarc:function(b){return 3>=this.getsector(b)},isinprimaryfiringarc:function(b){return 3>=
this.getprimarysector(b)},getsector:function(b,e){return this.weapons[0].getsector(b)},getprimarysector:function(b,e){var f;"undefined"==typeof e&&(e=this.m);var g=this.getoutlinerange(e,b).d;for(f=g;f<=g+1&&3>=f;f++)if(this.isinsector(e,f,b,this.getPrimarySubSectorString,this.getPrimarySectorString))return f;return 4},isinoutline:function(b,e,f){return this.isPointInside(b,e.getOutlinePoints(f))},checkcollision:function(b){return-1<this.touching.indexOf(b)},resolvecollision:function(){var b;"undefined"==
typeof this.touching&&(this.touching=[]);for(b=0;b<this.touching.length;b++){var e=this.touching[b];-1==e.touching.indexOf(this)&&(e.touching.push(this),e.collidedby(this))}},collidedby:function(b){},canhavehitocollision:function(){return!0},canhavecriticalocollision:function(){return!0},resolveocollision:function(b,e){var f;-1==e.indexOf(b)&&-1<b&&e.push(b);for(f=0;f<e.length;f++){var g=this.rollattackdie(1,OBSTACLES[e[f]],"blank")[0];switch(g){case "focus":this.log("roll for collision: <span class='focusreddice'></span>");
break;case "hit":this.log("roll for collision: <span class='hitreddice'></span>");break;case "blank":this.log("roll for collision: <span class='blankreddice'></span>");break;case "critical":this.log("roll for collision: <span class='criticalreddice'></span>")}OBSTACLES[e[f]].type==ROCK?"hit"==g&&this.canhavehitocollision()?(this.log("+1 %HIT% [collision]"),this.resolvehit(1),this.checkdead()):"critical"==g&&this.canhavecriticalocollision()&&(this.log("+1 %CRIT% [collision]"),this.resolvecritical(1),
this.checkdead()):OBSTACLES[e[f]].type==DEBRIS&&(this.addstress(),"critical"==g&&(this.log("+1 %CRIT% [debris collision]"),this.resolvecritical(1),this.checkdead()))}},addshield:function(b){this.movelog("S-"+b);this.shield<this.ship.shield&&this.animateaddtoken("cshield");this.shield+=b;return this.shield>this.ship.shield?(this.shield=this.ship.shield,!0):!1},addhull:function(b){this.movelog("H-"+b);this.hull<this.ship.hull&&this.animateaddtoken("chull");this.hull+=b;this.hull>this.ship.hull&&(this.hull=
this.ship.hull)},animateremovetoken:function(b){if(!FAST){var e=VIEWPORT.m.clone(),f=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>f?l=(g-f)/2:h=(f-g)/2;var m=Math.max(900/f,900/g),q=this.g.getBBox(),f=$("#svgout").offset();$("#playmat").width();$("#playmat").height();g=e.x(q.x,q.y)/m;g+=f.left+h;e=e.y(q.x,q.y)/m;e+=f.top+l;$("<div>").addClass("upanim").css({left:g,top:e}).html("<code class='"+b+"'></code>").appendTo("body").show()}},animateaddtoken:function(b){if(!FAST){var e=VIEWPORT.m.clone(),
f=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>f?l=(g-f)/2:h=(f-g)/2;var m=Math.max(900/f,900/g),q=this.g.getBBox(),f=$("#svgout").offset();$("#playmat").width();$("#playmat").height();g=e.x(q.x,q.y)/m;g+=f.left+h;e=e.y(q.x,q.y)/m;e+=f.top+l;$("<div>").addClass("downanim").css({left:g,top:e}).html("<code class='"+b+"'></code>").appendTo("body").show()}},removeshield:function(b){0<this.shield&&this.animateremovetoken("cshield");this.shield-=b;this.movelog("s-"+b);0>this.shield&&(this.shield=
0);var e=TEAMS[this.team].history.rawdata;"undefined"==typeof e[round]&&(e[round]={hits:0,dead:""});e[round].hits+=b},resolvehit:function(b){var e=0;if(0==b)return 0;this.shield>b?this.removeshield(b):(e=b-this.shield,this.removeshield(this.shield),0<e&&this.applydamage(e));this.show();return e},resolvecritical:function(b){var e=0;if(0==b)return 0;this.shield>b?this.removeshield(b):(e=b-this.shield,this.removeshield(this.shield),0<e&&this.applycritical(e));this.show();return e},removehull:function(b){0<
this.hull&&this.animateremovetoken("chull");this.hull-=b;this.movelog("h-"+b);var e=TEAMS[this.team].history.rawdata;"undefined"==typeof e[round]&&(e[round]={hits:0,dead:""});e[round].hits+=b;this.log("-%0 %HULL%",b);this.hull<=this.ship.hull/2&&this.imgsmoke.attr({display:"block"});1==this.hull&&(this.imgsmoke.attr({display:"none"}),this.imgflame.attr({display:"block"}))},selectunit:function(b,e,f,g){g&&b.push(this);0<b.length&&this.doselection(function(h){"undefined"!=typeof f&&""!=f[0]&&this.log.apply(this,
f);this.resolveactionselection(b,function(f){g&&this==b[f]||e.call(this,b,f);this.endnoaction(h,"SELECT")}.bind(this))}.bind(this),"selectunit")},selectcritical:function(b,e){var f=function(b,f){$("#actiondial").empty();e(b);this.endnoaction(f,"CRITICAL")}.bind(this);this.doselection(function(e){var g;$("#actiondial").empty();for(g=0;g<b.length;g++)(function(g){var h=$("<button>").text(CRITICAL_DECK[b[g]].name).click(function(){f(b[g],e)}.bind(this));$("#actiondial").append(h)}).call(this,g);$("#actiondial").show()}.bind(this),
"critical")},selectupgradetodesactivate:function(b,e){var f=function(b,f){$("#actiondial").empty();null!=b&&(b.desactivate(),b.unit.show(),e.desactivate(),this.log("desactivating %0 [%1]",b.name,this.name));this.endnoaction(f,"CREW")}.bind(this);this.doselection(function(e){var g;$("#actiondial").empty();for(g=0;g<b.length;g++)(function(g){var h=$("<button>").text(b[g].name).click(function(){f(b[g],e)});$("#actiondial").append(h)}).call(this,g);g=$("<button>").addClass("m-skip").addClass("wbutton").click(function(){f(null,
e)});$("#actiondial").append(g);$("#actiondial").show()}.bind(this),"upgrade")},selectdamage:function(){var b,e=0;for(b=0;b<CRITICAL_DECK.length;b++)-1<CRITICAL_DECK[b].version.indexOf(CURRENT_DECK)&&(e+=CRITICAL_DECK[b].count);var f=this.rand(e);for(b=e=0;b<CRITICAL_DECK.length;b++)if(-1<CRITICAL_DECK[b].version.indexOf(CURRENT_DECK)&&(e+=CRITICAL_DECK[b].count,e>f))return b;return 0},applydamage:function(b){var e,f;for(f=0;f<b;f++){e=this.selectdamage();CRITICAL_DECK[e].count--;var g=new Critical(this,
e);this.deal(g,FACEDOWN).then(function(b){switch(b.face){case FACEUP:b.crit.faceup(),this.movelog("c-"+e);case FACEDOWN:this.removehull(1);break;case DISCARD:this.criticals.slice(this.criticals.indexOf(g),1)}this.show()}.bind(this))}},applycritical:function(b){var e,f;for(f=0;f<b;f++){e=this.selectdamage();CRITICAL_DECK[e].count--;var g=new Critical(this,e);this.deal(g,FACEUP).then(function(b){switch(b.face){case FACEUP:b.crit.faceup(),this.movelog("c-"+e);case FACEDOWN:this.removehull(1);break;case DISCARD:this.criticals.slice(this.criticals.indexOf(g),
1)}this.show()}.bind(this))}},deal:function(b,e){return $.Deferred().resolve({crit:b,face:e}).promise()},gethitrange:function(b,e){return this.isally(e)?0:this.weapons[b].getrange(e)},getenemiesinrange:function(b,e){var f,g=[];"undefined"==typeof b&&(b=this.weapons);for(f=0;f<b.length;f++)g[f]=b[f].getenemiesinrange(e);return g},getrange:function(b){return this.getoutlinerange(this.m,b).d},getdist:function(b,e){var f=this.getOutlinePoints(b),g=e.getOutlinePoints(e.m),h=-1,l,m;for(l=0;l<f.length;l++)for(m=
0;m<g.length;m++){var q=dist(g[m],f[l]);if(q<h||-1==h)h=q}return h},getoutlinerange:function(b,e){var f=util.getOutlineRange(this,e,OBSTACLES);return{d:f.distance,o:f.obstructed}},getrangeallunits:function(){var b=[[],[],[],[],[]],e;for(e in squadron){var f=squadron[e];f!=this&&(f=this.getrange(f),b[f].push({unit:e}))}return b}};var IACOMPUTING=0;function IAUnit(){}
IAUnit.prototype={confirm:function(b){return!0},guessevades:function(b,e){this.rand(b.dice+1)==FE_evade(b.roll)&&(this.log("guessed correctly the number of evades ! +1 %EVADE% [%0]",self.name),b.roll+=FE_EVADE,b.dice+=1);e.resolve(b)},computemaneuver:function(){var b,e=0,e=[],f=this.getdial(),e=this.getskill();for(b in squadron){var g=squadron[b],h=g.getskill();g.oldm=g.m;h<e&&(g.team!=this.team?(g.meanmround!=round&&g.evaluatemoves(!1,!1),g.m=g.meanm):("undefined"==typeof g.futurem&&(g.futurem=g.m),
g.m=g.futurem))}this.evaluatemoves(!0,!0);e=function(b){var e=[],f,g=[GREEN,WHITE,YELLOW,RED];for(f=0;f<b.length;f++){var h=b[f];if(h.color!=BLACK){var l=this.getpathmatrix(this.m,b[f].move),y=24-8*g.indexOf(h.color);h.color==RED&&(y-=20);h.color==BLACK&&(y=-100);var z=this.m;this.m=l;y+=this.evaluateposition();"RED"==h.difficulty&&(y-=1.5);this.m=z;e.push({n:y,m:f})}}return e}.call(this,f);for(b in squadron)squadron[b].m=squadron[b].oldm;if(0<e.length)e.sort(function(b,e){return e.n-b.n}),e=e[0].m;
else{for(b=0;b<f.length&&"RED"==f[b].difficulty&&!f[b].move.match(/F\d/);b++);e=b}this.futurem=this.getpathmatrix(this.m,f[e].move);this.log("Maneuver set");return e},resolveactionselection:function(b,e){e(0)},selectcritical:function(b,e){for(var f=0;f<b.length;f++)if(0==CRITICAL_DECK[b[f]].lethal){e(b[f]);return}e(b[0])},resolveactionmove:function(b,e,f,g,h){var l,m=!1,q=-1E3;g=-1;var v=this.m;for(l=0;l<b.length;l++)if(this.getmovecolor(b[l],!0,!0)==GREEN){var w,m=!0;"array"==typeof h?w=h[l]:(this.m=
b[l],w=this.evaluateposition());q<w&&(q=w,g=l)}this.m=v;if(m&&-1<g){f&&(f=b[g].split(),h=this.m.split(),s.path("M "+h.dx+" "+h.dy+" L "+f.dx+" "+f.dy).appendTo(VIEWPORT).attr({stroke:this.color,display:TRACE?"block":"none",strokeWidth:"20px",strokeLinecap:"round",strokeDasharray:"1, 30",opacity:.2,fill:"rgba(0,0,0,0)"}).addClass("trace"),this.show(),this.m=b[g],f=this.m.split(),this.movelog("am-"+Math.floor(300+f.dx)+"-"+Math.floor(300+f.dy)+"-"+Math.floor((360+Math.floor(f.rotate))%360)));b=this.getmcollisions(this.m);
if(0<b.length)for(l=0;l<b.length;l++)"function"==typeof OBSTACLES[b[l]].detonate?OBSTACLES[b[l]].detonate(this):(this.log("colliding with obstacle"),this.resolveocollision(1,[]));e(this,g)}else this.m=v,e(this,-1)},doplan:function(){$("#move").css({display:"none"});$("#maneuverdial").empty();if(phase==PLANNING_PHASE&&-1==this.maneuver){IACOMPUTING++;1==IACOMPUTING&&$("#npimg").html("<img style='width:10px' src='png/waiting.gif'/>");var b;b=setInterval(function(){var e=this.computemaneuver();IACOMPUTING--;
0==IACOMPUTING&&$("#npimg").html("&gt;");this.newm=this.getpathmatrix(this.m,this.getdial()[e].move);this.setmaneuver(e);clearInterval(b)}.bind(this),0)}return this.deferred},showdial:function(){$("#maneuverdial").empty();phase>=PLANNING_PHASE&&(-1==this.maneuver||this.hasmoved)&&this.clearmaneuver()},resolvedecloak:function(){for(var b=this.getdecloakmatrix(this.m),e=this.getdial()[this.maneuver].move,f=[],g=this.m,h=0;h<b.length;h++)this.m=this.getpathmatrix(b[h],e),f[h]=this.evaluateposition();
this.m=g;this.resolveactionmove(b,function(b,e){0<e&&(this.removecloaktoken(),b.show());this.hasdecloaked=!0}.bind(this),!0,f)},showactivation:function(){},timetoshowmaneuver:function(){return-1<this.maneuver&&skillturn>=this.getskill()&&phase==ACTIVATION_PHASE&&subphase==ACTIVATION_PHASE},doactivation:function(){this.updateactivationdial();this.timeformaneuver()?this.resolvemaneuver():this.log("no resolvemaneuver")},showaction:function(){$("#actiondial").empty();if(-1<this.action&&this.action<this.actionList.length){var b=
A[this.actionList[this.action]].color;this.actionicon.attr({fill:this==activeunit?b:halftone(b)})}else this.actionicon.attr({text:""})},donoaction:function(b,e){b.sort(function(b,e){return"CRITICAL"==b.type?-1:"CRITICAL"==e.type?1:"EVADE"==b.type?-1:"EVADE"==e.type?1:"FOCUS"==b.type?-1:"FOCUS"==e.type?1:0});return this.enqueueaction(function(f){this.select();"undefined"!=typeof e&&""!=e&&this.log(e);var g=null;for(i=0;i<b.length;i++)if("CRITICAL"==b[i].type){g=b[i];break}else if("EVADE"==b[i].type&&
this.candoevade()){var h=!0,l=this.getenemiesinrange();for(i=0;i<l.length;i++)if(0<l[i].length){h=!1;break}if(h){g=b[i];break}}else if("FOCUS"==b[i].type){if(this.candofocus()){g=b[i];break}}else{g=b[i];break}this.resolvenoaction(g,f)}.bind(this),"donoaction ia")},doaction:function(b,e,f){var g;"undefined"==typeof f&&(f=this.candoaction);for(g=0;g<b.length;g++)this.setpriority(b[g]);b.sort(function(b,e){return e.priority-b.priority});return 0==b.length?this.enqueueaction(function(b){this.endnoaction(b)}.bind(this)):
this.enqueueaction(function(g){var h;if(f.call(this)){this.select();"undefined"!=typeof e&&""!=e&&this.log(e);var m=null;for(h=0;h<b.length;h++)if("CRITICAL"==b[h].type){m=b[h];break}else if("CLOAK"==b[h].type&&this.candocloak()){m=b[h];break}else if("EVADE"==b[h].type&&this.candoevade()){m=b[h];break}else if("FOCUS"==b[h].type){if(this.candofocus()){m=b[h];break}}else{m=b[h];break}null==m&&this.log("no possible action");null!=m?this.log("action chosen: "+m.type):this.log("null action chosen");this.resolveaction(m,
g)}else this.endaction(g)}.bind(this),"doaction ia")},showattack:function(){},doattack:function(b,e){var f=0,g=null,h,l,m;"undefined"==typeof b&&(b=this.weapons);var q=this.getenemiesinrange(b,e);for(l=0;l<b.length;l++){var v=q[l];m=this.weapons.indexOf(b[l]);for(h=0;h<v.length;h++){var w=this.evaluatetohit(m,v[h]).tohit;w>f&&!v[h].isdocked&&(g=v[h],f=w,this.activeweapon=m)}}if(null!=g)return this.selecttargetforattack(this.activeweapon,[g]);this.addhasfired();this.cleanupattack();return!1},getresultmodifiers:function(b,
e,f,g){var h=this.getdicemodifiers();NOLOG=!1;for(var l=0;l<h.length;l++){var m=h[l];m.from==f&&m.to==g&&(m.type==MOD_M&&m.req(b,e)&&("function"==typeof m.aiactivate&&1!=m.aiactivate(b,e)||modroll(m.f,l,g)),m.type==ADD_M&&m.req(b,e)&&("function"==typeof m.aiactivate&&1!=m.aiactivate(b,e)||addroll(m.f,l,g)),m.type!=REROLL_M||!m.req(activeunit,activeunit.weapons[activeunit.activeweapon],targetunit)||"function"==typeof m.aiactivate&&1!=m.aiactivate(b,e)||("function"==typeof m.f&&m.f(),reroll(e,f,g,m,
l)))}return[]}};var sabine_fct=function(){var b=[];!this.hasionizationeffect()&&this.candoaction()&&(this.candoboost()&&b.push(this.newaction(this.resolveboost,"BOOST")),this.candoroll()&&b.push(this.newaction(this.resolveroll,"ROLL")),this.doaction(b,"free %BOOST% or %ROLL% action"))},zeb_fct=function(b,e){this.log("cancel %CRIT% first");b=this.cancelcritical(b,e);return b=Unit.prototype.cancelhit(b,e)},maarek_fct=function(){var b=this;Unit.prototype.wrap_after("deal",this,function(e,f,g){var h=$.Deferred();g.then(function(e){if(e.face==
FACEUP&&activeunit==b&&targetunit==this){e=this.selectdamage();CRITICAL_DECK[e].count--;var f=this.selectdamage();CRITICAL_DECK[f].count--;var g=this.selectdamage();CRITICAL_DECK[g].count--;sc=[e,f,g];b.log("select one critical");b.selectcritical(sc,function(b){h.resolve({crit:new Critical(this,b),face:FACEUP})}.bind(this))}else h.resolve(e)}.bind(this));return h.promise()})},poe_fct=function(){this.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return 0<this.focus}.bind(this),aiactivate:function(b,
e){return 0<FCH_focus(b)},f:function(b,e){return 0<FCH_focus(b)?(this.log("1 %FOCUS% -> 1 %HIT%"),b-FCH_FOCUS+FCH_HIT):b}.bind(this),str:"focus"});this.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,this,{req:function(b,e){return 0<this.focus}.bind(this),aiactivate:function(b,e){return 0<FE_focus(b)},f:function(b,e){return 0<FE_focus(b)?(this.log("1 %FOCUS% -> 1 %EVADE%"),b-FE_FOCUS+FE_EVADE):b}.bind(this),str:"focus"})},hera_fct=function(){var b=this.getmaneuver(),e={},f=this.getdial();e[b.move]=b;if(("RED"==
b.difficulty||"GREEN"==b.difficulty)&&(2>this.ionized&&this.islarge||0==this.ionized))for(var g=0;g<f.length;g++)f[g].difficulty==b.difficulty&&"undefined"==typeof e[f[g].move]&&(e[f[g].move]=f[g]);return e},PILOTS=[{name:"Contracted Scout",faction:SCUM,pilotid:0,done:!0,unit:"JumpMaster 5000",skill:3,points:25,upgrades:[ELITE,TORPEDO,TORPEDO,CREW,SALVAGED,ILLICIT]},{name:"Wedge Antilles",done:!0,unique:!0,faction:REBEL,unit:"X-Wing",skill:9,init:function(){this.wrap_before("resolveattack",this,function(b,
e){e.log("-1 defense [%0]",this.name);e.wrap_after("getagility",this,function(b){return 0<b?b-1:b}).unwrapper("cleanupattack");e.showstats()})},pilotid:1,points:29,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"Garven Dreis",done:!0,faction:REBEL,unique:!0,unit:"X-Wing",init:function(){this.wrap_after("removefocustoken",this,function(){this.selectunit(this.selectnearbyally(2),function(b,e){b[e].log("+1 %FOCUS%");b[e].addfocustoken()}.bind(this),["select unit for free %FOCUS%"],!1)})},pilotid:2,skill:6,
points:26,upgrades:[TORPEDO,ASTROMECH]},{name:"Red Squadron Pilot",done:!0,unit:"X-Wing",faction:REBEL,skill:4,points:23,pilotid:3,upgrades:[TORPEDO,ASTROMECH]},{name:"Rookie Pilot",done:!0,unit:"X-Wing",faction:REBEL,skill:2,points:21,pilotid:4,upgrades:[TORPEDO,ASTROMECH]},{name:"Turbolaser",done:!0,unit:"Turbolaser",faction:EMPIRE,skill:0,points:5,pilotid:5,upgrades:[]},{name:"Thermal Exhaust Port",done:!0,unit:"Exhaust Port",faction:EMPIRE,skill:0,points:100,pilotid:6,upgrades:[]},{name:"Biggs Darklighter",
done:!0,pilotid:7,init:function(){var b=this;Weapon.prototype.wrap_after("getenemiesinrange",this,function(e,f){"undefined"==typeof f&&(f=e,this.unit.selectnearbyenemy(3));if(1==this.unit.foundbiggs){for(var g=[],h=0;h<f.length;h++){var l=f[h];(l==b||1<l.getrange(b))&&g.push(l)}f=g}return f});Unit.prototype.wrap_after("getenemiesinrange",this,function(e,f,g){this.foundbiggs=!1;f=[];for(var h=0;h<e.length;h++)if(-1<g[h].indexOf(b)){this.foundbiggs=!0;break}if(this.foundbiggs)for(h=0;h<e.length;h++){f[h]=
[];for(var l=0;l<g[h].length;l++){var m=g[h][l];(m==b||1<m.getrange(b))&&f[h].push(m)}}else f=g;return f})},unique:!0,unit:"X-Wing",faction:REBEL,skill:5,points:25,upgrades:[TORPEDO,ASTROMECH]},{name:"Luke Skywalker",done:!0,pilotid:8,faction:REBEL,init:function(){this.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,this,{req:function(b,e){return!0},aiactivate:function(b,e){return 0<FE_focus(b)},f:function(b,e){0<FE_focus(b)&&(this.log("1 %FOCUS% -> 1 %EVADE%"),b=b-FE_FOCUS+FE_EVADE);return b}.bind(this),
str:"focus"})},unique:!0,unit:"X-Wing",skill:8,points:28,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"Gray Squadron Pilot",done:!0,faction:REBEL,unit:"Y-Wing",skill:4,pilotid:9,points:20,upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"'Dutch' Vander",done:!0,pilotid:10,init:function(){this.wrap_after("addtarget",this,function(b){this.selectunit(this.selectnearbyally(2),function(b,f){b[f].selectunit(b[f].gettargetableunits(3),function(b,e){-1<this.gettargetableunits(3).indexOf(b[e])&&this.addtarget(b[e])},
["select target to lock"],!1)},["select unit for free %TARGET% (or self to cancel)"],!0)})},faction:REBEL,unique:!0,unit:"Y-Wing",skill:6,points:23,upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"Horton Salm",done:!0,pilotid:11,faction:REBEL,unique:!0,unit:"Y-Wing",skill:8,points:25,init:function(){unit=this;this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank"],n:function(){return 9},req:function(b,e,f){b=this.getrange(f);return 2<=b&&3>=b?(this.log("reroll any blank result"),!0):
!1}.bind(this)})},upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"Gold Squadron Pilot",done:!0,pilotid:12,unit:"Y-Wing",faction:REBEL,skill:2,points:18,upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"Academy Pilot",done:!0,pilotid:13,unit:"TIE Fighter",faction:EMPIRE,skill:1,points:12,upgrades:[]},{name:"Obsidian Squadron Pilot",done:!0,pilotid:14,unit:"TIE Fighter",faction:EMPIRE,skill:3,points:13,upgrades:[]},{name:"Black Squadron Pilot",done:!0,pilotid:15,unit:"TIE Fighter",faction:EMPIRE,
skill:4,points:14,upgrades:[ELITE]},{name:"'Scourge'",unique:!0,beta:!0,done:!0,pilotid:16,unit:"TIE Fighter",faction:EMPIRE,skill:7,points:17,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){return 0<e.criticals.length?(this.log("+1 attack die for attacking damaged unit"),f+1):f})},upgrades:[ELITE]},{name:"'Winged Gundark'",faction:EMPIRE,pilotid:17,init:function(){this.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return 1==this.getrange(targetunit)}.bind(this),
aiactivate:function(b,e){return 0<FCH_hit(b)},f:function(b,e){0<FCH_hit(b)&&(this.log("1 %HIT% -> 1 %CRIT%"),b=b-FCH_HIT+FCH_CRIT);return b}.bind(this),str:"hit"})},done:!0,unique:!0,unit:"TIE Fighter",skill:5,points:15,upgrades:[]},{name:"'Night Beast'",faction:EMPIRE,done:!0,pilotid:18,init:function(){this.wrap_after("handledifficulty",this,function(b){"GREEN"==b&&this.candofocus()&&this.candoaction()&&this.doaction([this.newaction(this.addfocus,"FOCUS")],"green maneuver -> free focus action")})},
unique:!0,unit:"TIE Fighter",skill:5,points:15,upgrades:[]},{name:"'Backstabber'",unique:!0,done:!0,pilotid:19,faction:EMPIRE,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){e.isinfiringarc(this)||(f+=1,this.log("+1 attack against %0",e.name));return f})},unit:"TIE Fighter",skill:6,points:16,upgrades:[]},{name:"'Dark Curse'",done:!0,pilotid:20,faction:EMPIRE,unique:!0,init:function(){var b=this;this.wrap_after("isattackedby",this,function(e,f){f.wrap_after("canusefocus",b,
function(){return!1}).unwrapper("afterdefenseeffect");f.wrap_after("canusetarget",b,function(b){return!1}).unwrapper("afterdefenseeffect");f.wrap_after("getdicemodifiers",b,function(b){for(var e=[],f=0;f<b.length;f++)b[f].type!=REROLL_M&&e.push(b[f]);return e}).unwrapper("afterdefenseeffect")})},unit:"TIE Fighter",skill:6,points:16,upgrades:[]},{name:"'Mauler Mithel'",faction:EMPIRE,done:!0,pilotid:21,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){1==this.gethitrange(b,e)&&
(this.log("+1 attack against %0",e.name),f+=1);return f})},unique:!0,unit:"TIE Fighter",skill:7,points:17,upgrades:[ELITE]},{name:"'Howlrunner'",unique:!0,done:!0,pilotid:22,faction:EMPIRE,unit:"TIE Fighter",skill:8,init:function(){Unit.prototype.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus"],n:function(){return 1},req:function(b,e,f){return b!=this&&!this.dead&&1==b.getrange(this)&&b.isally(this)&&e.isprimary?(b.log("+%1 reroll(s) [%0]",this.name,1),!0):!1}.bind(this)})},
points:18,upgrades:[ELITE]},{name:"Maarek Stele",unique:!0,done:!0,pilotid:23,ambiguous:!0,faction:EMPIRE,edition:"TIE Advanced",unit:"TIE Advanced",skill:7,points:27,init:maarek_fct,upgrades:[ELITE,MISSILE]},{name:"Maarek Stele",unique:!0,done:!0,pilotid:24,ambiguous:!0,edition:"TIE Defender",faction:EMPIRE,unit:"TIE Defender",skill:7,points:35,init:maarek_fct,shipimg:"tie-defender-red.png",upgrades:[ELITE,CANNON,MISSILE]},{name:"Tempest Squadron Pilot",faction:EMPIRE,done:!0,pilotid:25,unit:"TIE Advanced",
skill:2,points:21,upgrades:[MISSILE]},{name:"Storm Squadron Pilot",faction:EMPIRE,done:!0,pilotid:26,unit:"TIE Advanced",skill:4,points:23,upgrades:[MISSILE]},{name:"Darth Vader",faction:EMPIRE,unique:!0,done:!0,pilotid:27,unit:"TIE Advanced",skill:9,init:function(){this.wrap_before("doendmaneuveraction",this,function(){this.log("+1 action [%0]",this.name);this.doaction(this.getactionlist(),"",this.candoendmaneuveraction)})},secaction:-1,points:29,upgrades:[ELITE,MISSILE]},{name:"Alpha Squadron Pilot",
faction:EMPIRE,done:!0,pilotid:28,unit:"TIE Interceptor",skill:1,points:18,upgrades:[]},{name:"Avenger Squadron Pilot",faction:EMPIRE,done:!0,pilotid:29,unit:"TIE Interceptor",skill:3,points:20,upgrades:[]},{name:"Saber Squadron Pilot",faction:EMPIRE,done:!0,pilotid:30,unit:"TIE Interceptor",skill:4,points:21,upgrades:["Elite"]},{name:"'Fel's Wrath'",faction:EMPIRE,unique:!0,unit:"TIE Interceptor",skill:5,pilotid:31,done:!0,init:function(){this.wrap_after("endcombatphase",this,function(){this.hasfired=
0;this.checkdead()});this.wrap_after("canbedestroyed",this,function(b,e){return-1==b})},points:23,upgrades:[]},{name:"Turr Phennir",faction:EMPIRE,unique:!0,done:!0,pilotid:32,unit:"TIE Interceptor",skill:7,init:function(){this.addafterattackeffect(this,function(){var b=[];this.candoboost()&&b.push(this.newaction(this.resolveboost,"BOOST"));this.candoroll()&&b.push(this.newaction(this.resolveroll,"ROLL"));this.doaction(b,"free %BOOST% or %ROLL% action")})},points:25,upgrades:[ELITE]},{name:"Soontir Fel",
faction:EMPIRE,unique:!0,done:!0,pilotid:33,init:function(){this.wrap_after("addstress",this,function(){this.log("+1 %STRESS% -> +1 %FOCUS%");this.addfocustoken()})},unit:"TIE Interceptor",skill:9,points:27,upgrades:[ELITE]},{name:"Tycho Celchu",faction:REBEL,unique:!0,pilotid:34,done:!0,init:function(){this.wrap_after("hasnostresseffect",this,function(){return!0})},unit:"A-Wing",skill:8,points:26,upgrades:[ELITE,MISSILE]},{name:"Arvel Crynyd",faction:REBEL,pilotid:35,unique:!0,done:!0,unit:"A-Wing",
init:function(){this.wrap_after("checkcollision",this,function(b){return!1})},skill:6,points:23,upgrades:[MISSILE]},{name:"Green Squadron Pilot",faction:REBEL,done:!0,unit:"A-Wing",skill:3,pilotid:36,points:19,upgrades:[ELITE,MISSILE]},{name:"Prototype Pilot",faction:REBEL,done:!0,pilotid:37,unit:"A-Wing",skill:1,points:17,upgrades:[MISSILE]},{name:"Outer Rim Smuggler",faction:REBEL,unit:"YT-1300",done:!0,pilotid:38,install:function(){this.hull=6;this.shield=4;this.weapons[0].attack=2},uninstall:function(){this.hull=
8;this.shield=5;this.weapons[0].attack=3},skill:1,points:27,upgrades:[CREW,CREW]},{name:"Chewbacca",unique:!0,done:!0,ambiguous:!0,faction:REBEL,unit:"YT-1300",skill:5,pilotid:39,points:42,deal:function(b,e){var f=$.Deferred();return e==FACEUP?(this.log("turn faceup damage facedown"),f.resolve({crit:b,face:FACEDOWN}).promise()):f.resolve({crit:b,face:e}).promise()},upgrades:[ELITE,MISSILE,CREW,CREW]},{name:"Lando Calrissian",faction:REBEL,unique:!0,unit:"YT-1300",skill:7,pilotid:40,points:44,init:function(){this.wrap_after("handledifficulty",
this,function(b){"GREEN"==b&&this.selectunit(this.selectnearbyally(1),function(b,f){b[f].log("+1 action [%0]",this.name);b[f].doaction(b[f].getactionbarlist(),"")}.bind(this),["select unit (or self to cancel) [%0]",this.name],!0)})},done:!0,upgrades:[ELITE,MISSILE,CREW,CREW]},{name:"Han Solo",unique:!0,done:!0,faction:REBEL,unit:"YT-1300",skill:9,pilotid:41,points:46,init:function(){this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus","hit","critical"],n:function(){return 9},
req:function(b,e,f){return!0},mustreroll:!0})},upgrades:[ELITE,MISSILE,CREW,CREW]},{name:"Kath Scarlet",unique:!0,faction:EMPIRE,unit:"Firespray-31",skill:7,pilotid:42,done:!0,init:function(){this.wrap_before("resolveattack",this,function(b,e){var f=this;e.wrap_after("cancelcritical",f,function(b,e,l){FCH_crit(b.ch)>FCH_crit(l.ch)&&(this.log("+1 %STRESS% for cancelling %CRIT% [%0]",f.name),this.addstress());return l}).unwrapper("afterdefenseeffect")})},points:38,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE]},
{name:"Boba Fett",unique:!0,done:!0,pilotid:43,faction:EMPIRE,init:function(){this.wrap_after("getmaneuverlist",this,function(b){if(this.hasionizationeffect())return b;for(var e=1;3>=e;e++)"undefined"!=typeof b["BL"+e]?(this.log("select %BANKLEFT% or %BANKRIGHT% turn"),b["BR"+e]={move:"BR"+e,difficulty:b["BL"+e].difficulty}):"undefined"!=typeof b["BR"+e]&&(this.log("select %BANKLEFT% or %BANKRIGHT% turn"),b["BL"+e]={move:"BL"+e,difficulty:b["BR"+e].difficulty});return b})},unit:"Firespray-31",skill:8,
points:39,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE]},{name:"Krassis Trelix",unique:!0,done:!0,pilotid:44,faction:EMPIRE,unit:"Firespray-31",init:function(){this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus"],n:function(){return 1},req:function(b,e,f){return e.isprimary?!1:(b.log("+%1 reroll(s) [%0]",b.name,1),!0)}})},skill:5,points:36,upgrades:[CANNON,BOMB,CREW,MISSILE]},{name:"Bounty Hunter",unit:"Firespray-31",skill:3,pilotid:45,done:!0,faction:EMPIRE,points:33,upgrades:[CANNON,
BOMB,CREW,MISSILE]},{name:"Ten Numb",faction:REBEL,unique:!0,done:!0,pilotid:46,unit:"B-Wing",skill:8,shipimg:"b-wing-1.png",init:function(){var b=this;this.wrap_before("resolveattack",this,function(e,f){f.wrap_after("cancelcritical",b,function(b,e,l){return 0<FCH_crit(b.ch)&&0==FCH_crit(l.ch)?(f.log("cannot cancel 1 %CRIT% [%0]",this.name),{ch:l.ch+FCH_CRIT,e:l.e+1}):l}.bind(this)).unwrapper("afterdefenseeffect")})},points:31,upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Ibtisam",unique:!0,
done:!0,faction:REBEL,unit:"B-Wing",skill:6,pilotid:47,points:28,shipimg:"b-wing-1.png",init:function(){var b={dice:["blank","focus"],n:function(){return 1},req:function(b,f,g){return 0<this.stress?(this.log("+%0 reroll",1),!0):!1}.bind(this)};this.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,b);this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,$.extend({},b))},upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Dagger Squadron Pilot",unit:"B-Wing",done:!0,pilotid:48,faction:REBEL,skill:4,
points:24,upgrades:[SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Blue Squadron Pilot",unit:"B-Wing",done:!0,faction:REBEL,skill:2,pilotid:49,points:22,upgrades:[SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Rebel Operative",unit:"HWK-290",done:!0,faction:REBEL,skill:2,pilotid:50,points:16,upgrades:[TURRET,CREW]},{name:"Roark Garnet",unique:!0,faction:REBEL,unit:"HWK-290",skill:4,pilotid:51,init:function(){this.wrap_after("begincombatphase",this,function(b){var e=this;this.selectunit(this.selectnearbyally(3),function(b,
g){b[g].log("has PS of 12");b[g].wrap_after("getskill",e,function(b){return 12}).unwrapper("endcombatphase")},["select unit [%0]",this.name],!1);return b})},done:!0,points:19,upgrades:[TURRET,CREW]},{name:"Kyle Katarn",faction:REBEL,unique:!0,done:!0,unit:"HWK-290",skill:6,pilotid:52,points:21,init:function(){this.wrap_after("begincombatphase",this,function(b){this.canusefocus()&&this.selectunit(this.selectnearbyally(3),function(b,f){this.removefocustoken();b[f].addfocustoken();b[f].log("+1 %FOCUS%")},
["select unit for free %FOCUS% (or self to cancel)"],!0);return b})},upgrades:[ELITE,TURRET,CREW]},{name:"Jan Ors",faction:REBEL,unique:!0,done:!0,pilotid:53,unit:"HWK-290",skill:8,init:function(){var b=this;Unit.prototype.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,this,{req:function(e,f){return 0==b.stress&&!b.dead&&activeunit.isally(b)&activeunit!=b&&3>=b.getrange(activeunit)},f:function(e,f){var g=b.rollattackdie(1,b,"critical")[0];b.addstress();activeunit.log("+1 attack die [%0]",b.name);return"focus"==
g?{m:e+FCH_FOCUS,n:f+1}:"hit"==g?{m:e+FCH_HIT,n:f+1}:"critical"==g?{m:e+FCH_CRIT,n:f+1}:{m:e,n:f+1}},str:"hit"})},points:25,upgrades:[ELITE,TURRET,CREW]},{name:"Scimitar Squadron Pilot",done:!0,unit:"TIE Bomber",skill:2,pilotid:54,faction:EMPIRE,points:16,upgrades:[TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Gamma Squadron Pilot",done:!0,pilotid:55,unit:"TIE Bomber",faction:EMPIRE,skill:4,points:18,upgrades:[TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Captain Jonus",faction:EMPIRE,done:!0,pilotid:56,
init:function(){Unit.prototype.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus"],n:function(){return 2},req:function(b,e,f){return b!=this&&!this.dead&&1==b.getrange(this)&&b.isally(this)&&1!=e.isprimary?(b.log("+%1 reroll(s) [%0]",this.name,2),!0):!1}.bind(this)})},unique:!0,unit:"TIE Bomber",skill:6,points:22,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Major Rhymer",done:!0,pilotid:57,faction:EMPIRE,init:function(){for(var b=0;b<this.weapons.length;b++)this.weapons[b].wrap_after("getlowrange",
this,function(b){1<b&&--b;return b}),this.weapons[b].wrap_after("gethighrange",this,function(b){3>b&&(b+=1);return b});this.log("extending weapon ranges")},unique:!0,unit:"TIE Bomber",skill:7,points:26,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Captain Kagi",faction:EMPIRE,unique:!0,done:!0,pilotid:58,init:function(){var b=this;Unit.prototype.wrap_after("gettargetableunits",this,function(e,f){-1<f.indexOf(b)&&!b.dead&&(f=[b]);return f})},unit:"Lambda-Class Shuttle",skill:8,points:27,
upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Colonel Jendon",faction:EMPIRE,pilotid:59,init:function(){this.wrap_after("begincombatphase",this,function(b){0<this.targeting.length&&this.selectunit(this.selectnearbyally(1),function(b,f){var e=this.targeting[0];b[f].addtarget(e);this.removetarget(e);b[f].log("+%1 %TARGET% / %0",e.name,1)},["select unit to move %TARGET% (or self to cancel)"],!0);return b})},done:!0,unique:!0,unit:"Lambda-Class Shuttle",skill:6,points:26,upgrades:[SYSTEM,CANNON,CREW,CREW]},
{name:"Captain Yorr",faction:EMPIRE,pilotid:60,unique:!0,done:!0,unit:"Lambda-Class Shuttle",skill:4,init:function(){var b=this;Unit.prototype.wrap_after("addstress",this,function(){-1<this.selectnearbyally(2).indexOf(b)&&2>=b.stress&&!b.dead&&(this.log("%STRESS% -> %0 [%0]",b.name),this.removestresstoken(),this.showinfo(),b.addstress(),b.showinfo())})},points:24,upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Omicron Group Pilot",faction:EMPIRE,done:!0,unit:"Lambda-Class Shuttle",skill:2,pilotid:61,points:21,
upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Lieutenant Lorrir",faction:EMPIRE,unique:!0,done:!0,pilotid:62,unit:"TIE Interceptor",skill:5,points:23,resolveroll:function(b){for(var e=[],f=-20;20>=f;f+=20)var g=this.m.clone().translate(0,f).rotate(90,0,0),h=this.m.clone().translate(0,f).rotate(-90,0,0),e=e.concat([this.getpathmatrix(g,"BR1").rotate(-90,0,0),this.getpathmatrix(h,"BR1").rotate(90,0,0),this.getpathmatrix(g,"BL1").rotate(-90,0,0),this.getpathmatrix(h,"BL1").rotate(90,0,0)]);e=e.concat(this.getrollmatrix(this.m));
this.resolveactionmove(e,function(e,f){12>f&&e.addstress();e.endaction(b,"ROLL")},!0,this.canmoveonobstacles("ROLL"));return!0},upgrades:[]},{name:"Royal Guard Pilot",faction:EMPIRE,shipimg:"tie-interceptor-1.png",done:!0,pilotid:63,unit:"TIE Interceptor",skill:6,points:22,upgrades:[ELITE]},{name:"Tetran Cowall",faction:EMPIRE,unique:!0,done:!0,pilotid:64,init:function(){this.wrap_after("getmaneuverlist",this,function(b){var e=!1,f,g;for(g in b)if(g.match(/K/)){e=!0;f=b[g];break}if(e&&!this.hasionizationeffect())for(this.log("select %UTURN% speed"),
g=1;5>=g;g+=2)"undefined"==typeof b["K"+g]&&(b["K"+g]={move:"K"+g,difficulty:f.difficulty,halfturn:!1});return b})},unit:"TIE Interceptor",skill:7,points:24,upgrades:[ELITE]},{name:"Kir Kanos",faction:EMPIRE,shipimg:"tie-interceptor-1.png",pilotid:65,init:function(){this.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,this,{req:function(b,e){var f=this.getrange(targetunit);return 3>=f&&2<=f&&this.canuseevade()}.bind(this),f:function(b,e){this.removeevadetoken();this.log("+1 %HIT% for attacking at range 2-3");
return{m:b+FCH_HIT,n:e+1}}.bind(this),str:"evade"})},done:!0,unique:!0,unit:"TIE Interceptor",skill:6,points:24,upgrades:[]},{name:"Carnor Jax",faction:EMPIRE,pilotid:66,init:function(){var b=this;Unit.prototype.wrap_after("canusefocus",this,function(e){return 1==this.getrange(b)&&this.isenemy(b)&&!b.dead?!1:e});Unit.prototype.wrap_after("canuseevade",this,function(e){return 1==this.getrange(b)&&this.isenemy(b)&&!b.dead?!1:e});Unit.prototype.wrap_after("candofocus",this,function(e){return 1==this.getrange(b)&&
this.isenemy(b)&&!b.dead?!1:e});Unit.prototype.wrap_after("candoevade",this,function(e){return 1==this.getrange(b)&&this.isenemy(b)&&!b.dead?!1:e})},unique:!0,done:!0,unit:"TIE Interceptor",shipimg:"tie-interceptor-1.png",skill:8,points:26,upgrades:[ELITE]},{name:"Bandit Squadron Pilot",faction:REBEL,pilotid:67,done:!0,unit:"Z-95 Headhunter",skill:2,points:12,upgrades:[MISSILE]},{name:"Tala Squadron Pilot",faction:REBEL,pilotid:68,done:!0,unit:"Z-95 Headhunter",skill:4,points:13,upgrades:[MISSILE]},
{name:"Lieutenant Blount",faction:REBEL,pilotid:69,done:!0,init:function(){this.wrap_after("hashit",this,function(b,e){0==this.criticalresolved+this.hitresolved&&this.log("%0 is hit",targetunit.name);return!0})},unique:!0,unit:"Z-95 Headhunter",skill:6,points:17,upgrades:[ELITE,MISSILE]},{name:"Airen Cracken",faction:REBEL,pilotid:70,done:!0,init:function(){this.addafterattackeffect(this,function(){var b=this.selectnearbyally(1,function(b,f){return f.candoaction()});0<b.length&&this.doselection(function(e){this.log("select unit for a free action"+
b.length);this.resolveactionselection(b,function(f){var g=b[f].getactionlist();0<g.length?b[f].doaction(g,"").done(function(){this.select()}.bind(this)):this.select();this.endnoaction(e,"")}.bind(this))}.bind(this))})},unique:!0,unit:"Z-95 Headhunter",skill:8,points:19,upgrades:[ELITE,MISSILE]},{name:"Delta Squadron Pilot",faction:EMPIRE,pilotid:71,done:!0,unit:"TIE Defender",skill:1,points:30,upgrades:[CANNON,MISSILE]},{name:"Glaive Squadron Pilot",faction:EMPIRE,done:!0,pilotid:72,unit:"TIE Defender",
skill:6,points:34,upgrades:[ELITE,CANNON,MISSILE],shipimg:"tie-defender-red.png"},{name:"Onyx Squadron Pilot",done:!0,faction:EMPIRE,pilotid:73,unit:"TIE Defender",skill:3,points:32,upgrades:[CANNON,MISSILE]},{name:"Colonel Vessery",done:!0,pilotid:74,faction:EMPIRE,init:function(){this.wrap_after("attackroll",this,function(b,e){0<targetunit.istargeted.length&&0==this.targeting.length&&(this.addtarget(targetunit),this.log("+%1 %TARGET% / %0",targetunit.name,1));return e})},unique:!0,unit:"TIE Defender",
skill:6,points:35,upgrades:[ELITE,CANNON,MISSILE]},{name:"Rexler Brath",faction:EMPIRE,done:!0,pilotid:75,init:function(){this.addafterattackeffect(this,function(b,e){this.canusefocus()&&0<this.hitresolved&&(this.log("-1 %FOCUS%, %0 damage -> %0 critical(s)",e),this.donoaction([{name:this.name,org:this,type:"FOCUS",action:function(b){var e=targetunit.criticals.length-1;this.removefocustoken();for(var f=0;f<this.hitresolved;f++)this.log(targetunit.criticals[e-f-this.criticalresolved].name),targetunit.criticals[e-
f-this.criticalresolved].faceup();targetunit.checkdead();targetunit.show();this.endnoaction(b,"")}.bind(this)}],"",!0))})},unique:!0,unit:"TIE Defender",skill:8,points:37,upgrades:[ELITE,CANNON,MISSILE]},{name:"Knave Squadron Pilot",faction:REBEL,done:!0,pilotid:76,unit:"E-Wing",skill:1,points:27,upgrades:[SYSTEM,TORPEDO,ASTROMECH]},{name:"Blackmoon Squadron Pilot",pilotid:77,faction:REBEL,done:!0,unit:"E-Wing",skill:3,points:29,upgrades:[SYSTEM,TORPEDO,ASTROMECH]},{name:"Etahn A'baht",done:!0,pilotid:78,
faction:REBEL,init:function(){var b=this;Unit.prototype.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(e,f){return b.isally(activeunit)&&!b.dead&&b.isinfiringarc(targetunit)},aiactivate:function(b,f){return FCH_hit(b)},f:function(e,f){return 0<FCH_hit(e)?(this.log("1 %HIT% -> 1 %CRIT% [%0]",b.name),e+FCH_CRIT-FCH_HIT):e},str:"hit"})},unique:!0,unit:"E-Wing",skill:5,points:32,upgrades:[ELITE,SYSTEM,TORPEDO,ASTROMECH]},{name:"Corran Horn",faction:REBEL,done:!0,pilotid:79,init:function(){this.addattack(function(){return!0},
this,this.weapons,function(){this.log("no attack next round");this.noattack=round+1},null,"endcombatphase")},unique:!0,unit:"E-Wing",skill:8,points:35,upgrades:[ELITE,SYSTEM,TORPEDO,ASTROMECH]},{name:"Sigma Squadron Pilot",faction:EMPIRE,pilotid:80,done:!0,unit:"TIE Phantom",skill:3,points:25,upgrades:[SYSTEM,CREW]},{name:"Shadow Squadron Pilot",done:!0,faction:EMPIRE,pilotid:81,unit:"TIE Phantom",skill:5,points:27,upgrades:[SYSTEM,CREW]},{name:"'Echo'",faction:EMPIRE,done:!0,pilotid:82,getdecloakmatrix:function(b){var e;
e=this.getpathmatrix(b,"BL2");var f=this.getpathmatrix(b,"BR2"),f=[this.m,e,f];for(e=-20;20>=e;e+=20)var g=b.clone().translate(0,e).rotate(90,0,0),h=b.clone().translate(0,e).rotate(-90,0,0),f=f.concat([this.getpathmatrix(g,"BL2").rotate(-90,0,0),this.getpathmatrix(g,"BR2").rotate(-90,0,0),this.getpathmatrix(h,"BL2").rotate(90,0,0),this.getpathmatrix(h,"BR2").rotate(90,0,0)]);return f},unique:!0,unit:"TIE Phantom",skill:6,points:30,upgrades:[ELITE,SYSTEM,CREW]},{name:"'Whisper'",faction:EMPIRE,done:!0,
pilotid:83,init:function(){this.wrap_after("hashit",this,function(b,e){e&&(this.log("+1 %FOCUS%"),this.addfocustoken());return e})},unique:!0,unit:"TIE Phantom",skill:7,points:32,upgrades:[ELITE,SYSTEM,CREW]},{name:"Wes Janson",done:!0,pilotid:84,init:function(){this.wrap_before("cleanupattack",this,function(){0<targetunit.targeting.length?(targetunit.log("-1 %TARGET% [%0]",this.name),targetunit.removetarget(targetunit.targeting[0])):0<targetunit.focus?(targetunit.log("-1 %FOCUS% [%0]",this.name),
targetunit.removefocustoken()):0<targetunit.evade&&(targetunit.log("-1 %EVADE% [%0]",this.name),targetunit.removeevadetoken())})},faction:REBEL,unique:!0,unit:"X-Wing",skill:8,points:29,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"Jek Porkins",done:!0,pilotid:85,init:function(){this.wrap_after("addstress",this,function(){this.removestresstoken();var b=this.rollattackdie(1,this,"blank")[0];this.log("-1 %STRESS%, roll 1 attack dice");"hit"==b&&(this.applyhit(1),this.checkdead())})},faction:REBEL,unique:!0,
unit:"X-Wing",skill:7,points:26,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"'Hobbie' Klivian",faction:REBEL,done:!0,pilotid:86,init:function(){this.wrap_before("removetarget",this,function(b){this.stress&&(this.log("-1 %TARGET% -> -1 %STRESS%"),this.removestresstoken())});this.wrap_before("addtarget",this,function(b){this.stress&&(this.removestresstoken(),this.log("+1 %TARGET% -> -1 %STRESS%"))})},unique:!0,unit:"X-Wing",skill:5,points:25,upgrades:[TORPEDO,ASTROMECH]},{name:"Tarn Mison",done:!0,pilotid:87,
init:function(){this.wrap_after("isattackedby",this,function(b,e){if(0==this.targeting.length||this.getskill()<e.getskill())this.log("+%1 %TARGET% / %0",e.name,1),this.addtarget(e)})},faction:REBEL,unique:!0,unit:"X-Wing",skill:3,points:23,upgrades:[TORPEDO,ASTROMECH]},{name:"Jake Farrell",faction:REBEL,done:!0,pilotid:88,freemove:function(){var b=[];this.candoboost()&&b.push(this.newaction(this.resolveboost,"BOOST"));this.candoroll()&&b.push(this.newaction(this.resolveroll,"ROLL"));this.doaction(b,
"free %BOOST% or %ROLL% action")},init:function(){this.wrap_before("addfocustoken",this,function(){this.candoaction()&&this.freemove()})},unique:!0,unit:"A-Wing",skill:7,points:24,upgrades:[ELITE,MISSILE]},{name:"Gemmer Sojan",done:!0,pilotid:89,init:function(){this.wrap_after("getagility",this,function(b){return 0<this.selectnearbyenemy(1).length?b+1:b})},faction:REBEL,unique:!0,unit:"A-Wing",skill:5,points:22,upgrades:[MISSILE]},{name:"Keyan Farlander",faction:REBEL,done:!0,pilotid:90,shipimg:"b-wing-1.png",
init:function(){this.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return 0<this.stress}.bind(this),aiactivate:function(b,e){return!0},f:function(b,e){var f=FCH_focus(b);this.removestresstoken();return 0<f?(this.log("%0 %FOCUS% -> %0 %HIT%, -1 %STRESS%",f),b-FCH_FOCUS*f+FCH_HIT*f):b}.bind(this),str:"stress",noreroll:"focus"})},unique:!0,unit:"B-Wing",skill:7,points:29,upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Nera Dantels",faction:REBEL,done:!0,pilotid:91,shipimg:"b-wing-1.png",
init:function(){this.log("can fire %TORPEDO% at 360 degrees");this.wrap_after("isTurret",this,function(b,e){return b.type==TORPEDO?!0:e})},unique:!0,unit:"B-Wing",skill:5,points:26,upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Wild Space Fringer",done:!0,pilotid:92,faction:REBEL,unit:"YT-2400",skill:2,points:30,upgrades:[CANNON,MISSILE,CREW]},{name:"Eaden Vrill",done:!0,pilotid:93,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){return 0<e.stress&&this.weapons[b].isprimary?
(this.log("+1 attack die"),f+1):f})},faction:REBEL,unit:"YT-2400",unique:!0,skill:3,points:32,upgrades:[CANNON,MISSILE,CREW]},{name:"'Leebo'",faction:REBEL,done:!0,pilotid:94,init:function(){this.wrap_after("deal",this,function(b,e,f){var g=$.Deferred();f.then(function(b){if(b.face==FACEUP){b=this.selectdamage();CRITICAL_DECK[b].count--;var e=this.selectdamage();CRITICAL_DECK[e].count--;b=[b,e];this.log("select one critical");this.selectcritical(b,function(b){g.resolve({crit:new Critical(this,b),
face:FACEUP})}.bind(this))}else g.resolve(b)}.bind(this));return g.promise()})},unit:"YT-2400",unique:!0,skill:5,points:34,upgrades:[ELITE,CANNON,MISSILE,CREW]},{name:"Dash Rendar",faction:REBEL,pilotid:95,unit:"YT-2400",unique:!0,skill:7,done:!0,init:function(){this.wrap_after("hascollidedobstacle",this,function(b){return!1});this.wrap_after("canmoveonobstacles",this,function(){return!0})},points:36,upgrades:[ELITE,CANNON,MISSILE,CREW]},{name:"Patrol Leader",faction:EMPIRE,done:!0,pilotid:96,unit:"VT-49 Decimator",
skill:3,points:40,upgrades:[TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Captain Oicunn",faction:EMPIRE,unit:"VT-49 Decimator",skill:4,points:42,pilotid:97,unique:!0,done:!0,init:function(){this.wrap_before("resolvecollision",this,function(){for(var b=0;b<this.touching.length;b++){var e=this.touching[b];e.isenemy(this)&&(e.log("+1 %HIT% [%0]",this.name),e.resolvehit(1),e.checkdead())}})},upgrades:[ELITE,TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Commander Kenkirk",faction:EMPIRE,pilotid:98,init:function(){this.wrap_after("getagility",
this,function(b){return 0<this.criticals.length?b+1:b})},done:!0,unit:"VT-49 Decimator",skill:6,points:44,unique:!0,upgrades:[ELITE,TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Rear Admiral Chiraneau",pilotid:99,init:function(){this.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return 2>=this.getrange(targetunit)}.bind(this),aiactivate:function(b,e){return FCH_focus(b)},f:function(b,e){return 0<FCH_focus(b)?(this.log("1 %FOCUS% -> 1 %CRIT%"),b-FCH_FOCUS+FCH_CRIT):b}.bind(this),str:"hit"})},
faction:EMPIRE,unit:"VT-49 Decimator",skill:8,points:46,done:!0,unique:!0,upgrades:[ELITE,TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Prince Xizor",faction:SCUM,pilotid:100,modifydamageassigned:function(b,e){var f=[];if(0==b)return 0;f=this.selectnearbyally(1);if(0<f.length){f.sort(function(b,e){hpa=b.hull+b.shield;hpb=e.hull+e.shield;return hpa<hpb?1:hpa>hpb?-1:0});if(10<=b)return f[0].resolvecritical(1),this.log("-1 %CRIT%"),f[0].log("+1 %CRIT% [%0]",this.name),b-10;f[0].resolvehit(1);f[0].checkdead();
this.log("-1 %HIT%");f[0].log("+%1 %HIT% [%0]",this.name,1);return b-1}return b},unique:!0,done:!0,unit:"StarViper",skill:7,points:31,upgrades:[ELITE,TORPEDO]},{name:"Guri",faction:SCUM,pilotid:101,init:function(){this.wrap_after("begincombatphase",this,function(b){0<this.selectnearbyenemy(1).length&&(this.log("+1 %FOCUS%, ennemy at range 1"),this.addfocustoken());return b})},done:!0,unique:!0,unit:"StarViper",skill:5,points:30,upgrades:[ELITE,TORPEDO]},{name:"Black Sun Vigo",faction:SCUM,done:!0,
pilotid:102,unit:"StarViper",skill:3,points:27,upgrades:[TORPEDO]},{name:"Black Sun Enforcer",faction:SCUM,pilotid:103,done:!0,unit:"StarViper",skill:1,points:25,upgrades:[TORPEDO]},{name:"Serissu",faction:SCUM,pilotid:104,done:!0,init:function(){var b=this;Unit.prototype.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,{dice:["blank","focus"],n:function(){return 1},req:function(e,f,g){return g==this||b.dead||this.dead||1!=g.getrange(this)||!g.isally(this)?!1:(g.log("+%1 reroll(s) [%0]",this.name,
1),!0)}.bind(this)})},unit:"M3-A Interceptor",skill:8,points:20,unique:!0,upgrades:[ELITE]},{name:"Laetin A'shera",faction:SCUM,pilotid:105,init:function(){this.addafterdefenseeffect(this,function(b,e,f){0==b+e&&(this.log("0 %HIT%, +1 %EVADE%"),this.addevadetoken())})},done:!0,unit:"M3-A Interceptor",skill:6,points:18,unique:!0,upgrades:[]},{name:"Tansarii Point Veteran",faction:SCUM,pilotid:106,done:!0,unit:"M3-A Interceptor",skill:5,points:17,upgrades:[ELITE]},{name:"Cartel Spacer",faction:SCUM,
pilotid:107,done:!0,unit:"M3-A Interceptor",skill:2,points:14,upgrades:[]},{name:"IG-88A",faction:SCUM,pilotid:108,unique:!0,unit:"Aggressor",skill:6,points:36,init:function(b){this.addafterattackeffect(this,function(e,f){("undefined"==typeof b||!b.dead)&&targetunit.dead&&this.shield<this.ship.shield&&(this.addshield(1),this.showstats(),this.log("+1 %SHIELD% for a kill"))})},done:!0,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"IG-88B",faction:SCUM,pilotid:109,done:!0,init:function(b){var e=
[];this.ig88battack=-1;for(var f=0;f<this.weapons.length;f++){var g=this.weapons[f];"Cannon"==g.type&&g.isWeapon()&&e.push(g)}if(0!=e.length)for(f in this.weapons.indexOf(e[0]),this.weapons)this.addattack(function(e,f){return 0==e+f&&this.ig88battack<round&&("undefined"==typeof b||!b.dead)},{name:"IG-88B"},e,function(){this.ig88battack=round},function(){return squadron})},unique:!0,unit:"Aggressor",skill:6,points:36,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"IG-88C",faction:SCUM,pilotid:110,
init:function(b){this.wrap_before("resolveboost",this,function(){"undefined"!=typeof b&&b.dead||(this.log("free %EVADE% action [%0]","IG-88C"),this.doselection(function(b){this.addevade(b)}.bind(this)))})},done:!0,unique:!0,unit:"Aggressor",skill:6,points:36,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"IG-88D",faction:SCUM,pilotid:111,init:function(b){this.wrap_after("getmaneuverlist",this,function(e){"undefined"==typeof e.SL3||"undefined"!=typeof b&&b.dead||(this.log("%SLOOPLEFT% or %TURNLEFT% maneuver"),
e.TL3={move:"TL3",halfturn:!0,difficulty:e.SL3.difficulty});"undefined"!=typeof e.SR3&&(this.log("%SLOOPRIGHT% or %TURNRIGHT% maneuver"),e.TR3={move:"TR3",halfturn:!0,difficulty:e.SR3.difficulty});return e})},unique:!0,done:!0,unit:"Aggressor",skill:6,points:36,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"N'Dru Suhlak",unique:!0,done:!0,pilotid:112,faction:SCUM,init:function(){var b=this.getattackstrength;this.getattackstrength=function(e,f){var g=b.call(this,e,f);return 0==this.selectnearbyally(2).length?
(this.log("+1 attack against %0, at range >=3 of friendly ships",f.name),g+1):g}.bind(this)},unit:"Z-95 Headhunter",skill:7,points:17,upgrades:[ELITE,MISSILE,ILLICIT]},{name:"Kaa'To Leeachos",unique:!0,pilotid:113,faction:SCUM,done:!0,init:function(){this.wrap_after("begincombatphase",this,function(b){var e=this.selectnearbyally(2);this.selectunit(e,function(b,e){0<b[e].evade?(b[e].removeevadetoken(),this.addevadetoken(),b[e].log("-1 %EVADE% [%0]",this.name),this.log("+1 %EVADE%")):0<b[e].focus&&
(b[e].removefocustoken(),this.addfocustoken(),b[e].log("-1 %FOCUS% [%0]",this.name),this.log("+1 %FOCUS%"))},["select %FOCUS%/%EVADE% to take (or self to cancel)"],!0);return b})},unit:"Z-95 Headhunter",skill:5,points:15,upgrades:[ELITE,MISSILE,ILLICIT]},{name:"Black Sun Soldier",faction:SCUM,pilotid:114,done:!0,unit:"Z-95 Headhunter",skill:3,points:13,upgrades:[MISSILE,ILLICIT]},{name:"Binayre Pirate",faction:SCUM,pilotid:115,done:!0,unit:"Z-95 Headhunter",skill:1,points:12,upgrades:[MISSILE,ILLICIT]},
{name:"Boba Fett",faction:SCUM,pilotid:116,unit:"Firespray-31",skill:8,points:39,init:function(){var b={dice:["blank","focus"],n:function(){var b=0,f;for(f in squadron){var g=squadron[f];1==this.getrange(g)&&this.isenemy(g)&&b++}return b}.bind(this),req:function(b,f,g){return!0}};this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,b);this.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,$.extend({},b))},done:!0,unique:!0,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Kath Scarlet",done:!0,
pilotid:117,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){this.isinfiringarc(e)&&4==this.getprimarysector(e)&&(this.log("+1 attack die against %0 in auxiliary arc",e.name),f+=1);return f})},unique:!0,faction:SCUM,unit:"Firespray-31",skill:7,points:38,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Emon Azzameen",done:!0,unique:!0,pilotid:118,getbomblocation:function(){return["F1","TL3","TR3","F3"]},faction:SCUM,unit:"Firespray-31",skill:6,points:36,upgrades:[CANNON,
BOMB,CREW,MISSILE,ILLICIT]},{name:"Mandalorian Mercenary",faction:SCUM,pilotid:119,done:!0,unit:"Firespray-31",skill:5,points:35,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Kavil",unique:!0,done:!0,pilotid:120,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){return this.isinfiringarc(e)?f:(this.log("+1 attack die against %0 outside firing arc",e.name),f+1)})},faction:SCUM,unit:"Y-Wing",skill:7,points:24,upgrades:[ELITE,TURRET,TORPEDO,TORPEDO,SALVAGED]},{name:"Drea Renthal",
unique:!0,pilotid:121,faction:SCUM,unit:"Y-Wing",skill:5,done:!0,init:function(){this.wrap_before("removetarget",this,function(b){this.selectunit(this.gettargetableunits(3),function(b,f){-1==this.targeting.indexOf(b[f])&&(this.addtarget(b[f]),this.addstress())},["select unit to target, +1 %STRESS% (or self to cancel)"],!0)})},points:22,upgrades:[TURRET,TORPEDO,TORPEDO,SALVAGED]},{name:"Hired Gun",faction:SCUM,pilotid:122,done:!0,unit:"Y-Wing",skill:4,points:20,upgrades:[TURRET,TORPEDO,TORPEDO,SALVAGED]},
{name:"Syndicate Thug",faction:SCUM,pilotid:123,done:!0,unit:"Y-Wing",skill:2,points:18,upgrades:[TURRET,TORPEDO,TORPEDO,SALVAGED]},{name:"Dace Bonearm",unique:!0,pilotid:124,faction:SCUM,unit:"HWK-290",done:!0,init:function(){var b=this;Unit.prototype.wrap_after("addiontoken",this,function(){!b.dead&&3>=this.getrange(b)&&b.isenemy(this)&&0==b.stress&&(b.addstress(),this.resolvehit(1),b.log("+1 %STRESS%"),this.log("+%1 %HIT% [%0]",b.name,1),this.checkdead())})},skill:7,points:23,upgrades:[ELITE,TURRET,
CREW,ILLICIT]},{name:"Palob Godalhi",unique:!0,pilotid:125,faction:SCUM,unit:"HWK-290",init:function(){this.wrap_after("begincombatphase",this,function(b){this.selectunit(this.selectnearbyenemy(2),function(b,f){0<b[f].evade?(b[f].removeevadetoken(),this.addevadetoken(),b[f].log("-1 %EVADE% [%0]",this.name),this.log("+1 %EVADE%")):0<b[f].focus&&(b[f].removefocustoken(),this.addfocustoken(),b[f].log("-1 %FOCUS% [%0]",this.name),this.log("+1 %FOCUS%"))},["select %FOCUS%/%EVADE% to take (or self to cancel)"],
!0);return b})},done:!0,skill:5,points:20,upgrades:[ELITE,TURRET,CREW,ILLICIT]},{name:"Torkil Mux",unique:!0,pilotid:126,done:!0,init:function(){this.wrap_after("endactivationphase",this,function(){this.selectunit(this.selectnearbyenemy(2),function(b,e){b[e].wrap_after("getskill",this,function(b){return 0}).unwrapper("endcombatphase")},["select unit for a 0 PS"],!1)})},faction:SCUM,unit:"HWK-290",skill:3,points:19,upgrades:[TURRET,CREW,ILLICIT]},{name:"Spice Runner",faction:SCUM,pilotid:127,done:!0,
unit:"HWK-290",skill:1,points:16,upgrades:[TURRET,CREW,ILLICIT]},{name:"Commander Alozen",faction:EMPIRE,pilotid:128,unit:"TIE Advanced",unique:!0,done:!0,skill:5,points:25,init:function(){this.wrap_after("begincombatphase",this,function(b){this.selectunit(this.gettargetableunits(1),function(b,f){this.addtarget(b[f]);this.log("+%1 %TARGET% / %0",b[f].name,1)},["select unit to lock (or self to cancel)"],!0);return b})},upgrades:[ELITE,MISSILE]},{name:"Juno Eclipse",unique:!0,pilotid:129,done:!0,faction:EMPIRE,
unit:"TIE Advanced",skill:8,points:28,getmaneuverlist:function(){var b=this.getmaneuver(),e={};e[b.move]=b;if(this.hasionizationeffect())return e;for(var f=parseInt(b.move.substr(-1),10),g=-1;1>=g;g++){var h=b.move.replace(/\d/,f+g+"");"undefined"!=typeof P[h]&&(e[h]={move:h,difficulty:b.difficulty,halfturn:b.halfturn})}return e},upgrades:[ELITE,MISSILE]},{name:"Zertik Strom",unique:!0,pilotid:130,done:!0,faction:EMPIRE,unit:"TIE Advanced",skill:6,init:function(){var b=this;Weapon.prototype.wrap_after("getrangeattackbonus",
this,function(e,f){return this.unit.isenemy(b)&&1==b.getrange(this.unit)?(this.unit.log("0 attack range bonus [%0]",b.name),0):f});Weapon.prototype.wrap_after("getrangedefensebonus",this,function(e,f){return this.unit.isenemy(b)&&1==b.getrange(this.unit)?(this.unit.log("0 defense range bonus [%0]",b.name),0):f})},points:26,upgrades:[ELITE,MISSILE]},{name:"Lieutenant Colzet",unique:!0,pilotid:131,faction:EMPIRE,unit:"TIE Advanced",skill:3,points:23,upgrades:[MISSILE],done:!0,init:function(){this.wrap_after("endcombatphase",
this,function(){this.selectunit(this.targeting,function(b,e){if(this.canusetarget(b[e])){var f=b[e].criticals;this.removetarget(b[e]);0<f.length&&f[rand(f.length)].faceup()}},["select unit (or self to cancel)"],!0)})}},{name:"Bossk",faction:SCUM,pilotid:132,unit:"YV-666",unique:!0,skill:7,points:35,done:!0,init:function(){this.wrap_after("hashit",this,function(b,e){var f=this.criticalresolved+this.hitresolved;e&&0<this.criticalresolved&&(f<=b.shield||2>=b.hull&&f>b.shield?(this.criticalresolved--,
this.hitresolved+=2,this.log("1 %CRIT% -> 2 %HIT%")):this.log("%0 %SHIELD% are down, more than 2 %HULL%: keeping critical",b.name));return e})},upgrades:[ELITE,CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Moralo Eval",faction:SCUM,pilotid:133,unit:"YV-666",unique:!0,skill:6,points:34,done:!0,init:function(){for(var b=0;b<this.weapons.length;b++)"Cannon"==this.weapons[b].type&&(this.log("can fire %0 in auxiliary firing arc",this.weapons[b].name),this.weapons[b].auxiliary=this.weapons[0].auxiliary,
this.weapons[b].subauxiliary=this.weapons[0].subauxiliary)},upgrades:[CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Latts Razzi",faction:SCUM,pilotid:134,unit:"YV-666",unique:!0,skill:5,points:33,done:!0,init:function(){var b=this;Unit.prototype.wrap_after("declareattack",this,function(e,f,g){if(!g)return g;!b.dead&&b.isally(this)&&b.canusetarget(f)&&b.donoaction([this.newaction(function(e){this.removetarget(f);f.wrap_after("getdefensestrength",b,function(b,e,f){return 0<f?f-1:f}).unwrapper("afterdefenseeffect");
this.endnoaction(e,"TARGET")}.bind(b),"TARGET")],b.name+": -1 agility for "+f.name,!0);return g})},upgrades:[CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Trandoshan Slaver",faction:SCUM,pilotid:135,unit:"YV-666",done:!0,skill:2,points:29,upgrades:[CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Talonbane Cobra",unique:!0,faction:SCUM,pilotid:136,unit:"Kihraxz Fighter",skill:9,upgrades:[ELITE,MISSILE,ILLICIT],done:!0,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){return f+
this.weapons[b].getrangeattackbonus(e)});this.wrap_after("getdefensestrength",this,function(b,e,f){return f+e.weapons[b].getrangedefensebonus(this)})},points:28},{name:"Graz the Hunter",unique:!0,pilotid:137,faction:SCUM,unit:"Kihraxz Fighter",skill:6,upgrades:[MISSILE,ILLICIT],init:function(){this.wrap_after("getdefensestrength",this,function(b,e,f){3>=this.weapons[b].getsector(e)&&(f+=1,this.log("+1 defense die for defending in firing arc"));return f})},done:!0,points:25},{name:"Black Sun Ace",
faction:SCUM,pilotid:138,unit:"Kihraxz Fighter",done:!0,skill:5,upgrades:[ELITE,MISSILE,ILLICIT],points:23},{name:"Cartel Marauder",done:!0,pilotid:139,faction:SCUM,unit:"Kihraxz Fighter",skill:2,upgrades:[MISSILE,ILLICIT],points:20},{name:"Miranda Doni",unique:!0,pilotid:140,done:!0,faction:REBEL,unit:"K-Wing",skill:8,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],mirandaturn:-1,preattackroll:function(b,e){if(this.mirandaturn!=round){var f={org:this,name:this.name,type:"SHIELD",action:function(b){this.mirandaturn=
round;this.log("-1 attack die");this.wrap_after("getattackstrength",this,function(b,e,f){b=this.weapons[b].getrangeattackbonus(e);0<f-b&&--f;return f}).unwrapper("attackroll");this.shield<this.ship.shield&&(this.addshield(1),this.log("+1 %SHIELD%"));this.endnoaction(b,"SHIELD")}.bind(this)},g={org:this,name:this.name,type:"HIT",action:function(b){this.log("-1 %SHIELD%");this.log("+1 attack die");this.mirandaturn=round;this.wrap_after("getattackstrength",this,function(b,e,f){return 1+f}).unwrapper("attackroll");
this.removeshield(1);this.endnoaction(b,"HIT")}.bind(this)},h=[];0<this.shield&&h.push(g);this.shield<this.ship.shield&&h.push(f);this.donoaction(h,"select to add shield/roll 1 fewer die or remove shield/roll 1 additional die",!0)}},points:29},{name:"Esege Tuketu",unique:!0,pilotid:141,faction:REBEL,unit:"K-Wing",skill:6,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],points:28,done:!0,init:function(){var b=this;Unit.prototype.wrap_before("beginattack",this,function(){!b.dead&&this!=b&&this.isally(b)&&
(this.wrap_after("canusefocus",b,function(e){return e||b.canusefocus()&&2>=this.getrange(b)}).unwrapper("endattack"),this.wrap_before("removefocustoken",b,function(){2>=this.getrange(b)&&(this.focus++,b.log("-1 %FOCUS% [%0]",this.name),b.removefocustoken())}).unwrapper("endattack"))})}},{name:"Guardian Squadron Pilot",faction:REBEL,pilotid:142,done:!0,unit:"K-Wing",skill:4,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],points:25},{name:"Warden Squadron Pilot",faction:REBEL,pilotid:143,done:!0,
unit:"K-Wing",skill:2,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],points:23},{name:"'Redline'",unique:!0,pilotid:144,faction:EMPIRE,unit:"TIE Punisher",skill:7,done:!0,init:function(){this.wrap_after("addtarget",this,function(b){this.log("+%1 %TARGET% / %0",b.name,2);this.targeting.push(b);b.istargeted.push(this);this.movelog("T-"+b.id);b.show();this.show()})},boundtargets:function(b){var e=this.targeting;if(-1<this.targeting.indexOf(b))return!0;for(b=e.length-2;0<=b;b++)this.removetarget(e[b]);
return!1},upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:27},{name:"'Deathrain'",unique:!0,pilotid:145,faction:EMPIRE,unit:"TIE Punisher",skill:6,done:!0,init:function(){this.wrap_after("getbombposition",this,function(b,e,f){for(var g=0;g<b.length;g++)f.push(this.getpathmatrix(this.m.clone(),b[g]).translate(0,-e+20));return f});this.wrap_after("bombdropped",this,function(){this.candoroll()&&this.candoaction()&&($("#activationdial").hide(),this.doaction([this.newaction(this.resolveroll,
"ROLL")],"free %ROLL% action"))})},upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:26},{name:"Black Eight Squadron Pilot",faction:EMPIRE,pilotid:146,done:!0,unit:"TIE Punisher",skill:4,upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:23},{name:"Cutlass Squadron Pilot",faction:EMPIRE,done:!0,pilotid:147,unit:"TIE Punisher",skill:2,upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:21},{name:"Poe Dameron",faction:REBEL,pilotid:148,unit:"T-70 X-Wing",
unique:!0,done:!0,ambiguous:!0,skill:8,upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],init:poe_fct,points:31},{name:"'Blue Ace'",faction:REBEL,done:!0,pilotid:149,unit:"T-70 X-Wing",skill:5,unique:!0,getboostmatrix:function(b){return[this.getpathmatrix(this.m,"TR1"),this.getpathmatrix(this.m,"TL1")].concat(Unit.prototype.getboostmatrix.call(this,b))},upgrades:[TORPEDO,ASTROMECH,TECH],points:27},{name:"Ello Asty",faction:REBEL,done:!0,pilotid:150,beta:!0,unit:"T-70 X-Wing",skill:7,unique:!0,init:function(){var b=
[];this.wrap_after("getdial",this,function(e){if(0==b.length)for(var f=0;f<e.length;f++){var g=e[f].move,h=e[f].difficulty;g.match(/TR[RL]\d/)&&(h="WHITE");b[f]={move:g,difficulty:h}}return 0==this.stress?b:e})},upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],points:30},{name:"'Red Ace'",faction:REBEL,done:!0,pilotid:151,beta:!0,unit:"T-70 X-Wing",skill:6,unique:!0,init:function(){this.sr=-1;this.wrap_after("removeshield",this,function(b){this.sr<round&&(this.log("+1 %SHIELD%"),this.sr=round,this.addevadetoken())})},
upgrades:[TORPEDO,ASTROMECH,TECH],points:29},{name:"Blue Squadron Novice",faction:REBEL,done:!0,unit:"T-70 X-Wing",skill:2,pilotid:152,upgrades:[TORPEDO,ASTROMECH,TECH],points:24},{name:"Red Squadron Veteran",faction:REBEL,pilotid:153,done:!0,unit:"T-70 X-Wing",skill:4,upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],points:26},{name:"Omega Squadron Pilot",faction:EMPIRE,done:!0,pilotid:154,unit:"TIE/FO Fighter",skill:4,upgrades:[TECH,ELITE],points:17},{name:"Zeta Squadron Pilot",faction:EMPIRE,done:!0,pilotid:155,
unit:"TIE/FO Fighter",skill:3,upgrades:[TECH],points:16},{name:"Epsilon Squadron Pilot",faction:EMPIRE,done:!0,pilotid:156,unit:"TIE/FO Fighter",skill:1,upgrades:[TECH],points:15},{name:"'Zeta Ace'",faction:EMPIRE,done:!0,pilotid:157,unique:!0,unit:"TIE/FO Fighter",skill:5,getrollmatrix:function(b){var e=this.getpathmatrix(this.m.clone().rotate(90,0,0),"F2").translate(0,this.islarge?20:0).rotate(-90,0,0),f=this.getpathmatrix(this.m.clone().rotate(-90,0,0),"F2").translate(0,this.islarge?20:0).rotate(90,
0,0);return[e.clone().translate(0,-20),e,e.clone().translate(0,20),f.clone().translate(0,-20),f,f.clone().translate(0,20)].concat(Unit.prototype.getrollmatrix.call(this,b))},upgrades:[ELITE,TECH],points:18},{name:"'Epsilon Leader'",faction:EMPIRE,done:!0,pilotid:158,unique:!0,unit:"TIE/FO Fighter",skill:6,init:function(){this.wrap_after("begincombatphase",this,function(b){var e=this.selectnearbyally(1);e.push(this);for(var f=0;f<e.length;f++)e[f].removestresstoken();return b})},upgrades:[TECH],points:19},
{name:"'Epsilon Ace'",faction:EMPIRE,done:!0,pilotid:159,unique:!0,unit:"TIE/FO Fighter",skill:4,init:function(){this.wrap_after("getskill",this,function(b){return 0==this.criticals.length?12:b})},upgrades:[TECH],points:17},{name:"'Omega Ace'",faction:EMPIRE,done:!0,pilotid:160,unique:!0,unit:"TIE/FO Fighter",skill:7,init:function(){this.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return this.canusefocus()&&-1<this.targeting.indexOf(targetunit)}.bind(this),f:function(b,e){this.removefocustoken();
this.removetarget(targetunit);this.log("all results are %CRIT%");return e*FCH_CRIT}.bind(this),str:"critical"})},upgrades:[ELITE,TECH],points:20},{name:"'Omega Leader'",faction:EMPIRE,beta:!0,pilotid:161,unique:!0,unit:"TIE/FO Fighter",skill:8,upgrades:[ELITE,TECH],points:21,done:!0,init:function(){var b=this;this.wrap_after("isattackedby",this,function(e,f){-1<b.targeting.indexOf(f)&&f.wrap_after("getdicemodifiers",b,function(b){for(var e=[],f=0;f<b.length;f++)b[f].from!=ATTACK_M&&e.push(b[f]);return b}).unwrapper("endattack")});
this.wrap_before("resolveattack",this,function(b,f){-1<this.targeting.indexOf(f)&&f.wrap_after("getdicemodifiers",this,function(b){for(var e=[],f=0;f<b.length;f++)b[f].from!=DEFENSE_M&&e.push(b[f]);return b}).unwrapper("endbeingattacked")});this.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&this.candotarget()&&0==this.targeting.length&&(b.priority+=10)})}},{name:"Hera Syndulla",unique:!0,faction:REBEL,unit:"VCX-100",skill:7,pilotid:162,edition:"VCX-100",points:40,done:!0,getmaneuverlist:hera_fct,
upgrades:[SYSTEM,TURRET,TORPEDO,TORPEDO,CREW,CREW],init:function(){for(var b=0;b<this.weapons.length;b++){var e=this.weapons[b];e.type==TORPEDO&&(e.auxiliary=AUXILIARY,e.subauxiliary=SUBAUXILIARY)}}},{name:"'Chopper'",unique:!0,pilotid:163,faction:REBEL,unit:"VCX-100",skill:4,points:37,done:!0,init:function(){this.wrap_after("begincombatphase",this,function(b){for(var e=0;e<this.touching.length;e++)this.touching[e].isenemy(this.team)&&(this.touching[e].addstress(),this.touching[e].log("+1 %STRESS% [%0]",
this.name));return b});for(var b=0;b<this.weapons.length;b++){var e=this.weapons[b];e.type==TORPEDO&&(e.auxiliary=AUXILIARY,e.subauxiliary=SUBAUXILIARY)}},upgrades:[SYSTEM,TURRET,TORPEDO,TORPEDO,CREW,CREW]},{name:"Ezra Bridger",faction:REBEL,unique:!0,done:!0,pilotid:164,unit:"Attack Shuttle",skill:4,points:20,init:function(){this.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,this,{req:function(b,e){return 0<this.stress}.bind(this),f:function(b,e){var f=FE_focus(b);2<f&&(f=2);return 0<f?(this.log("%0 %FOCUS% -> %0 %EVADE%",
f),b-f*FE_FOCUS+f*FE_EVADE):b}.bind(this),str:"focus"})},upgrades:[ELITE,TURRET,CREW]},{name:"Hera Syndulla",faction:REBEL,unique:!0,done:!0,pilotid:165,unit:"Attack Shuttle",skill:7,ambiguous:!0,edition:"Attack Shuttle",points:22,getmaneuverlist:hera_fct,upgrades:[ELITE,TURRET,CREW]},{name:"Sabine Wren",faction:REBEL,unique:!0,done:!0,pilotid:166,unit:"Attack Shuttle",skill:5,points:21,ambiguous:!0,edition:"Attack Shuttle",init:function(){this.wrap_after("beginactivation",this,sabine_fct)},upgrades:[ELITE,
TURRET,CREW]},{name:"'Zeb' Orrelios",faction:REBEL,unique:!0,unit:"Attack Shuttle",skill:3,pilotid:167,points:18,done:!0,cancelhit:function(b,e){this.log("cancel %CRIT% first");b=this.cancelcritical(b,e);return b=Unit.prototype.cancelhit(b,e)},upgrades:[TURRET,CREW]},{name:"Kanan Jarrus",faction:REBEL,unique:!0,pilotid:168,unit:"VCX-100",skill:5,points:38,upgrades:[SYSTEM,TURRET,TORPEDO,TORPEDO,CREW,CREW],done:!0,init:function(){for(var b=this,e=0;e<this.weapons.length;e++){var f=this.weapons[e];
f.type==TORPEDO&&(f.auxiliary=AUXILIARY,f.subauxiliary=SUBAUXILIARY)}Unit.prototype.wrap_after("preattackroll",this,function(e,f){var g=this.selectnearbyenemy(2);b.canusefocus()&&-1<g.indexOf(b)&&!b.dead&&b.donoaction([{org:b,name:b.name,type:"FOCUS",action:function(e){this.wrap_after("getattackstrength",b,function(b,e,f){NOLOG=!0;b=this.weapons[b].getrangeattackbonus(e);f-=b;NOLOG=!1;0<f&&--f;return f+b}).unwrapper("attackroll");b.removefocustoken();this.log("-1 attack against %0",b.name);this.select();
b.endnoaction(e,"FOCUS")}.bind(this)}],"",!0)})}},{name:"'Wampa'",faction:EMPIRE,unique:!0,pilotid:169,unit:"TIE Fighter",skill:4,points:14,done:!0,init:function(){this.adddicemodifier(ATTACKCOMPARE_M,ADD_M,ATTACK_M,this,{req:function(b,e){return 0<e},f:function(b,e){this.log("cancel all dice");0<FCH_crit(b)&&(targetunit.log("+1 damage card [%0]",this.name),targetunit.applydamage(1));return{m:0,n:0}}.bind(this),str:"critical"})},upgrades:[]},{name:"'Youngster'",faction:EMPIRE,unique:!0,pilotid:170,
unit:"TIE Fighter",skill:6,points:15,done:!0,init:function(){var b=null,e=this;for(i=0;i<this.upgrades.length;i++)this.upgrades[i].type==ELITE&&"function"==typeof this.upgrades[i].action&&(b=$.extend({},this.upgrades[i]),b.clone=!0,b.isactive=!0);null!=b&&(this.log("share %0 upgrade",b.name),Unit.prototype.wrap_after("getupgactionlist",e,function(f){var g=this.selectnearbyally(3);!e.dead&&this.ship.name.match(/.*TIE.*Fighter.*/)&&-1<g.indexOf(e)&&b.candoaction()&&b.isactive&&(this.log("elite action from %0 available",
e.name),b.unit=this,f.push({org:b,action:b.action,type:b.type.toUpperCase(),name:b.name}));return f}))},upgrades:[ELITE]},{name:"'Chaser'",faction:EMPIRE,unique:!0,pilotid:171,done:!0,unit:"TIE Fighter",skill:3,points:14,init:function(){var b=this;Unit.prototype.wrap_after("removefocustoken",this,function(){!b.dead&&this.isally(b)&&this!=b&&1>=this.getrange(b)&&(b.log("+1 %FOCUS%"),b.addfocustoken())})},upgrades:[]},{name:"Gamma Squadron Veteran",faction:EMPIRE,pilotid:172,done:!0,unit:"TIE Bomber",
skill:5,points:19,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"The Inquisitor",faction:EMPIRE,pilotid:173,unit:"TIE Adv. Prototype",skill:8,unique:!0,done:!0,points:25,init:function(){this.weapons[0].wrap_after("getrangedefensebonus",this,function(b,e){1==e&&this.unit.log("defense range nullified");return 0});this.wrap_after("getattackstrength",this,function(b,e,f){return 0==b&&1<this.weapons[0].getrange(e)?(this.log("+1 attack die with primary weapon [%0]",this.name),f+1):f})},upgrades:[ELITE,
MISSILE]},{name:"Valen Rudor",faction:EMPIRE,unique:!0,pilotid:174,unit:"TIE Adv. Prototype",skill:6,points:22,done:!0,init:function(){this.addafterdefenseeffect(this,function(b,e,f){this.candoaction()&&(this.log("+1 free action [%0]",this.name),this.doaction(this.getactionlist(),""))})},upgrades:[ELITE,MISSILE]},{name:"Sienar Test Pilot",faction:EMPIRE,pilotid:175,done:!0,unit:"TIE Adv. Prototype",skill:2,points:16,upgrades:[MISSILE]},{name:"Zuckuss",faction:SCUM,pilotid:176,unique:!0,unit:"G-1A Starfighter",
skill:7,points:28,done:!0,upgrades:[ELITE,CREW,SYSTEM,ILLICIT],preattackroll:function(b,e){var f={org:this,name:this.name,type:"HIT",action:function(b){this.log("+1 attack die");this.wrap_after("getattackstrength",this,function(b,e,f){return 1+f}).unwrapper("attackroll");targetunit.wrap_after("getdefensestrength",this,function(b,e,f){return 1+f}).unwrapper("defenseroll");this.endnoaction(b,"HIT")}.bind(this)};this.donoaction([f],"select to add +1 attack roll",!0)}},{name:"4-LOM",faction:SCUM,pilotid:177,
unique:!0,done:!0,unit:"G-1A Starfighter",skill:6,points:27,init:function(){this.wrap_before("endphase",this,function(){var b=this.selectnearbyunits(1,function(){return!0});0<this.stress&&this.selectunit(b,function(b,f){b[f].addstress();this.removestresstoken();b[f].log("+1 %STRESS% [%0]",this.name);this.log("-1 %STRESS%")},["select unit (or self to cancel)"],!0)})},upgrades:[ELITE,CREW,SYSTEM,ILLICIT]},{name:"Nashtah Pup Pilot",faction:SCUM,done:!0,pilotid:178,unique:!0,unit:"Z-95 Headhunter",skill:2,
points:0,upgrades:[]},{name:"Dengar",faction:SCUM,unique:!0,pilotid:179,unit:"JumpMaster 5000",skill:9,points:33,done:!0,init:function(){this.dengarattack=-1;this.addattack(function(b,e,f){this.retaliationtarget=f;return this.dengarattack<round&&f!=this&&this.isinprimaryfiringarc(f)},this,this.weapons,function(){this.dengarattack=round},function(){return[this.retaliationtarget]},"endbeingattacked")},upgrades:[ELITE,TORPEDO,TORPEDO,CREW,SALVAGED,ILLICIT]},{name:"Tel Trevura",faction:SCUM,unique:!0,
pilotid:180,unit:"JumpMaster 5000",skill:7,points:30,done:!0,init:function(){this.resurrected=!1;this.wrap_before("checkdead",this,function(){0>=this.hull&&!this.dead&&!this.resurrected&&(this.addhull(this.ship.hull-this.hull),this.criticals=[],SOUNDS.explode.play(),this.resurrected=!0,this.log("resists!"),this.applydamage(4),this.showoverflow())})},upgrades:[ELITE,TORPEDO,TORPEDO,CREW,SALVAGED,ILLICIT]},{name:"Manaroo",faction:SCUM,pilotid:181,unit:"JumpMaster 5000",skill:4,unique:!0,points:27,done:!0,
init:function(){this.wrap_before("begincombatphase",this,function(){this.selectunit(this.selectnearbyally(1),function(b,e){for(var f=this.focus,g=this.evade,h=0;h<f;h++)this.removefocustoken(),b[e].addfocustoken();for(h=0;h<g;h++)this.removeevadetoken(),b[e].addevadetoken();f=this.targeting;for(h=f.length-1;0<=h;h--)g=f[h],this.removetarget(g),b[e].addtarget(g);f=this.istargeted;for(h=f.length-1;0<=h;h--)g=f[h],g.removetarget(this),g.addtarget(b[e])},["select unit (or self to cancel) [%0]",this.name],
!0)})},upgrades:[ELITE,TORPEDO,TORPEDO,CREW,SALVAGED,ILLICIT]},{name:"Tomax Bren",faction:EMPIRE,pilotid:182,unit:"TIE Bomber",skill:8,unique:!0,done:!0,points:24,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB],init:function(){var b=this;b.flip=-1;for(var e=0;e<this.upgrades.length;e++){var f=this.upgrades[e];f.type==ELITE&&function(e){e.wrap_after("desactivate",this,function(){b.flip<round&&b.donoaction([{org:b,name:b.name,type:"ELITE",action:function(f){e.isactive=!0;b.log("name reactivated:"+
e.name);b.flip=round;b.endnoaction(f,"ELITE")}}],"Choose to reactivate an elite upgrade (or not)",!0)})}(f)}}},{name:"Lothal Rebel",faction:REBEL,done:!0,unit:"VCX-100",skill:3,pilotid:183,points:35,upgrades:[SYSTEM,TURRET,TORPEDO,TORPEDO,CREW,CREW],init:function(){for(var b=0;b<this.weapons.length;b++){var e=this.weapons[b];e.type==TORPEDO&&(e.auxiliary=AUXILIARY,e.subauxiliary=SUBAUXILIARY)}}},{name:"Baron of the Empire",faction:EMPIRE,pilotid:184,done:!0,unit:"TIE Adv. Prototype",skill:4,points:19,
upgrades:[ELITE,MISSILE]},{name:"Gand Findsman",faction:SCUM,pilotid:185,done:!0,unit:"G-1A Starfighter",skill:5,points:25,upgrades:[ELITE,CREW,SYSTEM,ILLICIT]},{name:"Ruthless Freelancer",faction:SCUM,pilotid:186,done:!0,unit:"G-1A Starfighter",skill:3,points:23,upgrades:[CREW,SYSTEM,ILLICIT]},{name:"'Zeta Leader'",faction:EMPIRE,pilotid:187,done:!0,unique:!0,unit:"TIE/FO Fighter",skill:7,points:20,upgrades:[ELITE,TECH],preattackroll:function(b,e){var f={org:this,name:this.name,type:"STRESS",action:function(b){this.log("+1 attack die");
this.wrap_after("getattackstrength",this,function(b,e,f){return 1+f}).unwrapper("attackroll");this.addstress();this.endnoaction(b,"STRESS")}.bind(this)};0==this.stress&&this.donoaction([f],"select to add +1 attack roll",!0)}},{name:"Countess Ryad",faction:EMPIRE,pilotid:188,done:!0,unique:!0,unit:"TIE Defender",skill:5,points:34,shipimg:"tie-defender-red.png",upgrades:[ELITE,CANNON,MISSILE],init:function(){this.wrap_after("getmaneuverlist",this,function(b){if(this.hasionizationeffect())return b;for(var e=
1;5>=e;e++)"undefined"!=typeof b["F"+e]&&(b["K"+e]={move:"K"+e,difficulty:b["F"+e].difficulty});return b})}},{name:"'Deathfire'",faction:EMPIRE,pilotid:189,done:!0,unique:!0,unit:"TIE Bomber",skill:3,points:17,upgrades:[TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB],init:function(){var b;for(b=0;b<this.upgrades.length;b++){var e=this.upgrades[b];"function"==typeof e.action&&e.type==BOMB&&e.wrap_after("canbedropped",this,Bomb.prototype.canbedropped)}}},{name:"Rey",faction:REBEL,pilotid:190,done:!0,unique:!0,
unit:"YT-1300",skill:8,points:45,upgrades:[ELITE,MISSILE,CREW,CREW],init:function(){this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank"],n:function(){return 2},req:function(b,e,f){return b.isinfiringarc(f)}});this.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,{dice:["blank"],n:function(){return 2},req:function(b,e,f){return f.isinfiringarc(b)}})}},{name:"Poe Dameron",faction:REBEL,pilotid:191,unit:"T-70 X-Wing",unique:!0,done:!0,ambiguous:!0,edition:"HoR",init:poe_fct,skill:9,
upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],points:33},{name:"'Quickdraw'",faction:EMPIRE,pilotid:192,unit:"TIE/SF Fighter",unique:!0,done:!0,skill:9,upgrades:[ELITE,SYSTEM,MISSILE,TECH],points:29,init:function(){this.qdattack=-1;this.addattack(function(b,e){return this.qdattack<round},this,[this.weapons[0]],function(){this.qdattack=round},function(){return squadron},"removeshield")}},{name:"'Backdraft'",faction:EMPIRE,pilotid:193,unit:"TIE/SF Fighter",unique:!0,done:!0,skill:7,upgrades:[ELITE,SYSTEM,
MISSILE,TECH],points:27,init:function(){this.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,this,{req:function(b,e){return!targetunit.dead&&0==this.activeweapon&&3>=this.weapons[0].getauxiliarysector(targetunit)}.bind(this),f:function(b,e){this.log("%0 in auxiliary arc -> +1 %CRIT%",targetunit.name);return{m:b+FCH_CRIT,n:e+1}}.bind(this),str:"critical"})}},{name:"Zeta Specialist",faction:EMPIRE,pilotid:194,done:!0,unit:"TIE/SF Fighter",skill:3,upgrades:[SYSTEM,MISSILE,TECH],points:23},{name:"Ketsu Onyo",
faction:SCUM,pilotid:195,unit:"Lancer-class Pursuit Craft",unique:!0,skill:7,done:!0,upgrades:[ELITE,CREW,ILLICIT,ILLICIT],points:38,init:function(){var b=this;this.wrap_before("begincombatphase",this,function(){this.selectunit(this.selectnearbyenemy(1,function(e,f){var g=b.weapons[0];return 3>=g.getprimarysector(f)&&3>=g.getauxiliarysector(f)}),function(e,f){e[f].log("+1 tractor beam token [%0]",b.name);e[f].addtractorbeam(b)},["select unit for tractor beam token [%0]",b.name],!1)})}},{name:"Asajj Ventress",
faction:SCUM,pilotid:196,unit:"Lancer-class Pursuit Craft",unique:!0,done:!0,skill:6,upgrades:[ELITE,CREW,ILLICIT,ILLICIT],points:37,init:function(){var b=this;this.wrap_before("begincombatphase",this,function(){this.selectunit(this.selectnearbyenemy(2,function(e,f){return 3>=b.weapons[0].getauxiliarysector(f)}),function(e,f){e[f].log("+1 stress [%0]",b.name);e[f].addstress(b)},["select unit [%0]",b.name],!1)})}},{name:"Sabine Wren",faction:SCUM,pilotid:197,unit:"Lancer-class Pursuit Craft",unique:!0,
done:!0,skill:5,upgrades:[CREW,ILLICIT,ILLICIT],points:35,init:function(){this.adddicemodifier(DEFENSE_M,ADD_M,DEFENSE_M,this,{req:function(b,e){return 2>=this.weapons[0].getauxiliarysector(activeunit)}.bind(this),f:function(b,e){this.log("Attacker inside Range 1-2 of mobile arc -> +1 %FOCUS%");return{m:b+FE_FOCUS,n:e+1}}.bind(this),str:"focus"})}},{name:"Shadowport Hunter",faction:SCUM,pilotid:198,done:!0,unit:"Lancer-class Pursuit Craft",skill:2,upgrades:[CREW,ILLICIT,ILLICIT],points:33},{name:"Zealous Recruit",
faction:SCUM,pilotid:199,done:!0,unit:"Protectorate Starfighter",skill:1,upgrades:[TORPEDO],points:20},{name:"Concord Dawn Veteran",faction:SCUM,pilotid:200,done:!0,unit:"Protectorate Starfighter",skill:3,upgrades:[ELITE,TORPEDO],points:22},{name:"Concord Dawn Ace",faction:SCUM,pilotid:201,done:!0,unit:"Protectorate Starfighter",skill:5,upgrades:[ELITE,TORPEDO],points:23},{name:"Kad Solus",faction:SCUM,pilotid:202,unique:!0,done:!0,unit:"Protectorate Starfighter",skill:6,upgrades:[ELITE,TORPEDO],
points:25,init:function(){this.wrap_after("handledifficulty",this,function(b){"RED"==b&&(this.addfocustoken(),this.addfocustoken(),this.log("red maneuver -> +2 %FOCUS% [%0]",this.name))})}},{name:"Old Teroch",faction:SCUM,pilotid:203,unique:!0,done:!0,unit:"Protectorate Starfighter",skill:7,upgrades:[ELITE,TORPEDO],points:26,init:function(){var b=this;this.wrap_before("begincombatphase",this,function(){this.selectunit(this.selectnearbyenemy(1,function(b,f){return!0}),function(e,f){var g,h=e[f].focus,
l=e[f].evade;if(0<h)for(e[f].log("-%0 %FOCUS% [%1]",h,b.name),g=0;g<h;g++)e[f].removefocustoken();if(0<l)for(e[f].log("-%0 %EVADE% [%1]",h,b.name),g=0;g<l;g++)e[f].removeevadetoken()},["select unit [%0]",b.name],!1)})}},{name:"Fenn Rau",faction:SCUM,pilotid:204,unique:!0,done:!0,unit:"Protectorate Starfighter",skill:9,upgrades:[ELITE,TORPEDO],points:28,init:function(){this.wrap_after("getattackstrength",this,function(b,e,f){return 1==this.getrange(e)?(this.log("+1 attack die"),f+1):f});this.wrap_after("getdefensestrength",
this,function(b,e,f){return 1==this.getrange(e)?(this.log("+1 defense die"),f+1):f})}},{name:"Norra Wexley",faction:REBEL,pilotid:205,unique:!0,unit:"ARC-170",skill:7,done:!0,upgrades:[ELITE,TORPEDO,CREW,ASTROMECH],points:29,init:function(){this.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,this,{req:function(b,e){return this.canusetarget(targetunit)}.bind(this),f:function(b,e){this.removetarget(targetunit);this.log("1 %TARGET% -> 1 %FOCUS%");return{m:b+FCH_FOCUS,n:e+1}}.bind(this),str:"target"});this.adddicemodifier(DEFENSE_M,
ADD_M,DEFENSE_M,this,{req:function(b,e){return this.canusetarget(activeunit)}.bind(this),f:function(b,e){this.removetarget(activeunit);this.log("1 %TARGET% -> 1 %FOCUS%");return{m:b+FE_FOCUS,n:e+1}}.bind(this),str:"target"})}},{name:"Shara Bey",faction:REBEL,pilotid:206,unique:!0,done:!0,unit:"ARC-170",skill:6,upgrades:[ELITE,TORPEDO,CREW,ASTROMECH],points:28,init:function(){var b=this;Unit.prototype.wrap_after("canusetarget",b,function(e,f){return b!=this&&b.isally(this)&&2>=b.getrange(this)?f||
b.canusetarget(e):f});Unit.prototype.wrap_before("removetarget",b,function(e){b!=this&&b.isally(this)&&2>=b.getrange(this)&&-1==this.targeting.indexOf(e)&&-1<b.targeting.indexOf(e)&&b.removetarget(e)})}},{name:"Thane Kyrell",faction:REBEL,pilotid:207,unique:!0,done:!0,unit:"ARC-170",skill:4,upgrades:[TORPEDO,CREW,ASTROMECH],points:26,init:function(){var b=this;Unit.prototype.wrap_after("afterattackeffect",this,function(e,f){b!=this&&this.isally(b)&&3>=b.getrange(this)&&b.candoaction()&&(b.log("+1 free action [%0]",
b.name),b.doaction(b.getactionlist(),""))})}},{name:"Braylen Stramm",faction:REBEL,pilotid:208,unique:!0,done:!0,unit:"ARC-170",skill:3,upgrades:[TORPEDO,CREW,ASTROMECH],points:25,init:function(){this.wrap_before("endmaneuver",this,function(){if(0<this.stress){var b=this.rollattackdie(1,this,"hit")[0];if("hit"==b||"critical"==b)this.log("-1 stress [%0]",this.name),this.removestresstoken()}})}},{name:"Omega Specialist",faction:EMPIRE,pilotid:209,done:!0,unit:"TIE/SF Fighter",skill:5,upgrades:[ELITE,
SYSTEM,MISSILE,TECH],points:25},{name:"Sabine Wren",faction:REBEL,pilotid:210,done:!0,unique:!0,unit:"TIE Fighter",skill:5,ambiguous:!0,edition:"TIE Fighter",upgrades:[ELITE],points:15,init:function(){this.wrap_after("beginactivation",this,sabine_fct)}},{name:"Chewbacca",unit:"YT-1300",skill:5,unique:!0,edition:"HoR",ambiguous:!0,done:!0,pilotid:211,faction:REBEL,upgrades:[ELITE,MISSILE,CREW,CREW],points:42,init:function(){var b=this;this.addattack(function(e,f,g){return 0>=e+f&&3>=b.getrange(g)},
this,this.weapons,function(){},function(){return squadron},"warndeath")}},{name:"Han Solo",unit:"YT-1300",skill:9,done:!0,unique:!0,edition:"HoR",ambiguous:!0,pilotid:212,faction:REBEL,upgrades:[ELITE,MISSILE,CREW,CREW],points:46},{name:"Nien Nunb",unit:"T-70 X-Wing",unique:!0,done:!0,pilotid:213,faction:REBEL,upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],init:function(){this.wrap_after("addstress",this,function(){0<this.selectnearbyenemy(1,function(b,e){return b.isinprimaryfiringarc(e)}).length&&this.removestresstoken()})},
points:29,skill:7},{name:"'Snap' Wexley",unit:"T-70 X-Wing",unique:!0,done:!0,pilotid:214,faction:REBEL,upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],points:28,skill:6,init:function(){this.wrap_before("endmaneuver",this,function(){this.getdial()[this.maneuver].move.match(/\w+[234]/)&&!this.collision&&this.candoboost()&&this.doaction([this.newaction(this.resolveboost,"BOOST")],"free %BOOST%")})}},{name:"Jess Pava",unit:"T-70 X-Wing",unique:!0,done:!0,pilotid:215,faction:REBEL,upgrades:[TORPEDO,ASTROMECH,
TECH],points:25,skill:3,init:function(){var b=this,e=function(){return b.selectnearbyally(1,function(b,e){return b!=e}).length};this.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus"],n:e,req:function(b,e,h){return!0}});this.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,{dice:["blank","focus"],n:e,req:function(b,e,h){return!0}})}},{name:"Resistance Sympathizer",unit:"YT-1300",skill:3,done:!0,unique:!1,edition:"HoR",pilotid:216,faction:REBEL,upgrades:[MISSILE,CREW,CREW],points:38},
{name:"Black Squadron Scout",done:!0,pilotid:217,unit:"TIE Striker",faction:EMPIRE,skill:4,points:20,upgrades:[ELITE]},{name:"Scarif Defender",done:!0,pilotid:218,unit:"TIE Striker",faction:EMPIRE,skill:3,points:18,upgrades:[]},{name:"Imperial Trainee",done:!0,pilotid:219,unit:"TIE Striker",faction:EMPIRE,skill:1,points:17,upgrades:[]},{name:"Blue Squadron Pathfinder",unit:"U-wing",skill:2,done:!0,unique:!1,pilotid:220,faction:REBEL,upgrades:[SYSTEM,TORPEDO,CREW,CREW],points:23},{name:"Starkiller Base Pilot",
done:!0,pilotid:221,unit:"Upsilon-Class Shuttle",faction:EMPIRE,skill:2,points:30,upgrades:[SYSTEM,CREW,CREW,TECH,TECH]},{name:"Ahsoka Tano",faction:REBEL,pilotid:222,unique:!0,unit:"TIE Fighter",skill:7,upgrades:[ELITE],points:17,wave:["10"],done:!0,init:function(){var b=this;this.wrap_before("begincombatphase",this,function(){if(this.canusefocus()){var e=this.selectnearbyally(1);e.push(this);this.selectunit(e,function(e,g){e[g]!=b&&(b.removefocustoken(),e[g].log("+1 free action [%0]",b.name),e[g].doaction(e[g].getactionlist(),
""))},["select unit, self to cancel [%0]",b.name],!1)}})}},{name:"Captain Rex",faction:REBEL,pilotid:223,unique:!0,done:!0,unit:"TIE Fighter",skill:4,upgrades:[],points:14},{name:"Heff Tobber",faction:REBEL,pilotid:224,unique:!0,unit:"U-wing",skill:3,upgrades:[SYSTEM,TORPEDO,CREW,CREW],points:24,done:!0,init:function(){this.wrap_after("collidedby",this,function(b){this.doaction(this.getactionlist(),"")})}},{name:"Bodhi Rook",faction:REBEL,unique:!0,pilotid:225,unit:"U-wing",skill:4,done:!0,upgrades:[SYSTEM,
TORPEDO,CREW,CREW],points:25,init:function(){var b=this;Unit.prototype.wrap_after("gettargetableunits",this,function(e,f){if(b.isally(this)){var g=[],h;for(h in squadron){var l=squadron[h];l.isally(b)&&(g=g.concat(Unit.prototype.gettargetableunits.vanilla.call(l,3)))}return g}return f})}},{name:"'Duchess'",faction:EMPIRE,unique:!0,done:!0,pilotid:226,unit:"TIE Striker",skill:8,upgrades:[ELITE],points:23,init:function(){this.facultativeailerons=!0}},{name:"'Countdown'",faction:EMPIRE,unique:!0,pilotid:227,
unit:"TIE Striker",skill:5,upgrades:[],done:!0,points:20,init:function(){this.adddicemodifier(ATTACKCOMPARE_M,ADD_M,DEFENSE_M,this,{req:function(b,e){return 0==this.stress&&0<e}.bind(this),f:function(b,e){return 0==this.stress?(this.log("cancel all dice results"),this.applydamage(1),this.endattack(),this.addstress(),{m:0,n:0}):{m:b,n:e}}.bind(this),str:"hit"})}},{name:"'Pure Sabacc'",faction:EMPIRE,unique:!0,pilotid:228,unit:"TIE Striker",skill:6,upgrades:[ELITE],points:22,done:!0,init:function(){this.wrap_after("getattackstrength",
this,function(b,e,f){1>=this.criticals.length&&(f+=1);return f})}},{name:"Cassian Andor",faction:REBEL,pilotid:229,unit:"U-wing",skill:6,unique:!0,done:!0,upgrades:[ELITE,SYSTEM,TORPEDO,CREW,CREW],points:27,init:function(){var b=this;this.wrap_after("beginactivationphase",this,function(e){var f=this.selectnearbyally(2,function(b,e){return 0<e.stress?!0:!1});0<f.length&&this.doselection(function(e){this.log("select unit for -1 stress");this.resolveactionselection(f,function(g){f[g].removestresstoken();
b.endnoaction(e)})}.bind(this));return e})}},{name:"Kylo Ren",faction:EMPIRE,pilotid:230,unique:!0,unit:"Upsilon-Class Shuttle",skill:6,done:!0,upgrades:[ELITE,SYSTEM,CREW,CREW,TECH,TECH],points:34,init:function(){this.firstroundhit=-1;this.wrap_after("resolveishit",this,function(b){this.firstroundhit<round&&(this.firstroundhit=round,c=new Condition(b,this,"I'll Show You The Dark Side"))})}},{name:"Major Stridan",faction:EMPIRE,pilotid:231,unique:!0,done:!0,unit:"Upsilon-Class Shuttle",skill:4,upgrades:[SYSTEM,
CREW,CREW,TECH,TECH],points:32,init:function(){this.wrap_after("selectnearbyally",this,function(b,e,f){"undefined"==typeof f&&(f=e,e=void 0);return 1<b?f:Unit.prototype.selectnearbyally.call(this,3,e)})}},{name:"Lieutenant Dormitz",faction:EMPIRE,pilotid:232,unique:!0,done:!0,unit:"Upsilon-Class Shuttle",skill:3,upgrades:[SYSTEM,CREW,CREW,TECH,TECH],points:31},{name:"'Zeb' Orrelios",faction:REBEL,pilotid:233,unique:!0,done:!0,ambiguous:!0,edition:"TIE Fighter",unit:"TIE Fighter",skill:3,wave:["10"],
upgrades:[],points:13,cancelhit:zeb_fct}];var UPGRADE_TYPES={Elite:"ept",Torpedo:TORPEDO,Astromech:"amd",Turret:"turret",Missile:"missile",Crew:"crew",Cannon:"cannon",Bomb:"bomb",Title:"title",Mod:"mod",System:"system",Illicit:"illicit",Salvaged:"salvaged",Tech:"tech"};function AUXILIARY(b,e){return this.getPrimarySectorString(b,e.clone().rotate(this.arcrotation,0,0))}function SUBAUXILIARY(b,e,f){return this.getPrimarySubSectorString(b,e,f.clone().rotate(this.arcrotation,0,0))}
function Laser(b,e,f){switch(e){case "Bilaser":case "Mobilelaser":return new Weapon(b,{type:e,name:"Laser",isactive:!0,attack:f,range:[1,3],isprimary:!0,issecondary:!1,auxiliary:AUXILIARY,subauxiliary:SUBAUXILIARY});case "Laser180":return new Weapon(b,{type:e,name:"Laser",isactive:!0,attack:f,range:[1,3],isprimary:!0,issecondary:!1,auxiliary:function(b,e){return this.getHalfRangeString(b,e)},subauxiliary:function(b,e,f){return this.getHalfSubRangeString(b,e,f)}});default:return new Weapon(b,{type:e,
name:"Laser",isactive:!0,attack:f,range:[1,3],isprimary:!0,issecondary:!1})}}function Bomb(b,e){$.extend(this,e);b.upgrades.push(this);this.isactive=!0;this.wrapping=[];this.unit=b;b.bombs.push(this);this.exploded=!1}
Bomb.prototype={isWeapon:function(){return!1},isBomb:function(){return!0},canbedropped:function(){return this.isactive&&!this.unit.hasmoved&&this.unit.lastdrop!=round},desactivate:function(){this.isactive=!1;this.unit.movelog("D-"+this.unit.upgrades.indexOf(this))},getBall:function(){var b=this.g.getBBox();return{x:b.x+b.width/2,y:b.y+b.height/2,diam:Math.max(b.width/2,b.height/2)}},actiondrop:function(b){this.unit.lastdrop=round;$(".bombs").remove();this.drop(this.unit.getbomblocation(),b)},toString:function(){this.tooltip=
formatstring(getupgtxttranslation(this.name,this.type));this.trname=translate(this.name).replace(/\'/g,"&#39;");this.left=1==this.unit.team;return Mustache.render(TEMPLATES.bomb,this)},getrangeallunits:function(){var b=[[],[],[],[],[]],e;for(e in squadron){var f=this.getrange(squadron[e]);0<f&&b[f].push({unit:e})}return b},getcollisions:function(){var b=this.getOutlineString(),e=[];for(i in squadron){var f=squadron[i],g=f.getOutlineString(f.m);os=g.s;op=g.p;(0<Snap.path.intersection(b.s,os).length||
this.unit.isPointInside(b.s,op)||this.unit.isPointInside(os,b.p))&&e.push(f)}return e},getrange:function(b){var e=this.getOutlineString(this.m).p;b=b.getOutlinePoints(b.m);var f=90001,g,h;for(g=0;g<e.length;g++)for(h=0;4>h;h++){var l=dist(b[h],e[g]);l<f&&(f=l)}return 9E4<f?4:1E4>=f?1:4E4>=f?2:3},resolveactionmove:function(b,e){var f;this.pos=[];var g=function(e,g,m){for(f=0;f<b.length;f++)this.pos[f].remove();this.m=e;m(this,g)}.bind(this);if(1==b.length)this.pos[0]=this.getOutline(b[0]).attr({fill:this.unit.color,
opacity:.7}),g(b[0],0,e);else for(f=0;f<b.length;f++)this.pos[f]=this.getOutline(b[f]).attr({fill:this.unit.color,opacity:.7}),function(f){this.pos[f].hover(function(){this.pos[f].attr({stroke:this.unit.color,strokeWidth:"4px"})}.bind(this),function(){this.pos[f].attr({strokeWidth:"0"})}.bind(this));this.pos[f].click(function(){g(b[f],f,e)})}.call(this,f)},drop:function(b,e){var f=this;this.ordnance?(this.ordnance=!1,f=$.extend({},this)):this.desactivate();f.resolveactionmove(this.unit.getbombposition(b,
this.size),function(b){this.display(0,0);this.unit.bombdropped(this);"undefined"!=typeof e&&this.unit.endnoaction(e,"DROP")}.bind(f),!1,!0)},display:function(b,e){if(0!=b||0!=e)this.m=this.m.clone().translate(b,e);this.img1=s.image("png/"+this.img,-this.width/2,-this.height/2,this.width,this.height);this.outline=this.getOutline(new Snap.Matrix).attr({display:"block","class":"bombanim",stroke:halftone(BLUE),strokeWidth:2,fill:"rgba(8,8,8,0.3)"});this.g=s.group(this.outline,this.img1);this.g.hover(function(){var b=
VIEWPORT.m.clone(),e=$("#svgout").width(),f=$("#svgout").height(),m=0,q=0;f>e?q=(f-e)/2:m=(e-f)/2;var v=Math.max(900/e,900/f),w=this.g.getBBox(),e=$("#svgout").position();$("#playmat").width();$("#playmat").height();f=b.x(w.x,w.y-20)/v;f+=e.left+m;b=b.y(w.x,w.y-20)/v;b+=e.top+q;this.outline.attr({stroke:BLUE});$(".info").css({left:f,top:b}).html(this.name).appendTo("body").show()}.bind(this),function(){$(".info").hide();this.outline.attr({stroke:halftone(BLUE)})}.bind(this));this.g.transform(this.m);
this.g.appendTo(VIEWPORT);this.g.attr("display","block");BOMBS.push(this);if(this.stay){OBSTACLES.push(this);var f=this.getcollisions();0<f.length&&this.unit.resolveactionselection(f,function(b){this.detonate(f[b],!0)}.bind(this))}},getOutline:function(b){return s.path(this.getOutlineString(b).s).appendTo(VIEWPORT)},getOutlineString:function(b){"undefined"==typeof b&&(b=this.m);var e=transformPoint(b,{x:-16,y:-15}),f=transformPoint(b,{x:16,y:-15}),g=transformPoint(b,{x:16,y:15});b=transformPoint(b,
{x:-16,y:15});e=this.op=[e,f,g,b];return{s:"M "+e[0].x+" "+e[0].y+" L "+e[1].x+" "+e[1].y+" "+e[2].x+" "+e[2].y+" "+e[3].x+" "+e[3].y+" Z",p:e}},explode_base:function(){this.exploded=!0;this.unit.log("%0 explodes",this.name);SOUNDS[this.snd].play();this.g.remove();BOMBS.splice(BOMBS.indexOf(this),1)},explode:function(){this.explode_base()},detonate:function(b,e){OBSTACLES.splice(OBSTACLES.indexOf(this),1);this.explode_base()},endround:function(){},show:function(){},wrap_before:Unit.prototype.wrap_before,
wrap_after:Unit.prototype.wrap_after};function Weapon(b,e){this.isprimary=!1;this.issecondary=!0;$.extend(this,e);b.upgrades[b.upgrades.length]=this;this.wrapping=[];this.isactive=!0;this.unit=b;b.weapons.push(this)}
Weapon.prototype={isBomb:function(){return!1},isWeapon:function(){return!0},desactivate:function(){this.ordnance&&this.type.match(/Torpedo|Missile/)?this.ordnance=!1:(this.isactive=!1,this.unit.movelog("D-"+this.unit.upgrades.indexOf(this)),this.unit.show())},toString:function(){this.tooltip=formatstring(getupgtxttranslation(this.name,this.type));this.trname=translate(this.name).replace(/\'/g,"&#39;");this.left=1==this.unit.team;if(this.isactive){var b,e=this.getrangeallunits();for(b=0;b<e.length&&
!e[b].isenemy(this.unit);b++);this.nofire=b==e.length?!0:!1}this.attackkey=A[this.type.toUpperCase()].key;this.req=[];"undefined"!=typeof this.getrequirements()&&("Target".match(this.getrequirements())&&this.req.push([A.TARGET.key]),"Focus".match(this.getrequirements())&&this.req.push(A.FOCUS.key));this.uid=squadron.indexOf(this.unit);this.rank=this.unit.upgrades.indexOf(this);return Mustache.render(TEMPLATES.weapon,this)},prehit:function(b,e,f){},posthit:function(b,e,f){},getrequirements:function(){return this.requires},
getattack:function(){return this.attack},isTurret:function(){return this.type==TURRET},getlowrange:function(){return this.range[0]},gethighrange:function(){return this.range[1]},isinrange:function(b){return b>=this.getlowrange()&&b<=this.gethighrange()},modifydamagegiven:function(b){return b},modifyattackroll:function(b,e,f){return b},modifydamageassigned:function(b,e){return b},canfire:function(b){"undefined"==typeof b&&console.log("undefined unit: "+this.unit.name+" "+this.name);return!this.isactive||
this.unit.isally(b)||this.unit.checkcollision(b)?!1:"undefined"!=typeof this.getrequirements()?"Target".match(this.getrequirements())&&this.unit.canusetarget(b)||"Focus".match(this.getrequirements())&&this.unit.canusefocus(b)?!0:!1:!0},getrangeattackbonus:function(b){return this.isprimary&&1==this.getrange(b)?(this.unit.log("+1 attack for range 1"),1):0},declareattack:function(b){"undefined"!=typeof this.getrequirements()&&("Target".match(this.getrequirements())&&1==this.consumes&&this.unit.canusetarget(b)?
this.unit.removetarget(b):"Focus".match(this.getrequirements())&&1==this.consumes&&this.unit.canusefocus(b)&&this.unit.removefocustoken(),this.unit.show());return!0},getrangedefensebonus:function(b){return this.isprimary&&3==this.getrange(b)?(b.log("+1 defense for range 3"),1):0},getauxiliarysector:function(b){var e=this.unit.m;if("undefined"==typeof this.auxiliary)return 4;for(var f=this.unit.getoutlinerange(e,b).d,g=f;g<=f+1&&3>=g;g++)if(this.unit.isinsector(e,g,b,this.subauxiliary,this.auxiliary))return g;
return 4},getprimarysector:function(b){for(var e=this.unit.m,f=this.unit.getoutlinerange(e,b).d,g=f;g<=f+1&&3>=g;g++)if(this.unit.isinsector(e,g,b,this.unit.getPrimarySubSectorString,this.unit.getPrimarySectorString))return g;return 4},getsector:function(b){for(var e=this.unit.m,f=this.unit.getoutlinerange(e,b).d,g=f;g<=f+1&&3>=g;g++)if(this.unit.isinsector(e,g,b,this.unit.getPrimarySubSectorString,this.unit.getPrimarySectorString))return g;if("undefined"==typeof this.auxiliary)return 4;for(g=f;g<=
f+1&&3>=g;g++)if(this.unit.isinsector(e,g,b,this.subauxiliary,this.auxiliary))return g;return 4},getrange:function(b){if(!this.canfire(b))return 0;if(this.isTurret()||this.unit.isTurret(this))return b=this.unit.getrange(b),this.isinrange(b)?b:0;b=this.getsector(b);return b>=this.getlowrange()&&b<=this.gethighrange()?b:0},endattack:function(b,e){this.type.match(/Torpedo|Missile/)&&this.desactivate()},hasdoubleattack:function(){return!1},hasenemiesinrange:function(){for(var b in squadron){var e=squadron[b];
if(this.unit.isenemy(e)&&0<this.getrange(e))return!0}return!1},getenemiesinrange:function(b){var e=[];"undefined"==typeof b&&(b=squadron);for(var f in b){var g=b[f];this.unit.isenemy(g)&&0<this.getrange(g)&&e.push(g)}return e},getrangeallunits:function(){var b,e=[];for(b in squadron){var f=squadron[b];this.unit!=f&&0<this.getrange(f)&&e.push(f)}return e},wrap_before:Unit.prototype.wrap_before,wrap_after:Unit.prototype.wrap_after,endround:function(){},show:function(){}};
function Upgrade(b,e){$.extend(this,UPGRADES[e]);b.upgrades.push(this);this.isactive=!0;this.unit=b;this.wrapping=[]}function Upgradefromid(b,e){var f=UPGRADES[e];f.id=e;return f.type==BOMB?new Bomb(b,f):"undefined"!=typeof f.isWeapon?f.isWeapon()?new Weapon(b,f):new Upgrade(b,e):f.type.match(/Turretlaser|Bilaser|Mobilelaser|Laser180|Laser|Torpedo|Cannon|Missile|Turret/)||1==f.isweapon?new Weapon(b,f):new Upgrade(b,e)}
Upgrade.prototype={toString:function(){this.tooltip=formatstring(getupgtxttranslation(this.name,this.type));this.trname=translate(this.name).replace(/\'/g,"&#39;");this.left=1==this.unit.team;this.hasshield="undefined"!=typeof this.shield&&0<this.shield?!0:!1;this.hasfocus="undefined"!=typeof this.focus&&0<this.focus?!0:!1;if("undefined"!=typeof this["switch"]&&phase==SETUP_PHASE){for(j=0;j<this.unit.upgrades.length&&this.unit.upgrades[j]!=this;j++);this.hasswitch={uid:this.unit.id,uuid:j}}else this.hasswitch=
!1;return Mustache.render(TEMPLATES.upgrade,this)},isWeapon:function(){return!1},isBomb:function(){return!1},getlowrange:function(){return this.range[0]},gethighrange:function(){return this.range[1]},endround:function(){},desactivate:function(){this.ordnance&&this.type.match(/Torpedo|Missile/)?this.ordnance=!1:(this.isactive=!1,this.unit.movelog("D-"+this.unit.upgrades.indexOf(this)),this.unit.show())},show:function(){},install:function(b){if("undefined"!=typeof this.addedaction){var e=this.addedaction.toUpperCase();
b["addedaction"+this.id]=b.shipactionList.length;b.shipactionList.push(e);b.showactionlist()}"undefined"!=typeof this.upgrades&&(b["addedupg"+this.id]=b.upgradesno,"undefined"!=typeof this.pointsupg&&(b.upgbonus[this.upgrades[0]]=this.pointsupg),"undefined"!=typeof this.maxupg&&(b.maxupg[this.upgrades[0]]=this.maxupg),1==this.exclusive&&(b.exclupg[this.upgrades[0]]=!0),b.upgradetype=b.upgradetype.concat(this.upgrades),b.upgradesno=b.upgradetype.length,b.showupgradeadd());if("undefined"!=typeof this.lostupgrades){for(e=
0;e<b.upgradetype.length;e++)-1<this.lostupgrades.indexOf(b.upgradetype[e])&&(-1<b.upg[e]&&removeupgrade(b,e,b.upg[e]),b.upg[e]=-2);b.showupgradeadd()}if("undefined"!=typeof this.takesdouble){for(e=0;e<b.upgradetype.length&&(b.upgradetype[e]!=this.type||!(0>b.upg[e]||UPGRADES[b.upg[e]].name!=this.name));e++);e<b.upgradetype.length&&(-1<b.upg[e]&&removeupgrade(b,e,b.upg[e]),b.upg[e]=-2);b.showupgradeadd()}},uninstall:function(b){"undefined"!=typeof this.addedaction&&(this.addedaction.toUpperCase(),
b.shipactionList.splice(b["addedaction"+this.id],1));if("undefined"!=typeof this.upgrades){"undefined"!=typeof this.pointsupg&&(b.upgbonus[this.upgrades[0]]=0);"undefined"!=typeof this.maxupg&&(b.maxupg[this.upgrades[0]]=0);for(var e=0;e<this.upgrades.length;e++){var f=e+b["addedupg"+this.id],g=$("#unit"+b.id+" .upg div[num="+f+"]");0<g.length&&(g=g.attr("data"),removeupgrade(b,f,g))}1==typeof this.exclusive&&(b.exclupg[this.upgrades[0]]=!1);b.upgradetype.splice(b["addedupg"+this.id],this.upgrades.length);
b.upgradesno=b.upgradetype.length}if("undefined"!=typeof this.lostupgrades)for(e=0;e<b.upgradetype.length;e++)-1<this.lostupgrades.indexOf(b.upgradetype[e])&&(b.upg[e]=-1);if("undefined"!=typeof this.takesdouble)for(e=0;e<b.upgradetype.length;e++)b.upgradetype[e]==this.type&&-2==b.upg[e]&&(b.upg[e]=-1)},wrap_before:Unit.prototype.wrap_before,wrap_after:Unit.prototype.wrap_after};
var rebelonly=function(b){var e;for(e=0;e<PILOTS.length;e++)if(b==PILOTS[e].name&&PILOTS[e].faction==REBEL)return!0;return!1},empireonly=function(b){var e;for(e=0;e<PILOTS.length;e++)if(b==PILOTS[e].name&&PILOTS[e].faction==EMPIRE)return!0;return!1};var UPGRADES=[{name:"Ion Cannon Turret",type:TURRET,firesnd:"falcon_fire",points:5,attack:3,upgid:0,done:!0,modifyhit:function(b){return FCH_HIT},prehit:function(b,e,f){this.unit.hitresolved=1;this.unit.criticalresolved=0;b.log("+%1 %HIT%, +1 ion token [%0]",this.name,1);b.addiontoken()},range:[1,2]},{name:"Proton Torpedoes",requires:"Target",consumes:!0,type:TORPEDO,firesnd:"missile",points:4,done:!0,attack:4,init:function(b){b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(e,g){return b.weapons[b.activeweapon]==
this}.bind(this),aiactivate:function(b,e){return 0<FCH_focus(b)},f:function(b,e){0<FCH_focus(b)&&(this.unit.log("1 %FOCUS% -> 1 %CRIT% [%0]",this.name),b=b-FCH_FOCUS+FCH_CRIT);return b}.bind(this),str:"focus"});var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},range:[2,3]},{name:"R2 Astromech",done:!0,install:function(b){var e,f=this,g=[];b.installed=!0;b.wrap_after("getdial",this,function(b){if(0==g.length){for(e=0;e<b.length;e++){var h=
P[b[e].move].speed,m=b[e].difficulty;if(1==h||2==h)m="GREEN";g[e]={move:b[e].move,difficulty:m}}this.log("1, 2 speed maneuvers are green [%0]",f.name)}return g})},uninstall:function(b){"function"==typeof b.getdial.unwrap&&b.getdial.unwrap(this)},type:ASTROMECH,points:1},{name:"R2-D2",done:!0,init:function(b){var e=this;b.wrap_after("handledifficulty",this,function(b){"GREEN"==b&&this.shield<this.ship.shield&&(this.addshield(1),this.log("+1 %SHIELD% [%0]",e.name))})},unique:!0,type:ASTROMECH,points:4},
{name:"R2-F2",done:!0,candoaction:function(){return this.isactive},action:function(b){var e=this.unit;this.isactive&&(this.unit.log("+1 agility until end of round [%0]",e.name),e.wrap_after("getagility",this,function(b){return b+1}).unwrapper("endphase"),e.showstats());e.endaction(b,ASTROMECH);return!0},unique:!0,type:ASTROMECH,points:3},{name:"R5-D8",done:!0,candoaction:function(){if(!this.isactive)return!1;for(var b=0;b<this.unit.criticals.length;b++)if(0==this.unit.criticals[b].isactive)return!0;
return!1},action:function(b){var e=this;this.isactive?this.unit.endaction(b,ASTROMECH):this.unit.defenseroll(1).done(function(f){if(0<FE_evade(f.roll)+FE_focus(f.roll))for(f=0;f<this.criticals.length;f++)if(0==this.criticals[f].isactive){this.log("-1 %HIT% [%0]",e.name);this.criticals.slice(f,1);this.addhull(1);this.show();break}this.endaction(b,ASTROMECH)}.bind(this.unit))},unique:!0,type:ASTROMECH,points:3},{name:"R5-X3",unique:!0,type:ASTROMECH,points:1,done:!0,init:function(b){var e=this;b.wrap_after("updateactivationdial",
this,function(){this.addactivationdial(function(){return!this.hasionizationeffect()&&e.isactive}.bind(this),function(){this.log("ignore obstacles [%0]",e.name);e.desactivate();this.wrap_after("hascollidedobstacle",e,function(b){return!1}).unwrapper("endphase");this.wrap_after("isfireobstructed",this,function(){return!1}).unwrapper("endphase");this.wrap_after("getobstructiondef",this,function(){return 0}).unwrapper("endphase");this.show()}.bind(this),A[ASTROMECH.toUpperCase()].key,$("<div>").attr({"class":"symbols"}));
return this.activationdial})}},{name:"BB-8",unique:!0,done:!0,type:ASTROMECH,points:2,init:function(b){var e=this;e.bb=-1;b.wrap_after("updateactivationdial",this,function(b){e.isactive&&e.bb!=round&&!this.hasionizationeffect()&&this.addactivationdial(function(){return!this.hasmoved&&-1<this.maneuver&&"GREEN"==this.getmaneuver().difficulty&&this.candoroll()&&!this.hasionizationeffect()}.bind(this),function(){e.bb=round;this.doaction([this.newaction(this.resolveroll,"ROLL")],e.name+" free roll for green maneuver.")}.bind(this),
A[ASTROMECH.toUpperCase()].key,$("<div>").attr({"class":"symbols",title:e.name}));return this.activationdial})}},{name:"Integrated Astromech",points:0,type:MOD,ship:"X-Wing",done:!0,init:function(b){var e=this;b.wrap_after("deal",this,function(b,g,h){var f=-1,m;for(m in this.upgrades)if(b=this.upgrades[m],b.type==ASTROMECH&&1==b.isactive){f=m;break}if(-1==f||!e.isactive)return h;var q=$.Deferred();h.then(function(b){1==this.shield+this.hull||b.face==FACEUP&&b.crit.lethal&&2>=this.shield+this.hull?
(this.upgrades[f].desactivate(),this.log("%0 is inactive, damage discarded [%1]",this.upgrades[f].name,e.name),e.desactivate(),q.resolve({crit:b.crit,face:DISCARD})):q.resolve(b)}.bind(this));return q.promise()})}},{name:"Weapons Guidance",points:2,type:TECH,done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,g){return e.isactive&&this.canusefocus()}.bind(b),aiactivate:function(b,e){return 0<FCH_blank(b,e)},f:function(b,g){var f=FCH_blank(b,g);this.removefocustoken();
displayattacktokens(this);0<f&&(this.log("1 blank -> 1 %HIT% [%0]",e.name),b+=FCH_HIT);return b}.bind(b),str:"blank"})}},{name:"R5-K6",init:function(b){var e=this;b.wrap_after("removetarget",this,function(b){this.defenseroll(1).done(function(f){0<FE_evade(f.roll)&&(this.addtarget(b),this.log("+1 %TARGET% / %1 [%0]",e.name,b.name))}.bind(this))})},done:!0,unique:!0,type:ASTROMECH,points:2},{name:"R5 Astromech",done:!0,init:function(b){var e=this;b.wrap_before("endphase",this,function(){for(var b=-1,
g=-1,h=0;h<this.criticals.length;h++){var l=this.criticals[h];if(l.isactive&&"ship"==l.type&&(b=h,l.lethal)){g=h;break}}-1<g?(this.log("repairing critical %1 [%0]",e.name,this.criticals[g].name),this.criticals[g].facedown()):-1<b&&(this.log("repairing critical %1 [%0]",e.name,this.criticals[b].name),this.criticals[b].facedown())})},type:ASTROMECH,points:1},{name:"Determination",done:!0,init:function(b){var e=this;b.wrap_after("deal",this,function(b,g,h){if("pilot"!=b.type)return h;var f=$.Deferred();
h.then(function(b){b.face==FACEUP?(this.log("discarding critical %1 [%0]",e.name,b.crit.name),f.resolve({crit:b.crit,face:DISCARD})):f.resolve(b)}.bind(this));return f.promise()})},type:ELITE,points:1},{name:"Swarm Tactics",type:ELITE,points:2,done:!0,init:function(b){var e=this;"undefined"==typeof Unit.prototype.getswarm&&(Unit.prototype.getswarm=function(){return[[],[],[]]});Unit.prototype.wrap_after("getswarm",this,function(b){b[e.unit.team]=b[e.unit.team].concat(e.unit);return b});e.unit.propswarm=
-1;b.wrap_before("begincombatphase",this,function(){var b=this.getswarm()[this.team],g=this;if(this==b[0])for(var h=b.length,l=0;l<h;l++)this.doselection(function(f){b.sort(function(b,e){return b.getskill()>e.getskill()?1:b.getskill()<e.getskill()?-1:0});var h=b.pop(),l=h.selectnearbyally(1,function(b,e){return b.getskill()>e.getskill()});h.select();var m=h.getskill();0==l.length?g.endnoaction(f,"SELECT"):h.resolveactionselection(l,function(b){l[b].wrap_after("getskill",e,function(b){return m}).unwrapper("endcombatphase");
l[b].log("PS set to %1 [%0]",e.name,m);l[b].showskill();g.endnoaction(f,"SELECT")})})})}},{name:"Squad Leader",unique:!0,done:!0,type:ELITE,points:2,candoaction:function(){var b=this.unit.selectnearbyally(2,function(b,f){return f.getskill()<b.getskill()&&f.candoaction()});return this.isactive&&0<b.length},action:function(b){var e=this.unit,f=e.selectnearbyally(2,function(b,e){return e.getskill()<b.getskill()&&e.candoaction()});0<f.length?e.resolveactionselection(f,function(g){f[g].select();f[g].doaction(f[g].getactionlist(),
"+1 free action").done(function(){e.select()});e.endaction(b,"ELITE")}):(e.log("no lower skilled pilot within range 2 [%0]",this.name),e.endaction(b,"ELITE"))}},{name:"Expert Handling",candoaction:function(){return this.isactive&&-1==this.unit.actionsdone.indexOf("ROLL")},action:function(b){-1==this.unit.shipactionList.indexOf("ROLL")&&this.unit.addstress();0<this.unit.istargeted.length?(this.unit.log("select target to lock [%0]",this.name),this.unit.resolveactionselection(this.unit.istargeted,function(e){this.istargeted[e].removetarget(this);
this.resolveroll(b)}.bind(this.unit))):this.unit.resolveroll(b)},type:ELITE,done:!0,points:2},{name:"Marksmanship",init:function(b){this.mark=-1;var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return this.mark==round&&this.isactive}.bind(this),aiactivate:function(b,e){return 0<FCH_focus(b)},f:function(b,g){var f=FCH_focus(b);0<f&&this.mark==round&&(1<f?this.unit.log("%0 %FOCUS% -> 1 %CRIT%, %1 %HIT% [%2]",f,f-1,e.name):this.unit.log("1 %FOCUS% -> 1 %CRIT% [%1]",f,e.name),
b=b-FCH_FOCUS*f+FCH_CRIT+(f-1)*FCH_HIT);return b}.bind(this),str:"focus",noreroll:"focus"})},candoaction:function(){return this.isactive},action:function(b){this.mark=round;this.unit.endaction(b,ELITE)},done:!0,type:ELITE,points:3},{name:"Concussion Missiles",requires:"Target",consumes:!0,type:MISSILE,firesnd:"missile",points:4,attack:4,done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(f,g){return b.weapons[b.activeweapon]==this&&e.isactive}.bind(this),
f:function(b,e){0<FCH_blank(b,e)&&(b+=FCH_HIT);return b}.bind(this),str:"blank"});b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},range:[2,3]},{name:"Cluster Missiles",type:MISSILE,firesnd:"missile",requires:"Target",consumes:!0,points:4,attack:3,done:!0,followupattack:function(){return this.unit.weapons.indexOf(this)},hasdoubleattack:function(){return this.twinattack=!this.twinattack},init:function(b){this.twinattack=!1;b.wrap_after("setpriority",
this,function(b){"TARGET"==b.type&&self.isactive&&this.candotarget()&&(b.priority+=10)})},range:[1,2]},{name:"Daredevil",done:!0,candoaction:function(){return this.isactive},action:function(b){var e=this;this.unit.log("select maneuver [%0]",this.name);this.unit.resolveactionmove([this.unit.getpathmatrix(this.unit.m,"TL1"),this.unit.getpathmatrix(this.unit.m,"TR1")],function(f,g){if(-1==g)return f.endaction(b,ELITE);f.addstress();if(-1==f.shipactionList.indexOf("BOOST")){f.log("2 rolls for damage [%0]",
e.name);for(var h=f.rollattackdie(2,e,"hit"),l=0;2>l;l++)"hit"==h[l]?f.resolvehit(1):"critical"==h[l]&&f.resolvecritical(1);f.checkdead()}f.endaction(b,ELITE)},!0,!0)},type:ELITE,points:3},{name:"Elusiveness",done:!0,init:function(b){var e=this;b.adddicemodifier(DEFENSE_M,MOD_M,ATTACK_M,this,{req:function(){return 0==this.stress&&targetunit==this&&e.isactive}.bind(b),aiactivate:function(e,g){b.log("activate elusiveness "+FCH_crit(e)+" "+FCH_hit(e));return 0<FCH_crit(e)+FCH_hit(e)},f:function(b,e){this.unit.addstress();
0<FCH_crit(b)?(this.unit.log("1 %CRIT% rerolled [%0]",this.name),b=b-FCH_CRIT+activeunit.attackroll(1)):0<FCH_hit(b)&&(this.unit.log("1 %HIT% rerolled [%0]",this.name),b=b-FCH_HIT+activeunit.attackroll(1));return b}.bind(this),str:"critical"})},type:ELITE,points:2},{name:"Homing Missiles",requires:"Target",consumes:!1,type:MISSILE,firesnd:"missile",attack:4,range:[2,3],done:!0,declareattack:function(b){targetunit.wrap_after("canuseevade",this,function(){return!1}).unwrapper("afterdefenseeffect");
targetunit.log("cannot use evade tokens [%0]",this.name);return Weapon.prototype.declareattack.call(this,b)},init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},points:5},{name:"Push the Limit",init:function(b){var e=this;e.r=-1;b.wrap_before("endaction",this,function(b,g){e.r!=round&&this.candoaction()&&null!=g&&(e.r=round,this.doaction(this.getactionbarlist(),"+1 free action (Skip to cancel) ["+e.name+"]").done(function(b){null==
b?e.r=-1:this.addafteractions(function(){this.addstress()}.bind(this))}.bind(this)))})},done:!0,type:ELITE,points:3},{name:"Deadeye",init:function(b){for(var e in b.weapons)b.weapons[e].wrap_after("getrequirements",this,function(b){return"Target"==b?"Target|Focus":b})},done:!0,type:ELITE,points:1},{name:"Expose",candoaction:function(){return this.isactive},action:function(b){var e=this.unit.weapons[0];this.unit.log("-1 agility, +1 primary attack until end of turn [%0]",this.name);this.unit.wrap_after("getagility",
this,function(b){return 0<b?b-1:0}).unwrapper("endphase");e.wrap_after("getattack",this,function(b){return b+1}).unwrapper("endround");this.unit.showstats();this.unit.endaction(b,ELITE)},done:!0,type:ELITE,points:4},{name:"Gunner",done:!0,init:function(b){for(var e in b.weapons)b.weapons[e].immediateattack={pred:function(b){return 0==b},weapon:function(){return 0}};b.addattack(function(b,e){return this.weapons[0].isactive&&0==b+e},this,[b.weapons[0]],function(){this.noattack=round},function(){return this.selectnearbyenemy(3)})},
type:CREW,points:5},{name:"Ion Cannon",type:CANNON,firesnd:"slave_fire",done:!0,modifyhit:function(b){return FCH_HIT},prehit:function(b,e,f){this.unit.hitresolved=1;this.unit.criticalresolved=0;b.log("+%1 %HIT%, +1 ion token [%0]",this.name,1);b.addiontoken()},points:3,attack:3,range:[1,3]},{name:"Heavy Laser Cannon",type:CANNON,firesnd:"slave_fire",done:!0,modifydamagegiven:function(b){if(0<FCH_crit(b)){var e=FCH_crit(b);this.unit.log("%0 %CRIT%-> %0 %HIT% [%1]",e,this.name);b=b-FCH_CRIT*e+e*FCH_HIT}return b},
points:7,attack:4,range:[2,3]},{name:"Seismic Charges",done:!0,img:"seismic.png",snd:"explode",width:16,height:8,size:15,explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){for(var b=this.getrangeallunits(),e=0;e<b[1].length;e++){var f=squadron[b[1][e].unit];f.log("+1 %HIT% [%0]",this.name);f.resolvehit(1);f.checkdead()}this.explode_base()}},type:BOMB,points:2},{name:"Mercenary Copilot",init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return 3==
this.getrange(targetunit)}.bind(b),aiactivate:function(b,e){return 0<FCH_hit(b)},f:function(b,g){0<FCH_hit(b)&&(this.log("1 %HIT% -> 1 %CRIT% [%0]",e.name),b=b-FCH_HIT+FCH_CRIT);return b}.bind(b),str:"hit"})},done:!0,type:CREW,points:2},{name:"Assault Missiles",type:MISSILE,requires:"Target",consumes:!0,firesnd:"missile",done:!0,prehit:function(b,e,f){e=b.getrangeallunits();for(f=0;f<e[1].length;f++)squadron[e[1][f].unit]!=b&&(squadron[e[1][f].unit].log("+1 %HIT% [%0]",this.name),squadron[e[1][f].unit].resolvehit(1))},
init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},points:5,attack:4,range:[2,3]},{name:"Veteran Instincts",done:!0,install:function(b){b.installed=!0;b.wrap_after("getskill",this,function(b){return b+2});b.showskill()},uninstall:function(b){"function"==typeof b.getskill.unwrap&&b.getskill.unwrap(this);b.showskill()},type:ELITE,points:1},{name:"Proximity Mines",img:"proximity.png",snd:"explode",width:18,height:18,
size:35,done:!0,stay:!0,candoaction:function(){return this.unit.lastdrop!=round&&this.isactive},action:function(b){this.actiondrop(b)},canbedropped:function(){return!1},explode:function(){},detonate:function(b){if(!this.exploded){for(var e=this.unit.rollattackdie(3,this,"critical"),f=0;3>f;f++)"hit"==e[f]?(b.log("+1 %HIT% [%0]",this.name),b.resolvehit(1),b.checkdead()):"critical"==e[f]&&(b.log("+1 %CRIT% [%0]",this.name),b.resolvecritical(1),b.checkdead());Bomb.prototype.detonate.call(this)}},getOutlineString:function(b){var e=
"M ";this.op=[];"undefined"==typeof b&&(b=this.m);for(var f=0;25>f;f++){var g=transformPoint(b,{x:this.size*Math.sin(2*f*Math.PI/25),y:this.size*Math.cos(2*f*Math.PI/25)});this.op.push(g);e+=g.x+" "+g.y+" ";0==f&&(e+="L ")}return{s:e+"Z",p:this.op}},type:BOMB,points:3},{name:"Weapons Engineer",type:CREW,points:3,done:!0,init:function(b){this.second=!1;var e=this;b.boundtargets=function(b){if(-1<this.targeting.indexOf(b))return!0;for(b=this.targeting.length-2;0<=b;b--)this.removetarget(this.targeting[b]);
return!1};b.wrap_after("addtarget",this,function(b){1==this.second?this.second=!1:this.doselection(function(b){this.second=!0;this.log("select target to lock [%0]",e.name);this.resolvetargetnoaction(b,!0)}.bind(this))})}},{name:"Draw Their Fire",init:function(b){var e=this;e.ea=Unit.prototype.resolvecritical;Unit.prototype.resolvecritical=function(f){!e.unit.dead&&e.isactive&&0<f&&this.isally(b)&&b!=this&&1==this.getrange(b)?(this.selectunit([this,b],function(f,h){0==h?e.ea.call(this,1):e.ea.call(b,
1)},["select unit [%0]",e.name],!1),e.ea.call(this,f-1)):e.ea.call(this,f);return f}},done:!0,type:ELITE,points:1},{name:"Luke Skywalker",faction:REBEL,unique:!0,done:!0,init:function(b){var e=this,f;for(f in b.weapons)b.weapons[f].immediateattack={pred:function(b){return 0==b},weapon:function(){return 0}};b.addattack(function(b,e){return this.weapons[0].isactive&&0==b+e},this,[b.weapons[0]],function(){this.noattack=round},function(){return this.selectnearbyenemy(3)});b.adddicemodifier(ATTACK_M,MOD_M,
ATTACK_M,this,{req:function(b,f){return e.unit.addedattack==round&&e.isactive},aiactivate:function(b,e){return 0<FCH_focus(b)},f:function(b,f){0<FCH_focus(b)&&(this.log("1 %FOCUS% -> 1 %HIT% [%0]",e.name),b=b-FCH_FOCUS+FCH_HIT);return b},str:"focus"})},type:CREW,points:7},{name:"Nien Nunb",faction:REBEL,done:!0,install:function(b){b.installed=!0;b.wrap_after("getdial",this,function(b){for(var e=0;e<b.length;e++)b[e].move.match(/F[1-5]/)&&(b[e].difficulty="GREEN");return b})},uninstall:function(b){"function"==
typeof b.getdial.unwrap&&b.getdial.unwrap(this)},unique:!0,type:CREW,points:1},{name:"Chewbacca",faction:REBEL,unique:!0,done:!0,type:CREW,init:function(b){var e=this;b.wrap_after("deal",this,function(b,g,h){if(!e.isactive)return h;var f=$.Deferred();h.then(function(b){1==this.hull+this.shield||b.face==FACEUP&&b.crit.lethal&&2>=this.hull+this.shield?(this.shield<this.ship.shield&&this.addshield(1),this.log("+1 %SHIELD%, 1 damage discarded [%0]",e.name),e.desactivate(),f.resolve({crit:b.crit,face:DISCARD})):
f.resolve(b)}.bind(this));return f.promise()})},points:4},{name:"Advanced Proton Torpedoes",requires:"Target",consumes:!0,type:TORPEDO,firesnd:"missile",attack:5,done:!0,range:[1,1],init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(e,g){return b.weapons[b.activeweapon]==this}.bind(this),aiactivate:function(b,e){return 0<FCH_blank(b,e)},f:function(b,e){var f=FCH_blank(b,e);3<f&&(f=3);0<f&&(this.unit.log("%0 blanks -> %0 %FOCUS% [%1]",f,this.name),b+=f*FCH_FOCUS);
return b}.bind(this),str:"blank"});b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},points:6},{name:"Autoblaster",type:CANNON,done:!0,firesnd:"slave_fire",attack:3,declareattack:function(b){var e=this;b.wrap_after("cancelhit",e,function(b,g,h){e.unit.log("%HIT% cannot be cancelled [%0]",e.name);return b}).unwrapper("afterdefenseeffect");return Weapon.prototype.declareattack.call(this,b)},range:[1,1],points:5},{name:"Fire-Control System",
done:!0,init:function(b){var e=this;e.f=-1;b.wrap_before("postattack",this,function(b){this.reroll=10});b.addafterattackeffect(this,function(){-1<this.gettargetableunits(3).indexOf(targetunit)?(this.log("+1 %TARGET% / %1 [%0]",e.name,targetunit.name),this.addtarget(targetunit)):this.log("no valid target [%0]",e.name)})},type:SYSTEM,points:2},{name:"Blaster Turret",type:TURRET,done:!0,firesnd:"falcon_fire",requires:"Focus",consumes:!0,points:4,attack:3,range:[1,2]},{name:"Recon Specialist",init:function(b){var e=
this;b.wrap_before("addfocus",this,function(f){b.log("+1 %FOCUS% [%0]",e.name);b.addfocustoken()})},done:!0,type:CREW,points:3},{name:"Saboteur",type:CREW,done:!0,candoaction:function(){var b=this.unit.selectnearbyenemy(1);return this.isactive&&0<b.length},action:function(b){var e=this;if(this.isactive){var f=this.unit.selectnearbyenemy(1);0<f.length?(this.unit.log("select unit [%0]",this.name),this.unit.resolveactionselection(f,function(g){var h,l=[];for(h=0;h<f[g].criticals.length;h++)0==f[g].criticals[h].isactive&&
l.push(h);0<l.length?(h=f[g].rand(l.length),f[g].log("turn faceup one damage card [%0]",e.name),f[g].criticals[l[h]].faceup(),f[g].show()):f[g].log("no damage card [%0]",e.name);this.endaction(b,"CREW")}.bind(this.unit))):this.unit.endaction(b,"CREW")}else this.unit.endaction(b,"CREW")},points:2},{name:"Intelligence Agent",done:!0,init:function(b){var e=this;b.wrap_before("beginactivationphase",this,function(){this.selectunit(this.selectnearbyenemy(2),function(b,g){b[g].showmaneuver();var f=b[g].getmaneuver();
b[g].log("has a %0<span class='symbols'>"+P[f.move].key+"</span> maneuver [%1]",P[f.move].speed,e.name)},["select unit [%0]",e.name],!1)})},type:CREW,points:1},{name:"Proton Bombs",done:!0,width:32,height:30,size:15,snd:"explode",img:"proton.png",explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){for(var b=this.getrangeallunits(),e=0;e<b[1].length;e++)squadron[b[1][e].unit].applycritical(1),squadron[b[1][e].unit].checkdead();this.explode_base()}},type:BOMB,points:5},{name:"Adrenaline Rush",
done:!0,init:function(b){var e=this;b.wrap_after("updateactivationdial",this,function(){this.addactivationdial(function(){return!this.hasionizationeffect()&&!this.hasmoved&&e.isactive&&-1<this.maneuver&&"RED"==this.getmaneuver().difficulty}.bind(this),function(){this.log("red into white maneuver [%0]",e.name);e.desactivate();this.wrap_after("getmaneuver",e,function(b){return{move:b.move,difficulty:"WHITE"}}).unwrapper("endactivationphase");this.show()}.bind(this),A[ELITE.toUpperCase()].key,$("<div>").attr({"class":"symbols"}));
return this.activationdial})},type:ELITE,points:1},{name:"Advanced Sensors",done:!0,init:function(b){var e=this;b.wrap_before("beginactivation",this,function(){this.candoaction()&&!this.hasionizationeffect()&&this.doaction(this.getactionlist(),"").done(function(b){null!=b&&this.wrap_after("candoendmaneuveraction",e,function(){return!1}).unwrapper("endactivationphase")}.bind(this))})},type:SYSTEM,points:3},{name:"Sensor Jammer",init:function(b){var e=this;b.adddicemodifier(DEFENSE_M,MOD_M,ATTACK_M,
this,{req:function(b,g){return e.isactive}.bind(b),aiactivate:function(b,e){return 0<FCH_hit(b)},f:function(b,g){0<FCH_hit(b)&&(this.unit.log("1 %HIT% -> 1 %FOCUS% [%0]",e.name),b=b-FCH_HIT+FCH_FOCUS);return b}.bind(this),str:"hit"})},done:!0,type:SYSTEM,points:4},{name:"Darth Vader",faction:EMPIRE,unique:!0,done:!0,init:function(b){var e=this;b.addafterattackeffect(e,function(){this.hasfired&&this.donoaction([{org:e,type:"CREW",name:e.name,action:function(b){e.unit.log("+%1 %HIT% [%0]",e.name,2);
targetunit.log("+1 %CRIT% [%0]",e.name);this.resolvehit(2);SOUNDS.explode.play();targetunit.resolvecritical(1);this.checkdead();targetunit.checkdead();this.endnoaction(b,"CREW")}.bind(this)}],"",!0)})},type:CREW,points:3},{name:"Rebel Captive",faction:EMPIRE,done:!0,init:function(b){var e=this;b.rebelcaptive=0;b.wrap_before("isattackedby",this,function(b,g){this.rebelcaptive!=round&&(g.log("+1 %STRESS% [%0]",e.name),g.addstress(),this.rebelcaptive=round)}.bind(this))},unique:!0,type:CREW,points:3},
{name:"Flight Instructor",init:function(b){var e=this;b.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,{dice:["focus"],n:function(){return 2>=activeunit.getskill()?2:1},req:function(b,g,h){this.isactive&&this.unit.log("+%1 %FOCUS% reroll(s) [%0]",e.name,2>=activeunit.getskill()?2:1);return this.isactive}.bind(this)})},done:!0,type:CREW,points:4},{name:"Navigator",init:function(b){b.wrap_after("getmaneuverlist",this,function(b){var e=this.getdial();if(this.hasionizationeffect())return b;for(var g in b){var h=
g.replace(/\d/,"");for(j=0;j<e.length;j++)!e[j].move.match(h)||"undefined"!=typeof b[e[j].move]||"RED"==e[j].difficulty&&0!=this.stress||(b[e[j].move]=e[j])}return b})},done:!0,type:CREW,points:3},{name:"Opportunist",done:!0,init:function(b){var e=this;b.wrap_after("preattackroll",this,function(b,g){0==g.focus+g.evade&&0==this.stress&&this.donoaction([{org:this,name:this.name,type:"ELITE",action:function(b){this.wrap_after("getattackstrength",e,function(b,e,f){return f+1}).unwrapper("endattack");
this.addstress();this.log("+1 attack against %1, +1 %STRESS% [%0]",e.name,g.name);this.endnoaction(b,"ELITE")}.bind(this)}],"",!0)})},type:ELITE,points:4},{name:"Ion Pulse Missiles",requires:"Target",consumes:!1,type:MISSILE,firesnd:"missile",done:!0,modifyhit:function(b){return FCH_HIT},prehit:function(b,e,f){this.unit.log("+%1 %HIT%, +1 ion token [%0]",this.name,2);this.unit.hitresolved=1;this.unit.criticalresolved=0;b.addiontoken();b.addiontoken()},init:function(b){var e=this;b.wrap_after("setpriority",
this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},points:3,attack:3,range:[2,3]},{name:"Wingman",done:!0,init:function(b){var e=this;b.wrap_before("begincombatphase",this,function(){this.selectunit(this.selectnearbyally(1,function(b,e){return 0<e.stress}),function(b,e){b[e].removestresstoken()},["select unit [%0]",e.name],!1)})},type:ELITE,points:2},{name:"Decoy",init:function(b){var e=this;b.wrap_before("begincombatphase",this,function(){this.selectunit(this.selectnearbyally(2),
function(b,g){var f=b[g].getskill(),l=this.getskill();this.wrap_after("getskill",e,function(b){return f}).unwrapper("endcombatphase");b[g].wrap_after("getskill",e,function(b){return l}).unwrapper("endcombatphase")},["select unit (or self to cancel) [%0]",e.name],!0)})},done:!0,type:ELITE,points:2},{name:"Outmaneuver",done:!0,init:function(b){var e=this;b.wrap_before("resolveattack",this,function(b,g){g.wrap_after("getdefensestrength",e,function(b,f,g){return!this.isinfiringarc(f)&&f.isinfiringarc(this)&&
0<g?(this.log("-1 defense [%0]",e.name),g-1):g}).unwrapper("dodefenseroll")})},type:ELITE,points:3},{name:"Predator",done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus"],n:function(){return 2>=targetunit.getskill()?2:1},req:function(b,g,h){this.log("+%1 reroll(s) [%0]",e.name,2>=targetunit.getskill()?2:1);return e.isactive}.bind(b)})},type:ELITE,points:3},{name:"Flechette Torpedoes",requires:"Target",consumes:!0,type:TORPEDO,firesnd:"missile",
done:!0,endattack:function(b,e){4>=targetunit.hull&&targetunit.addstress();Weapon.prototype.endattack.call(this)},init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},points:2,attack:3,range:[2,3]},{name:"R7 Astromech",type:ASTROMECH,points:2,done:!0,init:function(b){b.adddicemodifier(DEFENSE_M,REROLL_M,ATTACK_M,this,{dice:["critical","hit","focus"],n:function(){return 9},req:function(){return-1<this.targeting.indexOf(activeunit)}.bind(b),
mustreroll:!0})}},{name:"R7-T1",candoaction:function(){return this.isactive},action:function(b){var e=this.unit.selectnearbyenemy(2);0<e.length&&this.isactive?(this.unit.log("select unit [%0]",this.name),this.unit.resolveactionselection(e,function(f){e[f]!=this?(e[f].isinfiringarc(this)&&this.addtarget(e[f]),this.resolveboost(b)):this.endaction(b,"ASTROMECH")}.bind(this.unit))):this.unit.endaction(b,"ASTROMECH")},done:!0,unique:!0,type:ASTROMECH,points:3},{name:"Tactician",type:CREW,limited:!0,points:2,
done:!0,init:function(b){var e=this;b.addafterattackeffect(this,function(b,g){2==this.getsector(targetunit)&&(targetunit.addstress(),targetunit.log("+1 %STRESS% [%0]",e.name))})}},{name:"R2-D2",faction:REBEL,unique:!0,type:CREW,points:4,done:!0,init:function(b){var e=this;b.wrap_after("endphase",this,function(){for(var b=[],g=this.criticals,h=0;h<g.length;h++)g[h].isactive||b.push(g[h]);0==this.shield&&0<this.ship.shield&&(this.log("+1 %SHIELD% [%0]",e.name),this.addshield(1),this.show(),0<b.length&&
(b=b[this.rand(b.length)],0<FCH_hit(this.attackroll(1))&&(this.log("+1 %CRIT% [%0]",this.name),b.faceup())))})}},{name:"C-3PO",unique:!0,faction:REBEL,type:CREW,points:3,done:!0,init:function(b){var e=-1;b.wrap_after("defenseroll",this,function(b,g){if(e==round)return g;var f=$.Deferred();e=round;g.done(function(b){this.guessevades(b,f)}.bind(this));return f.promise()})}},{name:"R3-A2",done:!0,init:function(b){var e=this;b.wrap_before("resolveattack",this,function(b,g){this.isinfiringarc(g)&&this.donoaction([{org:e,
name:e.name,type:"ASTROMECH",action:function(b){this.addstress();this.log("+1 %STRESS% [%0]",e.name);g.log("+1 %STRESS% [%0]",e.name);g.addstress();this.endnoaction(b,"ASTROMECH")}.bind(this)}],"",!0)})},unique:!0,type:ASTROMECH,points:2},{name:"R2-D6",upgrades:[ELITE],noupgrades:ELITE,skillmin:3,done:!0,unique:!0,type:ASTROMECH,points:1},{name:"Enhanced Scopes",done:!0,init:function(b){var e=this;b.wrap_before("beginactivationphase",this,function(){this.log("PS set to %1 [%0]",e.name,0);this.wrap_after("getskill",
e,function(b){return 0}).unwrapper("endactivationphase")})},type:SYSTEM,points:1},{name:"Chardaan Refit",type:MISSILE,done:!0,firesnd:"missile",isWeapon:function(){return!1},points:-2,ship:"A-Wing"},{name:"Proton Rockets",type:MISSILE,firesnd:"missile",requires:"Focus",consumes:!1,points:3,attack:2,done:!0,getattack:function(){a=this.attack;return a=3>=this.unit.agility?a+this.unit.agility:a+3},init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"FOCUS"==b.type&&e.isactive&&this.candofocus()&&
(b.priority+=10)})},range:[1,1]},{name:"Kyle Katarn",faction:REBEL,unique:!0,done:!0,type:CREW,points:3,init:function(b){var e=this;b.wrap_after("removestresstoken",this,function(){this.log("-1 stress -> +1 %FOCUS% [%0]",e.name);this.addfocustoken()})}},{name:"Jan Ors",faction:REBEL,unique:!0,type:CREW,points:2,done:!0,init:function(b){this.jan=-1;var e=this;Unit.prototype.wrap_after("addfocustoken",this,function(){!e.unit.dead&&3>=this.getrange(b)&&this.isally(b)&&e.jan<round&&(this.log("select %FOCUS% or %EVADE% token [%0]",
e.name),this.donoaction([{name:e.name,org:e,type:"FOCUS",action:function(b){this.endnoaction(b,"FOCUS")}.bind(this)},{name:e.name,org:e,type:"EVADE",action:function(b){e.jan=round;this.focus--;this.addevadetoken();this.endnoaction(b,"EVADE")}.bind(this)}],"",!1))})}},{name:"R4-D6",init:function(b){var e=this;b.wrap_after("cancelhit",this,function(f,g,h){f=FCH_hit(h.ch);if(3<=f){b.log("cancelling %0 hits [%1]",f-2,e);f-=2;g=h.ch-f*FCH_HIT;for(var l=0;l<f;l++)b.addstress();return{ch:g,e:h.e}}return h})},
done:!0,unique:!0,type:ASTROMECH,points:1},{name:"R5-P9",done:!0,init:function(b){var e=this;b.wrap_before("endcombatphase",this,function(){this.canusefocus()&&this.shield<this.ship.shield&&(this.addshield(1),this.log("1 %FOCUS% -> 1 %SHIELD% [%0]",e.name),this.removefocustoken())})},unique:!0,type:ASTROMECH,points:3},{name:"Han Solo",faction:REBEL,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,g){return e.isactive&&-1<this.targeting.indexOf(targetunit)}.bind(b),
aiactivate:function(b,e){return 0<FCH_focus(b)},f:function(b,g){var f=FCH_focus(b);this.log("%0 %FOCUS% -> %0 %HIT% [%1]",f,e.name);this.removetarget(targetunit);return b-FCH_FOCUS*f+FCH_HIT*f}.bind(b),str:"target",noreroll:"focus"})},type:CREW,unique:!0,done:!0,points:2},{name:"Leia Organa",faction:REBEL,type:CREW,unique:!0,done:!0,init:function(b){var e=this;b.wrap_before("beginactivationphase",this,function(){e.isactive&&this.donoaction([{type:"CREW",org:e,name:e.name,action:function(f){e.desactivate();
for(var g in squadron)squadron[g].isally(b)&&squadron[g].wrap_after("getmaneuver",e,function(b){"RED"==b.difficulty&&(b.difficulty="WHITE");return b}).unwrapper("endactivationphase");this.endnoaction(f,"CREW")}.bind(this)}],"",!0)})},points:4},{name:"Targeting Coordinator",type:CREW,limited:!0,done:!0,points:4},{name:"Lando Calrissian",faction:REBEL,type:CREW,unique:!0,done:!0,candoaction:function(){return this.isactive},action:function(b){var e=this,f="";this.isactive?this.unit.defenseroll(2).done(function(g){var h=
FE_focus(g.roll);g=FE_evade(g.roll);for(var l=0;l<h;l++)this.addfocustoken();0<h&&(f+=" +"+h+" %FOCUS%");for(l=0;l<g;l++)this.addevadetoken();0<g&&(f+=" +"+g+" %EVADE%");""==f?this.log("no effect [%0]",e.name):this.log(f+" [%0]",e.name);this.endaction(b,"CREW")}.bind(this.unit)):this.unit.endaction(b,"CREW")},points:3},{name:"Mara Jade",faction:EMPIRE,type:CREW,unique:!0,done:!0,init:function(b){var e=this;b.wrap_before("endcombatphase",this,function(){for(var b=this.gettargetableunits(1),g=0;g<b.length;g++)0==
b[g].stress&&(b[g].log("+1 %STRESS% [%0]",e.name),b[g].addstress())})},points:3},{name:"Fleet Officer",faction:EMPIRE,type:CREW,done:!0,candoaction:function(){return this.isactive},action:function(b){if(this.isactive){var e=this.unit.selectnearbyally(2);0<e.length?1==e.length?(e[0].addfocustoken(),this.unit.addstress(),this.unit.endaction(b,CREW)):2==e.length?(e[0].addfocustoken(),e[1].addfocustoken(),e[0].log("adding focus"),e[1].log("adding focus"),this.unit.addstress(),this.unit.endaction(b,CREW)):
(this.unit.log("select 2 units [%0]",this.name),this.unit.resolveactionselection(e,function(f){e[f].addfocustoken();e.splice(f,1);0<e.length?this.resolveactionselection(e,function(f){e[f].addfocustoken();this.addstress();this.endaction(b,CREW)}.bind(this)):this.endaction(b,CREW)}.bind(this.unit))):this.unit.endaction(b,CREW)}else this.unit.endaction(b,CREW)},points:3},{name:"Stay On Target",type:ELITE,points:2,done:!0,init:function(b){b.wrap_after("getmaneuverlist",this,function(b){var e=this.getdial();
if(this.hasionizationeffect()||0<this.stress)return b;for(var g in b)for(var h=b[g].move.substr(-1),l=0;l<e.length;l++)e[l].move.substr(-1)==h&&"undefined"==typeof b[e[l].move]&&(b[e[l].move]={move:e[l].move,difficulty:"RED",halfturn:!1});return b})}},{name:"Dash Rendar",faction:REBEL,unique:!0,done:!0,init:function(b){b.wrap_after("isfireobstructed",this,function(){return!1});b.wrap_after("getobstructiondef",this,function(){return 0})},type:CREW,points:2},{name:"Lone Wolf",done:!0,init:function(b){var e=
this;b.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank"],n:function(){return 1},req:function(b,g,h){b=this.unit.selectnearbyally(2);0==b.length&&e.isactive&&this.unit.log("+1 blank reroll [%0]",e.name);return 0==b.length&&e.isactive}.bind(this)});b.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,{dice:["blank"],n:function(){return 1},req:function(b,g,h){b=this.unit.selectnearbyally(2);0==b.length&&e.isactive&&this.unit.log("+1 blank reroll [%0]",e.name);return 0==b.length&&e.isactive}.bind(this)})},
unique:!0,type:ELITE,points:2},{name:"'Leebo'",faction:REBEL,unique:!0,candoaction:function(){return this.isactive},action:function(b){this.isactive?(this.unit.log("free %BOOST% and ion token [%0]",this.name),this.unit.addiontoken(),this.unit.resolveboost(b)):this.unit.endaction(b,"BOOST")},done:!0,type:CREW,points:2},{name:"Ruthlessness",faction:EMPIRE,type:ELITE,points:3,done:!0,init:function(b){var e=this;b.addafterattackeffect(this,function(b,g){if(0!=b+g){var f=targetunit.selectnearbyunits(1,
function(b,e){return e!=targetunit});this.selectunit(f,function(b,f){b[f].log("+%1 %HIT% [%0]",e.name,1);b[f].resolvehit(1);b[f].checkdead()},["select unit [%0]",e.name],!1)}})}},{name:"Intimidation",done:!0,init:function(b){var e=this.unit,f=this;Unit.prototype.wrap_after("getagility",this,function(b){return!e.dead&&this.isenemy(e)&&0<b&&"undefined"!=typeof this.touching&&-1<this.touching.indexOf(e)?(this.log("-1 agility [%0]",f.name),b-1):b})},type:ELITE,points:2},{name:"Ysanne Isard",faction:EMPIRE,
unique:!0,done:!0,init:function(b){var e=this;b.wrap_before("begincombatphase",this,function(){0<this.criticals.length&&this.candoevade()&&(this.addevadetoken(),this.log("+1 %EVADE% [%0]",e.name))})},type:CREW,points:4},{name:"Moff Jerjerrod",faction:EMPIRE,unique:!0,done:!0,type:CREW,points:2,init:function(b){var e=this;b.wrap_after("deal",this,function(b,g,h){if(!e.isactive)return h;var f=$.Deferred();h.then(function(g){var h,l=[];if(g.crit.lethal&&2>=this.hull+this.shield&&g.face==FACEUP||1==this.hull+
this.shield){for(h=0;h<this.upgrades.length;h++){var m=this.upgrades[h];m.type==CREW&&m!=e&&m.isactive&&l.push(m)}l.push(e);l[0].desactivate();this.log("discard %0 to remove critical %1 [%2]",l[0].name,b.name,e.name);f.resolve({crit:g.crit,face:FACEDOWN});return!1}f.resolve(g)}.bind(this));return f.promise()})}},{name:"Ion Torpedoes",requires:"Target",consumes:!0,type:TORPEDO,firesnd:"missile",done:!0,prehit:function(b,e,f){b.addiontoken();b=b.getrangeallunits();for(e=0;e<b[1].length;e++)squadron[b[1][e].unit].log("+1 ion token [%0]",
this.name),squadron[b[1][e].unit].addiontoken()},init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},points:5,attack:4,range:[2,3]},{name:"Bodyguard",faction:SCUM,unique:!0,done:!0,init:function(b){var e=this;b.wrap_before("begincombatphase",this,function(){var b=this.selectnearbyally(1,function(b,e){return b.getskill()<e.getskill()});this.canusefocus()&&this.selectunit(b,function(b,f){b[f].wrap_after("getagility",
e,function(b){return b+1}).unwrapper("endcombatphase");this.removefocustoken()},["select unit (or self to cancel) [%0]",e.name],!0)})},type:ELITE,points:2},{name:"Calculation",done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,g){return this.canusefocus()&&e.isactive}.bind(b),aiactivate:function(b,e){return FCH_focus(b)},f:function(b,g){var f=FCH_focus(b);this.removefocustoken();displayattacktokens(this);return 0<f?(this.log("1 %FOCUS% -> 1 %CRIT% [%0]",
e.name),b-FCH_FOCUS+FCH_CRIT):b}.bind(b),str:"focus"})},type:ELITE,points:1},{name:"Accuracy Corrector",init:function(b){var e=this;b.wrap_after("modifyattackroll",this,function(b,e,h,l){return 2>FCH_hit(l)+FCH_crit(l)?2*FCH_HIT:l});b.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,this,{req:function(b,g){return e.isactive},aiactivate:function(b,e){return 2>FCH_hit(b)+FCH_crit(b)},f:function(b,g){this.log("replace all dice by 2 %HIT% [%0]",e.name);return{m:2,n:2}}.bind(b),str:"hit"})},done:!0,type:SYSTEM,
points:3},{name:"Inertial Dampeners",done:!0,init:function(b){var e=this;b.wrap_after("updateactivationdial",this,function(){this.addactivationdial(function(){return!this.hasmoved&&e.isactive&&!this.hasionizationeffect()}.bind(this),function(){e.desactivate();this.addstress();this.wrap_after("getmaneuver",e,function(b){return{move:"F0",difficulty:"WHITE"}}).unwrapper("endactivationphase");this.show()}.bind(this),A[ILLICIT.toUpperCase()].key,$("<div>").attr({"class":"symbols"}));return this.activationdial})},
type:ILLICIT,points:1},{name:"Tractor Beam",type:CANNON,points:1,attack:3,done:!0,modifyhit:function(b){return 0},prehit:function(b,e,f){this.unit.hitresolved=0;this.unit.criticalresolved=0;b.log("+1 tractor beam token [%0]",this.name);b.addtractorbeam(this.unit)},range:[1,3]},{name:"Flechette Cannon",type:CANNON,firesnd:"slave_fire",done:!0,modifyhit:function(b){return FCH_HIT},prehit:function(b,e,f){this.unit.hitresolved=1;this.unit.criticalresolved=0;b.log("+1 %HIT%, +1 %STRESS% [%0]",this.name);
0==b.stress&&b.addstress()},points:2,attack:3,range:[1,3]},{name:"'Mangler' Cannon",type:CANNON,firesnd:"slave_fire",points:4,attack:3,done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(f,g){return b.weapons[b.activeweapon]==this?e.isactive:!1}.bind(this),aiactivate:function(b,e){return 0<FCH_hit(b)},f:function(b,g){return 0<FCH_hit(b)?(this.log("1 %HIT% -> 1 %CRIT% [%0]",e.name),b+FCH_CRIT-FCH_HIT):b}.bind(b),str:"hit"})},range:[1,3]},{name:"Dead Man's Switch",
done:!0,init:function(b){var e=this;b.wrap_before("dies",this,function(){for(var f=b.getrangeallunits(),g=0;g<f[1].length;g++)squadron[f[1][g].unit].log("+%1 %HIT% [%0]",e.name,1),squadron[f[1][g].unit].applydamage(1)})},type:ILLICIT,points:2},{name:"Feedback Array",type:ILLICIT,done:!0,range:[1,1],isTurret:function(){return!0},issecondary:!1,firesnd:"missile",isWeapon:function(){return!0},declareattack:function(b){this.unit.addhasfired();this.unit.resolvehit(1);this.unit.addiontoken();SOUNDS.explode.play();
this.unit.log("-1 %HIT%, +1 %ION% [%0]",this.name);b.log("-1 %HIT% [%0]",this.name);b.resolvehit(1);b.checkdead();this.unit.checkdead();this.unit.hasdamaged=!0;return!1},init:function(b){this.toString=Upgrade.prototype.toString},points:2},{name:"'Hot Shot' Blaster",done:!0,isWeapon:function(){return!0},isTurret:function(){return!0},endattack:function(b,e){this.desactivate()},type:ILLICIT,firesnd:"xwing_fire",points:3,attack:3,range:[1,2]},{name:"Greedo",faction:SCUM,unique:!0,done:!0,type:CREW,init:function(b){b.greedoa=
-1;b.greedod=-1;var e=this;b.wrap_before("hashit",e,function(b,g){e.unit.greedoa<round&&b.wrap_after("deal",e,function(b,f,g){return e.unit.greedoa<round?(e.unit.greedoa=round,this.log("first damage is a faceup damage [%0]",e.name),dd=$.Deferred(),dd.resolve({crit:b,face:FACEUP}).promise()):g}).unwrapper("endbeingattacked");return g});b.wrap_after("resolveishit",e,function(){this.greedod<round&&this.wrap_after("deal",e,function(b,g,h){return this.greedod<round?(this.greedod=round,this.log("first damage is a faceup damage [%0]",
e.name),dd=$.Deferred(),dd.resolve({crit:b,face:FACEUP}).promise()):h}).unwrapper("endbeingattacked")})},points:1},{name:"Salvaged Astromech",type:SALVAGED,done:!0,points:2,init:function(b){var e=this;b.wrap_after("deal",this,function(b,g,h){if(!e.isactive)return h;var f=$.Deferred();h.then(function(b){"ship"==b.crit.type&&b.face==FACEUP?(e.desactivate(),this.log("remove critical %0 [%1]",b.crit.name,e.name),f.resolve({crit:b.crit,face:DISCARD})):f.resolve(b)}.bind(this));return f.promise()})}},{name:"Bomb Loadout",
upgrades:[BOMB],done:!0,firesnd:"missile",isWeapon:function(){return!1},limited:!0,type:TORPEDO,points:0,ship:"Y-Wing"},{name:"'Genius'",unique:!0,done:!0,init:function(b){var e=this;b.wrap_after("handledifficulty",this,function(b){b=[];if(this.lastdrop!=round){for(var f=0;f<this.bombs.length;f++){var h=this.bombs[f];"undefined"==typeof h.action&&h.isactive&&b.push({type:"BOMB",name:h.name,org:e,action:function(b){this.actiondrop(b)}.bind(h)})}this.donoaction(b,"",!0)}})},type:SALVAGED,points:0},
{name:"Unhinged Astromech",type:SALVAGED,done:!0,install:function(b){var e=[];b.installed=!0;b.wrap_after("getdial",this,function(b){if(0==e.length)for(var f=0;f<b.length;f++){var h=b[f].difficulty,l=b[f].move;l.match(/[A-Z]+3/)&&(h="GREEN");e[f]={move:l,difficulty:h}}return e})},uninstall:function(b){"function"==typeof b.getdial.unwrap&&b.getdial.unwrap(this)},points:1},{name:"R4-B11",unique:!0,type:SALVAGED,points:3,done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,DEFENSE_M,
this,{req:function(b,e){return-1<this.targeting.indexOf(targetunit)}.bind(b),f:function(b,g){var f=FE_evade(b),l=FE_focus(b);targetunit.canusefocus()||(l=0);this.removetarget(targetunit);if(0<f+l){targetunit.log("Reroll %0 %EVADE%, %1 %FOCUS% [%2]",f,l,e.name);var m=targetunit.rolldefensedie(l,e,"evade");b-=FE_EVADE*f+FE_FOCUS*l;for(var q=0;q<l+f;q++)"evade"==m[q]&&(b+=FE_EVADE),"focus"==m[q]&&(b+=FE_FOCUS)}return b}.bind(b),str:"target"})}},{name:"Autoblaster Turret",type:TURRET,firesnd:"falcon_fire",
done:!0,points:2,attack:2,declareattack:function(b){var e=this;b.wrap_after("cancelhit",e,function(b,g,h){e.unit.log("%HIT% cannot be cancelled [%0]",e.name);return b}).unwrapper("afterdefenseeffect");return Weapon.prototype.declareattack.call(this,b)},range:[1,1]},{name:"R4 Agromech",done:!0,init:function(b){var e=this;this.spendfocus=!1;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,g){return e.spendfocus}.bind(b),f:function(b,g){e.spendfocus=!1;this.addtarget(targetunit);this.log("+1 %TARGET% / %1 [%0]",
e.name,targetunit.name);displayattacktokens2(this);return b}.bind(b),str:"target"});b.wrap_before("resolveattack",this,function(b,g){e.spendfocus=!1;this.wrap_before("removefocustoken",e,function(){e.spendfocus=!0;displayattacktokens2(this);this.log("+1 %TARGET% / %1 [%0]",e.name,g.name)}).unwrapper("endattack")})},type:SALVAGED,points:2},{name:"K4 Security Droid",faction:SCUM,type:CREW,done:!0,init:function(b){var e=this;b.wrap_before("handledifficulty",this,function(b){"GREEN"==b&&this.selectunit(this.gettargetableunits(3),
function(b,f){this.addtarget(b[f]);this.log("+1 %TARGET% / %1 [%0]",e.name,b[f].name)},["select unit (or self to cancel) [%0]",e.name],!0)})},points:3},{name:"Outlaw Tech",faction:SCUM,beta:!0,limited:!0,done:!0,type:CREW,init:function(b){var e=this;b.wrap_after("handledifficulty",this,function(f){"RED"==f&&(b.log("+1 %FOCUS% [%0]",e.name),b.addfocustoken())})},points:2},{name:"Advanced Targeting Computer",type:SYSTEM,points:5,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,
this,{req:function(b,g){return-1<this.targeting.indexOf(targetunit)&&1==e.isactive}.bind(b),f:function(b,g){return-1<this.targeting.indexOf(targetunit)?(this.log("+1 %CRIT% [%0]",e.name),$("#atokens > .xtargettoken").remove(),{m:b+10,n:g+1}):{m:b,n:g}}.bind(b),str:"critical"})},ship:"TIE Advanced",done:!0},{name:"Stealth Device",type:MOD,done:!0,install:function(b){b.wrap_after("getagility",this,function(b){return b+1});b.showstats()},uninstall:function(b){"function"==typeof b.getagility.unwrap&&
b.getagility.unwrap(this);b.showstats()},init:function(b){var e=this;b.log("+1 agility [%0]",e.name);b.wrap_before("resolveishit",this,function(b){e.isactive&&(e.uninstall(this),e.desactivate(),this.log("%0 is hit => destroyed",e.name),this.show())})},points:3},{name:"Shield Upgrade",type:MOD,done:!0,install:function(b){b.shield++;b.ship.shield++;b.installed=!0;b.showstats()},points:4},{name:"Engine Upgrade",type:MOD,done:!0,addedaction:"Boost",points:4},{name:"Anti-Pursuit Lasers",type:MOD,islarge:!0,
done:!0,points:2,init:function(b){var e=this;b.wrap_before("collidedby",this,function(b){if(e.isactive&&b.isenemy(this)){var f=this.rollattackdie(1,e,"hit")[0];"hit"==f||"critical"==f?(b.log("+%1 %HIT% [%0]",e.name,1),b.resolvehit(1),b.checkdead()):b.log("no effect [%0]",e.name)}})}},{name:"Targeting Computer",type:MOD,done:!0,addedaction:"Target",points:2},{name:"Hull Upgrade",type:MOD,done:!0,install:function(b){b.hull++;b.ship.hull++;b.installed=!0;b.showstats()},points:3},{name:"Munitions Failsafe",
type:MOD,init:function(b){var e=this;b.addafterattackeffect(this,function(b,g){this.weapons[this.activeweapon].isprimary||0!=b+g||(this.log("%0 still active [%1]",this.weapons[this.activeweapon].name,e.name),this.weapons[this.activeweapon].isactive=!0,this.show())})},done:!0,points:1},{name:"Stygium Particle Accelerator",type:MOD,done:!0,init:function(b){b.wrap_after("resolvedecloak",this,function(){this.candoevade()&&this.doaction([this.newaction(this.addevade,"EVADE")],"Stygium P.A.: +1 %EVADE%");
return!0});b.wrap_after("addcloak",this,function(b){this.candoevade()&&this.doaction([this.newaction(this.addevade,"EVADE")],"Stygium P.A.: +1 %EVADE%")})},points:2},{name:"Advanced Cloaking Device",type:MOD,points:4,done:!0,init:function(b){var e=this;b.addafterattackeffect(this,function(){this.candoaction()&&this.candocloak()&&this.doaction([this.newaction(this.addcloak,"CLOAK")],e.name+": free cloack action")})},ship:"TIE Phantom"},{name:"B-Wing/E2",type:MOD,done:!0,upgrades:[CREW],points:1,ship:"B-Wing",
install:function(b){b.shipimg="b-wing-1.png"},uninstall:function(b){b.shipimg="b-wing-2.png"}},{name:"Countermeasures",type:MOD,islarge:!0,done:!0,init:function(b){var e=this;b.wrap_before("begincombatphase",this,function(){e.isactive&&this.donoaction([{action:function(b){e.desactivate();this.wrap_after("getagility",e,function(b){return b+1}).unwrapper("endphase");0<this.istargeted.length?(this.log("select a lock to remove [%0]",e.name),this.resolveactionselection(this.istargeted,function(e){this.istargeted[e].removetarget(this);
this.endnoaction(b,"MOD")}.bind(this))):this.endnoaction(b,"MOD")}.bind(this),type:e.type.toUpperCase(),name:e.name}],"",!0)})},points:3},{name:"Experimental Interface",type:MOD,unique:!0,points:3,init:function(b){var e=this;e.r=-1;b.wrap_before("endaction",this,function(b,g){e.r!=round&&this.candoaction()&&null!=g&&(e.r=round,this.doaction(this.getupgactionlist(),"+1 free action (Skip to cancel)").done(function(b){null==b?e.r=-1:this.addafteractions(function(){this.addstress()}.bind(this))}.bind(this)))})},
done:!0},{name:"Tactical Jammer",type:MOD,islarge:!0,points:1,done:!0,init:function(b){var e=this;Unit.prototype.wrap_after("getobstructiondef",this,function(f,g){!e.unit.dead&&this.isenemy(b)&&0==g&&(OBSTACLES.push(b),g=this.getoutlinerange(this.m,f).o?1:0,OBSTACLES.splice(OBSTACLES.indexOf(b),1),1==g&&this.log("fire obstructed by %0",b.name));return g})}},{name:"Autothrusters",type:MOD,actionrequired:"Boost",points:2,done:!0,init:function(b){var e=this;b.wrap_after("modifydefenseroll",this,function(b,
e,h,l){2<b.getsector(this)&&0<FE_blank(l,h)&&(l+=FE_EVADE);return l});b.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,this,{req:function(b,g){return 2<activeunit.getsector(this)?e.isactive:!1}.bind(b),f:function(b,g){0<FE_blank(b,g)&&(this.log("1 blank -> 1 %EVADE% [%0]",e.name),b+=FE_EVADE);return b}.bind(b),str:"blank"})}},{name:"Slave I",type:TITLE,unique:!0,points:0,done:!0,ship:"Firespray-31",upgrades:[TORPEDO]},{name:"Millennium Falcon",type:TITLE,done:!0,addedaction:"Evade",unique:!0,points:1,
ship:"YT-1300"},{name:"Moldy Crow",type:TITLE,init:function(b){var e=this;b.wrap_after("resetfocus",this,function(){0<this.focus&&this.log("keep %FOCUS% tokens [%0]",e.name);return this.focus})},unique:!0,done:!0,points:3,ship:"HWK-290"},{name:"ST-321",type:TITLE,done:!0,init:function(b){b.wrap_after("gettargetableunits",this,function(b){b=[];for(i in squadron)squadron[i].isenemy(this)&&b.push(squadron[i]);return b})},unique:!0,points:3,ship:"Lambda-Class Shuttle"},{name:"Royal Guard TIE",type:TITLE,
done:!0,upgrades:[MOD],skillmin:5,points:0,install:function(b){b.shipimg="tie-interceptor-1.png"},uninstall:function(b){b.shipimg="tie-interceptor-2.png"},ship:"TIE Interceptor"},{name:"A-Wing Test Pilot",type:TITLE,done:!0,upgrades:[ELITE],skillmin:2,points:0,ship:"A-Wing",exclusive:!0,install:function(b){b.shipimg="a-wing-1.png"},uninstall:function(b){b.shipimg="a-wing-2.png"}},{name:"Outrider",type:TITLE,done:!0,init:function(b){var e;for(e=0;e<b.weapons.length;e++)if(b.weapons[e].type==CANNON){b.weapons[0].desactivate();
b.log("primary weapon inactive [%0]",this.name);b.weapons[e].isTurret=function(){return!0};b.log("%0 can fire in 360 degrees [%0]",b.weapons[e].name,this.name);break}},unique:!0,points:5,ship:"YT-2400"},{name:"Dauntless",type:TITLE,done:!0,init:function(b){var e=this;b.wrap_after("doendmaneuveraction",this,function(){this.candoaction()&&this.collision&&(this.log("+1 free action [%0]",e.name),this.doaction(this.getactionlist(),"").done(function(b){null!=b&&this.addstress()}.bind(this)))})},unique:!0,
points:2,ship:"VT-49 Decimator"},{name:"Virago",type:TITLE,done:!0,upgrades:[ILLICIT,SYSTEM],unique:!0,points:1,skillmin:4,ship:"StarViper"},{name:"'Heavy Scyk' Interceptor",done:!0,upgrades:["Cannon|Torpedo|Missile"],type:TITLE,install:function(b){b.hull++;b.ship.hull++;b.installed=!0;b.showstats()},points:2,ship:"M3-A Interceptor"},{name:"IG-2000",type:TITLE,done:!0,install:function(b){b.ig2000=!0},uninstall:function(b){b.ig2000=!1},init:function(b){for(var e in squadron){var f=squadron[e];f!=b&&
1==f.ig2000&&f.isally(b)&&(b.log("copying %0 abilities [%1]",f.name,this.name),f.init.call(b,f))}},points:0,ship:"Aggressor"},{name:"BTL-A4 Y-Wing",type:TITLE,done:!0,init:function(b){for(var e=[],f=0;f<b.weapons.length;f++){var g=b.weapons[f];g.type==TURRET&&0==g.isprimary&&(e.push(g),g.wrap_after("isTurret",this,function(){return!1}))}0!=e.length&&(b.wrap_after("isTurret",this,function(b,e){return!1}),b.addattack(function(b,e){return this.weapons[this.activeweapon].isprimary},this,e))},points:0,
ship:"Y-Wing"},{name:"Andrasta",type:TITLE,done:!0,upgrades:[BOMB,BOMB],unique:!0,points:0,ship:"Firespray-31"},{name:"TIE/x1",type:TITLE,done:!0,upgrades:[SYSTEM],pointsupg:-4,points:0,ship:"TIE Advanced"},{name:"Emperor Palpatine",type:CREW,unique:!0,takesdouble:!0,done:!0,points:8,faction:EMPIRE,init:function(){var b=this;b.unit.emperor=-1;var e=function(e,g,h,l){if(b.unit.isally(this)&&!b.unit.dead&&"undefined"!=typeof h&&b.unit.emperor<round){for(e=0;e<l.length&&l[e]==h;e++);e<l.length&&confirm("Emperor Palpatine effect\n"+
g.name+": "+l[0]+" die -> "+h+" die ?")&&(b.unit.log("%0 -> %1 [%2]",l[e],h,b.name),l[e]=h,b.unit.emperor=round)}return"undefined"!=typeof h?l:g};Unit.prototype.wrap_after("rollattackdie",b,e);Unit.prototype.wrap_after("rolldefensedie",b,e);Unit.prototype.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(e,g){return b.unit.emperor<round&&activeunit.isally(b.unit)},f:function(e,g){b.unit.emperor=round;var f=FCH_focus(e),l=FCH_blank(e,g),m=FCH_hit(e);0<l?(activeunit.log("blank -> %CRIT% [%0]",
b.name),e+=FCH_CRIT,b.round=round):0<f?(activeunit.log("%FOCUS% -> %CRIT% [%0]",b.name),e=e-FCH_FOCUS+FCH_CRIT):0<m&&(activeunit.log("%HIT% -> %CRIT% [%0]",b.name),e=e-FCH_HIT+FCH_CRIT);return e},str:"crew"});Unit.prototype.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,this,{req:function(e,g){return!b.unit.dead&&targetunit.isally(b.unit)&&b.unit.emperor<round},f:function(e,g){b.unit.emperor=round;var f=FE_focus(e);0<FE_blank(e,g)?(targetunit.log("blank -> %EVADE% [%0]",b.name),e+=FE_EVADE):0<f&&(targetunit.log("%FOCUS% -> %EVADE% [%0]",
b.name),e=e+FE_EVADE-FE_FOCUS);return e},str:"crew"})}},{name:"Extra Munitions",type:TORPEDO,limited:!0,firesnd:"missile",isWeapon:function(){return!1},points:2,done:!0,init:function(b){for(var e=0;e<b.upgrades.length;e++){var f=b.upgrades[e];f.type.match(/Missile|Torpedo|Bomb/)&&(f.ordnance=!0)}}},{name:"Cluster Mines",type:BOMB,snd:"explode",img:"cluster.png",width:15,height:10,repeatx:42,size:22,stay:!0,done:!0,getOutlineStringsmall:function(b){var e="M ";this.op=[];"undefined"==typeof b&&(b=this.m);
for(var f=0;20>f;f++){var g=transformPoint(b,{x:this.size*Math.sin(2*f*Math.PI/20),y:this.size*Math.cos(2*f*Math.PI/20)});this.op.push(g);e+=g.x+" "+g.y+" ";0==f&&(e+="L ")}return{s:e+"Z",p:this.op}},candoaction:function(){return this.unit.lastdrop!=round&&this.isactive},action:function(b){this.actiondrop(b)},canbedropped:function(){return!1},explode:function(){},detonate:function(b){if(!this.exploded){for(var e=this.unit.rollattackdie(2,this,"hit"),f=0;2>f;f++)"hit"==e[f]&&(b.log("+1 %HIT% [%0]",
this.name),b.resolvehit(1),b.checkdead());Bomb.prototype.detonate.call(this)}},display:function(b,e){this.getOutlineString=this.getOutlineStringsmall;var f=$.extend({},this),g=$.extend({},this);Bomb.prototype.display.call(f,this.repeatx,0);Bomb.prototype.display.call(g,-this.repeatx,0);Bomb.prototype.display.call(this,0,0)},init:function(b){b=s.path("M41.844,-21 C54.632,-21 65,-11.15 65,1 C65,13.15 54.632,23 41.844,23 C33.853,22.912 25.752,18.903 21.904,12.169 C17.975,18.963 10.014,22.806 1.964,23 C-7.439,22.934 -14.635,18.059 -18.94,10.466 C-22.908,18.116 -30.804,22.783 -39.845,23 C-52.633,23 -63,13.15 -63,1 C-63,-11.15 -52.633,-21 -39.845,-21 C-30.441,-20.935 -23.246,-16.06 -18.94,-8.466 C-14.972,-16.116 -7.076,-20.783 1.964,-21 C9.956,-20.913 18.055,-16.902 21.904,-10.17 C25.832,-16.964 33.795,-20.807 41.844,-21 z").attr({display:"none"});
var e=b.getTotalLength();this.op0=[];for(var f=0;60>f;f++)this.op0[f]=b.getPointAtLength(f*e/60)},getOutlineString:function(b){var e="M ";this.op=[];"undefined"==typeof b&&(b=this.m);for(var f=0;60>f;f++){var g=transformPoint(b,this.op0[f]);this.op.push(g);e+=g.x+" "+g.y+" ";0==f&&(e+="L ")}return{s:e+"Z",p:this.op}},points:4},{name:"Glitterstim",type:ILLICIT,points:2,activated:-1,done:!0,init:function(b){var e=this;b.glitter=-1;b.wrap_after("begincombatphase",this,function(b){e.isactive&&this.donoaction([{org:e,
name:e.name,type:"ILLICIT",action:function(b){this.addstress();this.glitter=round;this.endnoaction(b,"ILLICIT")}.bind(this)}],"",!0);return b});b.wrap_before("endphase",this,function(){this.glitter==round&&e.desactivate()});b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,g){return this.glitter==round&&e.isactive}.bind(b),f:function(b,g){var f=FCH_focus(b);0<f&&(this.log("%1 %FOCUS% -> %1 %HIT% [%0]",e.name,f),b=b-FCH_FOCUS*f+f*FCH_HIT);return b}.bind(b),str:"focus",noreroll:"focus"});
b.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,this,{req:function(b,g){return this.glitter==round&&e.isactive}.bind(b),f:function(b,g){var f=FE_focus(b);0<f&&(this.log("%1 %FOCUS% -> %1 %EVADE% [%0]",e.name,f),b=b-FE_FOCUS*f+FE_EVADE*f);return b}.bind(b),str:"focus",noreroll:"focus"})}},{name:"Cloaking Device",type:ILLICIT,islarge:!1,points:2,candoaction:function(){return this.isactive&&!this.unit.iscloaked},action:function(b){var e=this.unit;e.log("cloaked [%0]",this.name);e.addcloak(b)},done:!0,init:function(b){var e=
this;b.wrap_after("endphase",this,function(){e.isactive&&("focus"==this.rollattackdie(1,e,"blank")[0]&&this.iscloaked&&1==e.isactive?(this.log("%0 failed -> decloaking",e.name),this.resolvedecloak(!0),e.desactivate()):this.log("%0 still working",e.name))})}},{name:"Bossk",unique:!0,faction:SCUM,type:CREW,points:2,done:!0,init:function(b){var e=this;b.wrap_after("hashit",this,function(b,g){g||(this.log("+1 stress, +1 %FOCUS%, +1 %TARGET% [%0]",e.name),0==this.stress&&this.addstress(),-1<this.gettargetableunits(3).indexOf(b)?
this.addtarget(b):this.log("no valid target [%0]",e.name),this.addfocustoken());return g})}},{name:"Wired",type:ELITE,init:function(b){var e=this,f=function(){return 0<this.stress?(this.log("+%1 %FOCUS% reroll(s) [%0]",e.name,this.focus),e.isactive):!1}.bind(b);b.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["focus"],n:function(){return 9},req:f});b.adddicemodifier(DEFENSE_M,REROLL_M,DEFENSE_M,this,{dice:["focus"],n:function(){return 9},req:f})},done:!0,points:1},{name:"Cool Hand",type:ELITE,
points:1,done:!0,init:function(b){var e=this;b.wrap_after("addstress",this,function(){e.isactive&&this.donoaction([{type:"FOCUS",name:e.name,org:e,action:function(b){e.desactivate();this.addfocustoken();this.endnoaction(b,"ELITE")}.bind(this)},{type:"EVADE",name:e.name,org:e,action:function(b){e.desactivate();this.addevadetoken();this.endnoaction(b,"ELITE")}.bind(this)}],"Add %EVADE% or %FOCUS% instead of %STRESS% token",!0)})}},{name:"Juke",type:ELITE,points:2,islarge:!1,done:!0,init:function(b){var e=
this;b.adddicemodifier(ATTACK_M,MOD_M,DEFENSE_M,this,{req:function(){return 0<e.unit.evade},f:function(b,g){0<FE_evade(b)&&(targetunit.log("%EVADE% -> %FOCUS% [%0]",e.name),b=b-FE_EVADE+FE_FOCUS);return b},str:"evade"});b.wrap_after("setpriority",this,function(b){"EVADE"==b.type&&0==this.evade&&(b.priority=10)})}},{name:"Lightning Reflexes",type:ELITE,points:1,done:!0,init:function(b){var e=this;b.wrap_after("handledifficulty",this,function(b){"WHITE"!=b&&"GREEN"!=b||!e.isactive||this.donoaction([{type:"ELITE",
name:e.name,org:e,action:function(b){e.desactivate();this.addstress(1);this.m=this.m.rotate(180,0,0);this.show();this.endnoaction(b,ELITE)}.bind(this)}],"",!0)})},islarge:!1},{name:"Twin Laser Turret",type:TURRET,firesnd:"falcon_fire",points:6,done:!0,attack:3,range:[2,3],followupattack:function(){return this.unit.weapons.indexOf(this)},modifyhit:function(b){return FCH_HIT},prehit:function(b,e,f){this.unit.hitresolved=1;this.unit.criticalresolved=0;b.log("+%1 %HIT% [%0]",this.name,1)},hasdoubleattack:function(){return this.twinattack=
!this.twinattack},init:function(b){this.twinattack=!1}},{name:"Plasma Torpedoes",type:TORPEDO,points:3,attack:4,firesnd:"missile",requires:"Target",consumes:!0,done:!0,posthit:function(b,e,f){0<b.shield&&b.log("-1 %SHIELD% [%0]",this.name);b.removeshield(1)},init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})},range:[2,3]},{name:"Ion Bombs",type:BOMB,points:2,width:14,height:14,size:15,done:!0,snd:"explode",img:"ion.png",
explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){for(var b=this.getrangeallunits(),e=0;e<b[1].length;e++)squadron[b[1][e].unit].addiontoken(),squadron[b[1][e].unit].addiontoken();this.explode_base()}}},{name:"Conner Net",type:BOMB,snd:"explode",img:"conner-net3.png",width:40,height:60,size:40,done:!0,init:function(){this.conner=-1;var b=s.path("M-11.379,-0.26 C-11.241,-6.344 -16.969,-14.641 -19.247,-20.448 C-21.524,-26.255 -24.216,-38.147 -20.213,-39.46 C-16.21,-40.774 -8.619,-37.594 2.424,-37.663 C13.466,-37.732 22.162,-41.327 23.68,-39.322 C25.198,-37.317 26.716,-30.404 22.714,-21.278 C18.711,-12.152 14.156,-6.828 14.087,0.293 C14.018,7.414 19.47,15.364 22.3,22.555 C25.129,29.745 25.681,39.908 23.128,41.429 C20.574,42.95 13.673,41.29 4.218,41.29 C-5.237,41.29 -19.316,42.742 -20.903,41.29 C-22.49,39.839 -24.354,34.446 -20.213,23.108 C-16.072,11.769 -11.448,11.424 -11.379,1.606 C-11.322,-6.487 -11.514,5.685 -11.379,-0.26 z").attr({display:"none"}),
e=b.getTotalLength();this.op0=[];for(var f=0;60>f;f++)this.op0[f]=b.getPointAtLength(f*e/60)},getOutlineString:function(b){var e="M ";this.op=[];"undefined"==typeof b&&(b=this.m);for(var f=0;60>f;f++){var g=transformPoint(b,this.op0[f]);this.op.push(g);e+=g.x+" "+g.y+" ";0==f&&(e+="L ")}return{s:e+"Z",p:this.op}},stay:!0,candoaction:function(){return this.unit.lastdrop!=round&&this.isactive},action:function(b){this.actiondrop(b)},canbedropped:function(){return!1},explode:function(){},detonate:function(b,
e){var f=this;this.exploded||(e?b.hasmoved?(b.log("+1 %HIT%, +2 ion tokens next turn [%0]",f.name),b.wrap_after("beginplanningphase",this,function(b){this.resolvehit(1);this.checkdead();this.log("+2 ion tokens [%0]",f.name);this.addiontoken();this.addiontoken();this.beginplanningphase.unwrap(f);return b})):(b.log("%1 skips action phase [%0]",f.name,b.name),b.wrap_after("candoendmaneuveraction",f,function(){return!1}).unwrapper("endactivationphase")):(b.wrap_before("cleanupmaneuver",this,function(){b.log("+1 %HIT%, +2 ion tokens [%0]",
this.name);b.resolvehit(1);b.checkdead();b.addiontoken();b.addiontoken();b.log("%1 skips action phase [%0]",this.name,b.name)}).unwrapper("endactivationphase"),b.wrap_after("candoendmaneuveraction",this,function(){return!1}).unwrapper("endactivationphase")),Bomb.prototype.detonate.call(this,e))},points:4},{name:"Bombardier",type:CREW,points:1,done:!0,init:function(b){b.wrap_after("getbomblocation",this,function(b){return-1<b.indexOf("F1")?b.concat("F2"):b})}},{name:"Agent Kallus",type:CREW,faction:EMPIRE,
points:2,done:!0,init:function(b){var e=this;this.unit.nemesis=null;b.wrap_after("beginactivationphase",e,function(b){1==round&&this.selectunit(this.selectnearbyenemy(4),function(b,f){this.nemesis=b[f];this.log("%0 chosen as nemesis [%1]",b[f].name,e.name)});return b},["select unit [%0]",e.name],!1);b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,e,{req:function(){return targetunit==this.nemesis}.bind(b),f:function(b,g){0<FCH_focus(b)&&(b=b-FCH_FOCUS+FCH_HIT,this.log("1 %FOCUS% -> 1 %HIT% [%0]",e.name));
return b}.bind(b),str:"focus"});b.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,e,{req:function(){return activeunit==this.nemesis}.bind(b),f:function(b,g){0<FE_focus(b)&&(b=b-FE_FOCUS+FE_EVADE,this.log("1 %FOCUS% -> 1 %EVADE% [%0]",e.name));return b}.bind(b),str:"focus"})}},{name:"'Crack Shot'",type:ELITE,points:1,done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACKCOMPARE_M,MOD_M,DEFENSE_M,this,{req:function(){return this.isinfiringarc(targetunit)&&e.isactive}.bind(b),aiactivate:function(b,e){return 0<
FE_evade(b)},f:function(f,g){e.desactivate();0<FE_evade(f)&&(b.log("-1 %EVADE% [%0]",e.name),f-=FE_EVADE);return f},str:"evade"})}},{name:"Advanced Homing Missiles",type:MISSILE,firesnd:"missile",points:3,requires:"Target",consumes:!1,attack:3,range:[2,2],done:!0,modifyhit:function(b){return FCH_CRIT},prehit:function(b,e,f){b.log("+1 %CRIT% [%0]",this.name);b.applycritical(1);this.unit.hitresolved=0;this.unit.criticalresolved=0},init:function(b){var e=this;b.wrap_after("setpriority",this,function(b){"TARGET"==
b.type&&e.isactive&&this.candotarget()&&(b.priority+=10)})}},{name:"Advanced SLAM",type:MOD,done:!0,points:2,init:function(b){var e=this;b.wrap_after("resolveslam",this,function(){this.doaction(this.getactionlist(),"+1 free action (Skip to cancel) ["+e.name+"]")})}},{name:"Twin Ion Engine Mk. II",type:MOD,points:1,ship:"TIE",done:!0,install:function(b){var e=[];b.installed=!0;b.wrap_after("getdial",this,function(b){if(0==e.length)for(var f=0;f<b.length;f++){var h=b[f].move,l=b[f].difficulty;h.match(/BL\d|BR\d/)&&
(l="GREEN");e[f]={move:h,difficulty:l}}return e})},uninstall:function(b){"function"==typeof b.getdial.unwrap&&b.getdial.unwrap(this)}},{name:"Maneuvering Fins",type:MOD,points:1,ship:"YV-666",done:!0,init:function(b){var e=this;b.wrap_after("getmaneuverlist",e,function(b){if(this.hasionizationeffect())return b;for(var f in b)if(f.match(/TR\d|TL\d/)){this.log("change turn into a bank [%0]",e.name);var h=f.replace(/T/,"B");b[h]={move:h,difficulty:b[f].difficulty,halfturn:b[f].halfturn}}return b}.bind(b))}},
{name:"Hound's Tooth",points:6,type:TITLE,unique:!0,ship:"YV-666",done:!0,getdeploymentmatrix:function(b){for(var e=b.getdial(),f=[],g=0;g<e.length;g++){var h=this.unit.m.clone().translate(0,20).rotate(180,0,0);f.push(b.getpathmatrix(h,e[g].move))}for(g=0;g<e.length;g++)h=this.unit.m.clone().translate(0,-20),f.push(b.getpathmatrix(h,e[g].move));return f},init:function(b){var e=this,f,g=-1;for(f in squadron)if("Nashtah Pup Pilot"==squadron[f].name){g=f;break}if(-1<g)p=squadron[g],p.skill=b.skill;else{for(f=
0;f<PILOTS.length&&"Nashtah Pup Pilot"!=PILOTS[f].name;f++);p=new Unit(b.team,f);p.upg=[];p.skill=b.skill;p.tosquadron(s);allunits.push(p);squadron.push(p);TEAMS[b.team].units.push(p)}p.dock(b);p.show();b.wrap_before("dies",e,function(){var b=this.docked;this.init.call(b);this.hasfired=0;b.wrap_before("endphase",b,function(){this.hasmoved=!1});b.noattack=round;b.deploy(this,e.getdeploymentmatrix(b))})}},{name:"XX-23 S-Thread Tracers",points:1,type:MISSILE,firesnd:"missile",range:[1,3],attack:3,done:!0,
requires:"Focus",consumes:!1,modifyhit:function(b){return 0},prehit:function(b,e,f){e=this.unit.selectnearbyally(2);f="";if(0<e.length){e=e.concat(this.unit);for(var g=0;g<e.length;g++)-1<e[g].gettargetableunits(3).indexOf(b)?(e[g].addtarget(b),f+=e[g].name+" "):e[g].log("no valid target [%0]",this.name);this.unit.log("all dice cancelled, %0 now targeted by %1",b,f);this.unit.hitresolved=0;this.unit.criticalresolved=0}}},{name:"Comm Relay",points:3,type:TECH,done:!0,init:function(b){var e=this;b.wrap_after("addevadetoken",
this,function(){1<this.evade&&(this.log("1 %EVADE% max [%0]",e.name),this.evade=1);this.showinfo()});b.wrap_after("resetevade",this,function(){var b=0;0<this.evade&&(this.log("keep 1 %EVADE% token [%0]",e.name),b=1);return b})}},{name:"Dorsal Turret",type:TURRET,points:3,firesnd:"falcon_fire",attack:2,range:[1,2],done:!0,getrangeattackbonus:function(b){return 1==this.getrange(b)?(this.unit.log("+1 attack for range 1"),1):0}},{name:"'Chopper'",type:CREW,points:0,done:!0,init:function(b){b.wrap_after("begincombatphase",
this,function(b){for(var e=0;e<this.touching.length;e++){var g=this.touching[e];g.isenemy(this)&&(g.log("+1 %STRESS% [%0]",this.name),g.addstress())}return b})},faction:REBEL,unique:!0},{name:"Hera Syndulla",type:CREW,points:1,faction:REBEL,done:!0,init:function(b){b.wrap_after("canreveal",this,function(b,f){return"RED"==b.difficulty&&0<this.stress?!0:f})},unique:!0},{name:"'Zeb' Orrelios",type:CREW,points:1,faction:REBEL,unique:!0,done:!0,init:function(b){var e=this;Unit.prototype.wrap_after("checkcollision",
this,function(f,g){return!e.unit.dead&&f==b&&b.isinfiringarc(f)?!1:g});b.wrap_after("checkcollision",this,function(f,g){return!e.unit.dead&&b.isinfiringarc(f)?!1:g})}},{name:"Ezra Bridger",type:CREW,points:3,faction:REBEL,unique:!0,done:!0,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(f,g){return e.isactive&&0<b.stress}.bind(this),f:function(b,e){return 0<FCH_focus(b)?(this.unit.log("1 %FOCUS% -> 1 %CRIT% [%0]",this.name),b-FCH_FOCUS+FCH_CRIT):b}.bind(this),
str:"focus"})}},{name:"Kanan Jarrus",type:CREW,points:3,faction:REBEL,unique:!0,done:!0,init:function(b){var e=this;this.rd=-1;Unit.prototype.wrap_before("endmaneuver",e,function(){var b=this.maneuverdifficulty;!e.unit.dead&&"WHITE"==b&&0<this.stress&&e.rd<round&&this.isally(e.unit)&&2>=this.getrange(e.unit)&&(this.log("-1 %STRESS% [%0]",e.name),e.rd=round,this.removestresstoken())})}},{name:"Sabine Wren",type:CREW,points:2,upgrades:[BOMB],faction:REBEL,unique:!0,done:!0,rd:-1,init:function(b){var e=
this;e.rd=-1;Bomb.prototype.wrap_after("explode_base",this,function(){var b=[e.unit];if(e.rd!=round&&!this.unit.isenemy(e.unit)){for(var g in squadron){var h=squadron[g];this.unit.isenemy(h)&&1==this.getrange(h)&&b.push(h)}this.unit.selectunit(b,function(b,f){0!=f&&(b[f].log("+1 %HIT% [%0]",e.name),b[f].resolvehit(1),e.rd=round,SOUNDS.explode.play(),b[f].checkdead())},["select unit (or self to cancel) [%0]",e.name],!1)}})}},{name:"Ghost",type:TITLE,points:0,unique:!0,done:!0,getdeploymentmatrix:function(b){for(var e=
b.getdial(),f=[],g=0;g<e.length;g++){var h=this.unit.m.clone().translate(0,20).rotate(180,0,0);f.push(b.getpathmatrix(h,e[g].move))}return f},init:function(b){var e=-1,f=this,g;for(g in squadron){var h=squadron[g];if(h.isally(b)&&b!=h)for(var l=0;l<h.upgrades.length;l++)if("Phantom"==h.upgrades[l].name){e=g;break}if(-1!=e)break}-1!=e?(h=squadron[e],1==TEAMS[b.team].isia&&(h=$.extend(h,IAUnit.prototype)),h.dock(b),b.weapons[0].auxiliary=AUXILIARY,b.weapons[0].subauxiliary=SUBAUXILIARY,b.weapons[0].type=
"Bilaser",b.wrap_after("endmaneuver",this,function(){this.docked&&h.donoaction([{org:f,type:"TITLE",name:f.name,action:function(b){this.weapons[0].auxiliary=void 0;this.weapons[0].subauxiliary=void 0;this.weapons[0].type="Laser";h.deploy(this,f.getdeploymentmatrix(h));h.endnoaction(b,"TITLE")}.bind(this)}],"",!0)}),b.wrap_after("endcombatphase",this,function(){if(this.docked)for(var b=0;b<this.weapons.length;b++){var e=this.weapons[b];if(e.type==TURRET&&e.isactive&&this.noattack<round){this.log("+1 attack with %1 [%0]",
f.name,e.name);this.noattack=round;this.selecttargetforattack(b);break}}}),b.wrap_after("dies",this,function(){this.docked&&(this.docked.noattack=round,this.log("emergency deployment of %0, +1 %HIT% [%1]",this.docked.name,this.name),this.docked.resolvehit(1),this.docked.hasfired=0,this.docked.wrap_before("endphase",this.docked,function(){this.hasmoved=!1}),h.deploy(this,f.getdeploymentmatrix(h)))})):b.log("Phantom not found")},ship:"VCX-100"},{name:"Phantom",type:TITLE,points:0,unique:!0,done:!0,
ship:"Attack Shuttle"},{name:"Reinforced Deflectors",points:3,type:SYSTEM,islarge:!0,done:!0,init:function(b){var e=this;b.addafterdefenseeffect(e,function(b,g,h){3<=b+g&&this.addshield(1)&&this.log("+1 %SHIELD% [%0]",e.name)})}},{name:"Targeting Astromech",points:2,type:ASTROMECH,done:!0,init:function(b){var e=this;b.wrap_after("handledifficulty",this,function(b){"RED"==b&&this.selectunit(this.gettargetableunits(3),function(b,e){this.addtarget(b[e])},["select target or self to cancel [%0]",e.name],
!0)})}},{name:"TIE/x7",points:-2,type:TITLE,lostupgrades:[CANNON,MISSILE],ship:"TIE Defender",done:!0,init:function(b){var e=this;b.wrap_before("endmaneuver",this,function(){this.getdial()[this.maneuver].move.match(/[345]/)&&(this.log("+1 %EVADE% [%0]",e.name),this.addevadetoken())})}},{name:"TIE/D",points:0,type:TITLE,ship:"TIE Defender",done:!0,init:function(b){this.unit.tiedattack=-1;for(var e in b.weapons);b.addattack(function(b,e){var f=this.weapons[this.activeweapon];return f.type==CANNON&&
3>=f.points&&this.tiedattack<round},this,[b.weapons[0]],function(){this.tiedattack=round})}},{name:"TIE Shuttle",points:0,done:!0,type:TITLE,ship:"TIE Bomber",maxupg:4,lostupgrades:[TORPEDO,MISSILE,BOMB],upgrades:[CREW,CREW]},{name:"Guidance Chips",points:0,type:MOD,done:!0,init:function(b){var e=this;for(i in b.weapons){var f=FCH_HIT,g=b.weapons[i],h=b.weapons[0];h.isprimary&&3<=h.getattack()&&(f=FCH_CRIT);g.type.match(/Torpedo|Missile/)&&g.wrap_after("modifyattackroll",this,function(b,e,g,h){0<
FCH_blank(h,e)?h+=f:0<FCH_focus(h)?h=h-FCH_FOCUS+f:0<FCH_crit(h)&&(h=h-FCH_HIT+f);return h})}b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){var f=this.weapons[this.activeweapon].type;return f==TORPEDO||f==MISSILE?!0:!1}.bind(b),f:function(f,g){var h=FCH_blank(f,g),l=FCH_focus(f),m=FCH_hit(f),x=FCH_HIT,y="%HIT%";this.weapons[0].isactive&&3<=this.weapons[0].getattack()&&(x=FCH_CRIT,y="%CRIT%");0<h?(b.log("+1 "+y+" [%0]",e.name),f+=x):0<l?(b.log("%FOCUS% -> "+y+" [%0]",e.name),f+=
x-FCH_FOCUS):0<m&&x==FCH_CRIT&&(b.log("%HIT% -> %CRIT% [%0]",e.name),f+=x-FCH_HIT);return f}.bind(b),str:"target"})}},{name:"TIE/v1",ship:"TIE Adv. Prototype",points:1,done:!0,init:function(b){var e=this;b.wrap_after("addtarget",this,function(b){e.isactive&&this.candoaction()&&this.candoevade()&&(this.log("free %EVADE% action [%0]",this.name),this.doselection(function(b){this.addevade(b)}.bind(this)))})},type:TITLE},{name:"Zuckuss",faction:SCUM,points:1,unique:!0,done:!0,type:CREW,init:function(b){var e=
this;b.adddicemodifier(ATTACK_M,MOD_M,DEFENSE_M,this,{req:function(e,g){return 0==b.stress}.bind(this),f:function(f,g){var h=FE_focus(f);if(0<h){targetunit.log("Reroll %0 %FOCUS% [%1]",h,e.name);b.log("+%0 %STRESS% [%1]",h,e.name);var l=b.rolldefensedie(h,e,"evade");f-=FE_FOCUS*h;for(var m=0;m<h;m++)b.addstress(),"evade"==l[m]&&(f+=FE_EVADE),"focus"==l[m]&&(f+=FE_FOCUS)}return f},str:"focus"});b.adddicemodifier(ATTACK_M,MOD_M,DEFENSE_M,this,{req:function(e,g){return 0==b.stress}.bind(this),f:function(f,
g){var h=FE_evade(f);if(0<h){targetunit.log("Reroll %0 %EVADE% [%1]",h,e.name);b.log("+%0 %STRESS% [%1]",h,e.name);var l=b.rolldefensedie(h,e,"evade");f-=FE_EVADE*h;for(var m=0;m<h;m++)b.addstress(),"evade"==l[m]&&(f+=FE_EVADE),"focus"==l[m]&&(f+=FE_FOCUS)}return f},str:"evade"})}},{name:"4-LOM",faction:SCUM,points:1,unique:!0,done:!0,type:CREW,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(){return targetunit.canusefocus()},f:function(b,g){this.addiontoken();
targetunit.canusefocus()&&(targetunit.log("cannot use focus in this attack [%0]",e.name),targetunit.wrap_after("canusefocus",this,function(){return!1}).unwrapper("afterdefenseeffect"));return b}.bind(b),str:"focus"});b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(){return targetunit.canuseevade()},f:function(b,g){this.addiontoken();targetunit.canusefocus()&&(targetunit.log("cannot use evade in this attack [%0]",e.name),targetunit.wrap_after("canuseevade",this,function(){return!1}).unwrapper("afterdefenseeffect"));
return b}.bind(b),str:"evade"})}},{name:"Mist Hunter",type:TITLE,points:0,done:!0,ship:"G-1A Starfighter",unique:!0,upgrades:[CANNON],install:function(b){var e,f;b.installed=!0;b["addedaction"+this.id]=b.shipactionList.length;b.shipactionList.push("ROLL");b.showactionlist();for(f=0;f<UPGRADES.length&&"Tractor Beam"!=UPGRADES[f].name;f++);if(f!=UPGRADES.length)for(e=0;e<b.upgradetype.length;e++)if(b.upgradetype[e]==UPGRADES[f].type&&-1==b.upg[e]){addupgrade(b,f,e,!0);b.log("%0 added [%1]",UPGRADES[f].name,
this.name);break}}},{name:"Adaptability(+1)",type:ELITE,points:0,invisible:!0},{name:"Adaptability(-1)",type:ELITE,points:0,invisible:!0},{name:"Dengar",unique:!0,type:CREW,points:3,faction:SCUM,done:!0,init:function(b){b.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank","focus"],n:function(){return 1==targetunit.unique?2:1},req:function(b,f,g){return this.isactive}.bind(this)})}},{name:"'Gonk'",unique:!0,type:CREW,points:2,faction:SCUM,shield:0,candoaction:function(){return this.isactive},
action:function(b){var e=this.unit;this.isactive&&(e.log("+1 %SHIELD% on %0 [%0]",this.name),this.shield++);e.endaction(b,CREW);return!0},candoaction2:function(){return this.isactive},action2:function(b){var e=this.unit;this.isactive&&0<this.shield&&this.unit.shield<this.unit.ship.shield&&(e.shield<e.ship.shield&&e.log("+1 %SHIELD% [%0]",this.name),e.addshield(1),this.shield--,e.show());e.endaction(b,CREW);return!0},done:!0},{name:"Boba Fett",unique:!0,type:CREW,points:1,faction:SCUM,done:!0,init:function(b){var e=
this;b.wrap_before("hashit",this,function(b){var f=this;e.isactive&&b.wrap_after("deal",e,function(g,l,m){m.then(function(g){if(g.face==FACEUP){g=[];for(i in b.upgrades){var h=b.upgrades[i];h.type.match(/Missile|Torpedo|Crew|Bomb|Cannon|Turret|Astromech|System|Illicit|Salvaged|Tech|Elite/)&&g.push(h)}b.log("select upgrade to desactivate [%0]",e.name);f.selectupgradetodesactivate(g,e)}});return m}).unwrapper("afterdefenseeffect")})}},{name:"R5-P8",unique:!0,type:SALVAGED,points:3,done:!0,r5p8:-1,init:function(b){var e=
this;b.addafterdefenseeffect(this,function(b,g,h){e.r5p8!=round&&(e.r5p8=round,this.donoaction([{name:this.name,org:this,type:"HIT",action:function(b){var f=this.rollattackdie(1,e,"hit")[0];this.log("roll 1 attack dice [%0]",e.name);if("hit"==f||"critical"==f)h.log("+1 %HIT% [%1]",e.name),h.resolvehit(1),h.checkdead();"critical"==f&&(this.log("+1 %HIT% [%1]",e.name),this.resolvehit(1),this.checkdead());this.endnoaction(b,"")}.bind(this)}],"",!0))})}},{name:"Attanni Mindlink",type:ELITE,faction:SCUM,
points:1,done:!0,init:function(b){var e=this;"undefined"==typeof Unit.prototype.getattanni&&(Unit.prototype.getattanni=function(){return[]});Unit.prototype.wrap_after("getattanni",this,function(b){return b.concat(e.unit)});b.wrap_after("addfocustoken",this,function(){if(!this.dead&&e.isactive){var b=this.getattanni(),g;for(g in b)b[g]!=this&&b[g].isally(this)&&0==b[g].focus&&(b[g].addfocustoken(),b[g].log("+1 %FOCUS% [%0]",e.name))}});b.wrap_after("addstress",this,function(){if(!this.dead&&e.isactive){var b=
this.getattanni(),g;for(g in b)b[g]!=this&&b[g].isally(this)&&0==b[g].stress&&(b[g].addstress(),b[g].log("+1 %STRESS% [%0]",e.name))}})}},{name:"Rage",type:ELITE,round:-1,candoaction:function(){return this.isactive},action:function(b){var e=this.unit;this.isactive&&(this.unit.log("+1 %FOCUS%, +2 %STRESS%, 3 rerolls [%0]",e.name),this.round=round,e.addfocustoken(),e.addstress(),e.addstress());e.endaction(b,ELITE);return!0},init:function(b){b.adddicemodifier(ATTACK_M,REROLL_M,ATTACK_M,this,{dice:["blank",
"focus"],n:function(){return 3},req:function(b,f,g){return this.isactive&&this.round==round}.bind(this)})},done:!0,points:1},{name:"Punishing One",type:TITLE,unique:!0,points:12,done:!0,ship:"JumpMaster 5000",install:function(b){b.installed=!0;b.weapons[0].wrap_after("getattack",this,function(b){return b+1});b.showstats()},uninstall:function(b){"function"==typeof b.weapons[0].getattack.unwrap&&b.weapons[0].getattack.unwrap(this);b.showstats()}},{name:"Long-Range Scanners",type:MOD,points:0,done:!0,
requiredupg:[TORPEDO,MISSILE],init:function(b){b.wrap_after("gettargetableunits",this,function(b,f){var e=[];if(3>b)return e;for(var h in squadron)squadron[h].isenemy(this)&&3<=this.getrange(squadron[h])&&e.push(squadron[h]);return e})}},{name:"Electronic Baffle",type:SYSTEM,points:1,done:!0,init:function(b){var e=this;b.wrap_after("addstress",this,function(){this.donoaction([{type:"STRESS",name:e.name,org:e,action:function(b){this.removestresstoken();this.log("-1 %STRESS%, +1 %HIT% [%0]",e.name);
this.resolvehit(1);this.endnoaction(b,"SYSTEM")}.bind(this)}],"Take 1 %HIT% instead of %STRESS% token",!0)});b.wrap_after("addiontoken",this,function(){this.donoaction([{type:"ION",name:e.name,org:e,action:function(b){this.removeiontoken();this.log("-1 %ION%, +1 %HIT% [%0]",e.name);this.resolvehit(1);this.endnoaction(b,"SYSTEM")}.bind(this)}],"Take 1 %HIT% instead of %ION% token",!0)})}},{name:"Overclocked R4",type:SALVAGED,points:1,done:!0,init:function(b){var e=this;b.wrap_after("begincombatphase",
e,function(b){this.wrap_after("removefocustoken",e,function(){this.donoaction([{type:"STRESS",name:e.name,org:e,action:function(b){this.addstress();this.addfocustoken();this.endnoaction(b,"SALVAGED")}.bind(this)}],"Add %STRESS% for %FOCUS%",!0)}).unwrapper("endcombatphase");return b})}},{name:"Thermal Detonators",done:!0,img:"seismic.png",snd:"explode",width:16,height:8,size:15,explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){for(var b=this.getrangeallunits(),e=0;e<b[1].length;e++){var f=
squadron[b[1][e].unit];f.log("+1 %HIT%, +1 %STRESS% [%0]",this.name);f.resolvehit(1);f.addstress();f.checkdead()}this.explode_base()}},type:BOMB,points:3},{name:"Ion Projector",type:MOD,islarge:!0,done:!0,points:2,init:function(b){var e=this;b.wrap_before("collidedby",this,function(b){if(e.isactive&&b.isenemy(this)){var f=this.rollattackdie(1,e,"hit")[0];if("hit"==f||"critical"==f)b.log("+%1 %ION% [%0]",e.name,1),b.addiontoken()}else b.log("no effect [%0]",e.name)})}},{name:"Adaptability",type:ELITE,
points:0,done:!0,faceup:!1,"switch":function(){this.name=(this.faceup=!this.faceup)?"Adaptability(+1)":"Adaptability(-1)";this.unit.showskill()},init:function(b){var e=this;b.wrap_after("getskill",this,function(b){return e.faceup?b+1:b-1});this["switch"]();b.showskill()}},{name:"Systems Officer",type:CREW,limited:!0,faction:EMPIRE,done:!0,points:2,init:function(b){b.wrap_after("handledifficulty",this,function(b){var e=this.selectnearbyally(1);"GREEN"==b&&0<e.length&&this.selectunit(e,function(b,e){b[e].selectunit(b[e].gettargetableunits(3),
function(b,e){this.addtarget(b[e])},["select target to lock"],!1)},["select unit for free %TARGET% (or self to cancel)"],!0)})}},{name:"Special Ops Training",type:TITLE,faction:EMPIRE,ship:"TIE/SF Fighter",points:0,done:!0,init:function(b){var e=this;b.addattack(function(b,e){return this.secondattack},this,[b.weapons[0]],function(){},function(){var b=this.weapons[0].getenemiesinrange(),e=[],h;for(h in b)this.isinprimaryfiringarc(b[h])||e.push(b[h]);return e});b.wrap_after("preattackroll",this,function(b,
g){var f=this.weapons[b];this.secondattack=!1;f.isprimary&&this.isinprimaryfiringarc(g)&&(f={org:e,name:e.name,type:"HIT",action:function(b){this.log("+1 attack die");this.wrap_after("getattackstrength",this,function(b,e,f){return f+1}).unwrapper("attackroll");this.endnoaction(b,"HIT")}.bind(this)},this.donoaction([f],"Add 1 additional attack die or one auxiliary arc attack (by default)",!0,function(){this.secondattack=!0}.bind(this)))})}},{name:"Sensor Cluster",type:TECH,points:2,done:!0,init:function(b){var e=
this;b.adddicemodifier(DEFENSE_M,MOD_M,DEFENSE_M,e,{req:function(b,g){return e.isactive&&this.canusefocus()}.bind(b),aiactivate:function(b,e){return 0<FE_blank(b,e)&&0==FE_focus(b)},f:function(b,g){0<this.canusefocus()&&0<FE_blank(b,g)&&(this.removefocustoken(),this.log("1 blank -> 1 %EVADE% [%0]",e.name),b+=FE_EVADE);return b}.bind(b),str:"blank"})}},{name:"R3 Astromech",type:ASTROMECH,points:2,done:!0,init:function(b){var e=this,f=-1;b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,e,{req:function(b,e){return 0<
FCH_focus(b)&&f<round}.bind(b),aiactivate:function(b,e){return!1},f:function(b,h){0<FCH_focus(b,h)&&f<round&&(this.addevadetoken(),this.log("1 %FOCUS% -> 1 blank, +1 %EVADE% [%0]",e.name),f=round,b-=FCH_FOCUS);return b}.bind(b),str:"focus"})}},{name:"Vectored Thrusters",type:MOD,done:!0,islarge:!1,addedaction:"Roll",points:2},{name:"Tail Gunner",type:CREW,done:!0,limited:!0,points:2,init:function(b){b.wrap_before("resolveattack",this,function(b,f){var e=this.weapons[b];e.isprimary&&3>=e.getauxiliarysector(f)&&
"Bilaser"==e.type&&(f.log("-1 defense [%0]",this.name),f.wrap_after("getagility",this,function(b){return 0<b?b-1:b}).unwrapper("afterdefenseeffect"),f.showstats())})}},{name:"Collision Detector",type:SYSTEM,done:!0,points:0,init:function(b){var e=this;b.wrap_after("canmoveonobstacles",this,function(b,e){return b.match(/DECLOAK|ROLL|BOOST/)?!0:e});b.wrap_after("canhavecriticalocollision",this,function(){this.log("ignoring collision with obstacle [%0]",e.name);return!1})}},{name:"Alliance Overhaul",
type:TITLE,done:!0,points:0,ship:"ARC-170",init:function(b){var e=this;b.wrap_after("getattackstrength",this,function(b,g,h){this.weapons[b].isprimary&&this.isinprimaryfiringarc(g)&&(this.log("+1 attack die [%0]",e.name),h+=1);return h}.bind(b));b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(b,e){return!this.isinprimaryfiringarc(targetunit)}.bind(b),aiactivate:function(b,e){return 0<FCH_focus(b)},f:function(b,e){return 0<FCH_focus(b)?(this.log("1 %FOCUS% ->1 %CRIT%"),b-FCH_FOCUS+FCH_CRIT):
b}.bind(b),str:"focus"})}},{name:"Concord Dawn Protector",type:TITLE,done:!0,points:1,ship:"Protectorate Starfighter",init:function(b){var e=this;b.adddicemodifier(DEFENSE_M,ADD_M,DEFENSE_M,this,{req:function(b,e){return activeunit.isinfiringarc(this)&&this.isinfiringarc(activeunit)&&1==activeunit.getrange(this)}.bind(b),aiactivate:function(b,e){return!0},f:function(b,g){this.log("+1 %EVADE% [%0]",e.name);return{m:b+FE_EVADE,n:g+1}}.bind(b),str:"evade"})}},{name:"Fearlessness",type:ELITE,done:!0,
points:1,faction:SCUM,init:function(b){var e=this;b.adddicemodifier(ATTACK_M,ADD_M,ATTACK_M,this,{req:function(b,e){return targetunit.isinfiringarc(this)&&this.isinfiringarc(targetunit)&&1==targetunit.getrange(this)}.bind(b),aiactivate:function(b,e){return!0},f:function(b,g){this.log("+1 %HIT% [%0]",e.name);return{m:b+FCH_HIT,n:g+1}}.bind(b),str:"hit"})}},{name:"Seismic Torpedo",type:TORPEDO,points:2,done:!0,firesnd:"missile",isWeapon:function(){return!1},candoaction:function(){return this.isactive},
action:function(b){var e=this.unit,f=e.selectnearbyobstacle(2);0<f.length&&this.isactive?e.resolveactionselection(f,function(g){f[g].type=NONE;f[g].g.attr({display:"none"});SOUNDS.explode.play();for(var h in squadron){var l=squadron[h];if(1E4>=l.getdist(l.m,f[g])){var m=l.rollattackdie(1,e,"critical")[0];"hit"==m?(l.log("+1 %HIT% [%0]",this.name),l.resolvehit(1),l.checkdead()):"critical"==m&&(l.log("+1 %CRIT% [%0]",this.name),l.resolvecritical(1),l.checkdead())}}this.desactivate();e.endaction(b,TORPEDO)}.bind(this)):
e.endaction(b,TORPEDO)}},{name:"Latts Razzi",type:CREW,faction:SCUM,points:2,unique:!0,done:!0,init:function(b){var e=this;b.adddicemodifier(DEFENSE_M,ADD_M,DEFENSE_M,this,{req:function(b,e){return 0<activeunit.stress}.bind(b),aiactivate:function(b,e){return 0<activeunit.stress},f:function(b,g){return 0<activeunit.stress?(this.log("-1 stress for %0, +1 %EVADE [%1]",activeunit.name,e.name),activeunit.removestresstoken(),{m:b+FE_EVADE,n:g+1}):{m:b,n:g}}.bind(b),str:"evade"})}},{name:"Ketsu Onyo",type:CREW,
faction:SCUM,points:1,unique:!0,done:!0,init:function(b){var e=this;b.wrap_before("endphase",this,function(){var b=this.selectnearbyenemy(2,function(b,e){return 0<b.tractorbeam});0<b.length&&this.selectunit(b,function(b,f){b[f].wrap_after("resettractorbeam",e,function(b){return this.tractorbeam}).unwrapper("beginplanningphase");b[f].log("keeps %0 tractor beam tokens [%1]",this.tractorbeam,e.name)},["select unit"],!0)})}},{name:"IG-88D",type:CREW,faction:SCUM,points:1,unique:!0,done:!0,init:function(b){for(var e in squadron){var f=
squadron[e];f!=b&&1==f.ig2000&&f.isally(b)&&(b.log("copying %0 abilities [%1]",f.name,this.name),f.init.call(b,f))}}},{name:"Rigged Cargo Chute",type:ILLICIT,islarge:!0,points:1},{name:"Black Market Slicer Tools",type:ILLICIT,points:1,done:!0,candoaction:function(){return this.isactive},action:function(b){var e=this,f=e.unit.selectnearbyenemy(2,function(b,e){return 0<e.stress});0<f.length&&this.isactive&&this.unit.selectunit(f,function(b,f){var g=e.unit.rollattackdie(1,e,"blank")[0];if("hit"==g||
"critical"==g)b[f].applydamage(1),b[f].removestresstoken(),b[f].checkdead()},["select unit [%0]",e.name],!1);this.unit.endaction(b,ILLICIT)}},{name:"Gyroscopic Targeting",ship:"Lancer-class Pursuit Craft",type:MOD,points:2,done:!0,init:function(b){var e=this;b.gtmaneuver=-1;b.wrap_before("endmaneuver",this,function(b){b=this.getmaneuver();this.gtmaneuver=-1;b.move.match(/\w+[345]/)&&(this.gtmaneuver=round)});b.wrap_before("endcombatphase",this,function(){this.gtmaneuver==round&&this.donoaction([{org:e,
type:"MOD",name:e.name,action:function(b){this.log("Free moving arc rotation [%0]",e.name);this.resolvearcrotate(b,!0)}.bind(this)}],"",!0)})}},{name:"Shadow Caster",ship:"Lancer-class Pursuit Craft",type:TITLE,points:3,done:!0,unique:!0,init:function(b){var e=this;b.wrap_after("hashit",this,function(b,g){g&&2>=this.weapons[0].getauxiliarysector(b)&&(this.log("+1 tractor beam token [%0]",e.name),b.addtractorbeam(this));return g})}},{name:"Jyn Erso",faction:REBEL,points:2,unique:!0,done:!0,type:CREW,
candoaction:function(){return this.isactive&&!this.unit.dead},action:function(b){var e=this.unit,f=e.selectnearbyallyandself(2),g=e.selectnearbyenemy(3,function(b,e){return b.isinfiringarc(e)});log("p "+f);log("p.length "+f.length);log("e.length "+g.length);0<f.length&&0<g.length?e.resolveactionselection(f,function(h){var l=g.length;3<l&&(l=3);for(var m=0;m<l;m++)f[h].addfocustoken();e.endaction(b,"CREW")}):(e.log("no effect [%0]",this.name),e.endaction(b,"CREW"))}},{name:"Unkar Plutt",faction:SCUM,
points:1,type:CREW,done:!0,unique:!0,init:function(b){var e=this;b.unkar=-1;b.wrap_after("getcollidingunits",this,function(b,g){0<g.length&&this.unkar<round&&(this.unkar=round,this.donoaction([{org:e,type:"CREW",name:e.name,action:function(b){e.unit.log("+1 %HIT%, +1 free action [%0]",e.name);this.resolvehit(1);SOUNDS.explode.play();this.checkdead();this.doaction(this.getactionlist(),"");this.endnoaction(b,"CREW")}.bind(this)}],"",!0));return g})}},{name:"Sabine's Masterpiece",faction:REBEL,ship:"TIE Fighter",
unique:!0,done:!0,type:TITLE,upgrades:[CREW,ILLICIT],points:1},{name:"Millennium Falcon(HoR)",faction:REBEL,ambiguous:!0,ship:"YT-1300",unique:!0,done:!0,type:TITLE,points:1,init:function(b){var e=this;b.wrap_after("getmaneuverlist",this,function(b){if(this.hasionizationeffect())return b;for(var f in b)f.match(/BR3|BL3/)&&(this.log("perform half-turn after a bank [%0]",e.name),b["K"+f]={move:f,difficulty:b[f].difficulty,halfturn:!0});return b});b.wrap_before("completemaneuver",this,function(b,e,h){b.match(/BR3|BL3/)&&
1==h&&this.addstress()})}},{name:"Smuggling Compartment",ship:"YT-",type:MOD,limited:!0,done:!0,points:0,upgrades:[MOD,ILLICIT],maxupg:3},{name:"Burnout Slam",islarge:!0,done:!0,type:ILLICIT,addedaction:"SLAM",points:1,init:function(b){var e=this;b.wrap_after("resolveslam",this,function(){if(e.isactive){var b=e.unit.shipactionList.indexOf("SLAM");e.unit.shipactionList.splice(b,1);e.desactivate()}}.bind(b))}},{name:"Finn",faction:REBEL,points:5,unique:!0,type:CREW,done:!0,init:function(b){b.adddicemodifier(ATTACK_M,
ADD_M,ATTACK_M,this,{req:function(b,f){return this.isactive&&this.unit.isinfiringarc(targetunit)}.bind(this),f:function(b,f){this.unit.log("+1 blank [%0]",this.name);return{m:b,n:f+1}}.bind(this),str:"crew"});b.adddicemodifier(DEFENSE_M,ADD_M,DEFENSE_M,this,{req:function(b,f){return this.isactive&&this.unit.isinfiringarc(activeunit)}.bind(this),f:function(b,f){this.unit.log("+1 blank [%0]",this.name);return{m:b,n:f+1}}.bind(this),str:"crew"})}},{name:"Rey",faction:REBEL,points:2,unique:!0,type:CREW,
done:!0,init:function(b){var e=this;e.focus=0;b.wrap_before("endphase",this,function(){this.log("+1 %FOCUS% on %0",e.name);0<this.focus&&(e.focus++,this.removefocustoken())});b.wrap_before("begincombatphase",this,function(){0<e.focus&&this.donoaction([{org:e,type:"CREW",name:e.name,action:function(b){e.focus--;e.unit.addfocustoken();e.unit.endnoaction(b,"CREW")}}],"",!0)})}},{name:"Black One",points:1,unique:!0,done:!0,ship:"T-70 X-Wing",type:TITLE,skillmin:7,init:function(b){var e=this;b.wrap_after("endaction",
this,function(b,g){if("BOOST"==g||"ROLL"==g){var f=this.selectnearbyally(1,function(b,e){for(var f=0;f<e.istargeted.length;f++)if(!e.istargeted[f].isally(e))return!0;return!1});0<f.length&&this.selectunit(f,function(b,f){for(var g=0;g<b[f].istargeted.length;g++){var h=b[f].istargeted[g];if(!b[f].isally(h)){b[f].log("removing %TARGET% from %0 [%1]",h.name,e.name);h.removetarget(b[f]);break}}},["select unit (or self to cancel) [%0]",e.name],!1)}})}},{name:"Primed Thrusters",points:1,done:!0,islarge:!1,
type:TECH,init:function(b){b.wrap_after("isactiondone",this,function(b,f){if(0<this.stress&&"ROLL"!=b&&"BOOST"!=b)return!0;0<this.stress&&"ROLL"==b&&f&&this.log("can do %ROLL% [%0]");0<this.stress&&"BOOST"==b&&f&&this.log("can do %BOOST% [%0]");return f});b.wrap_after("hasnostresseffect",this,function(){return 3>this.stress})}},{name:"M9-G8",type:ASTROMECH,points:3,unique:!0,done:!1},{name:"Pattern Analyzer",type:TECH,points:2},{name:"General Hux",type:CREW,faction:EMPIRE,points:5,unique:!0,done:!0,
candoaction:function(){return!0},action:function(b){var e=this.unit,f=e.selectnearbyally(2);0<f.length?(1==f.length?(new Condition(f[0],e,"Fanatical Devotion"),f[0].addfocustoken(),e.endaction(b,CREW)):2<=f.length?(f.push(e),e.log("select up to 3 units (self to cancel) [%0]",e.name),e.resolveactionselection(f,function(g){f[g]==this&&this.endaction(b,CREW);new Condition(f[g],e,"Fanatical Devotion");f[g].addfocustoken();f.splice(g,1);1<f.length?this.resolveactionselection(f,function(e){f[e]==this&&
this.endaction(b,CREW);f[e].addfocustoken();f.splice(e,1);1<f.length?this.resolveactionselection(f,function(e){f[e]==this&&this.endaction(b,CREW);f[e].addfocustoken();this.endaction(b,CREW)}.bind(this)):this.endaction(b,CREW)}.bind(this)):this.endaction(b,CREW)}.bind(e))):e.endaction(b,CREW),e.addstress()):e.endaction(b,CREW)}},{name:"Kylo Ren",type:CREW,faction:EMPIRE,points:3,unique:!0,done:!0,candoaction:function(){return 0<this.unit.selectnearbyenemy(3).length},action:function(b){var e=this.unit,
f=e.selectnearbyenemy(3);this.resolveactionselect(f,function(b){new Condition(f[b],e,"I'll Show You The Dark Side")}.bind(this))}},{name:"Operations Specialist",type:CREW,points:3,limited:!0,done:!0,init:function(b){var e=this;Unit.prototype.wrap_after("endattack",e,function(b,g,h){if(e.isactive&&this.isally(e.unit)&&2>=this.getrange(e.unit)&&0==b+g){var f=this.selectnearbyally(3);0<f.length&&(console.log(e.name+" "+this.name),this.doselection(function(b){this.resolveactionselect(f,function(e){f[e].addfocustoken();
this.endnoaction(b,"OP")}.bind(this))}.bind(this)))}})}},{name:"Targeting Synchronizer",type:TECH,points:3,done:!0,init:function(b){var e=this;Unit.prototype.wrap_after("canusetarget",e,function(b,g){return e.unit!=this&&e.unit.isally(this)&&2>=e.unit.getrange(this)&&-1<e.unit.targeting.indexOf(b)?!0:g});Unit.prototype.wrap_before("removetarget",e,function(b){e.unit!=this&&e.unit.isally(this)&&2>=e.unit.getrange(this)&&-1==this.targeting.indexOf(b)&&-1<e.unit.targeting.indexOf(b)&&e.unit.removetarget(b)})}},
{name:"Hyperwave Comm Scanner",type:TECH,done:!0,points:1,init:function(b){var e=this;b.wrap_after("endsetupphase",this,function(){var b=this.selectnearbyunit(2);if(e.isactive)for(var g in b){var h=b[g];h.donoaction([{type:"FOCUS",name:e.name,org:e,action:function(b){this.addfocustoken();this.endnoaction(b,"TECH")}.bind(h)},{type:"EVADE",name:e.name,org:e,action:function(b){e.desactivate();this.addevadetoken();this.endnoaction(b,"TECH")}.bind(h)}],"+1 %EVADE% / %FOCUS%",!0)}})}},{name:"Cassian Andor",
type:CREW,points:2,faction:REBEL,unique:!0,init:function(b){b.wrap_after("endplanningphase",this,function(){var b=this.selectnearbyenemy(2);0<b&&this.doselection(function(e){this.resolveactionselect(b,function(e){this.guessmove(b[e].maneuver)}.bind(this))}.bind(this))})}},{name:"Captain Rex",type:CREW,points:2,faction:REBEL,unique:!0,done:!0,init:function(b){var e=this;b.wrap_after("hashit",this,function(b,g){g||(this.log("+1 stress, +1 %FOCUS% [%0]",e.name),this.addfocustoken());return g})}},{name:"EMP Device",
unique:!0,type:ILLICIT,points:2,range:[1,1],done:!0,isTurret:function(){return!0},issecondary:!1,firesnd:"missile",isWeapon:function(){return!0},getenemiesinrange:function(){return[this.unit]},declareattack:function(b){if(!this.isactive)return!1;b=this.unit.selectnearbyunits(1,function(b,f){return b!=f});for(i in b)b[i].addiontoken(),b[i].addiontoken(),b[i].log("+2 %ION% [%0]",this.name);this.isactive=!1;this.unit.cancelattack();return!1},init:function(b){this.toString=Upgrade.prototype.toString}},
{name:"Captured TIE",unique:!0,type:MOD,ship:"TIE Fighter",faction:REBEL,points:1,done:!0,init:function(b){var e=this,f=!1;b.wrap_after("declareattack",function(b,e){e&&(f=!0);return e});b.wrap_after("isenemy",this,function(b,h){return h||!f&&b.getskill()<this.getskill()&&e.isactive})}},{name:"Inspiring Recruit",type:CREW,points:1,done:!0,init:function(b){var e=this;Unit.prototype.wrap_after("removestresstoken",this,function(){this.isally(b)&&2>=this.getrange(b)&&0<this.stress&&(this.log("-1 stress token [%0]",
e.name),this.removestresstoken.vanilla.call(this))})}},{name:"Baze Malbus",type:CREW,points:3,unique:!0,done:!0,faction:REBEL,init:function(b){var e=this;b.addattack(function(b,e){return this.weapons[0].isactive&&0==b+e},this,[b.weapons[0]],function(){this.noattack=round},function(){this.log("+1 attack [%0]",e.name);return this.selectnearbyenemy(3,function(b,e){return e!=targetunit})})}},{name:"Bodhi Rook",type:CREW,points:1,unique:!0,faction:REBEL,done:!0,init:function(b){b.wrap_after("gettargetableunits",
this,function(b,f){var e=[],h;for(h in squadron)squadron[h].isally(this)&&(e=e.concat(Unit.prototype.gettargetableunits.vanilla.call(e,3)));return e})}},{name:"Adaptive Ailerons",type:TITLE,points:0,ship:"TIE Striker",done:!1},{name:"Swarm Leader",unique:!0,points:3,type:ELITE,done:!0,init:function(b){var e=this;b.wrap_after("preattackroll",this,function(b,g){var f=this.selectnearbyally(3,function(b,e){return e.canuseevade()&&e.isinfiringarc(g)?!0:!1}),l=0;0<f.length&&(l++,f[0].removeevadetoken());
1<f.length&&(l++,f[1].removeevadetoken());this.log("+%1 attack die [%0]",l,e.name);this.wrap_after("getattackstrength",this,function(b,e,f){return f+l}).unwrapper("attackroll")})}},{name:"Lightweight Frame",type:MOD,points:2,agilitymax:3,ship:"TIE",done:!0,init:function(b){var e=this;b.wrap_before("defenseroll",this,function(b,g){getattackdice()>getdefensedice()&&(this.log("+1 defense roll [%0]",e.name),this.wrap_after("getagility",e,function(b){return b+1}).unwrapper("defenseroll"))})}},{name:"'Light Scyk' Interceptor",
type:TITLE,points:-2,ship:"M3-A Interceptor",lostupgrades:[MOD],done:!0,init:function(b){this.deal=function(b,e){return $.Deferred().resolve({crit:b,face:FACEUP})};var e=[];b.installed=!0;b.wrap_after("getdial",this,function(b){if(0==e.length)for(var f=0;f<b.length;f++){var h=b[f].move,l=b[f].difficulty;h.match(/BL\d|BR\d/)&&(l="GREEN");e[f]={move:h,difficulty:l}}return e})}},{name:"Hotshot Co-Pilot",type:CREW,points:4,done:!0,init:function(b){var e=this,f=function(){if(this.canusefocus()){this.log("- %0 %FOCUS% [%1]",
this.focus,e.name);for(var b=0;b<this.focus;b++)this.removefocustoken()}};b.wrap_before("resolveattack",this,function(b,h){this.weapons[b].isprimary&&h.wrap_before("endmodifydefensestep",e,f)});b.wrap_before("isattackedby",this,function(b,h){h.wrap_before("endmodifyattackstep",e,f)})}},{name:"Trick Shot",type:ELITE,points:0,done:!0,init:function(b){var e=this;b.wrap_after("getattackstrength",this,function(b,g,h){0<this.getobstructiondef(g)&&(this.log("obstructed attack => +1 die [%0]",e.name),h+=
1);return h})}},{name:"Bistan",type:CREW,points:2,unique:!0,done:!0,faction:REBEL,init:function(b){b.wrap_after("modifyattackroll",this,function(b,f,g,h){2>=this.getrange(targetunit)&&(h=h+FCH_CRIT-FCH_HIT);return h});b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(e,f){return 2>=b.getrange(targetunit)}.bind(this),aiactivate:function(b,f){return!0},f:function(b,f){0<FCH_hit(b)&&(this.unit.log("%HIT% -> %CRIT% [%0]",this.name),b=b+FCH_CRIT-FCH_HIT);return b}.bind(this),str:"hit"})}},{name:"Expertise",
type:ELITE,rating:2,points:4,done:!0,init:function(b){b.wrap_after("modifyattackroll",this,function(b,f,g,h){0==this.stress&&FCH_focus(h)&&(h+=(FCH_HIT-FCH_FOCUS)*FCH_focus(h));return h});b.adddicemodifier(ATTACK_M,MOD_M,ATTACK_M,this,{req:function(e,f){return 0==b.stress}.bind(this),aiactivate:function(b,f){return 0<FCH_focus(b)},f:function(b,f){0<FCH_focus(b)&&(this.unit.log("%FOCUS% -> %HIT% [%0]",this.name),b+=FCH_focus(b)*(FCH_HIT-FCH_FOCUS));return b}.bind(this),str:"focus"});b.adddicemodifier(ATTACK_M,
REROLL_M,ATTACK_M,this,{req:function(e,f,g){return b.canusetarget(g)&&0==b.stress}.bind(this),n:function(){return 9}.bind(this),dice:["blank"],f:function(){activeunit.removetarget(targetunit)}.bind(this),str:"target",token:!0})}},{name:"BoShek",type:CREW,points:2}];var allunits=[];function Team(b){this.team=b;this.initiative=this.isia=this.isdead=!1;this.units=[];this.allhits=this.allcrits=this.allevade=this.allred=this.allgreen=0}
Team.prototype={setia:function(){for(i in squadron)if(u=squadron[i],squadron[i].team==this.team)for(j in IAUnit.prototype)squadron[i][j]=IAUnit.prototype[j];this.ia=!0},setplayer:function(){for(i in squadron)if(u=squadron[i],squadron[i].team==this.team)for(j in IAUnit.prototype)"undefined"!=typeof Unit.prototype[j]&&(squadron[i][j]=Unit.prototype[j]);this.ia=!1},setfaction:function(b){$(".listunits .generic").remove();this.faction=b;$("#"+b+"select").prop("checked",!0);this.color="REBEL"==this.faction?
RED:"EMPIRE"==this.faction?GREEN:YELLOW},changefaction:function(b){$("#rocks").hide();$("#debris").hide();$("#caroussel").show();if(this.faction!=b){for(var e in generics)generics[e].team==this.team&&delete generics[e];$("#totalpts").html(0);this.setfaction(b);displayfactionunits()}},setrocks:function(b){this.rocks="undefined"==typeof b?[-1,-1,-1]:b},displayrockdebris:function(b,e,f,g,h,l,m){var q=b%MAXROCKS+(b>=MAXROCKS?ROCKS.length:0),v=h[q].getBBox();e=b<MAXROCKS?MT(b*e/ROCKS.length+e/ROCKS.length/
4,f/4-v.height*g/2).scale(g,g):MT((b-MAXROCKS)*e/DEBRISCLOUD.length+e/DEBRISCLOUD.length/4,3*f/4-v.height*g/2).scale(g,g);h[q].transform(e);h[q].appendTo(l);h[q].hover(function(){h[q].attr({strokeWidth:12})},function(){h[q].attr({strokeWidth:3})});h[q].click(function(){var e=this.rocks.indexOf(b);if(-1<e)this.rocks[e]=-1,h[q].attr("fill",m);else{-1==this.rocks[0]?this.rocks[0]=b:-1==this.rocks[1]?this.rocks[1]=b:-1==this.rocks[2]&&(this.rocks[2]=b);if(-1<this.rocks[0]&&-1<this.rocks[1]&&-1<this.rocks[2])for(e=
0;3>e;e++){var f=OBSTACLES[e+3*(this.team-1)];f.g.remove();OBSTACLES[e+3*(this.team-1)]=new Rock(this.rocks[e],[f.tx,f.ty,f.alpha],this.team,e)}-1<this.rocks.indexOf(b)&&h[q].attr("fill",halftone(this.color))}}.bind(this))},selectrocks:function(){"undefined"==typeof this.rocks&&(this.rocks=[-1,-1,-1]);$(".aster").empty();for(var b=Snap(".aster"),e=[],f=b.g(),g=0,h=0,l=b.image(DEBRISIMG,0,0,256,256).pattern(0,0,256,256),m=b.image(ROCKIMG,0,0,256,256).pattern(0,0,256,256),q=0;q<ROCKS.length+DEBRISCLOUD.length;q++){q<
ROCKS.length?(e[q]=b.path(ROCKS[q]).attr({strokeWidth:3}),-1<this.rocks.indexOf(q)?e[q].attr({fill:halftone(this.color),stroke:this.color}):e[q].attr({fill:m,stroke:"#888"})):(e[q]=b.path(DEBRISCLOUD[q-ROCKS.length]).attr({strokeWidth:3}),-1<this.rocks.indexOf(q)?e[q].attr({fill:halftone(this.color),stroke:this.color}):e[q].attr({fill:l,stroke:"#888"}));var v=e[q].getBBox();g<v.width&&(g=v.width);h<v.height&&(h=v.height)}b=$(".aster").height();v=$(".aster").width();h=b/2/h;v/g/ROCKS.length<h&&(h=
v/g/ROCKS.length);for(q=0;q<ROCKS.length;q++)this.displayrockdebris(q,v,b,h,e,f,m);for(q=0;q<DEBRISCLOUD.length;q++)this.displayrockdebris(q+MAXROCKS,v,b,h,e,f,l)},checkdead:function(){var b,e=!0;for(b=0;b<this.units.length;b++)if(!this.units[b].dead){e=!1;break}return this.isdead=e},toggleplayer:function(b){this.isia=!this.isia},updatepoints:function(){var b=0;$("#listunits li").each(function(){var e=0;$(this).find(".pts").each(function(){e+=parseInt($(this).text())});$(this).find(".upts").html(e);
b+=e});$("#totalpts").html(b)},addunit:function(b){-1==b&&log("unknown addunit pilot "+pilots[b]);b=new Unit(this.team,b);$("#listunits").append(""+b);this.updatepoints()},tosquadron:function(b){var e=[],f,g,e=this.sortedgenerics(),h=0,l=0;for(f in generics)1==generics[f].team&&h++;for(f=0;f<e.length;f++)if(this.team==e[f].team){e[f].id=l++;2==e[f].team&&(e[f].id+=h);var m=e[f];for(g in PILOTS[m.pilotid]){var q=PILOTS[m.pilotid];"function"==typeof q[g]&&(m[g]=q[g])}m.tosquadron(b);allunits.push(m);
squadron.push(m);this.units.push(m)}for(f in squadron)m=squadron[f],m.team==this.team&&"function"==typeof m.init&&m.init();for(f in squadron)if(m=squadron[f],m.team==this.team)for(g=0;g<m.upgrades.length;g++)b=m.upgrades[g],0<=b.id&&"function"==typeof UPGRADES[b.id].uninstall&&UPGRADES[b.id].uninstall(m),"function"==typeof b.install&&b.install(m);for(f in squadron)if(m=squadron[f],m.team==this.team)for(g=0;g<m.upgrades.length;g++)b=m.upgrades[g],"function"!=typeof b.init||m.isdocked||b.init(m);this.units.sort(function(b,
e){return e.getskill()-b.getskill()});this.history={title:{text:UI_translation["Damage taken per turn"]},axisX:{interval:1,title:UI_translation.Turns},axisY:{title:UI_translation["Cumulated damage"]},rawdata:[],data:[{indexLabelFontColor:"darkSlateGray",name:"views",type:"area",color:"rgba(200,10,10,0.8)",markerSize:8,dataPoints:[]}]};return this.units},endsetup:function(){var b;for(b=0;b<this.units.length;b++)this.units[b].g.undrag()},endselection:function(b){var e=this.team;this.name=$("#teamname"+
this.team).val();""==this.name&&(this.name="Squad #"+e);$("#team"+e).empty();$("#importexport"+e).remove();sq=this.tosquadron(b);for(b=0;b<sq.length;b++){if(1==e){if(0>=sq[b].tx||0>=sq[b].ty)sq[b].tx=80-(sq[b].islarge?20:0),sq[b].ty=70+82*b,sq[b].alpha=90;$("#team1").append('<div id="'+sq[b].id+'" onclick=\'select($(this).attr("id"))\'>'+sq[b]+"</div>")}else{if(0>=sq[b].tx||0>=sq[b].ty)sq[b].tx=820+(sq[b].islarge?20:0),sq[b].ty=70+82*b,sq[b].alpha=-90;$("#team2").append('<div id="'+sq[b].id+'" onclick=\'select("'+
sq[b].id+"\")'>"+sq[b]+"</div>")}sq[b].m.translate(sq[b].tx,sq[b].ty).rotate(sq[b].alpha,0,0);sq[b].show()}$("#team"+e).css("top",$("nav").height()+2);activeunit=sq[0]},sortedgenerics:function(){var b=[],e;for(e in generics)generics[e].team==this.team&&b.push(generics[e]);b.sort(function(b,e){"undefined"==typeof b.points&&log("undefined score");return b.points<e.points?-1:b.points>e.points?1:b.toJuggler(!1)<e.toJuggler(!1)});return b},toASCII:function(){for(var b="",e=this.sortedgenerics(),f=0;f<
e.length;f++)b+=e[f].toASCII()+";";return b},toKey:function(){var b="",e=[],f;for(f in generics)generics[f].team==this.team&&e.push(generics[f]);e.sort(function(b,e){return b.pilotid-e.pilotid});for(f=0;f<e.length;f++)b+=e[f].toKey()+";";return b},toJSON:function(){var b={description:""};b.faction={REBEL:"rebels",SCUM:"scum",EMPIRE:"empire"}[this.faction];b.name=this.name;for(var e=[],f=0,g=this.sortedgenerics(),h=0;h<g.length;h++){var l=g[h].toJSON(),f=f+l.points;e.push(l)}b.pilots=e;this.points=
b.points=f;b.vendor={xwsbenchmark:{builder:"Ynot Squadron Benchmark",builder_url:"http://ynot6517.github.io/bench/"}};b.version="0.3.0";return b},toJuggler:function(b){for(var e="",f=this.sortedgenerics(),g=0;g<f.length;g++)e+=f[g].toJuggler(b)+"\n";return e},parseJuggler:function(b,e){var f,g,h,l;f=-1;var m=function(b){return"REBEL"==b?1:"SCUM"==b?2:4};f=7;if(""!=b){var q=b.trim().split("\n");for(g in generics)generics[g].team==this.team&&delete generics[g];for(g=0;g<q.length;g++){var v=q[g].split(/\s+\+\s+/),
w=0;for(h=0;h<PILOTS.length;h++){l=PILOTS[h].name;var x=translate(l),y="";1==PILOTS[h].ambiguous&&"undefined"!=typeof PILOTS[h].edition&&(y="("+PILOTS[h].edition+")");x+=y;l+=y;l.replace(/\'/g,"")==v[0]&&(w|=m(PILOTS[h].faction));x.replace(/\'/g,"")==v[0]&&(w|=m(PILOTS[h].faction))}f&=w}this.faction=1==(f&1)?"REBEL":2==(f&2)?"SCUM":"EMPIRE";this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;for(g=0;g<q.length;g++){f=-1;v=q[g].split(/\s+\+\s+/);for(h=0;h<PILOTS.length;h++)if(x=
l=PILOTS[h].name,y="",PILOTS[h].faction==this.faction){x=translate(l);1==PILOTS[h].ambiguous&&"undefined"!=typeof PILOTS[h].edition&&(y="("+PILOTS[h].edition+")");l+=y;x+=y;if(l.replace(/\'/g,"")==v[0]){f=h;break}if(x.replace(/\'/g,"")==v[0]){f=h;e=!0;break}}-1==f&&console.log("pid undefined:"+e+"!!"+v[0]+"!!"+this.faction);-1==f&&log("unknown Juggler pilot:"+q[g]+"/"+b);x=new Unit(this.team,f);x.upg=[];for(h=0;10>h;h++)x.upg[h]=-1;y=[TITLE,MOD].concat(PILOTS[x.pilotid].upgrades);for(h=1;h<v.length;h++)for(l=
0;l<UPGRADES.length;l++)if(1==e&&translate(UPGRADES[l].name).replace(/\'/g,"").replace(/\(Crew\)/g,"")==v[h]||UPGRADES[l].name.replace(/\'/g,"")==v[h]){if(-1<y.indexOf(UPGRADES[l].type)){"undefined"!=typeof UPGRADES[l].upgrades&&("Cannon|Torpedo|Missile"==UPGRADES[l].upgrades[0]?(y=y.concat(["Cannon","Torpedo","Missile"]),x.upgradetype=x.upgradetype.concat(["Cannon","Torpedo","Missile"])):(y=y.concat(UPGRADES[l].upgrades),""!=typeof UPGRADES[l].upgrades&&(x.upgradetype=x.upgradetype.concat(UPGRADES[l].upgrades))));
break}l==UPGRADES.length&&log("UPGRADE undefined: "+v[h])}for(h=1;h<v.length;h++)for(l=0;l<UPGRADES.length;l++)if(1==e&&translate(UPGRADES[l].name).replace(/\'/g,"").replace(/\(Crew\)/g,"")==v[h]||UPGRADES[l].name.replace(/\'/g,"")==v[h])if(-1<y.indexOf(UPGRADES[l].type)){for(f=0;f<x.upgradetype.length;f++)if(x.upgradetype[f]==UPGRADES[l].type&&-1==x.upg[f]){x.upg[f]=l;break}break}else log("** "+v[h]+" UPGRADE not listed: "+UPGRADES[l].type+" in "+x.name)}}},parseASCII:function(b){b=b.split(";");
for(var e in generics)generics[e].team==this.team&&delete generics[e];for(e=0;e<b.length-1;e++){var f=b[e].split(":"),g=f[0].split(","),h=parseInt(g[0],10);this.faction=PILOTS[h].faction;this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;-1==h&&log("unknown ASCII pilot "+b[e]);h=new Unit(this.team,h);h.upg=[];for(var l=0;10>l;l++)h.upg[l]=-1;for(l=1;l<g.length;l++)for(var m=parseInt(g[l],10),q=0;q<h.upgradetype.length;q++)if(h.upgradetype[q]==UPGRADES[m].type&&-1==h.upg[q]){h.upg[q]=
m;break}1<f.length&&(f=f[1].split(","),h.tx=parseInt(f[0],10),h.ty=parseInt(f[1],10),h.alpha=parseInt(f[2],10))}},parseJSON:function(b,e){var f,g={rebel:REBEL,scum:SCUM,imperial:EMPIRE};try{f=$.parseJSON(b),ga("send","event",{eventCategory:"social",eventAction:"receive",eventLabel:"xws"})}catch(z){return this.parseJuggler(b,e)}var h,l,m;this.name=f.name;this.points=f.points;this.faction=g[f.faction];this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;for(h in generics)generics[h].team==
this.team&&delete generics[h];for(h=0;h<f.pilots.length;h++){var q=f.pilots[h],v,g=-1;q.team=this.team;for(l=0;l<PILOTS.length;l++)if(PILOTS[l].faction==this.faction&&PILOTS[l].unit==PILOT_dict[q.ship]&&(va=PILOTS[l].name,va==PILOT_dict[q.name])){g=l;break}if(-1==g)throw"pid undefined:"+PILOT_dict[q.name];v=new Unit(this.team,g);v.upg=[];for(l=0;10>l;l++)v.upg[l]=-1;if("undefined"!=typeof q.upgrades){var w=0;for(l in q.upgrades){var x=q.upgrades[l];for(m=0;m<x.length;m++){w++;for(var y=0;y<UPGRADES.length;y++)if(UPGRADES[y].name==
UPGRADE_dict[x[m]]){for(g=0;g<v.upgradetype.length;g++)if(v.upgradetype[g]==UPGRADES[y].type&&-1==v.upg[g]){v.upg[g]=y;break}break}}}}}}};var Resample=function(b){function e(){throw"not found: "+this.src;}function f(){var e=this._width,f=this._height,q=this._onresample,v=Math.min(this.height,this.width);null==e&&(e=h(this.width*f/this.height));null==f&&(f=h(this.height*e/this.width));delete this._onresample;delete this._width;delete this._height;b.width=e;b.height=f;g.drawImage(this,0,0,v,v,0,0,e,f);q(b.toDataURL("image/png"))}var g=b.getContext("2d"),h=Math.round;return function(b,g,h,v){var l="string"==typeof b,m=l||b;l&&(m=new Image,
m.onload=f,m.onerror=e);m._onresample=v;m._width=g;m._height=h;l?m.src=b:f.call(b)}}(this.document.createElement("canvas"));(function(){var b,e={settings:{bod:$("#setting"),img:$("#profile-avatar"),fileInput:$("#uploader")},init:function(){b=e.settings;var f;b.bod.on("dragover",function(g){clearTimeout(f);g.currentTarget==b.bod[0]&&e.showDroppableArea();return!1});b.bod.on("dragleave",function(g){g.currentTarget==b.bod[0]&&(f=setTimeout(function(){e.hideDroppableArea()},200))});b.bod.on("drop",function(b){b.preventDefault();e.handleDrop(b.dataTransfer.files)});b.fileInput.on("change",function(b){e.handleDrop(b.target.files)})},
showDroppableArea:function(){b.bod.addClass("droppable")},hideDroppableArea:function(){b.bod.removeClass("droppable")},handleDrop:function(b){e.hideDroppableArea();b=b[0];"undefined"!==typeof b&&b.type.match("image.*")?e.resizeImage(b,16,function(b){e.placeImage(b)}):alert("That file wasn't an image.")},resizeImage:function(b,e,h){var f=new FileReader;f.onload=function(){Resample(this.result,e,e,h)};f.readAsDataURL(b);f.onabort=function(){alert("The upload was aborted.")};f.onerror=function(){alert("An error occured while reading the file.")}},
placeImage:function(e){b.img.attr("src",e);localStorage.image=e}};e.init()})();var a1=[.25,.375];a1[10]=.125;a1[100]=.25;var d1=[.375,.375];d1[10]=.25;function addattackdice(b,e){var f,g,h,l,m=[];for(f=0;f<b;f++)for(h=0;h<b-f;h++)for(g=0;g<b-h-f;g++)l=100*f+h+10*g,m[l]=0,m[l+1]=0,m[l+10]=0,m[l+100]=0;for(f=0;f<b;f++)for(h=0;h<b-f;h++)for(g=0;g<b-h-f;g++)l=100*f+h+10*g,m[l]+=e[l]*a1[0],m[l+1]+=e[l]*a1[1],m[l+10]+=e[l]*a1[10],m[l+100]+=e[l]*a1[100];return m}
function adddefensedice(b,e){var f,g,h,l=[];for(f=0;f<b;f++)for(g=0;g<b-f;g++)h=10*f+g,l[h]=0,l[h+1]=0,l[h+10]=0;for(f=0;f<b;f++)for(g=0;g<b-f;g++)h=10*f+g,l[h]+=e[h]*d1[0],l[h+1]+=e[h]*d1[1],l[h+10]+=e[h]*d1[10];return l}function attackproba(b){var e,f=[];f[0]=a1[0];f[1]=a1[1];f[10]=a1[10];f[100]=a1[100];for(e=2;e<=b;e++)f=addattackdice(e,f);return f}function defenseproba(b){var e,f=[];f[0]=d1[0];f[1]=d1[1];f[10]=d1[10];for(e=2;e<=b;e++)f=adddefensedice(e,f);return f}
function attackwithreroll(b,e,f){var g,h,l,m,q,v,w,x,y=[];if(0==b.reroll||"undefined"==typeof b.reroll)return e;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)for(l=0;l<=f-h-g;l++)w=100*g+h+10*l,y[w]=0;var z,B;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)for(l=0;l<=f-h-g;l++)if(w=100*g+h+10*l,m=f-h-l-g,B=b.reroll,z=g,b.reroll>m&&(0==b.focus?b.reroll>g+m?(B=g+m,z=0):z=g-(B-m):B=m),0==B)y[w]+=e[w];else for(m=0;m<=B;m++)for(q=0;q<=B-m;q++)for(v=0;v<=B-m-q;v++)x=100*m+q+10*v,k=100*(z+m)+h+q+10*(l+v),y[k]+=e[w]*ATTACK[B][x];
return y}function defendwithreroll(b,e,f){var g,h,l,m,q,v,w=[];if(0==b.reroll||"undefined"==typeof b.reroll)return e;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)w[10*g+h]=0;var x,y;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)if(q=10*g+h,l=f-h-g,y=b.reroll,x=g,b.reroll>l&&(0==b.focus?b.reroll>g+l?(y=g+l,x=0):x=g-(y-l):y=l),0==y)w[q]+=e[q];else for(l=0;l<=y;l++)for(m=0;m<=y-l;m++)v=10*l+m,k=10*(x+l)+h+m,w[k]+=e[q]*DEFENSE[y][v];return w}
function tohitproba(b,e,f,g,h,l,m){var q=[],v,w,x,y,z,B,E,D,F=0,K=0,L=0,M=h;h=0==m?[]:h;for(w=0;w<=l;w++)for(x=0;x<=l-w;x++)z=w+10*x,q[z]=0;if("undefined"==typeof g)return{proba:[],tohit:0,meanhit:0,meancritical:0,tokill:0};g=attackwithreroll(b,g,l);0<m&&(M=defendwithreroll(f,h,m));for(h=0;h<=l;h++)for(w=0;w<=l-h;w++)for(x=0;x<=l-w-h;x++){E=FCH_FOCUS*h+FCH_CRIT*x+FCH_HIT*w;var G,H,I,O=b.focus,Q=b.reroll,J=g[FCH_FOCUS*h+FCH_HIT*w+FCH_CRIT*x];"undefined"!=typeof e.modifyattackroll&&(E=e.modifyattackroll(E,
l,f));"undefined"!=typeof b.modifyattackroll&&(E=b.modifyattackroll(E,l,f));z=FCH_focus(E);G=FCH_crit(E);E=FCH_hit(E);0<b.focus&&0<z&&(E+=z,b.focus--);for(H=0;H<=m;H++)for(I=0;I<=m-H;I++){var R=f.evade,S=f.focus;z=FE_FOCUS*H+FE_EVADE*I;"undefined"!=typeof f.modifydefenseroll&&(z=f.modifydefenseroll(b,z,m));v=FE_focus(z);D=FE_evade(z);y=0==m?1:M[z];z=0;0<f.focus&&0<v&&D<E+G&&(D+=v,f.focus--);0<f.evade&&D<E+G&&(D+=1,f.evade--);E>D?(z=FCH_HIT*(E-D),D=0):D-=E;G>D&&(z+=FCH_CRIT*(G-D));"function"==typeof e.modifyhit&&
0<z&&(z=e.modifyhit(z));b.reroll=0;if("undefined"!=typeof e.immediateattack&&e.immediateattack.pred(z)&&"undefined"==typeof b.iar){b.iar=!0;v=e.immediateattack.weapon();D=b.gethitrange(v,f);if(3>=D&&0<D){D=b.getattackstrength(v,f);var N=f.getdefensestrength(v,b);D=tohitproba(b,b.weapons[v],f,b.getattacktable(D),f.getdefensetable(N),D,N);for(B in D.proba)v=z+1*B,"undefined"==typeof q[v]&&(q[v]=0),q[v]+=D.proba[B]*J*y}else q[z]+=J*y;delete b.iar}else q[z]+=J*y;f.focus=S;f.evade=R}b.focus=O;b.reroll=
Q}for(w=0;w<=l;w++)for(x=0;x<=l-w;x++)z=FCH_HIT*w+FCH_CRIT*x,0<z&&(F+=q[z]),K+=w*q[z],L+=x*q[z];return{proba:q,tohit:Math.floor(1E4*F)/100,meanhit:0==F?0:Math.floor(100*K)/100,meancritical:0==F?0:Math.floor(100*L)/100}};var cmd=[],startreplayall=function(){if(0!=REPLAY.length&&(FAST="W"==REPLAY.substr(-1)?!1:!0,ANIM=REPLAY,cmd=LZString.decompressFromEncodedURIComponent(decodeURI(window.location.search.substr(1))).split("&")[6].split("_"),cmd.splice(0,1),0!=cmd.length)){$(".nextphase").prop("disabled",!0);$(".unit").css("cursor","pointer");actionrlock=$.Deferred();actionrlock.progress(replayall);1==TEAMS[1].isia&&TEAMS[1].setia();1==TEAMS[2].isia&&TEAMS[2].setia();subphase=ACTIVATION_PHASE;for(i in squadron)squadron[i].hasmoved=
!1,squadron[i].maneuver=-1,squadron[i].hasdecloaked=!1;replayall()}},stopreplay=function(){actionrlock=$.Deferred()},restartreplay=function(){ga("send","event",{eventCategory:"interaction",eventAction:"replay",eventLabel:"replay"});actionrlock=$.Deferred();actionrlock.progress(replayall);replayall()},replayall=function(){if(""==cmd){FAST=!1;filltabskill();if(phase!=SETUP_PHASE)setphase();else{$(".imagebg").hide();$(".nextphase").prop("disabled",!1);for(var b=0;b<OBSTACLES.length;b++)OBSTACLES[b].addDrag();
1==TEAMS[1].isia&&TEAMS[1].setplayer();1==TEAMS[2].isia&&TEAMS[2].setplayer();displayplayertype(1);displayplayertype(2)}INREPLAY=!1}else{INREPLAY=!0;var e=cmd[0].split("-");console.log(cmd[0]);cmd.splice(0,1);var f=null,g;if(0<e[0].length){f=parseInt(e[0],10);for(g in squadron)if(squadron[g].id==f)break;if(squadron[g].id==f)f=squadron[g];else{console.log("cannot find id "+f);actionrlock.notify();return}}var h={fo:"removefocustoken",FO:"addfocustoken",e:"removeevadetoken",E:"addevadetoken",ct:"removecloaktoken",
CT:"addcloaktoken",i:"removeiontoken",I:"addiontoken",tb:"removetractorbeamtoken",TB:"addtractorbeamtoken",ST:"addstress",DPY:"deploy",st:"removestresstoken",d:"dies"};if("string"==typeof h[e[1]])b=Unit.prototype[h[e[1]]],"function"==typeof b.vanilla?b.vanilla.call(f,l):b.call(f),actionrlock.notify();else switch(e[1]){case "W":break;case "P":r=parseInt(e[2],10);phase=parseInt(e[3],10);if(round!=r)for(b in $("#turnselector").append("<option value='"+round+"'>"+UI_translation["turn #"]+round+"</option>"),
round=r,squadron)f=squadron[b],f.focus=Unit.prototype.resetfocus.call(f),f.evade=Unit.prototype.resetevade.call(f),f.tractorbeam=Unit.prototype.resettractorbeam.call(f),f.showinfo();phase==SETUP_PHASE+1&&1==r&&endsetupphase();$("#phase").html(UI_translation["turn #"]+round+" "+UI_translation["phase"+phase]);actionrlock.notify();break;case "L":FAST?actionrlock.notify():(b=decodeURIComponent(e[2].substring(2,e[2].length-2)),f.setinfo(b).delay(1500).fadeOut(400),setTimeout(function(){actionrlock.notify()},
2E3));break;case "t":for(g in squadron)if(squadron[g].id==parseInt(e[2],10))break;if(squadron[g].id!=parseInt(e[2],10)){console.log("cannot find target "+e[2]);actionrlock.notify();break}var l=squadron[g];"function"==typeof Unit.prototype.removetarget.vanilla?Unit.prototype.removetarget.vanilla.call(f,l):Unit.prototype.removetarget.call(f,l);actionrlock.notify();break;case "T":for(g in squadron)if(squadron[g].id==parseInt(e[2],10))break;if(squadron[g].id!=parseInt(e[2],10)){console.log("cannot find target "+
e[2]);actionrlock.notify();break}l=squadron[g];"function"==typeof Unit.prototype.addtarget.vanilla?Unit.prototype.addtarget.vanilla.call(f,l):Unit.prototype.addtarget.call(f,l);actionrlock.notify();break;case "R":f.setarcrotate(parseInt(e[2],10));actionrlock.notify();break;case "s":Unit.prototype.removeshield.call(f,parseInt(e[2],10));f.show();actionrlock.notify();break;case "S":Unit.prototype.addshield.call(f,parseInt(e[2],10));f.show();actionrlock.notify();break;case "h":Unit.prototype.removehull.call(f,
parseInt(e[2],10));f.show();actionrlock.notify();break;case "H":Unit.prototype.addhull.call(f,parseInt(e[2],10));f.show();actionrlock.notify();break;case "f":f.select();for(g in squadron)if(squadron[g].id==parseInt(e[2],10))break;squadron[g].id!=parseInt(e[2],10)?(console.log("cannot find target unit "+e[2]),actionrlock.notify()):(targetunit=squadron[g],f.activeweapon=parseInt(e[3],10),FAST||f.playfiresnd(),setTimeout(function(){actionrlock.notify()},FAST?0:1E3));break;case "am":f.select();f.m=(new Snap.Matrix).translate(e[2]-
300,e[3]-300).rotate(e[4],0,0);f.g.transform(f.m);f.geffect.transform(f.m);actionrlock.notify();break;case "c":(new Critical(f,parseInt(e[2],10))).faceup();actionrlock.notify();break;case "D":f.upgrades[parseInt(e[2],10)].desactivate();actionrlock.notify();break;case "m":f.select();var l=e[2],m=parseInt(e[4],10),q=f.m,v=P[l].path;if(FAST){f.m=f.getmatrixwithmove(q,v,m);f.m.rotate(parseFloat(e[3],0,0),0,0);f.g.transform(f.m);f.geffect.transform(f.m);actionrlock.notify();break}SOUNDS[f.ship.flysnd].play();
Snap.animate(0,m,function(b){b=this.getmatrixwithmove(q,v,b);this.g.transform(b);this.geffect.transform(b)}.bind(f),TIMEANIM*m/200,mina.linear,function(){this.m=this.getmatrixwithmove(q,v,m);this.m.rotate(parseFloat(e[3]),0,0);this.g.transform(this.m);this.geffect.transform(this.m);actionrlock.notify()}.bind(f));break;default:console.log("unknown cmd:"+e[1]),FAST=!1,filltabskill(),setphase(phase==SETUP_PHASE)}}};var phase=1,subphase=0,round=1,skillturn=0,tabskill,VERSION="v0.10.4",LANG="en",ENGAGED=!1,FILTER="none",DECLOAK_PHASE=1,DICES="focusred hitred criticalred blankred focusgreen evadegreen blankgreen".split(" "),SETUP_PHASE=2,PLANNING_PHASE=3,ACTIVATION_PHASE=4,COMBAT_PHASE=5,SELECT_PHASE=1,CREATION_PHASE=6,XP_PHASE=7,BOMBS=[],ROCKDATA="",WINCOND=0,INREPLAY=!1,allunits=[],PILOT_translation,SHIP_translation,CRIT_translation,UI_translation,UPGRADE_translation,PILOT_dict,UPGRADE_dict,actionr=[],actionrlock,
HISTORY=[],replayid=0,dice=1,ATTACK=[],DEFENSE=[],SEARCHINGSQUAD,FACTIONS={rebel:"REBEL",empire:"EMPIRE",scum:"SCUM"},SQUADLIST,SQUADBATTLE,COMBATLIST,TEAMS=[new Team(0),new Team(1),new Team(2)],currentteam=TEAMS[0],teamtarget=0,VIEWPORT,ANIM="",SETUP,SHOWDIAL=[],TRACE=!1,TEMPLATES={bomb:"",upgrade:"",weapon:"",social:""},UNIQUE=[],stype="",REPLAY="",PERMALINK="",SETUPS={playzone:"M 0 0 L 900 0 900 900 0 900 Z",zone1:"M 0 0 L 100 0 100 900 0 900 Z",zone2:"M 800 0 L 900 0 900 900 800 900 Z",asteroids:6,
"Classic Map":{name:"Classic",background:"css/playmat10.jpg"},"Cloud City Map":{name:"Cloud City",background:"css/playmat6.jpg"},"Blue Sky Map":{name:"Blue Sky",background:"css/playmat13.jpg"},"Blue Planet Map":{name:"Blue Planet",background:"css/playmat11.jpg"},"Mars Map":{name:"Mars",background:"css/playmat14.jpg"}};function sleep(b){for(var e=(new Date).getTime(),f=0;1E7>f&&!((new Date).getTime()-e>b);f++);}
function changeimage(b){if(b.files&&b.files[0]){var e=new FileReader;e.onload=function(b){var e=ZONE[0].getBBox();b=s.image(b.target.result,0,0,e.w,e.h).pattern(0,0,e.w,e.h);ZONE[0].attr({fill:b,fillOpacity:1})};e.readAsDataURL(b.files[0])}}
function center(){var b=activeunit.g.getBBox(),e=b.x+b.width/2,f=b.y+b.height/2,b=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>b?l=(g-b)/2:h=(b-g)/2;var m=Math.min(b/900,g/900),q=h+VIEWPORT.m.x(e,f)*m,e=l+VIEWPORT.m.y(e,f)*m;VIEWPORT.m.invert();if(0>q||q>b)VIEWPORT.m=MT((-q+b/2-h)/m,0).add(VIEWPORT.m);if(0>e||e>g)VIEWPORT.m=MT(0,(-e+g/2-l)/m).add(VIEWPORT.m);VIEWPORT.transform(VIEWPORT.m);activeunit.show()}
var AIstats=function(b,e,f){if("undefined"!=typeof f.rows)for(b=1;b<f.rows.length;b+=200){for(var g=e=0,h=1;200>h&&h+b<f.rows.length;h++){var l=f.rows[b+h].cellsArray[0].split(" "),m=l[0].split(":"),q=m[0],m=m[1],v=l[1].split(":"),l=v[0],v=v[1],w=0,x=0;l!=q&&("Human"==l?x+=parseInt(v,10):w+=parseInt(v,10),"Human"==q?x+=parseInt(m,10):w+=parseInt(m,10),g+=Math.floor(w/(w+x)*100),e++)}console.log(g/e)}},mk2split=function(b){b=b.split(".");for(var e=[],f=!1,g=1;g<b.length;g++)b[g].match(/_II.*/)?(e.push(b[g-
1]+"."+b[g]),b[g]=null,f=!1):(b[g-1]&&e.push(b[g-1]),f=!0);f&&e.push(b[b.length-1]);return e},save=function(){movelog("W");var b="http://ynot6517.github.io/bench/?"+permalink(!1);$(".social").html(Mustache.render(TEMPLATES.social,{url:b,name:"save this link",encodedurl:encodeURI(b)}));"undefined"!=typeof gapi&&"undefined"!=typeof gapi.client.urlshortener?gapi.client.urlshortener.url.insert({longUrl:b}).then(function(b){b=b.result.id;$(".tweet").show();$("#submission").contents().find("#entry_245821581").val(b);
$("#submission").contents().find("#ss-form").submit();$(".social").html(Mustache.render(TEMPLATES.social,{url:b,name:b,encodedurl:encodeURI(b)}))},function(b){$("#submission").contents().find("#ss-form").submit();console.log("Error: "+b.result.error.message)}):$("#submission").contents().find("#ss-form").submit()},myCallback=function(b,e,f){if(null!=f&&"undefined"!=typeof f.rows){ga("send","event",{eventCategory:"interaction",eventAction:"battlelog",eventLabel:"battlelog",eventValue:f.rows.length});
e=b="";for(var g=mk2split(SEARCHINGSQUAD),h=0;h<g.length;h++)b+=g[h].replace(/\*/g," + ").replace(/_/g," ")+"<br>",e+=g[h].replace(/\*/g," + ").replace(/_/g," ")+"\n";stype="";TEAMS[1].parseJuggler(e,!1);for(h=1;h<f.rows.length;h++)myTemplate(h,f.rows[h].cellsArray,null,null);SQUADBATTLE.columns.adjust().draw()}},myTemplate=function(b,e,f,g){g=e[0].split(" ");f=g[0].split(":");b=f[0];f=f[1];var h=g[1].split(":");g=h[0];var h=h[1],l=e[1].split("VS"),m=mk2split(l[0]),q=mk2split(l[1]),v="",w="";if(l[0]==
SEARCHINGSQUAD){var l=h,x=g,m=q,h=f;g=b;f=l;b=x}for(q=0;q<m.length-1;q++)w+=m[q].replace(/\*/g," + ").replace(/_/g," ")+"\n",v+=m[q].replace(/\*/g," + ").replace(/_/g," ")+"<br>";TEAMS[2].parseJuggler(w,!1);"en"!=LANG&&(v=TEAMS[2].toJuggler(!0).replace(/\n/g,"<br>"));f=""+f;h=""+h;for(m=0;3>m;m++)3>f.length&&(f="0"+f),3>h.length&&(h="0"+h);"Human"==g&&(h="<b>"+h+"</b>");"Human"==b&&(f="<b>"+f+"</b>");SQUADBATTLE.row.add([h+"-"+f,'<span onclick=\'$(".replay").attr("src","'+e[2]+"\")'>"+v+"</span>"]).draw(!1)},
computeurl=function(b,e,f){b=[];if("undefined"!=typeof f.rows)for(var g=1;g<f.rows.length;g++){var h=f.rows[g].cellsArray[0].split("VS");e=mk2split(h[0]);for(var h=mk2split(h[1]),l="",m="",q=0;q<e.length-1;q++)l+=e[q].replace(/\*/g," + ").replace(/_/g," ")+"\n";try{TEAMS[1].parseJuggler(l,!1);for(q=0;q<h.length-1;q++)m+=h[q].replace(/\*/g," + ").replace(/_/g," ")+"\n";TEAMS[2].parseJuggler(m,!1)}catch(v){}for(q in generics)"undefined"==typeof b[generics[q].pilotid]&&(b[generics[q].pilotid]=0),b[generics[q].pilotid]++}for(g in b)console.log(PILOTS[g].name+
":"+b[g])};
function translate(b){return"undefined"!=typeof PILOT_translation[b]&&"undefined"!=typeof PILOT_translation[b].name?PILOT_translation[b].name:"undefined"!=typeof PILOT_translation[b+" (Scum)"]&&"undefined"!=typeof PILOT_translation[b+" (Scum)"].name?PILOT_translation[b+" (Scum)"].name:"undefined"!=typeof UPGRADE_translation[b]&&"undefined"!=typeof UPGRADE_translation[b].name?UPGRADE_translation[b].name:"undefined"!=typeof UPGRADE_translation[b+"(Crew)"]&&"undefined"!=typeof UPGRADE_translation[b+"(Crew)"].name?
UPGRADE_translation[b+"(Crew)"].name:"undefined"!=typeof CRIT_translation[b]&&"undefined"!=typeof CRIT_translation[b].name?CRIT_translation[b].name:b}
function formatstring(b){return b.replace(/%HIT%/g,"<code class='hit'></code>").replace(/%ACTION%/g,"<b>Action:</b>").replace(/%STRESS%/g,"<code class='xstresstoken'></code>").replace(/%CRIT%/g,"<code class='critical'></code>").replace(/%EVADE%/g,"<code class='symbols'>e</code>").replace(/%FOCUS%/g,"<code class='symbols'>f</code>").replace(/%SHIELD%/g,"<code class='cshield'></code>").replace(/%HULL%/g,"<code class='chull'></code>").replace(/%ROLL%/g,"<code class='symbols'>r</code>").replace(/%TURNLEFT%/g,
"<code class='symbols'>4</code>").replace(/%TURNRIGHT%/g,"<code class='symbols'>6</code>").replace(/%BOOST%/g,"<code class='symbols'>b</code>").replace(/%ELITE%/g,"<code class='symbols'>E</code>").replace(/%ION%/g,"<code class='xionizedtoken'></code>").replace(/%BOMB%/g,"<code class='symbols'>B</code>").replace(/%STRAIGHT%/g,"<code class='symbols'>8</code>").replace(/%STOP%/g,"<code class='symbols'>5</code>").replace(/%TARGET%/g,"<code class='symbols'>l</code>").replace(/%TORPEDO%/g,"<code class='symbols'>P</code>").replace(/%CANNON%/g,
"<code class='symbols'>C</code>").replace(/%SYSTEM%/g,"<code class='symbols'>S</code>").replace(/%ILLICIT%/g,"<code class='symbols'>I</code>").replace(/%MISSILE%/g,"<code class='symbols'>M</code>").replace(/%TURRET%/g,"<code class='symbols'>U</code>").replace(/%BANKLEFT%/g,"<code class='symbols'>7</code>").replace(/%BANKRIGHT%/g,"<code class='symbols'>9</code>").replace(/%UTURN%/g,"<code class='symbols'>2</code>").replace(/%SLOOPLEFT%/g,"<code class='symbols'>1</code>").replace(/%SLOOPRIGHT%/g,"<code class='symbols'>3</code>").replace(/%TALONLEFT%/g,
"<code class='symbols'>;</code>").replace(/%TALONRIGHT%/g,"<code class='symbols'>:</code>").replace(/%ASTROMECH%/g,"<code class='symbols'>A</code>").replace(/%CREW%/g,"<code class='symbols'>W</code>").replace(/%SLAM%/g,"<code class='symbols'>s</code>")}
function displayplayertype(b,e){var f=localStorage.image,g=localStorage.imageplayer,h=localStorage.name,l=localStorage.playername;"undefined"!=typeof l&&(h=l);"undefined"!=typeof e&&(f=e);"undefined"!=typeof g&&(f=g);"undefined"==typeof f&&(f="css/human.png");TEAMS[b].isia?($("#player"+b+" option[value='computer']").prop("selected",!0),$("#player"+b+"img").attr("src","css/computer.png")):($("#player"+b+" option[value='human']").prop("selected",!0),$("#player"+b+"img").attr("src",f),$("#player"+b+
" option[value='human']").text(h))}
function nextunit(b,e,f,g){var h,l=!1,m=0;if(0>skillturn||12<skillturn)return f();for(h=0;h<tabskill[skillturn].length;h++){var q=tabskill[skillturn][h];if(b(q)&&1!=q.isdocked){l=!0;m=h;break}}if(!l){do if(e(tabskill),m=0,0<=skillturn&&12>=skillturn){for(;m<tabskill[skillturn].length&&(1==tabskill[skillturn][m].isdocked||!b(tabskill[skillturn][m]));)m++;m==tabskill[skillturn].length&&(m=-1)}while(0<=skillturn&&12>=skillturn&&-1==m)}if(0>skillturn||12<skillturn||-1==m)return f();barrier(function(){active=
m;tabskill[skillturn][m].select();g()})}function endphase(){for(var b in squadron)squadron[b].endphase()}
function nextcombat(){nextunit(function(b){return b.canfire()},function(b){0<=skillturn&&skillturn--;for(var e=0;e<b[skillturn+1].length;e++){var f=b[skillturn+1][e];f.canbedestroyed(skillturn)&&f.checkdead()}TEAMS[1].checkdead()&&TEAMS[2].checkdead()&&win(0);TEAMS[1].checkdead()&&win(1);TEAMS[2].checkdead()&&win(2)},function(){$("#attackdial").hide();for(var b in squadron)squadron[b].endcombatphase();log(UI_translation["No more firing units, ready to end phase."]);barrier(endphase);return enablenextphase()},
function(){activeunit.beginattack();activeunit.doattack()})}function nextactivation(){nextunit(function(b){return b.candomaneuver()},function(){13>skillturn&&skillturn++},function(){return enablenextphase()},function(){activeunit.beginactivation();activeunit.doactivation()})}function nextdecloak(){nextunit(function(b){return b.candecloak()},function(){13>skillturn&&skillturn++},function(){return enablenextphase()},function(){activeunit.dodecloak()})}
function nextplanning(){nextunit(function(b){return-1==b.maneuver},function(){13>skillturn&&skillturn++},function(){return enablenextphase()},function(){activeunit.select();activeunit.doplan()})}function getattackresult(){var b=$(".hitreddice").length,e=$(".criticalreddice").length;return FCH_CRIT*e+FCH_HIT*b}function getdefenseresult(){return $(".evadegreendice").length+$(".evadegreen").length}function addattackdie(b,e){for(var f=0;f<e;f++)$("#attack").append("<td class="+b+"reddice'></td>")}
function adddefensedie(b,e){for(var f=0;f<e;f++)$("#defense").append("<td class="+b+"greendice'></td>")}function getattackdice(){return $(".focusreddice").length+$(".criticalreddice").length+$(".hitreddice").length+$(".blankreddice").length}function getattackvalue(){return $(".focusreddice").length*FCH_FOCUS+$(".criticalreddice").length*FCH_CRIT+$(".hitreddice").length*FCH_HIT}function getdefensedice(){return $(".focusgreendice").length+$(".blankgreendice").length+$(".evadegreendice").length}
function displaycombatdial(){$("#attackdial").empty();$("#dtokens").empty();$("#defense").empty();$("#combatdial").show()}
function addredclickchange(){var b=function(){$(this).hasClass("focusreddice")?($(this).removeClass("focusreddice"),$(this).addClass("hitreddice")):$(this).hasClass("blankreddice")?($(this).removeClass("blankreddice"),$(this).addClass("focusreddice")):$(this).hasClass("hitreddice")?($(this).removeClass("hitreddice"),$(this).addClass("criticalreddice")):$(this).hasClass("criticalreddice")&&($(this).removeClass("criticalreddice"),$(this).addClass("blankreddice"))};$(".focusreddice").click(b);$(".hitreddice").click(b);
$(".blankreddice").click(b);$(".criticalreddice").click(b)}
function displayattackroll(b,e){var f,g=0;for(f=0;f<DICES.length;f++)$("."+DICES[f]+"dice").remove();$("#attack").empty();for(f=0;f<Math.floor(b/100)%10;f++,g++)$("#attack").append("<td class='focusreddice'></td>");for(f=0;f<Math.floor(b/10)%10;f++,g++)$("#attack").append("<td class='criticalreddice'></td>");for(f=0;f<b%10;f++,g++)$("#attack").append("<td class='hitreddice'></td>");for(f=g;f<e;f++)$("#attack").append("<td class='blankreddice'></td>");addredclickchange()}
function displayattacktokens(b,e){$("#atokens").empty();var f=targetunit.getresultmodifiers(b.ar,b.ad,DEFENSE_M,ATTACK_M);0<f.length?($("#atokens").append(f),$("#atokens").append($("<button>").addClass("m-done").click(function(){displayattacktokens2(b,e)}))):displayattacktokens2(b,e)}
function displayattacktokens2(b,e){"function"!=typeof e?e=b.lastaf:b.lastaf=e;$("#atokens").empty();var f=b.getresultmodifiers(b.ar,b.ad,ATTACK_M,ATTACK_M);0<f.length?($("#atokens").append(f),$("#atokens").append($("<button>").addClass("m-done").click(function(){$("#atokens").empty();e()}.bind(b)))):e()}
function displaydefensetokens(b,e){$("#dtokens").empty();var f=activeunit.getresultmodifiers(b.dr,b.dd,ATTACK_M,DEFENSE_M);0<f.length?($("#dtokens").append(f),$("#dtokens").append($("<button>").addClass("m-done").click(function(){displaydefensetokens2(b,e)}))):displaydefensetokens2(b,e)}
function displaydefensetokens2(b,e){"function"!=typeof e&&(e=b.lastdf);b.lastdf=e;$("#dtokens").empty();var f=b.getresultmodifiers(b.dr,b.dd,DEFENSE_M,DEFENSE_M);FAST?displaycompareresults(b,e):($("#dtokens").append(f),$("#dtokens").append($("<button>").addClass("m-fire").click(function(){displaycompareresults(activeunit,e)}.bind(b))))}
function displaycompareresults(b,e){"function"!=typeof e&&(e=b.lastdf);b.lastdf=e;$("#dtokens").empty();dm=b.getresultmodifiers(targetunit.dr,targetunit.dd,ATTACKCOMPARE_M,DEFENSE_M);am=b.getresultmodifiers(b.ar,b.ad,ATTACKCOMPARE_M,ATTACK_M);FAST||0==dm.length&&0==am.length?($("#combatdial").hide(),e()):($("#dtokens").append(dm).append(am),$("#dtokens").append($("<button>").addClass("m-fire").click(function(){$("#combatdial").hide();e()}.bind(b))))}
function FE_focus(b){return Math.floor(b/10)%10}function FE_evade(b){return b%10}function FE_blank(b,e){return e-FE_evade(b)-FE_focus(b)}function FCH_hit(b){return b%10}function FCH_focus(b){return Math.floor(b/100)%10}function FCH_crit(b){return Math.floor(b/10)%10}function FCH_blank(b,e){return e-FCH_crit(b)-FCH_focus(b)-FCH_hit(b)}var FE_EVADE=1,FE_FOCUS=10,FCH_HIT=1,FCH_FOCUS=100,FCH_CRIT=10,UNITFILTER={},ACTIONFILTER={},MOVEFILTER={},TEXTFILTER="";
function unitfilter(b){"undefined"!=typeof UNITFILTER[b]?delete UNITFILTER[b]:UNITFILTER[b]=!0;displayfactionunits(!0)}function actionfilter(b){"undefined"!=typeof ACTIONFILTER[b]?delete ACTIONFILTER[b]:ACTIONFILTER[b]=!0;displayfactionunits(!0)}function textfilter(b){TEXTFILTER=b;log(TEXTFILTER);displayfactionunits(!0)}
function addroll(b,e,f){if(f==DEFENSE_M)return addrolld(b,e);f=getattackdice();var g=$(".focusreddice").length,h=$(".hitreddice").length,l=$(".criticalreddice").length;b=b(100*g+10*l+h,f);displayattackroll(b.m,b.n);$("#atokens #mod"+e).remove()}function addrolld(b,e){var f=getdefensedice(),g=$(".focusgreendice").length,h=$(".evadegreendice").length,f=b(10*g+h,f);displaydefenseroll(f.m,f.n);$("#dtokens #mod"+e).remove()}
function modroll(b,e,f){if(f==DEFENSE_M)return modrolld(b,e);f=getattackdice();var g=$(".focusreddice").length,h=$(".hitreddice").length,l=$(".criticalreddice").length;b=b(100*g+10*l+h,f);displayattackroll(b,f);$("#atokens #mod"+e).remove()}function modrolld(b,e){var f=getdefensedice(),g=$(".focusgreendice").length,h=$(".evadegreendice").length,g=b(10*g+h,f);displaydefenseroll(g,f);$("#dtokens #mod"+e).remove()}
function addgreenclickchange(){var b=function(){$(this).hasClass("focusgreendice")?($(this).removeClass("focusgreendice"),$(this).addClass("evadegreendice")):$(this).hasClass("blankgreendice")?($(this).removeClass("blankgreendice"),$(this).addClass("focusgreendice")):$(this).hasClass("evadegreendice")&&($(this).removeClass("evadegreendice"),$(this).addClass("blankgreendice"))};$(".focusgreendice").click(b);$(".evadegreendice").click(b);$(".blankgreendice").click(b)}
function displaydefenseroll(b,e){var f,g=0;$("#defense").empty();for(f=0;f<Math.floor(b/10);f++,g++)$("#defense").append("<td class='focusgreendice'></td>");for(f=0;f<b%10;f++,g++)$("#defense").append("<td class='evadegreendice'></td>");for(f=g;f<e;f++)$("#defense").append("<td class='blankgreendice'></td>");addgreenclickchange()}
function reroll(b,e,f,g,h){var l,m,q=0,v=["blank","focus","hit","critical"],w=["blank","focus","evade"];"function"==typeof g.f&&g.f();var x="";if(f==ATTACK_M){for(l=0;4>l;l++)if((!activeunit.hasnorerollmodifiers(e,f,getattackvalue(),getattackdice(),"focus")||"undefined"!=typeof g.mustreroll||"focus"!=v[l])&&-1<g.dice.indexOf(v[l]))if(m=$("."+v[l]+"reddice:not([noreroll])"),m.length<b)m.remove(),x+=("<span class='"+v[l]+"reddice'></span>").repeat(m.length),q+=m.length,b-=m.length;else{$("."+v[l]+"reddice:lt("+
b+"):not([noreroll])").remove();x+=("<span class='"+v[l]+"reddice'></span>").repeat(b);q+=b;b=0;break}x+=" -> ";$("#atokens #reroll"+h).remove();b=activeunit.rollattackdie(q);for(l=0;l<q;l++)x+="<span class='"+b[l]+"reddice'></span>",$("#attack").append("<td class='"+b[l]+"reddice' noreroll></td>");activeunit.log("reroll: "+x);addredclickchange()}else{for(l=0;3>l;l++)if(("undefined"!=typeof g.mustreroll||!targetunit.hasnorerollmodifiers(e,f,getattackvalue(),getattackdice(),"focus")||"focus"!=v[l])&&
-1<g.dice.indexOf(w[l]))if(m=$("."+w[l]+"greendice:not([noreroll])"),m.length<b)m.remove(),q+=m.length,b-=m.length;else{$("."+v[l]+"greendice:lt("+b+"):not([noreroll])").remove();q+=b;b=0;break}$("#dtokens #reroll"+h).remove();activeunit.defenseroll(q).done(function(b){var e;for(e=0;e<FE_evade(b.roll);e++)$("#defense").append("<td class='evadegreendice'></td>");for(e=0;e<FE_focus(b.roll);e++)$("#defense").append("<td class='focusgreendice'></td>");for(e=0;e<FE_blank(b.roll,b.dice);e++)$("#defense").append("<td class='blankgreendice'></td>");
addgreenclickchange()})}}function next_replay(){var b=[];0<REPLAY.length&&(b=REPLAY[replayid].split("_"));return b}
function enablenextphase(){var b,e=!0;switch(phase){case SELECT_PHASE:b=$("#squad1").attr("data-name");var f=$("#squad2").attr("data-name");if("undefined"==typeof b||"undefined"==typeof f)e=!1,$(".nextphase").prop("disabled",!0);break;case PLANNING_PHASE:for(b in squadron)if(0>squadron[b].maneuver&&!squadron[b].isdocked){e=!1;break}e&&$(".nextphase").prop("disabled")&&log(UI_translation["All units have planned a maneuver, ready to end phase"]);break;case ACTIVATION_PHASE:if(subphase!=ACTIVATION_PHASE){subphase=
ACTIVATION_PHASE;skillturn=0;e=!1;for(b in squadron)squadron[b].enddecloak().done(nextactivation);barrier(nextactivation)}else{for(b in squadron)if(-1<squadron[b].maneuver&&!squadron[b].isdocked){e=!1;break}e&&$(".nextphase").prop("disabled")&&log(UI_translation["All units have been activated, ready to end phase"])}}e&&$(".nextphase").prop("disabled",!1);return e&&FAST&&phase>=SETUP_PHASE?nextphase():e}
function win(b){log("Team "+b+" was destroyed!");movelog("W");var e="m-draw",f,g="",h="",l=0,m=0,q=!1,v=!1;for(f=0;f<allunits.length;f++){var w=allunits[f];w.dead||1!=w.team||(q=!0);w.dead||2!=w.team||(v=!0);if(w.dead||w.islarge&&w.shield+w.hull<(w.ship.hull+w.ship.shield)/2){var x=parseInt(w.dead?w.points:w.points/2);1==w.team?(h+="<tr><td>"+w.name+(w.dead?"":" (1/2 points)")+"</td><td>"+x+"</td></tr>",m+=x):(g+="<tr><td>"+w.name+(w.dead?"":" (1/2 points)")+"</td><td>"+x+"</td></tr>",l+=x)}}0==q&&
(m=100);0==v&&(l=100);""==g&&(g="<tr><td class='m-nocasualty'></td><td>0</td></tr>");""==h&&(h="<tr><td class='m-nocasualty'></td><td>0</td></tr>");f=l-m;l=f+100;m=100-f;$(".victory-table").empty();$(".victory-table").append("<tr><th class='m-squad1'></th><th>"+l+"</th></tr>");$(".victory-table").append(g);$(".victory-table").append("<tr><th class='m-squad2'></th><th>"+m+"</th></tr>");$(".victory-table").append(h);if(0<f&&0>WINCOND||2==b&&(WINCOND<round||0==WINCOND))e="m-1win",log("Team 1 wins! "+
l+" to "+m);else if(0>f&&0>WINCOND||1==b&&(WINCOND<round||0==WINCOND))e="m-2win",log("Team 2 wins! "+m+" to "+l);$(".victory").attr("class",e);b=TEAMS[1].toJuggler(!1);b+="VS"+TEAMS[2].toJuggler(!1);b=b.replace(/\n/g,".");b=b.replace(/ \+ /g,"*");b.replace(/ /g,"_");window.location="#modal"}document.addEventListener("win",win,!1);function battlelog(b){b=SQUADLIST.row(b.parents("tr")).data()[3];TEAMS[0].parseJuggler(b,!1);b=TEAMS[0].toJuggler(!1);displaycombats(b);window.location="#battlelog"}
function createsquad(){$(".activeunit").prop("disabled",!0);$("#selectphase").hide();$("#addcomment").hide();ga("send","event",{eventCategory:"interaction",eventAction:"create",eventLabel:"create"});phase=CREATION_PHASE;$("footer").hide();$("#consolecb").removeAttr("Checked");$(".nextphase").prop("disabled",!1);currentteam.changefaction("REBEL");$(".factionselect selected").val("REBEL");$("#creation").show();var b={getdial:function(){return[{move:"TL1",difficulty:"WHITE"},{move:"BL1",difficulty:"WHITE"},
{move:"F1",difficulty:"WHITE"},{move:"SL2",difficulty:"WHITE"},{move:"TL2",difficulty:"WHITE"},{move:"BL2",difficulty:"WHITE"},{move:"F2",difficulty:"WHITE"},{move:"K2",difficulty:"WHITE"},{move:"SL3",difficulty:"WHITE"},{move:"TL3",difficulty:"WHITE"},{move:"BL3",difficulty:"WHITE"},{move:"F3",difficulty:"WHITE"},{move:"K3",difficulty:"WHITE"},{move:"F4",difficulty:"WHITE"},{move:"K4",difficulty:"WHITE"},{move:"F5",difficulty:"WHITE"},{move:"K5",difficulty:"WHITE"}]}};$("#dialfilter").html(Unit.prototype.getdialstring.call(b));
$("#dialfilter td[move]").click(function(){var b=$(this).attr("move");"undefined"!=typeof MOVEFILTER[b]?(delete MOVEFILTER[b],$(this).removeClass("selected")):(MOVEFILTER[b]=!0,$(this).addClass("selected"));displayfactionunits(!0)});for(var e in generics)if(b=generics[e],b.team==targetteam){currentteam.faction=b.faction;break}displayfactionunits();for(e in generics)if(b=generics[e],b.team==targetteam){currentteam.faction=b.faction;addunit(b.pilotid,b);for(var f=0;f<b.upgradetype.length;f++){var g=
b.upg[f];-1<g&&addupgrade(b,g,f)}}}function switchdialimg(b){1==b?($("#caroussel .shipimg").css("display","none"),$("#caroussel .shipdial").css("display","table-cell")):($("#caroussel .shipdial").css("display","none"),$("#caroussel .shipimg").css("display","table-cell"))}var mySpreadsheets=["https://docs.google.com/spreadsheets/d/1KR1uc7QgbiDkxCU5J1rm9qBMMjwKC0WyfAuDhnrbgAA/edit#gid=0"];
function displayAIperformance(){for(var b=0;b<mySpreadsheets.length;b++)$("#squadbattlediv").sheetrock({url:mySpreadsheets[b],query:"select B",callback:AIstats,rowTemplate:function(){return""},labels:["Score"]})}function selectrocks(){var b=[1,2,3,4,5,6];$(".aster img").click(function(e){e=parseInt(e.target.id.substr(1),10);if(-1<b.indexOf(e))b[e]=null;else{var f;for(f=0;6>f&&null!=b[f];f++);6>f&&(b[f]=e,$("#a"+e).addClass("selected"))}}.bind(this))}
function recomputeurl(){$("#squadbattlediv").sheetrock({url:mySpreadsheets[0],query:"select C",callback:computeurl,rowTemplate:function(){return""},labels:["ascii","short","long"]})}
function displaycombats(b){var e=b;b=b.replace(/\n/g,".");b=b.replace(/ \+ /g,"*");b=b.replace(/ /g,"_");$(".replay").attr("src","");"."!=b.slice(-1)&&(b+=".");SEARCHINGSQUAD=b;var f="";"en"!=LANG&&(TEAMS[0].parseJuggler(e,!1),e=TEAMS[0].toJuggler(!0));f=e.replace(/\n/g,"<br>");$("#battlingsquad").html(f);SQUADBATTLE.clear().draw();for(e=0;e<mySpreadsheets.length;e++)$("#squadbattlediv").sheetrock({url:mySpreadsheets[e],query:"select B,C,E where C contains '"+b+"'",callback:myCallback,fetchSize:100,
rowTemplate:function(){return""},labels:["Score","Squadlist","URL"]})}function dial2JSON(b){var e=[],f,g;for(f=0;5>=f;f++)e[f]={item:"",moves:null};for(f=0;f<b.length;f++){d=b[f];var h=MPOS[d.move][0],l=MPOS[d.move][1];e[5-h].item=h;if(null==e[5-h].moves)for(e[5-h].moves=[],g=0;6>=g;g++)e[5-h].moves[g]={difficulty:"",key:""};e[5-h].moves[l]={difficulty:d.difficulty,key:P[d.move].key}}return e}
function displayfactionunits(b){var e=0,f=0,g,h,l,m=currentteam.faction,q={},v=[];if(phase==CREATION_PHASE){"REBEL"==m?$("#dialfilter td[move='SL3']").text(P.TRL3.key).attr("move","TRL3"):$("#dialfilter td[move='TRL3']").text(P.SL3.key).attr("move","SL3");for(g in unitlist)-1<unitlist[g].faction.indexOf(m)&&e++;1==b?$("#caroussel").html(""):$(".caroussel").html("");for(g=0;g<PILOTS.length;g++){var w=PILOTS[g].unit;PILOTS[g].faction==m&&("undefined"==typeof q[w]&&(q[w]=[]),-1<PILOTS[g].upgrades.indexOf(ELITE)&&
(PILOTS[g].haselite=!0),b=getpilottexttranslation(PILOTS[g],m),""!=b&&(b+=1==PILOTS[g].done?"":"<div><strong class='m-notimplemented'></strong></div>"),PILOTS[g].tooltip=b,PILOTS[g].trname=translate(PILOTS[g].name),q[w].push(PILOTS[g]))}for(w in q)q[w].sort(function(b,e){return b.points-e.points});for(g in unitlist)-1<unitlist[g].faction.indexOf(m)&&(unitlist[g].trname=SHIP_translation[g],unitlist[g].name=g,"undefined"==typeof unitlist[g].trname&&(unitlist[g].trname=g),v.push(unitlist[g]));v.sort(function(b,
e){return b.trname>e.trname});for(g=0;g<v.length;g++){f++;w=v[g];b=q[w.name];var x=q[w.name][0].upgrades,e=!0;for(h in UNITFILTER)-1==x.indexOf(h)&&(e=!1);for(h in ACTIONFILTER)-1==w.actionList.indexOf(h)&&(e=!1);if(""!=TEXTFILTER){b=[];for(l in q[w.name]){var x=q[w.name][l],y=getpilottexttranslation(x,m),z=translate(x.name),B=new RegExp(TEXTFILTER,"i");(y.match(B)||z.match(B))&&b.push(x)}0==b.length&&(e=!1)}for(h in MOVEFILTER){x=!1;for(l=0;l<w.dial.length;l++)w.dial[l].move==h&&(x=!0);x||(e=!1)}e&&
(b=Mustache.render(TEMPLATES.faction,{shipimg:w.img[0],fire:repeat("u",w.fire),evade:repeat("u",w.evade),hull:repeat("u",w.hull),shield:repeat("u",w.shield),diallist:dial2JSON(w.dial),shipname:w.trname,actionlist:function(){var b=[];for(h=0;h<w.actionList.length;h++)b[h]=A[w.actionList[h]].key;return b},hastitle:w.hastitle,shipupgrades:q[w.name][0].upgrades,pilots:b}),$("#caroussel").append("<li>"+b+"</li>"))}}}
function selectweapon(b){$("#attackdial").html(Mustache.render(TEMPLATES.selectweapon,b)).show()}
function getpilottexttranslation(b,e){var f=b.name+("SCUM"==e?" (Scum)":"");if("undefined"!=typeof b.edition){var g=b.name+"("+b.edition+")";if("undefined"!=typeof PILOT_translation[g]&&"undefined"!=typeof PILOT_translation[g].text)return formatstring(PILOT_translation[g].text)}return"undefined"!=typeof PILOT_translation[f]&&"undefined"!=typeof PILOT_translation[f].text?formatstring(PILOT_translation[f].text):""}
function getupgtxttranslation(b,e){var f=b+(e==CREW?"(Crew)":"");return"undefined"!=typeof UPGRADE_translation[f]&&"undefined"!=typeof UPGRADE_translation[f].text?formatstring(UPGRADE_translation[f].text):""}function addunique(b){UNIQUE[b]=!0;for(var e=0;e<PILOTS.length;e++)b==PILOTS[e].name&&$(".pilots button[pilotid="+PILOTS[e].pilotid+"]").prop("disabled",!0);for(e=0;e<UPGRADES.length;e++)b==UPGRADES[e].name&&$(".upglist button[data="+e+"]").prop("disabled",!0)}
function removeunique(b){UNIQUE[b]=!1;for(var e=0;e<PILOTS.length;e++)b==PILOTS[e].name&&$(".pilots button[pilotid="+PILOTS[e].pilotid+"]").prop("disabled",!1);for(e=0;e<UPGRADES.length;e++)b==UPGRADES[e].name&&$(".upglist button[data="+e+"]").prop("disabled",!1)}function addlimited(b,e){$("#unit"+b.id+" .upglist button[data="+e+"]").prop("disabled",!0)}function removelimited(b,e){$("#unit"+b.id+" .upglist button[data="+e+"]").prop("disabled",!1)}
function addupgradeaddhandler(b){$("#unit"+b.id+" button.upgrades").click(function(b){var e=b.currentTarget.getAttribute("class").split(" ")[1];b=b.currentTarget.getAttribute("num");var g=this.getupgradelist(e);$("#unit"+this.id+" .upgs .upgavail").hide();$("#unit"+this.id+" .upgs .upg").hide();"undefined"==typeof this.upgbonus[e]&&(this.upgbonus[e]=0);for(var h=[],l=0;l<g.length;l++){var m=UPGRADES[g[l]],q,v=[];if(!m.invisible){q=1==UNIQUE[m.name]||(1==m.limited||1==this.exclupg[m.type])&&0<$("#unit"+
this.id+" .upg tr[data="+g[l]+"]").length;var w=m.points+this.upgbonus[e];0<m.points&&0>w&&(w=0);var x=formatstring(getupgtxttranslation(m.name,m.type));1!=m.done&&(x+="<div><strong class='m-notimplemented'></strong></div>");"undefined"!=typeof m.attack&&(v=[{attack:m.attack,lrange:m.range[0],hrange:m.range[1]}]);h.push({pts:w,tooltip:[x],text:x,isdisabled:q,num:b,data:g[l],name:translate(m.name).replace(/\(Crew\)/g,""),attacks:v})}}$("#unit"+this.id+" .upglist").html(Mustache.render(TEMPLATES["upglist-creation"],
{upglist:h}));$("#unit"+this.id+" .upglist button").click(function(b){var e=b.currentTarget.getAttribute("data");b=b.currentTarget.getAttribute("num");$("#unit"+this.id+" .upgs .upgavail").show();$("#unit"+this.id+" .upgs .upg").show();addupgrade(this,e,b)}.bind(this))}.bind(b))}
function addunit(b,e){"undefined"==typeof e&&(e=new Unit(currentteam.team,b));$("#listunits").append("<li id='unit"+e.id+"'></li>");e.show();$("li#unit"+e.id).hover(function(){$(".highlighted").removeClass("highlighted");$(this).addClass("highlighted")},function(){});1==e.unique&&addunique(e.name);$("#unit"+e.id+" .close").click(function(){var b=$(this).attr("data"),e=generics["u"+b];$("#unit"+b+" .upg tr[data]").each(function(){var b=$(this).attr("data");1==UPGRADES[b].unique&&removeunique(UPGRADES[b].name)});
1==PILOTS[e.pilotid].unique&&removeunique(e.name);$("#unit"+b).remove();delete generics["u"+b];currentteam.updatepoints()});$("#unit"+e.id+" .duplicate").click(function(){var b=$(this).attr("data"),e=generics["u"+b],h=addunit(e.pilotid);$("#unit"+b+" .upg tr[data]").each(function(){var b=$(this).attr("data"),f=$(this).attr("num");1!=UPGRADES[b].unique&&e.upgnocopy!=b&&addupgrade(h,b,f)})});currentteam.updatepoints();addupgradeaddhandler(e);return e}
function addupgrade(b,e,f,g){var h=UPGRADES[e];$("#unit"+b.id+" .upglist").empty();if("undefined"!=typeof h){1==h.unique&&addunique(h.name);1==h.limited&&addlimited(b,e);$("#unit"+b.id+" .upgavail span[num="+f+"]").css("display","none");var l=translate(h.name).replace(/\(Crew\)/g,"").replace(/\'/g,"");"undefined"==typeof b.upgbonus[h.type]&&(b.upgbonus[h.type]=0);var m=h.points+b.upgbonus[h.type];0<=h.points&&0>m&&(m=0);var q="",v=formatstring(getupgtxttranslation(h.name,h.type));""!=v&&(q="<div class='tooltip'>"+
v+(1==h.done?"":"<div><strong class='m-notimplemented'></strong></div></div>"));$("#unit"+b.id+" .upg").append("<tr data="+e+" num="+f+"><td><code class='upgrades "+h.type+"'></code></td><td>"+l+q+"</td><td class='pts'>"+m+"<button>-</button></td></tr>");b.upg[f]=e;Upgrade.prototype.install.call(h,b);"undefined"!=typeof h.install&&h.install(b);$("#unit"+b.id+" .shipdial").html("<table>"+b.getdialstring()+"</table>");b.showupgradeadd();b.showactionlist();b.showstats();currentteam.updatepoints();"undefined"==
typeof g?$("#unit"+b.id+" .upg tr[num="+f+"] button").click(function(e){var f=e.currentTarget.parentElement.parentElement.getAttribute("num");e=e.currentTarget.parentElement.parentElement.getAttribute("data");$("#unit"+b.id+" .upglist").empty();removeupgrade(b,f,e)}.bind(b)):b.upgnocopy=e}}
function removeupgrade(b,e,f){var g=UPGRADES[f];$("#unit"+b.id+" .upgavail span[num="+e+"]").css("display","block");$("#unit"+b.id+" .upg tr[num="+e+"]").remove();1==g.unique&&removeunique(g.name);1==g.limited&&removelimited(b,f);b.upg[e]=-1;"undefined"!=typeof g.uninstall&&g.uninstall(b);Upgrade.prototype.uninstall.call(g,b);$("#unit"+b.id+" .shipdial").html("<table>"+b.getdialstring()+"</table>");b.showupgradeadd();b.showactionlist();b.showstats();currentteam.updatepoints()}
function setselectedunit(b,e){currentteam=TEAMS[b];try{currentteam.parseJuggler(e,!0)}catch(f){currentteam.parseJuggler(e,!1)}currentteam.name=currentteam.toASCII();currentteam.toJSON();addrow(b,currentteam.name,currentteam.points,currentteam.faction,currentteam.toJuggler(!0))}
function addrow(b,e,f,g,h,l,m){1==b&&($("#squad1").val(h),$("#squad1points").html(f),$("#squad1").attr("data-name",e));2==b&&($("#squad2").val(h),$("#squad2points").html(f),$("#squad2").attr("data-name",e));1!=m&&enablenextphase();b=g.toUpperCase();"undefined"!=typeof localStorage[e]&&1!=l||SQUADLIST.row.add(["",b,""+f,h,e,"",""]).draw(!1)}
function endselection(){$("#creation").hide();$("#selectphase").show();currentteam.name="SQUAD."+currentteam.toASCII();currentteam.toJSON();var b=currentteam.toJuggler(!1);TEAMS[targetteam].parseJuggler(b,!1);"undefined"==typeof localStorage[currentteam.name]&&(localStorage[currentteam.name]=JSON.stringify({pts:currentteam.points,faction:currentteam.faction,jug:b,rocks:currentteam.rocks}));addrow(targetteam,currentteam.name,currentteam.points,currentteam.faction,currentteam.toJuggler(!0),!0)}
function removerow(b){b=SQUADLIST.row(b.parents("tr"));var e=b.data()[4];delete localStorage[e];b.remove().draw(!1)}function checkrow(b,e){var f=SQUADLIST.row(e.parents("tr")),g=f.data()[3],f=f.data()[4];f.match("SQUAD")&&TEAMS[b].setrocks($.parseJSON(localStorage[f]).rocks);setselectedunit(b,g)}
function importsquad(b){currentteam.parseJSON($("#squad"+b).val(),!0);currentteam.name="SQUAD."+currentteam.toASCII();var e=currentteam.toJuggler(!0);currentteam.toJSON();localStorage[currentteam.name]=JSON.stringify({pts:currentteam.points,faction:currentteam.faction,jug:currentteam.toJuggler(!1)});addrow(b,currentteam.name,currentteam.points,currentteam.faction,e)}
function findsquad(b){currentteam.parseJSON($("#squad"+b).val(),!0);var e=currentteam.toJuggler(!1).replace(/ \+.*/g,"").replace(/\n/g,".*.").replace(/ /g,"_");$("#squad"+b).sheetrock({url:mySpreadsheets[0],query:"select C where C matches '.*VS"+e+"'",callback:matchsquad,fetchSize:100,rowTemplate:function(){return""},labels:["squad"]})}
function matchsquad(b,e,f){if(null!=f&&"undefined"!=typeof f.rows){f.rows.sort(function(b,e){return b.cellsArray[0]<e.cellsArray[0]});b="";for(var g in f.rows)e=f.rows[g].cellsArray[0].split("VS"),e[1]!=b&&(b=e[1])}}function startcombat(){}
function filltabskill(){var b;tabskill=[];for(b=0;12>=b;b++)tabskill[b]=[];for(b in squadron)tabskill[squadron[b].getskill()].push(squadron[b]);for(b=0;12>=b;b++)tabskill[b].sort(function(b,f){var e=0,h=0;1==TEAMS[b.team].initiative&&(e=1);1==TEAMS[f.team].initiative&&(h=1);return 0==h-e?f.id-b.id:h-e})}var ZONE=[];function movelog(b){ANIM+="_-"+b}
function endsetupphase(){$(".buttonbar .share-buttons").hide();$("#leftpanel").show();$(".bigbutton").hide();$(".bigbutton2").prop("disabled",!0);ZONE[1].remove();ZONE[2].remove();TEAMS[1].endsetup();TEAMS[2].endsetup();PERMALINK=permalink(!0);$("#turnselector").append("<option value='0'>"+UI_translation["phase"+SETUP_PHASE]+"</option>");$(".playerselect").remove();$(".nextphase").prop("disabled",!0);$(".unit").css("cursor","pointer");$("#positiondial").hide();for(var b=0;b<OBSTACLES.length;b++)OBSTACLES[b].unDrag();
HISTORY=[]}
function nextphase(){var b;$("#savebtn").hide();window.location="#";switch(phase){case SELECT_PHASE:$(".mainbutton").hide();$("#game").show();$("#selectphase").hide();$("#creation").hide();$("#rightpanel").show();$("#leftpanel").show();break;case CREATION_PHASE:endselection();phase=SELECT_PHASE;return;case SETUP_PHASE:"human"==$("#player1 option:checked").val()?TEAMS[1].isia=!1:TEAMS[1].isia=!0;TEAMS[2].isia=!0;"computer"==$("#player2 option:checked").val()?TEAMS[2].isia=!0:TEAMS[2].isia=!1;1==TEAMS[1].isia&&
TEAMS[1].setia();1==TEAMS[2].isia&&TEAMS[2].setia();ZONE[0].attr({fillOpacity:0});$(".imagebg").hide();endsetupphase();break;case PLANNING_PHASE:$("#maneuverdial").hide();break;case ACTIVATION_PHASE:$("#activationdial").hide();for(b in squadron)squadron[b].hasmoved=!1,squadron[b].hasdecloaked=!1,squadron[b].actiondone=!1,squadron[b].endactivationphase();var e=[];for(b=0;b<BOMBS.length;b++)e[b]=BOMBS[b];for(b=0;b<e.length;b++)e[b].explode();break;case COMBAT_PHASE:$("#attackdial").hide();$("#listunits").html("");
for(b in squadron)squadron[b].endround();$("#turnselector").append("<option value='"+round+"'>"+UI_translation["turn #"]+round+"</option>");round++;WINCOND<round&&0<WINCOND&&win(0);-WINCOND<round&&0>WINCOND&&win(0)}phase=phase==COMBAT_PHASE?PLANNING_PHASE:phase+1;movelog("P-"+round+"-"+phase);1==phase?$("#phase").empty():3>phase?$("#phase").html(UI_translation["phase"+phase]):$("#phase").html(UI_translation["turn #"]+round+" "+UI_translation["phase"+phase]);$("#combatdial").hide();$(".nextphase").prop("disabled",
!1);setphase()}
function setphase(b){$(".imagebg").hide();switch(phase){case SELECT_PHASE:$("#addcomment").hide();$(".mainbutton").show();$(".buttonbar .share-buttons").hide();$(".h2 .share-buttons").show();$(".permalink").hide();$(".activeunit").prop("disabled",!0);$("#rightpanel").hide();$("#leftpanel").hide();$("#game").hide();$("#selectphase").show();$("#creation").hide();currentteam.setfaction("REBEL");$(".nextphase").prop("disabled",!0);break;case SETUP_PHASE:$(".imagebg").show();$("#addcomment").show();for(var e=
["bomb","weapon","upgrade","social"],f=0;f<e.length;f++)TEMPLATES[e[f]]=$("#"+e[f]).html(),Mustache.parse(TEMPLATES[e[f]]);e=localStorage.name;if("undefined"==typeof e||null==e)e=UI_translation.human;TEAMS[2].isia=!0;$("#player1").html("<option selected value='human'>"+e+"</option>");$("#player1").append("<option value='computer'>"+UI_translation.computer+"</option>");$("#player2").html("<option selected value='computer'>"+UI_translation.computer+"</option>");$("#player2").append("<option value='human'>"+
e+"</option>");$("#player1").change(function(){TEAMS[1].isia=!TEAMS[1].isia;displayplayertype(1)});$("#player2").change(function(){TEAMS[2].isia=!TEAMS[2].isia;displayplayertype(2)});displayplayertype(1);displayplayertype(2);$(".bigbutton").show();$(".bigbutton2").prop("disabled",!1);$(".buttonbar .share-buttons").show();$("#team2").css("top",$("nav").height()+2);$("#team1").css("top",$("nav").height()+2);$(".ctrl").css("display","block");ZONE[0]=s.path(SETUPS.playzone).attr({strokeWidth:6,stroke:halftone(WHITE),
strokeDasharray:"20,10,5,5,5,10",id:"ZONE",fillOpacity:0,pointerEvents:"none"});$("#imagebg").change(function(){changeimage(this)});""!=SETUP.background&&$(".playmat").css({background:"url("+SETUP.background+") no-repeat",backgroundSize:"100% 100%"});ZONE[0].appendTo(VIEWPORT);ZONE[1]=s.path(SETUPS.zone1).attr({fill:TEAMS[1].color,strokeWidth:2,opacity:.3,pointerEvents:"none"});ZONE[1].appendTo(VIEWPORT);ZONE[2]=s.path(SETUPS.zone2).attr({fill:TEAMS[2].color,strokeWidth:2,opacity:.3,pointerEvents:"none"});
ZONE[2].appendTo(VIEWPORT);TEAMS[1].endselection(s);TEAMS[2].endselection(s);loadsound();TEAMS[1].points>TEAMS[2].points?TEAMS[2].initiative=!0:TEAMS[1].initiative=!0;1==TEAMS[1].initiative?log("TEAM #1 has initiative"):log("TEAM #2 has initiative");$(".activeunit").prop("disabled",!1);for(f in squadron)if(!squadron[f].isdocked)break;activeunit=squadron[f];activeunit.select();activeunit.show();$("#svgout").bind("mousewheel DOMMouseScroll",function(b){var e=b.originalEvent;b=Math.pow(1.1,"undefined"!=
typeof e.wheelDelta?e.wheelDelta/360:e.detail/-9);var f=e.clientX-$("#team1").width(),e=e.clientY-$("nav").height(),g=$("#svgout").width(),q=$("#svgout").height(),v=0,w=0;q>g?w=(q-g)/2:v=(g-q)/2;g=Math.max(900/g,900/q);f=(f-v)*g;w=(e-w)*g;v=VIEWPORT.m.clone().invert();e=v.x(f,w);f=v.y(f,w);VIEWPORT.m.translate(e,f).scale(b).translate(-e,-f);VIEWPORT.transform(VIEWPORT.m);activeunit.show()});$("#svgout").mousedown(function(b){dragstart(b)});$("#svgout").mousemove(function(b){dragmove(b)});$("#svgout").mouseup(function(b){dragstop(b)});
jwerty.key("escape",nextphase);jwerty.key("alt+p",function(){activeunit.showpossiblepositions()},{});jwerty.key("alt+m",function(){activeunit.showmeanposition()});jwerty.key("alt+shift+p",function(){$(".possible").remove()});jwerty.key("alt+1",function(){activeunit.addfocustoken();activeunit.show()});jwerty.key("alt+2",function(){activeunit.addevadetoken();activeunit.show()});jwerty.key("alt+3",function(){activeunit.iscloaked||(activeunit.addcloaktoken(),activeunit.show())});jwerty.key("alt+4",function(){activeunit.addstress();
activeunit.show()});jwerty.key("alt+5",function(){activeunit.addiontoken();activeunit.show()});jwerty.key("alt+6",function(){activeunit.addtractorbeamtoken();activeunit.show()});jwerty.key("alt+shift+1",function(){0<activeunit.focus&&activeunit.removefocustoken();activeunit.show()});jwerty.key("alt+shift+2",function(){0<activeunit.evade&&activeunit.removeevadetoken();activeunit.show()});jwerty.key("alt+shift+3",function(){activeunit.iscloaked&&(activeunit.removecloaktoken(),activeunit.show())});jwerty.key("alt+shift+4",
function(){0<activeunit.stress&&activeunit.removestresstoken();activeunit.show()});jwerty.key("alt+shift+5",function(){0<activeunit.ionized&&activeunit.removeiontoken()});jwerty.key("alt+shift+6",function(){0<activeunit.tractorbeam&&activeunit.removetractorbeamtoken()});jwerty.key("alt+f",function(){var b="";for(f in activeunit.actionsdone)b+=activeunit.actionsdone[f]+" ";activeunit.log("actions done:"+b)});jwerty.key("alt+d",function(){activeunit.resolvehit(1)});jwerty.key("alt+c",function(){activeunit.resolvecritical(1)});
jwerty.key("alt+shift+d",function(){activeunit.hull<activeunit.ship.hull?activeunit.addhull(1):activeunit.shield<activeunit.ship.shield&&activeunit.addshield(1);activeunit.show()});0<SETUPS.asteroids&&loadrock(s,ROCKDATA);log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$(".unit").css("cursor","move");$("#positiondial").show();$(".permalink").show();$("#savebtn").hide();1!=b&&startreplayall();break;case PLANNING_PHASE:active=0;actionr=[$.Deferred().resolve()];
actionrlock=$.Deferred().resolve();log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$(".nextphase").prop("disabled",!0);$("#maneuverdial").show();skillturn=0;filltabskill();$("#savebtn").show();for(f in squadron)squadron[f].newm=squadron[f].m,squadron[f].beginplanningphase().progress(nextplanning);nextplanning();break;case ACTIVATION_PHASE:log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$(".nextphase").prop("disabled",
!0);$("#activationdial").show();for(f in squadron)squadron[f].beginactivationphase().done(nextdecloak);filltabskill();subphase=DECLOAK_PHASE;skillturn=0;barrier(nextdecloak);break;case COMBAT_PHASE:log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$("#attackdial").show();skillturn=12;for(f in squadron)squadron[f].begincombatphase().done(nextcombat);barrier(nextcombat)}}function barrier(b){$.when.apply(null,actionr).done(b)}
function log(b){$("#log").append("<div>"+b+"<div>");$("#log").scrollTop(1E4)}function permalink(b){var e="";b||(e=ANIM);b=localStorage.image;var f=localStorage.name;"undefined"==typeof b&&(b="");"undefined"==typeof f&&(f="");return LZString.compressToEncodedURIComponent(TEAMS[1].toASCII()+"&"+TEAMS[2].toASCII()+"&"+saverock()+"&"+TEAMS[1].isia+"&"+TEAMS[2].isia+"&"+SETUP.name+"&"+e+"&"+b+"&"+f)}
function resetlink(b,e,f){switch(phase){case SETUP_PHASE:case SELECT_PHASE:document.location.search="";f=document.location.href;0<f.indexOf("?")&&(f=f.substring(0,f.indexOf("?")),window.history.replaceState({},document.title,f));location.reload();break;case CREATION_PHASE:phase=0;document.location.search="";nextphase();break;default:1==b?""!=document.location.search?document.location.search="":document.location.reload():(1==e?ANIM="":1==f?$("#turnselector option:selected").each(function(){var b=$(this).val();
-1!=b&&(0==b?ANIM="":(b=ANIM.search("_-P-"+b+"-3"),ANIM=ANIM.slice(0,ANIM.indexOf("_",b+1))))}):(b=ANIM.search("_-P-"+f+"-3"),-1==ANIM.indexOf("_",b+1)&&(b=ANIM.search("_-P-"+(f-1)+"-3")),ANIM=ANIM.slice(0,ANIM.indexOf("_",b+1))),f=LZString.decompressFromEncodedURIComponent(decodeURI(PERMALINK)),args=f.split("&"),args[2]=saverock(),args[6]=ANIM,f=args.join("&"),document.location.search="?"+LZString.compressToEncodedURIComponent(f))}}function record(b,e,f){}
function history_toASCII(){for(var b="",e=0;e<HISTORY.length;e++)b+=HISTORY[e].s+"_"+HISTORY[e].id+";";return b}function select(b){for(var e in squadron)if(squadron[e].id==b)break;squadron[e].select();$("#"+activeunit.id).attr({color:"white",background:"tomato"})}
function probatable(b,e){var f,g,h="";for(f=0;5>=f;f++){h+="<tr><td>"+f+"</td>";for(g=0;5>=g;g++){var l=g;0<e.adddice&&(l+=e.adddice);l=tohitproba(b,{},e,ATTACK[f],DEFENSE[l],f,l);h+="<td class='probacell' style='background:hsl("+1.2*(100-l.tohit)+",100%,80%)'>";h+="<div>"+l.tohit+"%</div><div><code class='symbols'>d</code>"+l.meanhit+"</div><div><code class='symbols'>c</code>"+l.meancritical+"</div></td>"}h+="</tr>"}return h}
function fillprobatable(){var b={focus:$("#focusA").prop("checked")?1:0,reroll:$("#targetA").prop("checked")?5:0},e={focus:$("#focusD").prop("checked")?1:0,evade:$("#evadeD").prop("checked")?1:0,adddice:$("#cloakD").prop("checked")?2:0,reroll:0},f;f=parseInt($("#rerollA").val(),10);var g=parseInt($("#rerollD").val(),10);if(0==b.reroll||0<f&&f<b.reroll)b.reroll=f;if(0==e.reroll||0<g&&g<e.reroll)e.reroll=g;b="<tr><th>Rolls</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>"+probatable(b,
e);$("#probatable").html(b)}function modal_dragstart(b){var e=window.getComputedStyle(b.originalEvent.target,null);b.originalEvent.dataTransfer.setData("text/plain",b.target.parentElement.id+","+(parseInt(e.getPropertyValue("left"),10)-b.originalEvent.clientX)+","+(parseInt(e.getPropertyValue("top"),10)-b.originalEvent.clientY))}function modal_dragover(b){b.originalEvent.preventDefault();return!1}
function modal_drop(b){var e=b.originalEvent.dataTransfer.getData("text/plain").split(","),f=e[0];$("#"+f+" > div").css("left",b.originalEvent.clientX+parseInt(e[1],10)+"px");$("#"+f+" > div").css("top",b.originalEvent.clientY+parseInt(e[2],10)+"px");b.originalEvent.preventDefault();return!1}
var viewport_translate=function(b,e){VIEWPORT.m=MT(b,e).add(VIEWPORT.m);$(".phasepanel").hide();VIEWPORT.transform(VIEWPORT.m)},viewport_zoom=function(b){$("#svgout").width();$("#svgout").height();var e=activeunit.m.x(0,0),f=activeunit.m.y(0,0),g=VIEWPORT.m.clone().invert(),h=g.x(e,f),e=g.y(e,f);VIEWPORT.m.translate(h,e).scale(b).translate(-h,-e);VIEWPORT.transform(VIEWPORT.m);activeunit.show()},dragmove=function(b){if(1!=activeunit.dragged&&VIEWPORT.dragged){var e=$("#svgout").width(),f=$("#svgout").height(),
e=Math.max(900/e,900/f);VIEWPORT.dragMatrix=MT((b.offsetX-VIEWPORT.x0)*e,(b.offsetY-VIEWPORT.y0)*e).add(VIEWPORT.m);VIEWPORT.dragged=!0;$(".phasepanel").hide();VIEWPORT.transform(VIEWPORT.dragMatrix)}},dragstart=function(b){VIEWPORT.dragged=!0;"svgout"==b.originalEvent.target.id?(VIEWPORT.x0=b.offsetX,VIEWPORT.y0=b.offsetY,VIEWPORT.dragged=!0,VIEWPORT.dragMatrix=VIEWPORT.m):VIEWPORT.dragged=!1},dragstop=function(b){VIEWPORT.dragged&&(VIEWPORT.m=VIEWPORT.dragMatrix,VIEWPORT.m.clone(),VIEWPORT.transform(VIEWPORT.m),
activeunit.show());VIEWPORT.dragged=!1},scrolloverflow=function(b){$("#"+b.target.id+" .outoverflow").each(function(b){"auto"!=$(this).css("top")&&$(this).css("top",$(this).parent().offset().top+"px")})},changelanguage=function(b){localStorage.LANG=b;location.reload()};
$(document).ready(function(){var b;s=Snap("#svgout");VIEWPORT=s.g().attr({id:"viewport"});VIEWPORT.m=new Snap.Matrix;FILTER=s.filter(Snap.filter.blur(5,5));P={F0:{path:s.path("M 0 0 L 0 0"),speed:0,key:"5"},F1:{path:s.path("M 0 0 L 0 -80"),speed:1,key:"8"},F2:{path:s.path("M 0 0 L 0 -120"),speed:2,key:"8"},F3:{path:s.path("M 0 0 L 0 -160"),speed:3,key:"8"},F4:{path:s.path("M 0 0 L 0 -200"),speed:4,key:"8"},F5:{path:s.path("M 0 0 L 0 -240"),speed:5,key:"8"},TR1:{path:s.path("M0 0 C 0 -40 15 -55 55 -55"),
speed:1,key:"6"},TR2:{path:s.path("M0 0 C 0 -50 33 -83 83 -83"),speed:2,key:"6"},TRR2:{path:s.path("M0 0 C 0 -50 33 -83 83 -83"),speed:2,key:";"},TR3:{path:s.path("M0 0 C 0 -60 45 -105 105 -105"),speed:3,key:"6"},TRR3:{path:s.path("M0 0 C 0 -60 45 -105 105 -105"),speed:3,key:";"},TL1:{path:s.path("M0 0 C 0 -40 -15 -55 -55 -55"),speed:1,key:"4"},TL2:{path:s.path("M0 0 C 0 -50 -33 -83 -83 -83"),speed:2,key:"4"},TRL2:{path:s.path("M0 0 C 0 -50 -33 -83 -83 -83"),speed:2,key:":"},TL3:{path:s.path("M0 0 C 0 -60 -45 -105 -105 -105"),
speed:3,key:"4"},TRL3:{path:s.path("M0 0 C 0 -60 -45 -105 -105 -105"),speed:3,key:":"},BR1:{path:s.path("M0 0 C 0 -20 18 -72 38 -92"),speed:1,key:"9"},BR2:{path:s.path("M0 0 C 0 -30 24 -96 54 -126"),speed:2,key:"9"},SR2:{path:s.path("M0 0 C 0 -30 24 -96 54 -126"),speed:2,key:"3"},BR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160"),speed:3,key:"9"},SR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160"),speed:3,key:"3"},BL1:{path:s.path("M0 0 C 0 -20 -18 -72 -38 -92"),speed:1,key:"7"},BL2:{path:s.path("M0 0 C 0 -30 -24 -96 -54 -126"),
speed:2,key:"7"},SL2:{path:s.path("M0 0 C 0 -30 -24 -96 -54 -126"),speed:2,key:"1"},BL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160"),speed:3,key:"7"},SL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160"),speed:3,key:"1"},K1:{path:s.path("M 0 0 L 0 -80"),speed:1,key:"2"},K2:{path:s.path("M 0 0 L 0 -120"),speed:2,key:"2"},K3:{path:s.path("M 0 0 L 0 -160"),speed:3,key:"2"},K4:{path:s.path("M 0 0 L 0 -200"),speed:4,key:"2"},K5:{path:s.path("M 0 0 L 0 -240"),speed:5,key:"2"}};for(b in P)P[b].path.attr({display:"none"});
$(".menu").mouseover(function(){$(".menu ul").css({display:"block",visibility:"visible"})}).mouseout(function(){$("nav ul").css({display:"none",visibility:"hidden"})});"undefined"!=typeof gapi&&gapi.load("client",function(){gapi.client.setApiKey("AIzaSyBN2T9d2ZuWaT0Vj6EanYb5IgWzLlhy7Zo");gapi.client.load("urlshortener","v1")});LANG=localStorage.LANG||window.navigator.userLanguage||window.navigator.language;LANG=LANG.substring(0,2);$.ajaxSetup({beforeSend:function(b){b.overrideMimeType&&b.overrideMimeType("application/json")},
isLocal:!0});-1=="en fr de es it pl".split(" ").indexOf(LANG)&&(LANG="en");$("#langselect").val(LANG);$.when($.ajax("data/ships.json",{error:function(b,f,g){console.log("**Error loading ships.json\n"+f+" "+g)}}),$.ajax("data/strings."+LANG+".json",{error:function(b,f,g){console.log("**Error loading strings."+LANG+".json\n"+f+" "+g)}}),$.ajax("data/xws.json",{error:function(b,f,g){console.log("**Error loading xws.json\n"+f+" "+g)}}),$.ajax("data/strings.en.json",{error:function(b,f,g){console.log("**Error loading strings."+
LANG+".json\n"+f+" "+g)}})).done(function(b,f,g,h){var e=setInterval(function(){ATTACK[dice]=attackproba(dice);DEFENSE[dice]=defenseproba(dice);dice++;8==dice&&(fillprobatable(),$("#showproba").prop("disabled",!1),clearInterval(e))},500);unitlist=b[0];ENSHIP_translation=h[0].ships;ENPILOT_translation=h[0].pilots;ENUPGRADE_translation=h[0].upgrades;SHIP_translation=f[0].ships;PILOT_translation=f[0].pilots;UPGRADE_translation=f[0].upgrades;UI_translation=f[0].ui;CRIT_translation=f[0].criticals;h=f[0].css;
b="";if("en"!=LANG){for(q in ENUPGRADE_translation){f=ENUPGRADE_translation[q];var m=UPGRADE_translation[q];"undefined"==typeof m&&(UPGRADE_translation[q]=f)}for(q in ENPILOT_translation)f=ENPILOT_translation[q],m=PILOT_translation[q],"undefined"==typeof m&&(PILOT_translation[q]=f)}for(var q in h)b+="."+q+'::after { content:"'+h[q]+'";}\n';$("#localstrings").html(b);UPGRADE_dict=g[0].upgrades;PILOT_dict=g[0].pilots;for(var v in PILOT_dict){for(q=0;q<PILOTS.length;q++)PILOTS[q].name==PILOT_dict[v]&&
(PILOTS[q].dict=v);for(q in unitlist)q==PILOT_dict[v]&&(unitlist[q].dict=v)}for(q=0;q<UPGRADES.length;q++)f=UPGRADES[q],f.type==TITLE&&(unitlist[f.ship].hastitle=!0);for(q=0;q<PILOTS.length;q++){g=!1;for(v in PILOT_dict)if(PILOTS[q].name==PILOT_dict[v]){g=!0;break}g||log("no xws translation for "+PILOTS[q].name)}for(q=0;q<UPGRADES.length;q++){g=!1;for(v in UPGRADE_dict)if(UPGRADES[q].name==UPGRADE_dict[v]){g=!0;break}g||log("no xws translation for "+UPGRADES[q].name)}squadron=[];s.attr({width:"100%",
height:"100%",viewBox:"0 0 900 900"});TEAMS[1].setfaction("REBEL");TEAMS[2].setfaction("EMPIRE");g=f=v=0;b="";for(q=0;q<PILOTS.length;q++)1==PILOTS[q].done&&(PILOTS[q].unique&&f++,v++),PILOTS[q].done||(b=PILOTS[q].unique?b+", .":b+", ",b+=PILOTS[q].name);log(v+"/"+PILOTS.length+" pilots with full effect");""!=b&&log("Pilots NOT implemented"+b);v=0;b="";for(q=0;q<UPGRADES.length;q++)UPGRADES[q].invisible||(1==UPGRADES[q].done?v++:b+=(""==b?"":", ")+(UPGRADES[q].unique?".":"")+UPGRADES[q].name,g++);
$(".ver").html(VERSION);log(v+"/"+g+" upgrades with full effect");log("Upgrades NOT working yet:"+b);$("#showproba").prop("disabled",!0);"undefined"==typeof localStorage.volume&&(localStorage.volume=.8);"undefined"!=typeof localStorage.image&&$("#profile-avatar").attr("src",localStorage.image);"undefined"!=typeof localStorage.name?$("#nameinput").val(localStorage.name):$("#nameinput").val("Human");Howler.volume(localStorage.volume);$("#vol").val(100*localStorage.volume);var w=new Hammer(document.getElementById("svgout"));
w.get("pinch").set({enable:!0});w.get("pan").set({direction:Hammer.DIRECTION_ALL});w.on("panleft panright panup pandown",function(b){"svgout"==b.target.id&&1!=activeunit.dragged&&viewport_translate(50*-b.velocityX,50*-b.velocityY)});TEMPLATES["unit-creation"]=$("#unit-creation").html();Mustache.parse(TEMPLATES["unit-creation"]);TEMPLATES["upglist-creation"]=$("#upglist-creation").html();Mustache.parse(TEMPLATES["upglist-creation"]);TEMPLATES.faction=$("#faction").html();Mustache.parse(TEMPLATES.faction);
TEMPLATES.usabletokens=$("#usabletokens").html();Mustache.parse(TEMPLATES.usabletokens);TEMPLATES.selectweapon=$("#selectweapon").html();Mustache.parse(TEMPLATES.selectweapon);$("body").on("mousedown","footer",function(){$(this).addClass("draggable").parents().on("mousemove",function(b){$(".draggable").offset({top:b.pageY-$(".draggable").outerHeight()/2,left:b.pageX-$(".draggable").outerWidth()/2}).on("mouseup",function(){$(this).removeClass("draggable")})});"function"==typeof(0).preventDefault&&
(0).preventDefault()}).on("mouseup",function(){$(".draggable").removeClass("draggable")});w.zoom=1;w.on("pinch",function(b){if("svgout"==b.target.id&&1!=activeunit.dragged){var e=VIEWPORT.m.clone().invert(),f=e.x(b.center.x,b.center.y),e=e.y(b.center.x,b.center.y);VIEWPORT.m.translate(f,e).scale(b.scale).scale(1/w.zoom).translate(-f,-e);w.zoom=b.scale;VIEWPORT.transform(VIEWPORT.m);activeunit.show();b["final"]&&(w.zoom=1)}});$("aside").on("scroll touchmove touchstart mousewheel",scrolloverflow);$("#squadbattle").html("<thead><tr><th><span class='m-score'></span></th><th><span class='m-opponent'></span></th></tr></thead>");
SQUADBATTLE=$("#squadbattle").DataTable({language:{search:UI_translation.Search,lengthMenu:UI_translation["Display _MENU_ records per page"],zeroRecords:UI_translation["Nothing found - sorry"],info:UI_translation["Showing page _PAGE_ of _PAGES_"],infoEmpty:UI_translation["No records available"],infoFiltered:UI_translation["(filtered from _MAX_ total records)"]},autoWidth:!0,scrollY:"20em",scrollX:!0,deferRender:!0,scrollCollapse:!0,ordering:!0,processing:!0,info:!0,paging:!0});$("#squadbattle tbody").on("click",
"tr",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):($("#squadbattle tr.selected").removeClass("selected"),$(this).addClass("selected"))});v=LZString.decompressFromEncodedURIComponent(decodeURI(window.location.search.substr(1)));g=[];null!=v&&(g=v.split("&"));if(1<g.length)return log("Loading permalink..."),ROCKDATA=g[2],phase=CREATION_PHASE,TEAMS[1].parseASCII(g[0]),TEAMS[1].toJSON(),TEAMS[2].parseASCII(g[1]),TEAMS[2].toJSON(),TEAMS[1].isia=!1,TEAMS[2].isia=!1,"true"==g[3]?
TEAMS[1].isia=!0:(localStorage.imageplayer=g[7],localStorage.playername=g[8]),"true"==g[4]?TEAMS[2].isia=!0:(localStorage.imageplayer=g[7],localStorage.playername=g[8]),SETUP=SETUPS[g[5]+" Map"],phase=SELECT_PHASE,6<g.length&""!=g[6]&&(REPLAY=g[6]),PERMALINK=LZString.compressToEncodedURIComponent(TEAMS[1].toASCII()+"&"+TEAMS[2].toASCII()+"&"+saverock()+"&"+TEAMS[1].isia+"&"+TEAMS[2].isia+"&"+g[5]),nextphase();delete localStorage.imageplayer;delete localStorage.playername;phase=0;nextphase();localStorage.getItem("import")&&
(log("Importing from another Squad Builder..."),currentteam=""==$("#squad1").val()?TEAMS[1]:TEAMS[2],currentteam.parseJSON(sessionStorage.getItem("import")),sessionStorage.clear(),endselection());SETUP=SETUPS["Classic Map"];$("#squadlist").html("<thead><tr><th></th><th>"+UI_translation.type+"</th><th><span class='m-points'></span></th><th><span class='m-units'></span></th><th></th><th></th><th></th></tr></thead>");$.fn.dataTable.ext.search.push(function(b,e,f){return-1<e[1].search(stype)});SQUADLIST=
$("#squadlist").DataTable({language:{search:UI_translation.Search,lengthMenu:UI_translation["Display _MENU_ records per page"],zeroRecords:UI_translation["Nothing found - sorry"],info:UI_translation["Showing page _PAGE_ of _PAGES_"],infoEmpty:UI_translation["No records available"],infoFiltered:UI_translation["(filtered from _MAX_ total records)"]},autoWidth:!0,columnDefs:[{targets:[0],render:function(){return"<span class='closemiddle' onclick='removerow($(this))'>&times;</span> "},sortable:!1},{targets:[6],
width:"2em",render:function(){return"<span class='squadtop'><span class='squadmiddle' onclick='checkrow(1,$(this))'>1</span>&nbsp;<span class='squadmiddle right' onclick='checkrow(2,$(this))'>2</span></span>"},sortable:!1},{targets:[5],render:function(b,e,f){return"<span class='logmiddle symbols' onclick='battlelog($(this));'>&#xE9;</span>"},sortable:!1},{targets:[1],sortable:!1,render:function(b,e,f){return-1<f[4].search("SQUAD")?"<span style='display:none'>"+b+" USER</span><span class='"+b+"'></span>":
"ELITE"==f[4]?"<span style='display:none'>"+b+" ELITE</span><span class='"+b+"'></span><span style='font-size:larger'></span><code style='color:orange' class='symbols'>\u00ef</code>":"<span style='display:none'>"+b+" PREBUILT</span><span class='"+b+"'></span><code style='font-size:larger' class='symbols'>\u00ec</code>"}},{targets:[4],visible:!1,searchable:!1},{targets:[3],render:function(b,e,f){"en"!=LANG&&phase==SELECT_PHASE&&-1==f[4].search("SQUAD")&&(TEAMS[0].parseJuggler(b,!1),b=TEAMS[0].toJuggler(!0));
return b.replace(/\n/g,"<br>")}}],ajax:"data/full4b.json",scrollY:"20em",scrollCollapse:!0,deferRender:!0,ordering:!0,info:!0,paging:!0});for(q in localStorage)"string"==typeof localStorage[q]&&q.match(/SQUAD.*/)&&(v=$.parseJSON(localStorage[q]),"undefined"==typeof v.jug||"undefined"==typeof v.pts?delete localStorage[q]:"en"!=LANG?(TEAMS[0].parseJuggler(v.jug,!1),addrow(0,q,v.pts,v.faction,TEAMS[0].toJuggler(!0),!0)):addrow(0,q,v.pts,v.faction,v.jug,!0));$("#squadlist tr:first-child .squadtop").attr("data-intro",
"Select squad").attr("data-position","bottom");$("#squadlist tr:first-child .logmiddle").attr("data-intro","Battle log").attr("data-position","left");g=[];for(q=0;q<PILOTS.length;q++)v=q,v=translate(PILOTS[q].name),1==PILOTS[q].ambiguous&&"undefined"!=typeof PILOTS[q].edition&&(v+="("+PILOTS[q].edition+")"),g.push(v.replace(/\'/g,"").replace(/\(Scum\)/g,""));v=[];for(q in UPGRADE_translation)v.push(" "+translate(q).replace(/\'/g,"").replace(/\(Crew\)/g,""));$(".squadbg > textarea").asuggest(g,{delimiters:"^\n",
cycleOnTab:!0});$(".squadbg > textarea").asuggest(v,{delimiters:"+",cycleOnTab:!0})})});function util(){}
util.getOutlineRange=function(b,e,f){b=b.getOutlinePoints(b.m);e=e.getOutlinePoints(e.m);var g=90001,h,l,m=!1,q=0,v,w;for(h=0;h<b.length;h++)for(l=0;l<e.length;l++){var x=dist(e[l],b[h]);x<g&&(g=x,v=h,w=l)}if(9E4<g)return{distance:4,obstructed:m,obstructionCount:q};var x=e[w].x-b[v].x,y=e[w].y-b[v].y,z=-b[v].x*y+b[v].y*x;if(0<f.length)for(l=0;l<f.length;l++)if(f[l].type!=NONE&&f[l].type!=BOMB){var B=f[l].getOutlineString().p;if(0==B.length)break;var E=B[0].x*y-B[0].y*x+z,D=E;for(h=1;h<B.length&&!(dist(e[w],
B[h])<1.2*g&&dist(b[v],B[h])<1.2*g&&(D=B[h].x*y-B[h].y*x+z,0>D*E));h++);0>D*E&&(m=!0,q++)}return 1E4>=g?{distance:1,obstructed:m,obstructionCount:q}:4E4>=g?{distance:2,obstructed:m,obstructionCount:q}:{distance:3,obstructed:m,obstructionCount:q}};//@ sourceMappingURL=bench.js.map
